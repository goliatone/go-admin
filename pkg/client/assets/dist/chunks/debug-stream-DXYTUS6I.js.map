{"version":3,"file":"debug-stream-DXYTUS6I.js","sources":["../../src/debug/debug-stream.ts"],"sourcesContent":["export type DebugEvent = {\n  type: string;\n  payload: any;\n  timestamp: string;\n};\n\nexport type DebugCommand = {\n  type: string;\n  panels?: string[];\n};\n\nexport type DebugStreamStatus = 'connected' | 'disconnected' | 'reconnecting' | 'error';\n\nexport type DebugStreamOptions = {\n  basePath: string;\n  maxReconnectAttempts?: number;\n  reconnectDelayMs?: number;\n  maxReconnectDelayMs?: number;\n  onEvent?: (event: DebugEvent) => void;\n  onStatusChange?: (status: DebugStreamStatus) => void;\n  onError?: (event: Event) => void;\n};\n\nconst defaultReconnectDelayMs = 1000;\nconst defaultMaxReconnectDelayMs = 12000;\nconst defaultMaxReconnectAttempts = 8;\n\nconst normalizeBasePath = (basePath: string): string => {\n  const trimmed = (basePath || '').trim();\n  if (!trimmed) {\n    return '';\n  }\n  if (trimmed.startsWith('/')) {\n    return trimmed.replace(/\\/+$/, '');\n  }\n  return `/${trimmed.replace(/\\/+$/, '')}`;\n};\n\nconst buildWebSocketURL = (basePath: string): string => {\n  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n  const normalized = normalizeBasePath(basePath);\n  return `${protocol}//${window.location.host}${normalized}/ws`;\n};\n\nexport class DebugStream {\n  private options: DebugStreamOptions;\n  private ws: WebSocket | null = null;\n  private reconnectTimer: number | null = null;\n  private reconnectAttempts = 0;\n  private manualClose = false;\n  private pendingCommands: DebugCommand[] = [];\n  private status: DebugStreamStatus = 'disconnected';\n\n  constructor(options: DebugStreamOptions) {\n    this.options = options;\n  }\n\n  connect(): void {\n    if (this.ws && (this.ws.readyState === WebSocket.OPEN || this.ws.readyState === WebSocket.CONNECTING)) {\n      return;\n    }\n\n    this.manualClose = false;\n    const url = buildWebSocketURL(this.options.basePath);\n    this.ws = new WebSocket(url);\n\n    this.ws.onopen = () => {\n      this.reconnectAttempts = 0;\n      this.setStatus('connected');\n      this.flushPending();\n    };\n\n    this.ws.onmessage = (event) => {\n      if (!event || typeof event.data !== 'string') {\n        return;\n      }\n      try {\n        const parsed = JSON.parse(event.data) as DebugEvent;\n        this.options.onEvent?.(parsed);\n      } catch {\n        // ignore malformed payloads\n      }\n    };\n\n    this.ws.onclose = () => {\n      this.ws = null;\n      if (this.manualClose) {\n        this.setStatus('disconnected');\n        return;\n      }\n      this.setStatus('reconnecting');\n      this.scheduleReconnect();\n    };\n\n    this.ws.onerror = (event) => {\n      this.options.onError?.(event);\n      this.setStatus('error');\n    };\n  }\n\n  close(): void {\n    this.manualClose = true;\n    if (this.reconnectTimer !== null) {\n      window.clearTimeout(this.reconnectTimer);\n      this.reconnectTimer = null;\n    }\n    if (this.ws) {\n      this.ws.close();\n    }\n  }\n\n  sendCommand(cmd: DebugCommand): void {\n    if (!cmd || !cmd.type) {\n      return;\n    }\n    if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n      this.ws.send(JSON.stringify(cmd));\n      return;\n    }\n    this.pendingCommands.push(cmd);\n  }\n\n  subscribe(panels: string[]): void {\n    this.sendCommand({ type: 'subscribe', panels });\n  }\n\n  unsubscribe(panels: string[]): void {\n    this.sendCommand({ type: 'unsubscribe', panels });\n  }\n\n  requestSnapshot(): void {\n    this.sendCommand({ type: 'snapshot' });\n  }\n\n  clear(panels?: string[]): void {\n    this.sendCommand({ type: 'clear', panels });\n  }\n\n  getStatus(): DebugStreamStatus {\n    return this.status;\n  }\n\n  private setStatus(status: DebugStreamStatus): void {\n    if (this.status === status) {\n      return;\n    }\n    this.status = status;\n    this.options.onStatusChange?.(status);\n  }\n\n  private flushPending(): void {\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {\n      return;\n    }\n    if (this.pendingCommands.length === 0) {\n      return;\n    }\n    const pending = [...this.pendingCommands];\n    this.pendingCommands = [];\n    for (const cmd of pending) {\n      this.ws.send(JSON.stringify(cmd));\n    }\n  }\n\n  private scheduleReconnect(): void {\n    const maxAttempts = this.options.maxReconnectAttempts ?? defaultMaxReconnectAttempts;\n    const baseDelay = this.options.reconnectDelayMs ?? defaultReconnectDelayMs;\n    const maxDelay = this.options.maxReconnectDelayMs ?? defaultMaxReconnectDelayMs;\n    if (this.reconnectAttempts >= maxAttempts) {\n      this.setStatus('disconnected');\n      return;\n    }\n    const attempt = this.reconnectAttempts;\n    const backoff = Math.min(baseDelay * Math.pow(2, attempt), maxDelay);\n    const jitter = backoff * (0.2 + Math.random() * 0.3);\n    this.reconnectAttempts += 1;\n    this.reconnectTimer = window.setTimeout(() => {\n      this.connect();\n    }, backoff + jitter);\n  }\n}\n"],"names":["normalizeBasePath","basePath","trimmed","buildWebSocketURL","protocol","normalized","DebugStream","options","url","event","parsed","cmd","panels","status","pending","maxAttempts","baseDelay","maxDelay","attempt","backoff","jitter"],"mappings":"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"}