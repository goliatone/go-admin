{"version":3,"file":"file_uploader.js","sources":["../../src/formgen/file_uploader.ts"],"sourcesContent":["type FileUploaderConfig = {\n  uploadEndpoint?: string;\n  allowedTypes?: string[];\n  maxSize?: number;\n  preview?: boolean;\n  variant?: string;\n};\n\ntype FileUploaderElements = {\n  root: HTMLElement;\n  urlInput: HTMLInputElement;\n  fileInput: HTMLInputElement;\n  previewImg?: HTMLImageElement;\n  placeholder?: HTMLElement;\n  errorEl: HTMLElement;\n  statusEl: HTMLElement;\n};\n\nfunction parseConfig(raw: string | null): FileUploaderConfig {\n  if (!raw) return {};\n  try {\n    const parsed = JSON.parse(raw) as unknown;\n    if (parsed && typeof parsed === 'object') {\n      return parsed as FileUploaderConfig;\n    }\n  } catch {\n    // ignore\n  }\n  return {};\n}\n\nfunction formatBytes(bytes: number): string {\n  if (!Number.isFinite(bytes) || bytes <= 0) return '0 B';\n  const units = ['B', 'KB', 'MB', 'GB'];\n  let size = bytes;\n  let unitIndex = 0;\n  while (size >= 1024 && unitIndex < units.length - 1) {\n    size /= 1024;\n    unitIndex += 1;\n  }\n  const precision = unitIndex === 0 ? 0 : 1;\n  return `${size.toFixed(precision)} ${units[unitIndex]}`;\n}\n\nfunction showError(elements: FileUploaderElements, message: string): void {\n  elements.errorEl.textContent = message;\n  elements.errorEl.classList.remove('hidden');\n  elements.statusEl.textContent = '';\n  elements.statusEl.classList.add('hidden');\n}\n\nfunction clearError(elements: FileUploaderElements): void {\n  elements.errorEl.textContent = '';\n  elements.errorEl.classList.add('hidden');\n}\n\nfunction setStatus(elements: FileUploaderElements, message: string): void {\n  elements.statusEl.textContent = message;\n  elements.statusEl.classList.remove('hidden');\n}\n\nfunction clearStatus(elements: FileUploaderElements): void {\n  elements.statusEl.textContent = '';\n  elements.statusEl.classList.add('hidden');\n}\n\nfunction setPreview(elements: FileUploaderElements, src: string | null): void {\n  if (!elements.previewImg || !elements.placeholder) return;\n  if (src) {\n    elements.previewImg.src = src;\n    elements.previewImg.classList.remove('hidden');\n    elements.placeholder.classList.add('hidden');\n  } else {\n    elements.previewImg.removeAttribute('src');\n    elements.previewImg.classList.add('hidden');\n    elements.placeholder.classList.remove('hidden');\n  }\n}\n\nfunction ensureInlineElement(root: HTMLElement, selector: string, className: string): HTMLElement {\n  const existing = root.querySelector<HTMLElement>(selector);\n  if (existing) return existing;\n\n  const el = document.createElement('p');\n  el.className = className;\n  root.appendChild(el);\n  return el;\n}\n\nfunction resolveElements(root: HTMLElement): FileUploaderElements | null {\n  const urlInput = root.querySelector<HTMLInputElement>('input[data-file-uploader-url]');\n  const fileInput = root.querySelector<HTMLInputElement>('input[data-file-uploader-file]');\n  if (!urlInput || !fileInput) return null;\n\n  const errorEl = ensureInlineElement(root, '[data-file-uploader-error]', 'text-sm text-red-600 hidden');\n  errorEl.setAttribute('data-file-uploader-error', 'true');\n\n  const statusEl = ensureInlineElement(root, '[data-file-uploader-status]', 'text-xs text-gray-500 hidden');\n  statusEl.setAttribute('data-file-uploader-status', 'true');\n\n  const previewImg = root.querySelector<HTMLImageElement>('[data-file-uploader-preview]');\n  const placeholder = root.querySelector<HTMLElement>('[data-file-uploader-placeholder]');\n\n  return {\n    root,\n    urlInput,\n    fileInput,\n    previewImg: previewImg ?? undefined,\n    placeholder: placeholder ?? undefined,\n    errorEl,\n    statusEl\n  };\n}\n\nasync function uploadFile(elements: FileUploaderElements, endpoint: string, file: File): Promise<string> {\n  const formData = new FormData();\n  formData.append('file', file, file.name);\n\n  const response = await fetch(endpoint, {\n    method: 'POST',\n    body: formData,\n    credentials: 'same-origin',\n    headers: { 'Accept': 'application/json' }\n  });\n\n  if (!response.ok) {\n    const text = await response.text();\n    let message = `Upload failed (${response.status})`;\n    try {\n      const parsed = JSON.parse(text) as any;\n      if (parsed?.message && typeof parsed.message === 'string') message = parsed.message;\n      if (parsed?.error && typeof parsed.error === 'string') message = parsed.error;\n      if (parsed?.error?.message && typeof parsed.error.message === 'string') message = parsed.error.message;\n    } catch {\n      if (text) message = text;\n    }\n    throw new Error(message);\n  }\n\n  const data = (await response.json()) as { url?: unknown };\n  if (!data || typeof data.url !== 'string' || !data.url) {\n    throw new Error('Upload succeeded but response did not include a url');\n  }\n\n  return data.url;\n}\n\nfunction initUploader(root: HTMLElement): void {\n  const elements = resolveElements(root);\n  if (!elements) return;\n\n  const config = parseConfig(root.getAttribute('data-component-config'));\n\n  if (Array.isArray(config.allowedTypes) && config.allowedTypes.length > 0) {\n    elements.fileInput.setAttribute('accept', config.allowedTypes.join(','));\n  }\n\n  if (config.preview !== false) {\n    const existing = elements.urlInput.value?.trim();\n    if (existing) setPreview(elements, existing);\n  }\n\n  elements.fileInput.addEventListener('change', async () => {\n    clearError(elements);\n    clearStatus(elements);\n\n    const file = elements.fileInput.files?.[0];\n    if (!file) return;\n\n    if (Array.isArray(config.allowedTypes) && config.allowedTypes.length > 0) {\n      if (!config.allowedTypes.includes(file.type)) {\n        showError(elements, `Unsupported file type: ${file.type || 'unknown'}`);\n        return;\n      }\n    }\n\n    if (typeof config.maxSize === 'number' && Number.isFinite(config.maxSize) && config.maxSize > 0) {\n      if (file.size > config.maxSize) {\n        showError(elements, `File too large: ${formatBytes(file.size)} (max ${formatBytes(config.maxSize)})`);\n        return;\n      }\n    }\n\n    const endpoint = (config.uploadEndpoint || '').trim();\n    if (!endpoint) {\n      showError(elements, 'Upload endpoint is not configured');\n      return;\n    }\n\n    const previousDisabled = elements.fileInput.disabled;\n    elements.fileInput.disabled = true;\n\n    let objectURL: string | null = null;\n    try {\n      if (config.preview !== false) {\n        objectURL = URL.createObjectURL(file);\n        setPreview(elements, objectURL);\n      }\n\n      setStatus(elements, 'Uploadingâ€¦');\n      const url = await uploadFile(elements, endpoint, file);\n      elements.urlInput.value = url;\n      if (config.preview !== false) setPreview(elements, url);\n      setStatus(elements, 'Uploaded');\n      window.setTimeout(() => clearStatus(elements), 1500);\n    } catch (err) {\n      const message = err instanceof Error ? err.message : 'Upload failed';\n      showError(elements, message);\n      if (config.preview !== false) {\n        const existing = elements.urlInput.value?.trim();\n        setPreview(elements, existing || null);\n      }\n    } finally {\n      if (objectURL) URL.revokeObjectURL(objectURL);\n      elements.fileInput.disabled = previousDisabled;\n    }\n  });\n}\n\nexport function initFileUploaders(scope: ParentNode = document): void {\n  const roots = Array.from(scope.querySelectorAll<HTMLElement>('[data-component=\"file_uploader\"], [data-file-uploader]'));\n  roots.forEach((root) => initUploader(root));\n}\n\nfunction onReady(fn: () => void): void {\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', fn, { once: true });\n  } else {\n    fn();\n  }\n}\n\nonReady(() => initFileUploaders());\n\n"],"names":["parseConfig","raw","parsed","formatBytes","bytes","units","size","unitIndex","precision","showError","elements","message","clearError","setStatus","clearStatus","setPreview","src","ensureInlineElement","root","selector","className","existing","el","resolveElements","urlInput","fileInput","errorEl","statusEl","previewImg","placeholder","uploadFile","endpoint","file","formData","response","text","data","initUploader","config","previousDisabled","objectURL","url","err","initFileUploaders","scope","onReady","fn"],"mappings":"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"}