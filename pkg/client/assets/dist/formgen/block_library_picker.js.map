{"version":3,"file":"block_library_picker.js","sources":["../../src/formgen/block_library_picker.ts"],"sourcesContent":["import {\n  initBlockEditor,\n  registerBlockTemplate,\n  refreshBlockTemplateRegistry,\n  markRequiredFields,\n} from './block_editor';\n\n// =============================================================================\n// 5.1  Type Definitions\n// =============================================================================\n\ntype BlockEditorConfig = {\n  sortable?: boolean;\n  addLabel?: string;\n  emptyLabel?: string;\n  allowDrag?: boolean;\n  dragFromHeader?: boolean;\n  enableTouch?: boolean;\n  enableAnimations?: boolean;\n  enableCrossEditor?: boolean;\n  schemaVersionPattern?: string;\n  requiredFields?: Record<string, string[]>;\n  validateOnInput?: boolean;\n  legacyBlocks?: any[];\n  showConflicts?: boolean;\n};\n\nexport type BlockLibraryPickerConfig = BlockEditorConfig & {\n  apiBase?: string;\n  allowedBlocks?: string[];\n  maxBlocks?: number;\n  groupByCategory?: boolean;\n  searchable?: boolean;\n  lazyLoad?: boolean;\n  includeInactive?: boolean;\n};\n\nexport type BlockDefinitionMeta = {\n  slug: string;\n  label: string;\n  icon?: string;\n  category?: string;\n  description?: string;\n  schema_version?: string;\n  required_fields?: string[];\n  status?: string;\n  disabled?: boolean;\n};\n\ntype BlockTemplateResponse = {\n  slug: string;\n  label: string;\n  icon: string;\n  category: string;\n  schema_version: string;\n  status: string;\n  disabled: boolean;\n  required_fields: string[];\n  html: string;\n};\n\n// =============================================================================\n// Utilities\n// =============================================================================\n\nfunction parsePickerConfig(raw: string | null): BlockLibraryPickerConfig {\n  if (!raw) return {};\n  try {\n    const parsed = JSON.parse(raw) as unknown;\n    if (parsed && typeof parsed === 'object') return parsed as BlockLibraryPickerConfig;\n  } catch { /* ignore */ }\n  return {};\n}\n\nfunction parseJSONAttr<T>(value: string | null | undefined, fallback: T): T {\n  if (!value) return fallback;\n  try {\n    return JSON.parse(value) as T;\n  } catch { /* ignore */ }\n  return fallback;\n}\n\nasync function fetchJSON<T>(url: string): Promise<T> {\n  const resp = await fetch(url);\n  if (!resp.ok) throw new Error(`fetch ${url}: ${resp.status}`);\n  return resp.json() as Promise<T>;\n}\n\n// =============================================================================\n// API Layer\n// =============================================================================\n\nasync function fetchBlockMetadata(\n  apiBase: string,\n  includeInactive: boolean,\n): Promise<BlockDefinitionMeta[]> {\n  const params = new URLSearchParams();\n  if (!includeInactive) {\n    params.set('filter_status', 'active');\n  }\n  const qs = params.toString();\n  const url = qs ? `${apiBase}?${qs}` : apiBase;\n\n  const data = await fetchJSON<{ items: any[] }>(url);\n  if (!Array.isArray(data.items)) return [];\n\n  return data.items.map((item: any) => {\n    const status = typeof item.status === 'string' ? item.status.trim() : '';\n    return {\n      slug: item.slug ?? '',\n      label: item.name ?? item.label ?? item.slug ?? '',\n      icon: item.icon,\n      category: item.category,\n      description: item.description,\n      schema_version: item.schema_version,\n      required_fields: item.required_fields,\n      status: item.status,\n      disabled: status.toLowerCase() !== 'active',\n    };\n  });\n}\n\nasync function fetchBatchTemplates(\n  apiBase: string,\n  slugs: string[],\n  includeInactive: boolean,\n): Promise<BlockTemplateResponse[]> {\n  if (slugs.length === 0) return [];\n  let url = `${apiBase}/templates?slugs=${encodeURIComponent(slugs.join(','))}`;\n  if (includeInactive) url += '&include_inactive=true';\n  const data = await fetchJSON<{ items: BlockTemplateResponse[] }>(url);\n  return data.items ?? [];\n}\n\nasync function fetchSingleTemplate(\n  apiBase: string,\n  slug: string,\n  includeInactive: boolean,\n): Promise<BlockTemplateResponse | null> {\n  let url = `${apiBase}/${encodeURIComponent(slug)}/template`;\n  if (includeInactive) url += '?include_inactive=true';\n  try {\n    const data = await fetchJSON<{ items: BlockTemplateResponse[] }>(url);\n    return data.items?.[0] ?? null;\n  } catch {\n    return null;\n  }\n}\n\n// =============================================================================\n// Template Registration Helper\n// =============================================================================\n\nfunction registerFromResponse(root: HTMLElement, tmpl: BlockTemplateResponse): void {\n  registerBlockTemplate(root, {\n    type: tmpl.slug,\n    label: tmpl.label,\n    icon: tmpl.icon || undefined,\n    schemaVersion: tmpl.schema_version || undefined,\n    requiredFields: tmpl.required_fields ?? [],\n    html: tmpl.html,\n  });\n  refreshBlockTemplateRegistry(root);\n}\n\n// =============================================================================\n// Block Item DOM Creation (for lazy-loaded templates)\n// =============================================================================\n\nfunction resolveTemplateSchemaVersion(tmpl: BlockTemplateResponse, pattern?: string): string {\n  const raw = typeof tmpl.schema_version === 'string' ? tmpl.schema_version.trim() : '';\n  if (raw) return raw;\n  if (pattern) return pattern.replace('{type}', tmpl.slug);\n  return `${tmpl.slug}@v1.0.0`;\n}\n\nfunction createBlockItemDOM(\n  tmpl: BlockTemplateResponse,\n  sortable: boolean,\n  schemaVersionPattern?: string,\n): HTMLElement {\n  const wrapper = document.createElement('div');\n  wrapper.className = 'border border-gray-200 rounded-lg bg-white shadow-sm dark:bg-slate-900 dark:border-gray-700';\n  wrapper.setAttribute('data-block-item', 'true');\n  wrapper.dataset.blockType = tmpl.slug;\n  if (sortable) wrapper.setAttribute('draggable', 'true');\n\n  // Header\n  const header = document.createElement('div');\n  header.className = 'flex flex-wrap items-center justify-between gap-2 p-3 border-b border-gray-200 dark:border-gray-700';\n  header.setAttribute('data-block-header', 'true');\n\n  const titleWrap = document.createElement('div');\n  titleWrap.className = 'flex items-center gap-2 text-sm font-medium text-gray-900 dark:text-white';\n\n  const icon = document.createElement('span');\n  icon.className = 'inline-flex items-center justify-center h-6 min-w-[1.5rem] px-2 text-xs font-semibold uppercase rounded-full bg-gray-100 text-gray-700 dark:bg-slate-800 dark:text-slate-200';\n  icon.textContent = tmpl.icon || tmpl.label.slice(0, 1).toUpperCase();\n\n  const label = document.createElement('span');\n  label.textContent = tmpl.label;\n\n  const typeBadge = document.createElement('span');\n  typeBadge.className = 'text-xs text-gray-500 dark:text-gray-400';\n  typeBadge.textContent = tmpl.slug;\n\n  // Schema version badge (Phase 7.1)\n  const schemaVersion = resolveTemplateSchemaVersion(tmpl, schemaVersionPattern);\n  const schemaBadge = document.createElement('span');\n  schemaBadge.className = 'block-schema-badge inline-flex items-center text-xs font-mono text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded dark:bg-blue-900/20 dark:text-blue-400';\n  schemaBadge.textContent = schemaVersion;\n  schemaBadge.setAttribute('data-block-schema-badge', 'true');\n\n  titleWrap.appendChild(icon);\n  titleWrap.appendChild(label);\n  titleWrap.appendChild(typeBadge);\n  titleWrap.appendChild(schemaBadge);\n\n  const actions = document.createElement('div');\n  actions.className = 'flex items-center gap-2';\n\n  if (sortable) {\n    const moveUp = document.createElement('button');\n    moveUp.type = 'button';\n    moveUp.className = 'text-xs text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white';\n    moveUp.textContent = 'Up';\n    moveUp.setAttribute('data-block-move-up', 'true');\n    actions.appendChild(moveUp);\n\n    const moveDown = document.createElement('button');\n    moveDown.type = 'button';\n    moveDown.className = 'text-xs text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white';\n    moveDown.textContent = 'Down';\n    moveDown.setAttribute('data-block-move-down', 'true');\n    actions.appendChild(moveDown);\n  }\n\n  const collapseBtn = document.createElement('button');\n  collapseBtn.type = 'button';\n  collapseBtn.className = 'text-xs text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white';\n  collapseBtn.textContent = 'Collapse';\n  collapseBtn.setAttribute('data-block-collapse', 'true');\n  actions.appendChild(collapseBtn);\n\n  const removeBtn = document.createElement('button');\n  removeBtn.type = 'button';\n  removeBtn.className = 'text-xs text-red-600 hover:text-red-700';\n  removeBtn.textContent = 'Remove';\n  removeBtn.setAttribute('data-block-remove', 'true');\n  actions.appendChild(removeBtn);\n\n  if (sortable) {\n    const dragHandle = document.createElement('span');\n    dragHandle.className = 'text-xs text-gray-400 cursor-move';\n    dragHandle.textContent = 'Drag';\n    dragHandle.setAttribute('data-block-drag-handle', 'true');\n    actions.appendChild(dragHandle);\n  }\n\n  header.appendChild(titleWrap);\n  header.appendChild(actions);\n\n  // Body\n  const body = document.createElement('div');\n  body.className = 'p-4 space-y-4';\n  body.setAttribute('data-block-body', 'true');\n  body.innerHTML = tmpl.html;\n\n  // Mark required fields with visual indicators (Phase 7.2)\n  const requiredFields = tmpl.required_fields || [];\n  if (requiredFields.length > 0) {\n    markRequiredFields(body, requiredFields);\n  }\n\n  wrapper.appendChild(header);\n  wrapper.appendChild(body);\n\n  // Hidden _type field\n  const typeInput = document.createElement('input');\n  typeInput.type = 'hidden';\n  typeInput.name = '_type';\n  typeInput.value = tmpl.slug;\n  typeInput.readOnly = true;\n  typeInput.setAttribute('data-block-type-input', 'true');\n  typeInput.setAttribute('data-block-ignore', 'true');\n  wrapper.appendChild(typeInput);\n\n  // Hidden _schema field\n  wrapper.dataset.blockSchema = schemaVersion;\n  const schemaInput = document.createElement('input');\n  schemaInput.type = 'hidden';\n  schemaInput.name = '_schema';\n  schemaInput.value = schemaVersion;\n  schemaInput.setAttribute('data-block-schema-input', 'true');\n  schemaInput.setAttribute('data-block-ignore', 'true');\n  wrapper.appendChild(schemaInput);\n\n  return wrapper;\n}\n\n// =============================================================================\n// 6.1–6.7  Picker Popover\n// =============================================================================\n\ntype PopoverCallbacks = {\n  onSelect: (slug: string) => void;\n  onClose: () => void;\n};\n\ntype PopoverAPI = {\n  element: HTMLElement;\n  open: () => void;\n  close: () => void;\n  isOpen: () => boolean;\n  updateCards: (defs: BlockDefinitionMeta[], disabledSlugs?: Set<string>) => void;\n};\n\nfunction renderPickerPopover(\n  initialDefs: BlockDefinitionMeta[],\n  config: BlockLibraryPickerConfig,\n  callbacks: PopoverCallbacks,\n): PopoverAPI {\n  const searchable = config.searchable !== false;\n  const groupByCategory = config.groupByCategory !== false;\n\n  // ---- Popover root (6.1, 6.5) ----\n  const popover = document.createElement('div');\n  popover.className =\n    'absolute left-0 z-50 mt-1 w-80 rounded-lg border border-gray-200 ' +\n    'bg-white shadow-xl overflow-hidden picker-popover ' +\n    'dark:bg-slate-900 dark:border-gray-700';\n  popover.style.display = 'none';\n  popover.setAttribute('data-picker-popover', 'true');\n  popover.setAttribute('data-picker-dropdown', 'true');\n  popover.setAttribute('role', 'dialog');\n  popover.setAttribute('aria-label', 'Add block');\n\n  // ---- Search header (6.1, 6.2) ----\n  let searchInput: HTMLInputElement | null = null;\n\n  if (searchable) {\n    const searchWrap = document.createElement('div');\n    searchWrap.className =\n      'sticky top-0 bg-white dark:bg-slate-900 border-b border-gray-100 ' +\n      'dark:border-gray-700 p-2 z-10';\n\n    const searchInner = document.createElement('div');\n    searchInner.className = 'relative';\n\n    const searchIcon = document.createElement('svg');\n    searchIcon.className =\n      'absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none';\n    searchIcon.setAttribute('fill', 'none');\n    searchIcon.setAttribute('stroke', 'currentColor');\n    searchIcon.setAttribute('viewBox', '0 0 24 24');\n    searchIcon.innerHTML =\n      '<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" ' +\n      'd=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\"></path>';\n\n    searchInput = document.createElement('input');\n    searchInput.type = 'text';\n    searchInput.placeholder = 'Search blocks\\u2026';\n    searchInput.className =\n      'w-full pl-8 pr-3 py-1.5 text-sm rounded-md border border-gray-200 ' +\n      'bg-gray-50 placeholder-gray-400 focus:outline-none focus:ring-2 ' +\n      'focus:ring-blue-500 focus:border-transparent ' +\n      'dark:bg-slate-800 dark:border-gray-600 dark:text-white dark:placeholder-gray-500';\n    searchInput.setAttribute('data-picker-search', 'true');\n    searchInput.setAttribute('autocomplete', 'off');\n\n    searchInner.appendChild(searchIcon);\n    searchInner.appendChild(searchInput);\n    searchWrap.appendChild(searchInner);\n    popover.appendChild(searchWrap);\n  }\n\n  // ---- Cards container ----\n  const cardsContainer = document.createElement('div');\n  cardsContainer.className = 'max-h-72 overflow-y-auto py-1';\n  cardsContainer.setAttribute('data-picker-cards', 'true');\n  cardsContainer.setAttribute('role', 'listbox');\n  popover.appendChild(cardsContainer);\n\n  // ---- Empty state (6.1) ----\n  const emptyState = document.createElement('div');\n  emptyState.className = 'px-4 py-8 text-center text-sm text-gray-500 dark:text-gray-400';\n  emptyState.setAttribute('data-picker-empty', 'true');\n  emptyState.style.display = 'none';\n\n  const emptyIcon = document.createElement('svg');\n  emptyIcon.className = 'mx-auto mb-2 w-8 h-8 text-gray-300 dark:text-gray-600';\n  emptyIcon.setAttribute('fill', 'none');\n  emptyIcon.setAttribute('stroke', 'currentColor');\n  emptyIcon.setAttribute('viewBox', '0 0 24 24');\n  emptyIcon.innerHTML =\n    '<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"1.5\" ' +\n    'd=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\"></path>';\n\n  const emptyText = document.createElement('p');\n  emptyText.setAttribute('data-picker-empty-text', 'true');\n  emptyText.textContent = 'No block types available';\n\n  emptyState.appendChild(emptyIcon);\n  emptyState.appendChild(emptyText);\n  popover.appendChild(emptyState);\n\n  // ---- State ----\n  let isOpenFlag = false;\n  let focusedIndex = -1;\n  let visibleCards: HTMLButtonElement[] = [];\n  let currentDefs = [...initialDefs];\n  let currentDisabledSlugs = new Set<string>();\n\n  // ---- Card creation (6.1, 6.5, 6.7) ----\n  function createCard(def: BlockDefinitionMeta, isTypeDisabled: boolean): HTMLButtonElement {\n    const disabled = isTypeDisabled || !!def.disabled;\n\n    const card = document.createElement('button');\n    card.type = 'button';\n    card.setAttribute('data-picker-item', def.slug);\n    card.setAttribute('data-picker-card', def.slug);\n    card.setAttribute('role', 'option');\n    card.setAttribute('aria-selected', 'false');\n    if (def.category) card.dataset.category = def.category;\n\n    card.className =\n      'w-full flex items-center gap-3 px-3 py-2.5 text-left text-sm transition-colors ' +\n      (disabled\n        ? 'opacity-50 cursor-not-allowed'\n        : 'hover:bg-gray-50 dark:hover:bg-slate-800 focus:outline-none');\n\n    if (disabled) {\n      card.disabled = true;\n      card.setAttribute('aria-disabled', 'true');\n      card.title =\n        def.status && def.status.toLowerCase() !== 'active'\n          ? 'This block type is inactive'\n          : 'This block type is not available';\n    }\n\n    // Icon badge\n    const iconEl = document.createElement('span');\n    iconEl.className =\n      'inline-flex items-center justify-center h-9 w-9 shrink-0 rounded-lg text-xs font-semibold ' +\n      (disabled\n        ? 'bg-gray-100 text-gray-400 dark:bg-slate-800 dark:text-gray-500'\n        : 'bg-blue-50 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400');\n    iconEl.textContent = def.icon || def.label.slice(0, 2).toUpperCase();\n\n    // Text content\n    const textEl = document.createElement('div');\n    textEl.className = 'flex-1 min-w-0';\n\n    const labelEl = document.createElement('div');\n    labelEl.className =\n      'font-medium truncate ' +\n      (disabled\n        ? 'text-gray-400 dark:text-gray-500'\n        : 'text-gray-900 dark:text-white');\n    labelEl.textContent = def.label;\n\n    const metaEl = document.createElement('div');\n    metaEl.className = 'text-xs text-gray-500 dark:text-gray-400 truncate';\n    const parts: string[] = [def.description || def.slug];\n    if (def.status && def.status.toLowerCase() !== 'active') {\n      parts.push(`(${def.status})`);\n    }\n    metaEl.textContent = parts.join(' ');\n\n    textEl.appendChild(labelEl);\n    textEl.appendChild(metaEl);\n    card.appendChild(iconEl);\n    card.appendChild(textEl);\n\n    return card;\n  }\n\n  // ---- Render cards (6.1, 6.2) ----\n  function renderCards(filter: string = ''): void {\n    cardsContainer.innerHTML = '';\n    visibleCards = [];\n    focusedIndex = -1;\n\n    const query = filter.toLowerCase().trim();\n\n    const filtered = query\n      ? currentDefs.filter(\n          (d) =>\n            d.label.toLowerCase().includes(query) ||\n            d.slug.toLowerCase().includes(query) ||\n            (d.category || '').toLowerCase().includes(query) ||\n            (d.description || '').toLowerCase().includes(query),\n        )\n      : currentDefs;\n\n    if (filtered.length === 0) {\n      emptyState.style.display = '';\n      const txt = emptyState.querySelector('[data-picker-empty-text]');\n      if (txt) {\n        txt.textContent = query ? 'No blocks match your search' : 'No block types available';\n      }\n      return;\n    }\n\n    emptyState.style.display = 'none';\n\n    if (groupByCategory) {\n      const groups = new Map<string, BlockDefinitionMeta[]>();\n      for (const def of filtered) {\n        const cat = def.category || 'other';\n        if (!groups.has(cat)) groups.set(cat, []);\n        groups.get(cat)!.push(def);\n      }\n\n      for (const [category, items] of groups) {\n        const header = document.createElement('div');\n        header.className =\n          'px-3 py-1.5 text-xs font-semibold text-gray-400 uppercase tracking-wider ' +\n          'sticky top-0 bg-white dark:bg-slate-900';\n        header.setAttribute('data-picker-category', category);\n        header.setAttribute('role', 'presentation');\n        header.textContent = category;\n        cardsContainer.appendChild(header);\n\n        for (const def of items) {\n          const card = createCard(def, currentDisabledSlugs.has(def.slug));\n          cardsContainer.appendChild(card);\n          if (!card.disabled) visibleCards.push(card);\n        }\n      }\n    } else {\n      for (const def of filtered) {\n        const card = createCard(def, currentDisabledSlugs.has(def.slug));\n        cardsContainer.appendChild(card);\n        if (!card.disabled) visibleCards.push(card);\n      }\n    }\n  }\n\n  renderCards();\n\n  // ---- Focus management (6.3) ----\n  function setFocusedCard(index: number): void {\n    if (focusedIndex >= 0 && focusedIndex < visibleCards.length) {\n      const prev = visibleCards[focusedIndex];\n      prev.classList.remove('bg-blue-50', 'dark:bg-blue-900/20');\n      prev.setAttribute('aria-selected', 'false');\n    }\n\n    focusedIndex = index;\n\n    if (focusedIndex >= 0 && focusedIndex < visibleCards.length) {\n      const card = visibleCards[focusedIndex];\n      card.classList.add('bg-blue-50', 'dark:bg-blue-900/20');\n      card.setAttribute('aria-selected', 'true');\n      if (typeof card.scrollIntoView === 'function') {\n        card.scrollIntoView({ block: 'nearest' });\n      }\n    }\n  }\n\n  // ---- Search input handler (6.2) ----\n  if (searchInput) {\n    searchInput.addEventListener('input', () => {\n      renderCards(searchInput!.value);\n    });\n  }\n\n  // ---- Keyboard navigation (6.3) ----\n  function handleKeydown(e: KeyboardEvent): void {\n    switch (e.key) {\n      case 'ArrowDown':\n        e.preventDefault();\n        if (visibleCards.length > 0) {\n          setFocusedCard(focusedIndex < visibleCards.length - 1 ? focusedIndex + 1 : 0);\n        }\n        break;\n\n      case 'ArrowUp':\n        e.preventDefault();\n        if (visibleCards.length > 0) {\n          setFocusedCard(focusedIndex <= 0 ? visibleCards.length - 1 : focusedIndex - 1);\n        }\n        break;\n\n      case 'Enter':\n        e.preventDefault();\n        if (focusedIndex >= 0 && focusedIndex < visibleCards.length) {\n          const slug = visibleCards[focusedIndex].getAttribute('data-picker-item');\n          if (slug) callbacks.onSelect(slug);\n        }\n        break;\n\n      case 'Escape':\n        e.preventDefault();\n        callbacks.onClose();\n        break;\n\n      case 'Tab':\n        e.preventDefault();\n        if (searchInput && document.activeElement !== searchInput) {\n          searchInput.focus();\n          focusedIndex = -1;\n        } else if (visibleCards.length > 0) {\n          setFocusedCard(0);\n        }\n        break;\n    }\n  }\n\n  // ---- Card click handler ----\n  cardsContainer.addEventListener('click', (e) => {\n    const target = (e.target as HTMLElement).closest<HTMLButtonElement>('[data-picker-item]');\n    if (!target || target.disabled) return;\n    const slug = target.getAttribute('data-picker-item');\n    if (slug) callbacks.onSelect(slug);\n  });\n\n  // ---- Popover positioning (6.4) ----\n  function positionPopover(): void {\n    popover.style.bottom = '';\n    popover.style.marginBottom = '';\n    popover.style.top = '';\n    popover.style.marginTop = '4px';\n\n    requestAnimationFrame(() => {\n      const rect = popover.getBoundingClientRect();\n      if (rect.bottom > window.innerHeight - 8) {\n        popover.style.bottom = '100%';\n        popover.style.top = 'auto';\n        popover.style.marginBottom = '4px';\n        popover.style.marginTop = '0';\n      }\n    });\n  }\n\n  // ---- Open / Close (6.4) ----\n  function open(): void {\n    popover.style.display = '';\n    isOpenFlag = true;\n    positionPopover();\n\n    if (searchInput) {\n      searchInput.value = '';\n      renderCards('');\n      requestAnimationFrame(() => searchInput!.focus());\n    }\n\n    popover.addEventListener('keydown', handleKeydown);\n  }\n\n  function close(): void {\n    popover.style.display = 'none';\n    isOpenFlag = false;\n    focusedIndex = -1;\n    popover.removeEventListener('keydown', handleKeydown);\n  }\n\n  // ---- Update cards (6.6, 6.7) ----\n  function updateCards(defs: BlockDefinitionMeta[], disabled?: Set<string>): void {\n    currentDefs = defs;\n    if (disabled) currentDisabledSlugs = disabled;\n    renderCards(searchInput?.value || '');\n  }\n\n  return {\n    element: popover,\n    open,\n    close,\n    isOpen: () => isOpenFlag,\n    updateCards,\n  };\n}\n\n// =============================================================================\n// 5.3  Picker Initialization\n// =============================================================================\n\nasync function initPicker(root: HTMLElement): Promise<void> {\n  const configRoot = root.closest<HTMLElement>('[data-component-config]') || root;\n  const config = parsePickerConfig(configRoot.getAttribute('data-component-config'));\n\n  const apiBase = root.dataset.apiBase || config.apiBase || '';\n  if (!apiBase) {\n    console.warn('block-library-picker: missing data-api-base');\n    return;\n  }\n\n  const allowedBlocks = parseJSONAttr<string[]>(root.dataset.allowedBlocks, config.allowedBlocks ?? []);\n  const maxBlocks = parseInt(root.dataset.maxBlocks || '', 10) || config.maxBlocks || 0;\n  const lazyLoad = config.lazyLoad !== false;\n  const includeInactive = config.includeInactive === true;\n  const sortable = config.sortable ?? (root.dataset.blockSortable === 'true');\n\n  const registeredSlugs = new Set<string>();\n  const templateCache = new Map<string, BlockTemplateResponse>();\n\n  // -- 5.3.1: Fetch block definition metadata --\n  let definitions: BlockDefinitionMeta[];\n  try {\n    definitions = await fetchBlockMetadata(apiBase, includeInactive);\n  } catch (err) {\n    console.error('block-library-picker: metadata fetch failed', err);\n    return;\n  }\n\n  // Filter by allowedBlocks\n  if (allowedBlocks.length > 0) {\n    const allowed = new Set(allowedBlocks.map((s) => s.toLowerCase()));\n    definitions = definitions.filter((d) => allowed.has(d.slug.toLowerCase()));\n  }\n\n  // -- 5.3.2: Parse existing blocks from hidden input --\n  const output = root.querySelector<HTMLInputElement>('input[data-block-output]');\n  let existingBlocks: any[] = [];\n  if (output?.value) {\n    try {\n      const parsed = JSON.parse(output.value);\n      if (Array.isArray(parsed)) existingBlocks = parsed;\n    } catch { /* ignore */ }\n  }\n\n  // -- 5.3.3: Collect unique slugs from existing blocks --\n  const existingSlugs = [\n    ...new Set(\n      existingBlocks\n        .map((b) => (b && typeof b === 'object' ? (b._type as string) : ''))\n        .filter((t): t is string => typeof t === 'string' && t.length > 0),\n    ),\n  ];\n\n  // -- 5.3.4: Fetch templates for existing block slugs --\n  if (existingSlugs.length > 0) {\n    try {\n      const templates = await fetchBatchTemplates(apiBase, existingSlugs, includeInactive);\n      for (const tmpl of templates) {\n        registerFromResponse(root, tmpl);\n        registeredSlugs.add(tmpl.slug);\n        templateCache.set(tmpl.slug, tmpl);\n      }\n    } catch (err) {\n      console.error('block-library-picker: template fetch failed', err);\n    }\n  }\n\n  // -- 5.5 (lazyLoad=false): Prefetch all remaining templates --\n  if (!lazyLoad) {\n    const missing = definitions\n      .filter((d) => !registeredSlugs.has(d.slug))\n      .map((d) => d.slug);\n    if (missing.length > 0) {\n      try {\n        const templates = await fetchBatchTemplates(apiBase, missing, includeInactive);\n        for (const tmpl of templates) {\n          registerFromResponse(root, tmpl);\n          registeredSlugs.add(tmpl.slug);\n          templateCache.set(tmpl.slug, tmpl);\n        }\n      } catch (err) {\n        console.error('block-library-picker: prefetch failed', err);\n      }\n    }\n  }\n\n  // -- 5.3.6: Initialize the underlying block editor --\n  initBlockEditor(root);\n\n  // =========================================================================\n  // 5.4  Picker UI — replaces hidden <select> with \"+ Add Block\" button\n  // =========================================================================\n\n  const addSelect = root.querySelector<HTMLSelectElement>('[data-block-add-select]');\n  const addButton = root.querySelector<HTMLButtonElement>('[data-block-add]');\n\n  // The template already hides the select/button wrapper (style=\"display:none\").\n\n  // Picker controls container\n  const pickerControls = document.createElement('div');\n  pickerControls.className = 'mt-3';\n  pickerControls.setAttribute('data-picker-controls', 'true');\n\n  const pickerWrapper = document.createElement('div');\n  pickerWrapper.className = 'relative inline-block';\n\n  // Add Block button\n  const addBtn = document.createElement('button');\n  addBtn.type = 'button';\n  addBtn.className =\n    'inline-flex items-center gap-1.5 py-2 px-4 rounded-md border border-dashed ' +\n    'border-gray-300 text-sm font-medium text-gray-600 hover:border-gray-400 ' +\n    'hover:text-gray-700 hover:bg-gray-50 transition-colors dark:border-gray-600 ' +\n    'dark:text-gray-400 dark:hover:border-gray-500 dark:hover:text-gray-300 ' +\n    'dark:hover:bg-slate-800';\n  addBtn.setAttribute('data-picker-add-btn', 'true');\n  addBtn.innerHTML =\n    '<svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">' +\n    '<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 4v16m8-8H4\"></path>' +\n    '</svg>' +\n    `<span>${config.addLabel || 'Add Block'}</span>`;\n\n  // =========================================================================\n  // Phase 6: Picker Popover UI\n  // =========================================================================\n\n  // -- MaxBlocks enforcement --\n  const checkMaxBlocks = (): void => {\n    if (maxBlocks <= 0) return;\n    const count = root.querySelectorAll('[data-block-item]').length;\n    const atMax = count >= maxBlocks;\n    addBtn.disabled = atMax;\n    addBtn.classList.toggle('opacity-50', atMax);\n    addBtn.classList.toggle('cursor-not-allowed', atMax);\n    addBtn.title = atMax ? `Maximum of ${maxBlocks} blocks reached` : '';\n  };\n\n  // -- Create popover (6.1–6.7) --\n  const pickerPopover = renderPickerPopover(definitions, config, {\n    onSelect: (slug) => handleBlockSelection(slug),\n    onClose: () => {\n      pickerPopover.close();\n      addBtn.focus();\n    },\n  });\n\n  // -- Block selection handler (5.5, updated for popover) --\n  async function handleBlockSelection(slug: string): Promise<void> {\n    const def = definitions.find((d) => d.slug === slug);\n    if (!def || def.disabled) return;\n\n    // Check maxBlocks\n    if (maxBlocks > 0) {\n      const count = root.querySelectorAll('[data-block-item]').length;\n      if (count >= maxBlocks) {\n        pickerPopover.close();\n        return;\n      }\n    }\n\n    // Check if block editor already knows this template (option exists in select)\n    const editorKnows =\n      addSelect instanceof HTMLSelectElement &&\n      Array.from(addSelect.options).some((o) => o.value === slug);\n\n    if (editorKnows) {\n      // Use the block editor's built-in add mechanism\n      addSelect!.value = slug;\n      addButton?.click();\n    } else {\n      // Lazy load: fetch template if not cached\n      let tmplResp = templateCache.get(slug);\n      if (!tmplResp) {\n        try {\n          const fetched = await fetchSingleTemplate(apiBase, slug, includeInactive);\n          if (fetched) {\n            tmplResp = fetched;\n            registerFromResponse(root, tmplResp);\n            registeredSlugs.add(tmplResp.slug);\n            templateCache.set(tmplResp.slug, tmplResp);\n          }\n        } catch (err) {\n          console.error(`block-library-picker: fetch template ${slug} failed`, err);\n          pickerPopover.close();\n          return;\n        }\n      }\n\n      if (!tmplResp) {\n        pickerPopover.close();\n        return;\n      }\n\n      // Create block item directly and append to the list\n      const blockList = root.querySelector<HTMLElement>('[data-block-list]');\n      if (blockList) {\n        const item = createBlockItemDOM(tmplResp, sortable, config.schemaVersionPattern);\n        blockList.appendChild(item);\n        // Trigger the block editor's sync by dispatching an input event\n        item.dispatchEvent(new Event('input', { bubbles: true }));\n      }\n    }\n\n    pickerPopover.close();\n    checkMaxBlocks();\n  }\n\n  // -- Toggle popover from add button --\n  addBtn.addEventListener('click', (e) => {\n    e.stopPropagation();\n    if (addBtn.disabled) return;\n    if (pickerPopover.isOpen()) {\n      pickerPopover.close();\n    } else {\n      pickerPopover.open();\n    }\n  });\n\n  // -- Open popover on ArrowDown from add button --\n  addBtn.addEventListener('keydown', (e) => {\n    if (e.key === 'ArrowDown' && !pickerPopover.isOpen() && !addBtn.disabled) {\n      e.preventDefault();\n      pickerPopover.open();\n    }\n  });\n\n  // -- Close on outside click (6.4) --\n  document.addEventListener('click', (e) => {\n    if (pickerPopover.isOpen() && !pickerWrapper.contains(e.target as Node)) {\n      pickerPopover.close();\n    }\n  });\n\n  // -- Close on Escape (document-level fallback) --\n  document.addEventListener('keydown', (e) => {\n    if (e.key === 'Escape' && pickerPopover.isOpen()) {\n      pickerPopover.close();\n      addBtn.focus();\n    }\n  });\n\n  // -- Observe block list for maxBlocks updates --\n  if (maxBlocks > 0) {\n    const blockList = root.querySelector('[data-block-list]');\n    if (blockList) {\n      new MutationObserver(() => checkMaxBlocks()).observe(blockList, { childList: true });\n    }\n    checkMaxBlocks();\n  }\n\n  // -- Mount picker controls into the DOM --\n  pickerWrapper.appendChild(addBtn);\n  pickerWrapper.appendChild(pickerPopover.element);\n  pickerControls.appendChild(pickerWrapper);\n\n  const blockList = root.querySelector('[data-block-list]');\n  if (blockList && blockList.nextSibling) {\n    blockList.parentElement?.insertBefore(pickerControls, blockList.nextSibling);\n  } else {\n    root.appendChild(pickerControls);\n  }\n\n  root.setAttribute('data-picker-initialized', 'true');\n}\n\n// =============================================================================\n// 5.2  Public init — find all pickers and initialize them\n// =============================================================================\n\nexport async function initBlockLibraryPickers(scope: ParentNode = document): Promise<void> {\n  const roots = Array.from(\n    scope.querySelectorAll<HTMLElement>('[data-block-library-picker=\"true\"]'),\n  );\n  const tasks = roots\n    .filter((root) => root.getAttribute('data-picker-initialized') !== 'true')\n    .map((root) => initPicker(root));\n  await Promise.all(tasks);\n}\n\n// =============================================================================\n// 5.6  DOMContentLoaded auto-initialization\n// =============================================================================\n\nfunction onReady(fn: () => void): void {\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', fn, { once: true });\n  } else {\n    fn();\n  }\n}\n\nonReady(() => {\n  initBlockLibraryPickers();\n});\n"],"names":["parsePickerConfig","raw","parsed","parseJSONAttr","value","fallback","fetchJSON","url","resp","fetchBlockMetadata","apiBase","includeInactive","params","qs","data","item","status","fetchBatchTemplates","slugs","fetchSingleTemplate","slug","registerFromResponse","root","tmpl","registerBlockTemplate","refreshBlockTemplateRegistry","resolveTemplateSchemaVersion","pattern","createBlockItemDOM","sortable","schemaVersionPattern","wrapper","header","titleWrap","icon","label","typeBadge","schemaVersion","schemaBadge","actions","moveUp","moveDown","collapseBtn","removeBtn","dragHandle","body","requiredFields","markRequiredFields","typeInput","schemaInput","renderPickerPopover","initialDefs","config","callbacks","searchable","groupByCategory","popover","searchInput","searchWrap","searchInner","searchIcon","cardsContainer","emptyState","emptyIcon","emptyText","isOpenFlag","focusedIndex","visibleCards","currentDefs","currentDisabledSlugs","createCard","def","isTypeDisabled","disabled","card","iconEl","textEl","labelEl","metaEl","parts","renderCards","filter","query","filtered","d","txt","groups","cat","category","items","setFocusedCard","index","prev","handleKeydown","target","positionPopover","open","close","updateCards","defs","initPicker","configRoot","allowedBlocks","maxBlocks","lazyLoad","registeredSlugs","templateCache","definitions","err","allowed","s","output","existingBlocks","existingSlugs","b","t","templates","missing","initBlockEditor","addSelect","addButton","pickerControls","pickerWrapper","addBtn","checkMaxBlocks","atMax","pickerPopover","handleBlockSelection","o","tmplResp","fetched","blockList","initBlockLibraryPickers","scope","tasks","onReady","fn"],"mappings":";AAiEA,SAASA,EAAkBC,GAA8C;AACvE,MAAI,CAACA,EAAK,QAAO,CAAA;AACjB,MAAI;AACF,UAAMC,IAAS,KAAK,MAAMD,CAAG;AAC7B,QAAIC,KAAU,OAAOA,KAAW,SAAU,QAAOA;AAAA,EACnD,QAAQ;AAAA,EAAe;AACvB,SAAO,CAAA;AACT;AAEA,SAASC,EAAiBC,GAAkCC,GAAgB;AAC1E,MAAI,CAACD,EAAO,QAAOC;AACnB,MAAI;AACF,WAAO,KAAK,MAAMD,CAAK;AAAA,EACzB,QAAQ;AAAA,EAAe;AACvB,SAAOC;AACT;AAEA,eAAeC,EAAaC,GAAyB;AACnD,QAAMC,IAAO,MAAM,MAAMD,CAAG;AAC5B,MAAI,CAACC,EAAK,GAAI,OAAM,IAAI,MAAM,SAASD,CAAG,KAAKC,EAAK,MAAM,EAAE;AAC5D,SAAOA,EAAK,KAAA;AACd;AAMA,eAAeC,EACbC,GACAC,GACgC;AAChC,QAAMC,IAAS,IAAI,gBAAA;AACnB,EAAKD,KACHC,EAAO,IAAI,iBAAiB,QAAQ;AAEtC,QAAMC,IAAKD,EAAO,SAAA,GACZL,IAAMM,IAAK,GAAGH,CAAO,IAAIG,CAAE,KAAKH,GAEhCI,IAAO,MAAMR,EAA4BC,CAAG;AAClD,SAAK,MAAM,QAAQO,EAAK,KAAK,IAEtBA,EAAK,MAAM,IAAI,CAACC,MAAc;AACnC,UAAMC,IAAS,OAAOD,EAAK,UAAW,WAAWA,EAAK,OAAO,SAAS;AACtE,WAAO;AAAA,MACL,MAAMA,EAAK,QAAQ;AAAA,MACnB,OAAOA,EAAK,QAAQA,EAAK,SAASA,EAAK,QAAQ;AAAA,MAC/C,MAAMA,EAAK;AAAA,MACX,UAAUA,EAAK;AAAA,MACf,aAAaA,EAAK;AAAA,MAClB,gBAAgBA,EAAK;AAAA,MACrB,iBAAiBA,EAAK;AAAA,MACtB,QAAQA,EAAK;AAAA,MACb,UAAUC,EAAO,kBAAkB;AAAA,IAAA;AAAA,EAEvC,CAAC,IAfsC,CAAA;AAgBzC;AAEA,eAAeC,EACbP,GACAQ,GACAP,GACkC;AAClC,MAAIO,EAAM,WAAW,EAAG,QAAO,CAAA;AAC/B,MAAIX,IAAM,GAAGG,CAAO,oBAAoB,mBAAmBQ,EAAM,KAAK,GAAG,CAAC,CAAC;AAC3E,SAAIP,MAAiBJ,KAAO,4BACf,MAAMD,EAA8CC,CAAG,GACxD,SAAS,CAAA;AACvB;AAEA,eAAeY,EACbT,GACAU,GACAT,GACuC;AACvC,MAAIJ,IAAM,GAAGG,CAAO,IAAI,mBAAmBU,CAAI,CAAC;AAChD,EAAIT,MAAiBJ,KAAO;AAC5B,MAAI;AAEF,YADa,MAAMD,EAA8CC,CAAG,GACxD,QAAQ,CAAC,KAAK;AAAA,EAC5B,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAMA,SAASc,EAAqBC,GAAmBC,GAAmC;AAClF,EAAAC,EAAsBF,GAAM;AAAA,IAC1B,MAAMC,EAAK;AAAA,IACX,OAAOA,EAAK;AAAA,IACZ,MAAMA,EAAK,QAAQ;AAAA,IACnB,eAAeA,EAAK,kBAAkB;AAAA,IACtC,gBAAgBA,EAAK,mBAAmB,CAAA;AAAA,IACxC,MAAMA,EAAK;AAAA,EAAA,CACZ,GACDE,EAA6BH,CAAI;AACnC;AAMA,SAASI,EAA6BH,GAA6BI,GAA0B;AAC3F,QAAM1B,IAAM,OAAOsB,EAAK,kBAAmB,WAAWA,EAAK,eAAe,SAAS;AACnF,SAAItB,MACA0B,IAAgBA,EAAQ,QAAQ,UAAUJ,EAAK,IAAI,IAChD,GAAGA,EAAK,IAAI;AACrB;AAEA,SAASK,EACPL,GACAM,GACAC,GACa;AACb,QAAMC,IAAU,SAAS,cAAc,KAAK;AAC5C,EAAAA,EAAQ,YAAY,+FACpBA,EAAQ,aAAa,mBAAmB,MAAM,GAC9CA,EAAQ,QAAQ,YAAYR,EAAK,MAC7BM,KAAUE,EAAQ,aAAa,aAAa,MAAM;AAGtD,QAAMC,IAAS,SAAS,cAAc,KAAK;AAC3C,EAAAA,EAAO,YAAY,uGACnBA,EAAO,aAAa,qBAAqB,MAAM;AAE/C,QAAMC,IAAY,SAAS,cAAc,KAAK;AAC9C,EAAAA,EAAU,YAAY;AAEtB,QAAMC,IAAO,SAAS,cAAc,MAAM;AAC1C,EAAAA,EAAK,YAAY,gLACjBA,EAAK,cAAcX,EAAK,QAAQA,EAAK,MAAM,MAAM,GAAG,CAAC,EAAE,YAAA;AAEvD,QAAMY,IAAQ,SAAS,cAAc,MAAM;AAC3C,EAAAA,EAAM,cAAcZ,EAAK;AAEzB,QAAMa,IAAY,SAAS,cAAc,MAAM;AAC/C,EAAAA,EAAU,YAAY,4CACtBA,EAAU,cAAcb,EAAK;AAG7B,QAAMc,IAAgBX,EAA6BH,GAAMO,CAAoB,GACvEQ,IAAc,SAAS,cAAc,MAAM;AACjD,EAAAA,EAAY,YAAY,uJACxBA,EAAY,cAAcD,GAC1BC,EAAY,aAAa,2BAA2B,MAAM,GAE1DL,EAAU,YAAYC,CAAI,GAC1BD,EAAU,YAAYE,CAAK,GAC3BF,EAAU,YAAYG,CAAS,GAC/BH,EAAU,YAAYK,CAAW;AAEjC,QAAMC,IAAU,SAAS,cAAc,KAAK;AAG5C,MAFAA,EAAQ,YAAY,2BAEhBV,GAAU;AACZ,UAAMW,IAAS,SAAS,cAAc,QAAQ;AAC9C,IAAAA,EAAO,OAAO,UACdA,EAAO,YAAY,sFACnBA,EAAO,cAAc,MACrBA,EAAO,aAAa,sBAAsB,MAAM,GAChDD,EAAQ,YAAYC,CAAM;AAE1B,UAAMC,IAAW,SAAS,cAAc,QAAQ;AAChD,IAAAA,EAAS,OAAO,UAChBA,EAAS,YAAY,sFACrBA,EAAS,cAAc,QACvBA,EAAS,aAAa,wBAAwB,MAAM,GACpDF,EAAQ,YAAYE,CAAQ;AAAA,EAC9B;AAEA,QAAMC,IAAc,SAAS,cAAc,QAAQ;AACnD,EAAAA,EAAY,OAAO,UACnBA,EAAY,YAAY,sFACxBA,EAAY,cAAc,YAC1BA,EAAY,aAAa,uBAAuB,MAAM,GACtDH,EAAQ,YAAYG,CAAW;AAE/B,QAAMC,IAAY,SAAS,cAAc,QAAQ;AAOjD,MANAA,EAAU,OAAO,UACjBA,EAAU,YAAY,2CACtBA,EAAU,cAAc,UACxBA,EAAU,aAAa,qBAAqB,MAAM,GAClDJ,EAAQ,YAAYI,CAAS,GAEzBd,GAAU;AACZ,UAAMe,IAAa,SAAS,cAAc,MAAM;AAChD,IAAAA,EAAW,YAAY,qCACvBA,EAAW,cAAc,QACzBA,EAAW,aAAa,0BAA0B,MAAM,GACxDL,EAAQ,YAAYK,CAAU;AAAA,EAChC;AAEA,EAAAZ,EAAO,YAAYC,CAAS,GAC5BD,EAAO,YAAYO,CAAO;AAG1B,QAAMM,IAAO,SAAS,cAAc,KAAK;AACzC,EAAAA,EAAK,YAAY,iBACjBA,EAAK,aAAa,mBAAmB,MAAM,GAC3CA,EAAK,YAAYtB,EAAK;AAGtB,QAAMuB,IAAiBvB,EAAK,mBAAmB,CAAA;AAC/C,EAAIuB,EAAe,SAAS,KAC1BC,EAAmBF,GAAMC,CAAc,GAGzCf,EAAQ,YAAYC,CAAM,GAC1BD,EAAQ,YAAYc,CAAI;AAGxB,QAAMG,IAAY,SAAS,cAAc,OAAO;AAChD,EAAAA,EAAU,OAAO,UACjBA,EAAU,OAAO,SACjBA,EAAU,QAAQzB,EAAK,MACvByB,EAAU,WAAW,IACrBA,EAAU,aAAa,yBAAyB,MAAM,GACtDA,EAAU,aAAa,qBAAqB,MAAM,GAClDjB,EAAQ,YAAYiB,CAAS,GAG7BjB,EAAQ,QAAQ,cAAcM;AAC9B,QAAMY,IAAc,SAAS,cAAc,OAAO;AAClD,SAAAA,EAAY,OAAO,UACnBA,EAAY,OAAO,WACnBA,EAAY,QAAQZ,GACpBY,EAAY,aAAa,2BAA2B,MAAM,GAC1DA,EAAY,aAAa,qBAAqB,MAAM,GACpDlB,EAAQ,YAAYkB,CAAW,GAExBlB;AACT;AAmBA,SAASmB,EACPC,GACAC,GACAC,GACY;AACZ,QAAMC,IAAaF,EAAO,eAAe,IACnCG,IAAkBH,EAAO,oBAAoB,IAG7CI,IAAU,SAAS,cAAc,KAAK;AAC5C,EAAAA,EAAQ,YACN,6JAGFA,EAAQ,MAAM,UAAU,QACxBA,EAAQ,aAAa,uBAAuB,MAAM,GAClDA,EAAQ,aAAa,wBAAwB,MAAM,GACnDA,EAAQ,aAAa,QAAQ,QAAQ,GACrCA,EAAQ,aAAa,cAAc,WAAW;AAG9C,MAAIC,IAAuC;AAE3C,MAAIH,GAAY;AACd,UAAMI,IAAa,SAAS,cAAc,KAAK;AAC/C,IAAAA,EAAW,YACT;AAGF,UAAMC,IAAc,SAAS,cAAc,KAAK;AAChD,IAAAA,EAAY,YAAY;AAExB,UAAMC,IAAa,SAAS,cAAc,KAAK;AAC/C,IAAAA,EAAW,YACT,wFACFA,EAAW,aAAa,QAAQ,MAAM,GACtCA,EAAW,aAAa,UAAU,cAAc,GAChDA,EAAW,aAAa,WAAW,WAAW,GAC9CA,EAAW,YACT,iIAGFH,IAAc,SAAS,cAAc,OAAO,GAC5CA,EAAY,OAAO,QACnBA,EAAY,cAAc,kBAC1BA,EAAY,YACV,mQAIFA,EAAY,aAAa,sBAAsB,MAAM,GACrDA,EAAY,aAAa,gBAAgB,KAAK,GAE9CE,EAAY,YAAYC,CAAU,GAClCD,EAAY,YAAYF,CAAW,GACnCC,EAAW,YAAYC,CAAW,GAClCH,EAAQ,YAAYE,CAAU;AAAA,EAChC;AAGA,QAAMG,IAAiB,SAAS,cAAc,KAAK;AACnD,EAAAA,EAAe,YAAY,iCAC3BA,EAAe,aAAa,qBAAqB,MAAM,GACvDA,EAAe,aAAa,QAAQ,SAAS,GAC7CL,EAAQ,YAAYK,CAAc;AAGlC,QAAMC,IAAa,SAAS,cAAc,KAAK;AAC/C,EAAAA,EAAW,YAAY,kEACvBA,EAAW,aAAa,qBAAqB,MAAM,GACnDA,EAAW,MAAM,UAAU;AAE3B,QAAMC,IAAY,SAAS,cAAc,KAAK;AAC9C,EAAAA,EAAU,YAAY,yDACtBA,EAAU,aAAa,QAAQ,MAAM,GACrCA,EAAU,aAAa,UAAU,cAAc,GAC/CA,EAAU,aAAa,WAAW,WAAW,GAC7CA,EAAU,YACR;AAGF,QAAMC,IAAY,SAAS,cAAc,GAAG;AAC5C,EAAAA,EAAU,aAAa,0BAA0B,MAAM,GACvDA,EAAU,cAAc,4BAExBF,EAAW,YAAYC,CAAS,GAChCD,EAAW,YAAYE,CAAS,GAChCR,EAAQ,YAAYM,CAAU;AAG9B,MAAIG,IAAa,IACbC,IAAe,IACfC,IAAoC,CAAA,GACpCC,IAAc,CAAC,GAAGjB,CAAW,GAC7BkB,wBAA2B,IAAA;AAG/B,WAASC,EAAWC,GAA0BC,GAA4C;AACxF,UAAMC,IAAWD,KAAkB,CAAC,CAACD,EAAI,UAEnCG,IAAO,SAAS,cAAc,QAAQ;AAC5C,IAAAA,EAAK,OAAO,UACZA,EAAK,aAAa,oBAAoBH,EAAI,IAAI,GAC9CG,EAAK,aAAa,oBAAoBH,EAAI,IAAI,GAC9CG,EAAK,aAAa,QAAQ,QAAQ,GAClCA,EAAK,aAAa,iBAAiB,OAAO,GACtCH,EAAI,aAAUG,EAAK,QAAQ,WAAWH,EAAI,WAE9CG,EAAK,YACH,qFACCD,IACG,kCACA,gEAEFA,MACFC,EAAK,WAAW,IAChBA,EAAK,aAAa,iBAAiB,MAAM,GACzCA,EAAK,QACHH,EAAI,UAAUA,EAAI,OAAO,YAAA,MAAkB,WACvC,gCACA;AAIR,UAAMI,IAAS,SAAS,cAAc,MAAM;AAC5C,IAAAA,EAAO,YACL,gGACCF,IACG,mEACA,oEACNE,EAAO,cAAcJ,EAAI,QAAQA,EAAI,MAAM,MAAM,GAAG,CAAC,EAAE,YAAA;AAGvD,UAAMK,IAAS,SAAS,cAAc,KAAK;AAC3C,IAAAA,EAAO,YAAY;AAEnB,UAAMC,IAAU,SAAS,cAAc,KAAK;AAC5C,IAAAA,EAAQ,YACN,2BACCJ,IACG,qCACA,kCACNI,EAAQ,cAAcN,EAAI;AAE1B,UAAMO,IAAS,SAAS,cAAc,KAAK;AAC3C,IAAAA,EAAO,YAAY;AACnB,UAAMC,IAAkB,CAACR,EAAI,eAAeA,EAAI,IAAI;AACpD,WAAIA,EAAI,UAAUA,EAAI,OAAO,YAAA,MAAkB,YAC7CQ,EAAM,KAAK,IAAIR,EAAI,MAAM,GAAG,GAE9BO,EAAO,cAAcC,EAAM,KAAK,GAAG,GAEnCH,EAAO,YAAYC,CAAO,GAC1BD,EAAO,YAAYE,CAAM,GACzBJ,EAAK,YAAYC,CAAM,GACvBD,EAAK,YAAYE,CAAM,GAEhBF;AAAA,EACT;AAGA,WAASM,EAAYC,IAAiB,IAAU;AAC9C,IAAApB,EAAe,YAAY,IAC3BM,IAAe,CAAA,GACfD,IAAe;AAEf,UAAMgB,IAAQD,EAAO,YAAA,EAAc,KAAA,GAE7BE,IAAWD,IACbd,EAAY;AAAA,MACV,CAACgB,MACCA,EAAE,MAAM,YAAA,EAAc,SAASF,CAAK,KACpCE,EAAE,KAAK,YAAA,EAAc,SAASF,CAAK,MAClCE,EAAE,YAAY,IAAI,YAAA,EAAc,SAASF,CAAK,MAC9CE,EAAE,eAAe,IAAI,YAAA,EAAc,SAASF,CAAK;AAAA,IAAA,IAEtDd;AAEJ,QAAIe,EAAS,WAAW,GAAG;AACzB,MAAArB,EAAW,MAAM,UAAU;AAC3B,YAAMuB,IAAMvB,EAAW,cAAc,0BAA0B;AAC/D,MAAIuB,MACFA,EAAI,cAAcH,IAAQ,gCAAgC;AAE5D;AAAA,IACF;AAIA,QAFApB,EAAW,MAAM,UAAU,QAEvBP,GAAiB;AACnB,YAAM+B,wBAAa,IAAA;AACnB,iBAAWf,KAAOY,GAAU;AAC1B,cAAMI,IAAMhB,EAAI,YAAY;AAC5B,QAAKe,EAAO,IAAIC,CAAG,KAAGD,EAAO,IAAIC,GAAK,EAAE,GACxCD,EAAO,IAAIC,CAAG,EAAG,KAAKhB,CAAG;AAAA,MAC3B;AAEA,iBAAW,CAACiB,GAAUC,CAAK,KAAKH,GAAQ;AACtC,cAAMtD,IAAS,SAAS,cAAc,KAAK;AAC3C,QAAAA,EAAO,YACL,oHAEFA,EAAO,aAAa,wBAAwBwD,CAAQ,GACpDxD,EAAO,aAAa,QAAQ,cAAc,GAC1CA,EAAO,cAAcwD,GACrB3B,EAAe,YAAY7B,CAAM;AAEjC,mBAAWuC,KAAOkB,GAAO;AACvB,gBAAMf,IAAOJ,EAAWC,GAAKF,EAAqB,IAAIE,EAAI,IAAI,CAAC;AAC/D,UAAAV,EAAe,YAAYa,CAAI,GAC1BA,EAAK,YAAUP,EAAa,KAAKO,CAAI;AAAA,QAC5C;AAAA,MACF;AAAA,IACF;AACE,iBAAWH,KAAOY,GAAU;AAC1B,cAAMT,IAAOJ,EAAWC,GAAKF,EAAqB,IAAIE,EAAI,IAAI,CAAC;AAC/D,QAAAV,EAAe,YAAYa,CAAI,GAC1BA,EAAK,YAAUP,EAAa,KAAKO,CAAI;AAAA,MAC5C;AAAA,EAEJ;AAEA,EAAAM,EAAA;AAGA,WAASU,EAAeC,GAAqB;AAC3C,QAAIzB,KAAgB,KAAKA,IAAeC,EAAa,QAAQ;AAC3D,YAAMyB,IAAOzB,EAAaD,CAAY;AACtC,MAAA0B,EAAK,UAAU,OAAO,cAAc,qBAAqB,GACzDA,EAAK,aAAa,iBAAiB,OAAO;AAAA,IAC5C;AAIA,QAFA1B,IAAeyB,GAEXzB,KAAgB,KAAKA,IAAeC,EAAa,QAAQ;AAC3D,YAAMO,IAAOP,EAAaD,CAAY;AACtC,MAAAQ,EAAK,UAAU,IAAI,cAAc,qBAAqB,GACtDA,EAAK,aAAa,iBAAiB,MAAM,GACrC,OAAOA,EAAK,kBAAmB,cACjCA,EAAK,eAAe,EAAE,OAAO,UAAA,CAAW;AAAA,IAE5C;AAAA,EACF;AAGA,EAAIjB,KACFA,EAAY,iBAAiB,SAAS,MAAM;AAC1C,IAAAuB,EAAYvB,EAAa,KAAK;AAAA,EAChC,CAAC;AAIH,WAASoC,EAAc,GAAwB;AAC7C,YAAQ,EAAE,KAAA;AAAA,MACR,KAAK;AACH,UAAE,eAAA,GACE1B,EAAa,SAAS,KACxBuB,EAAexB,IAAeC,EAAa,SAAS,IAAID,IAAe,IAAI,CAAC;AAE9E;AAAA,MAEF,KAAK;AACH,UAAE,eAAA,GACEC,EAAa,SAAS,KACxBuB,EAAexB,KAAgB,IAAIC,EAAa,SAAS,IAAID,IAAe,CAAC;AAE/E;AAAA,MAEF,KAAK;AAEH,YADA,EAAE,eAAA,GACEA,KAAgB,KAAKA,IAAeC,EAAa,QAAQ;AAC3D,gBAAM/C,IAAO+C,EAAaD,CAAY,EAAE,aAAa,kBAAkB;AACvE,UAAI9C,KAAMiC,EAAU,SAASjC,CAAI;AAAA,QACnC;AACA;AAAA,MAEF,KAAK;AACH,UAAE,eAAA,GACFiC,EAAU,QAAA;AACV;AAAA,MAEF,KAAK;AACH,UAAE,eAAA,GACEI,KAAe,SAAS,kBAAkBA,KAC5CA,EAAY,MAAA,GACZS,IAAe,MACNC,EAAa,SAAS,KAC/BuB,EAAe,CAAC;AAElB;AAAA,IAAA;AAAA,EAEN;AAGA,EAAA7B,EAAe,iBAAiB,SAAS,CAAC,MAAM;AAC9C,UAAMiC,IAAU,EAAE,OAAuB,QAA2B,oBAAoB;AACxF,QAAI,CAACA,KAAUA,EAAO,SAAU;AAChC,UAAM1E,IAAO0E,EAAO,aAAa,kBAAkB;AACnD,IAAI1E,KAAMiC,EAAU,SAASjC,CAAI;AAAA,EACnC,CAAC;AAGD,WAAS2E,IAAwB;AAC/B,IAAAvC,EAAQ,MAAM,SAAS,IACvBA,EAAQ,MAAM,eAAe,IAC7BA,EAAQ,MAAM,MAAM,IACpBA,EAAQ,MAAM,YAAY,OAE1B,sBAAsB,MAAM;AAE1B,MADaA,EAAQ,sBAAA,EACZ,SAAS,OAAO,cAAc,MACrCA,EAAQ,MAAM,SAAS,QACvBA,EAAQ,MAAM,MAAM,QACpBA,EAAQ,MAAM,eAAe,OAC7BA,EAAQ,MAAM,YAAY;AAAA,IAE9B,CAAC;AAAA,EACH;AAGA,WAASwC,IAAa;AACpB,IAAAxC,EAAQ,MAAM,UAAU,IACxBS,IAAa,IACb8B,EAAA,GAEItC,MACFA,EAAY,QAAQ,IACpBuB,EAAY,EAAE,GACd,sBAAsB,MAAMvB,EAAa,OAAO,IAGlDD,EAAQ,iBAAiB,WAAWqC,CAAa;AAAA,EACnD;AAEA,WAASI,IAAc;AACrB,IAAAzC,EAAQ,MAAM,UAAU,QACxBS,IAAa,IACbC,IAAe,IACfV,EAAQ,oBAAoB,WAAWqC,CAAa;AAAA,EACtD;AAGA,WAASK,EAAYC,GAA6B1B,GAA8B;AAC9E,IAAAL,IAAc+B,GACV1B,MAAUJ,IAAuBI,IACrCO,EAAYvB,GAAa,SAAS,EAAE;AAAA,EACtC;AAEA,SAAO;AAAA,IACL,SAASD;AAAA,IACT,MAAAwC;AAAA,IACA,OAAAC;AAAA,IACA,QAAQ,MAAMhC;AAAA,IACd,aAAAiC;AAAA,EAAA;AAEJ;AAMA,eAAeE,EAAW9E,GAAkC;AAC1D,QAAM+E,IAAa/E,EAAK,QAAqB,yBAAyB,KAAKA,GACrE8B,IAASpD,EAAkBqG,EAAW,aAAa,uBAAuB,CAAC,GAE3E3F,IAAUY,EAAK,QAAQ,WAAW8B,EAAO,WAAW;AAC1D,MAAI,CAAC1C,GAAS;AACZ,YAAQ,KAAK,6CAA6C;AAC1D;AAAA,EACF;AAEA,QAAM4F,IAAgBnG,EAAwBmB,EAAK,QAAQ,eAAe8B,EAAO,iBAAiB,EAAE,GAC9FmD,IAAY,SAASjF,EAAK,QAAQ,aAAa,IAAI,EAAE,KAAK8B,EAAO,aAAa,GAC9EoD,IAAWpD,EAAO,aAAa,IAC/BzC,IAAkByC,EAAO,oBAAoB,IAC7CvB,IAAWuB,EAAO,YAAa9B,EAAK,QAAQ,kBAAkB,QAE9DmF,wBAAsB,IAAA,GACtBC,wBAAoB,IAAA;AAG1B,MAAIC;AACJ,MAAI;AACF,IAAAA,IAAc,MAAMlG,EAAmBC,GAASC,CAAe;AAAA,EACjE,SAASiG,GAAK;AACZ,YAAQ,MAAM,+CAA+CA,CAAG;AAChE;AAAA,EACF;AAGA,MAAIN,EAAc,SAAS,GAAG;AAC5B,UAAMO,IAAU,IAAI,IAAIP,EAAc,IAAI,CAACQ,MAAMA,EAAE,YAAA,CAAa,CAAC;AACjE,IAAAH,IAAcA,EAAY,OAAO,CAACvB,MAAMyB,EAAQ,IAAIzB,EAAE,KAAK,YAAA,CAAa,CAAC;AAAA,EAC3E;AAGA,QAAM2B,IAASzF,EAAK,cAAgC,0BAA0B;AAC9E,MAAI0F,IAAwB,CAAA;AAC5B,MAAID,GAAQ;AACV,QAAI;AACF,YAAM7G,IAAS,KAAK,MAAM6G,EAAO,KAAK;AACtC,MAAI,MAAM,QAAQ7G,CAAM,MAAG8G,IAAiB9G;AAAA,IAC9C,QAAQ;AAAA,IAAe;AAIzB,QAAM+G,IAAgB;AAAA,IACpB,GAAG,IAAI;AAAA,MACLD,EACG,IAAI,CAACE,MAAOA,KAAK,OAAOA,KAAM,WAAYA,EAAE,QAAmB,EAAG,EAClE,OAAO,CAACC,MAAmB,OAAOA,KAAM,YAAYA,EAAE,SAAS,CAAC;AAAA,IAAA;AAAA,EACrE;AAIF,MAAIF,EAAc,SAAS;AACzB,QAAI;AACF,YAAMG,IAAY,MAAMnG,EAAoBP,GAASuG,GAAetG,CAAe;AACnF,iBAAWY,KAAQ6F;AACjB,QAAA/F,EAAqBC,GAAMC,CAAI,GAC/BkF,EAAgB,IAAIlF,EAAK,IAAI,GAC7BmF,EAAc,IAAInF,EAAK,MAAMA,CAAI;AAAA,IAErC,SAASqF,GAAK;AACZ,cAAQ,MAAM,+CAA+CA,CAAG;AAAA,IAClE;AAIF,MAAI,CAACJ,GAAU;AACb,UAAMa,IAAUV,EACb,OAAO,CAACvB,MAAM,CAACqB,EAAgB,IAAIrB,EAAE,IAAI,CAAC,EAC1C,IAAI,CAACA,MAAMA,EAAE,IAAI;AACpB,QAAIiC,EAAQ,SAAS;AACnB,UAAI;AACF,cAAMD,IAAY,MAAMnG,EAAoBP,GAAS2G,GAAS1G,CAAe;AAC7E,mBAAWY,KAAQ6F;AACjB,UAAA/F,EAAqBC,GAAMC,CAAI,GAC/BkF,EAAgB,IAAIlF,EAAK,IAAI,GAC7BmF,EAAc,IAAInF,EAAK,MAAMA,CAAI;AAAA,MAErC,SAASqF,GAAK;AACZ,gBAAQ,MAAM,yCAAyCA,CAAG;AAAA,MAC5D;AAAA,EAEJ;AAGA,EAAAU,EAAgBhG,CAAI;AAMpB,QAAMiG,IAAYjG,EAAK,cAAiC,yBAAyB,GAC3EkG,IAAYlG,EAAK,cAAiC,kBAAkB,GAKpEmG,IAAiB,SAAS,cAAc,KAAK;AACnD,EAAAA,EAAe,YAAY,QAC3BA,EAAe,aAAa,wBAAwB,MAAM;AAE1D,QAAMC,IAAgB,SAAS,cAAc,KAAK;AAClD,EAAAA,EAAc,YAAY;AAG1B,QAAMC,IAAS,SAAS,cAAc,QAAQ;AAC9C,EAAAA,EAAO,OAAO,UACdA,EAAO,YACL,iUAKFA,EAAO,aAAa,uBAAuB,MAAM,GACjDA,EAAO,YACL,0LAGSvE,EAAO,YAAY,WAAW;AAOzC,QAAMwE,IAAiB,MAAY;AACjC,QAAIrB,KAAa,EAAG;AAEpB,UAAMsB,IADQvG,EAAK,iBAAiB,mBAAmB,EAAE,UAClCiF;AACvB,IAAAoB,EAAO,WAAWE,GAClBF,EAAO,UAAU,OAAO,cAAcE,CAAK,GAC3CF,EAAO,UAAU,OAAO,sBAAsBE,CAAK,GACnDF,EAAO,QAAQE,IAAQ,cAActB,CAAS,oBAAoB;AAAA,EACpE,GAGMuB,IAAgB5E,EAAoByD,GAAavD,GAAQ;AAAA,IAC7D,UAAU,CAAChC,MAAS2G,EAAqB3G,CAAI;AAAA,IAC7C,SAAS,MAAM;AACb,MAAA0G,EAAc,MAAA,GACdH,EAAO,MAAA;AAAA,IACT;AAAA,EAAA,CACD;AAGD,iBAAeI,EAAqB3G,GAA6B;AAC/D,UAAMmD,IAAMoC,EAAY,KAAK,CAACvB,MAAMA,EAAE,SAAShE,CAAI;AACnD,QAAI,CAACmD,KAAOA,EAAI,SAAU;AAG1B,QAAIgC,IAAY,KACAjF,EAAK,iBAAiB,mBAAmB,EAAE,UAC5CiF,GAAW;AACtB,MAAAuB,EAAc,MAAA;AACd;AAAA,IACF;AAQF,QAHEP,aAAqB,qBACrB,MAAM,KAAKA,EAAU,OAAO,EAAE,KAAK,CAACS,MAAMA,EAAE,UAAU5G,CAAI;AAI1D,MAAAmG,EAAW,QAAQnG,GACnBoG,GAAW,MAAA;AAAA,SACN;AAEL,UAAIS,IAAWvB,EAAc,IAAItF,CAAI;AACrC,UAAI,CAAC6G;AACH,YAAI;AACF,gBAAMC,IAAU,MAAM/G,EAAoBT,GAASU,GAAMT,CAAe;AACxE,UAAIuH,MACFD,IAAWC,GACX7G,EAAqBC,GAAM2G,CAAQ,GACnCxB,EAAgB,IAAIwB,EAAS,IAAI,GACjCvB,EAAc,IAAIuB,EAAS,MAAMA,CAAQ;AAAA,QAE7C,SAASrB,GAAK;AACZ,kBAAQ,MAAM,wCAAwCxF,CAAI,WAAWwF,CAAG,GACxEkB,EAAc,MAAA;AACd;AAAA,QACF;AAGF,UAAI,CAACG,GAAU;AACb,QAAAH,EAAc,MAAA;AACd;AAAA,MACF;AAGA,YAAMK,IAAY7G,EAAK,cAA2B,mBAAmB;AACrE,UAAI6G,GAAW;AACb,cAAMpH,IAAOa,EAAmBqG,GAAUpG,GAAUuB,EAAO,oBAAoB;AAC/E+E,QAAAA,EAAU,YAAYpH,CAAI,GAE1BA,EAAK,cAAc,IAAI,MAAM,SAAS,EAAE,SAAS,GAAA,CAAM,CAAC;AAAA,MAC1D;AAAA,IACF;AAEA,IAAA+G,EAAc,MAAA,GACdF,EAAA;AAAA,EACF;AAqCA,MAlCAD,EAAO,iBAAiB,SAAS,CAAC,MAAM;AAEtC,IADA,EAAE,gBAAA,GACE,CAAAA,EAAO,aACPG,EAAc,WAChBA,EAAc,MAAA,IAEdA,EAAc,KAAA;AAAA,EAElB,CAAC,GAGDH,EAAO,iBAAiB,WAAW,CAAC,MAAM;AACxC,IAAI,EAAE,QAAQ,eAAe,CAACG,EAAc,OAAA,KAAY,CAACH,EAAO,aAC9D,EAAE,eAAA,GACFG,EAAc,KAAA;AAAA,EAElB,CAAC,GAGD,SAAS,iBAAiB,SAAS,CAAC,MAAM;AACxC,IAAIA,EAAc,YAAY,CAACJ,EAAc,SAAS,EAAE,MAAc,KACpEI,EAAc,MAAA;AAAA,EAElB,CAAC,GAGD,SAAS,iBAAiB,WAAW,CAAC,MAAM;AAC1C,IAAI,EAAE,QAAQ,YAAYA,EAAc,aACtCA,EAAc,MAAA,GACdH,EAAO,MAAA;AAAA,EAEX,CAAC,GAGGpB,IAAY,GAAG;AACjB,UAAM4B,IAAY7G,EAAK,cAAc,mBAAmB;AACxD,IAAI6G,KACF,IAAI,iBAAiB,MAAMP,GAAgB,EAAE,QAAQO,GAAW,EAAE,WAAW,IAAM,GAErFP,EAAA;AAAA,EACF;AAGA,EAAAF,EAAc,YAAYC,CAAM,GAChCD,EAAc,YAAYI,EAAc,OAAO,GAC/CL,EAAe,YAAYC,CAAa;AAExC,QAAMS,IAAY7G,EAAK,cAAc,mBAAmB;AACxD,EAAI6G,KAAaA,EAAU,cACzBA,EAAU,eAAe,aAAaV,GAAgBU,EAAU,WAAW,IAE3E7G,EAAK,YAAYmG,CAAc,GAGjCnG,EAAK,aAAa,2BAA2B,MAAM;AACrD;AAMA,eAAsB8G,EAAwBC,IAAoB,UAAyB;AAIzF,QAAMC,IAHQ,MAAM;AAAA,IAClBD,EAAM,iBAA8B,oCAAoC;AAAA,EAAA,EAGvE,OAAO,CAAC/G,MAASA,EAAK,aAAa,yBAAyB,MAAM,MAAM,EACxE,IAAI,CAACA,MAAS8E,EAAW9E,CAAI,CAAC;AACjC,QAAM,QAAQ,IAAIgH,CAAK;AACzB;AAMA,SAASC,EAAQC,GAAsB;AACrC,EAAI,SAAS,eAAe,YAC1B,SAAS,iBAAiB,oBAAoBA,GAAI,EAAE,MAAM,IAAM,IAEhEA,EAAA;AAEJ;AAEAD,EAAQ,MAAM;AACZ,EAAAH,EAAA;AACF,CAAC;"}