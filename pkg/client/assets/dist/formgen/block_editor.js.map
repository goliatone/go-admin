{"version":3,"file":"block_editor.js","sources":["../../src/formgen/block_editor.ts"],"sourcesContent":["type BlockEditorConfig = {\n  sortable?: boolean;\n  addLabel?: string;\n  emptyLabel?: string;\n  allowDrag?: boolean;\n};\n\ntype BlockTemplate = {\n  type: string;\n  label: string;\n  icon?: string;\n  collapsed?: boolean;\n  template: HTMLTemplateElement;\n};\n\ntype BlockEditorElements = {\n  root: HTMLElement;\n  list: HTMLElement;\n  output: HTMLInputElement;\n  addSelect?: HTMLSelectElement;\n  addButton?: HTMLButtonElement;\n  emptyState?: HTMLElement;\n};\n\nfunction parseConfig(raw: string | null): BlockEditorConfig {\n  if (!raw) return {};\n  try {\n    const parsed = JSON.parse(raw) as unknown;\n    if (parsed && typeof parsed === 'object') {\n      return parsed as BlockEditorConfig;\n    }\n  } catch {\n    // ignore\n  }\n  return {};\n}\n\nfunction resolveConfig(root: HTMLElement): BlockEditorConfig {\n  const configRoot = root.closest<HTMLElement>('[data-component-config]');\n  return parseConfig(configRoot?.getAttribute('data-component-config') ?? null);\n}\n\nfunction parseBoolean(value?: string | null): boolean | undefined {\n  if (value == null) return undefined;\n  const normalized = value.trim().toLowerCase();\n  if (normalized === 'true') return true;\n  if (normalized === 'false') return false;\n  return undefined;\n}\n\nfunction resolveElements(root: HTMLElement): BlockEditorElements | null {\n  const list = root.querySelector<HTMLElement>('[data-block-list]');\n  const output = root.querySelector<HTMLInputElement>('input[data-block-output]');\n  if (!list || !output) return null;\n  const addSelect = root.querySelector<HTMLSelectElement>('[data-block-add-select]');\n  const addButton = root.querySelector<HTMLButtonElement>('[data-block-add]');\n  const emptyState = root.querySelector<HTMLElement>('[data-block-empty]');\n  return { root, list, output, addSelect: addSelect ?? undefined, addButton: addButton ?? undefined, emptyState: emptyState ?? undefined };\n}\n\nfunction toPathParts(raw: string): string[] {\n  const cleaned = raw.replace(/\\]/g, '');\n  return cleaned.split(/\\.|\\[/).map((part) => part.trim()).filter((part) => part.length > 0);\n}\n\nfunction buildInputName(base: string, index: number, raw: string): string {\n  if (!base) return raw;\n  const parts = toPathParts(raw);\n  let result = `${base}[${index}]`;\n  for (const part of parts) {\n    result += `[${part}]`;\n  }\n  return result;\n}\n\nfunction getByPath(data: any, rawPath: string): any {\n  if (!data || !rawPath) return undefined;\n  const parts = toPathParts(rawPath);\n  let current = data;\n  for (const part of parts) {\n    if (current == null) return undefined;\n    current = current[part];\n  }\n  return current;\n}\n\nfunction setByPath(target: Record<string, any>, rawPath: string, value: any): void {\n  if (!rawPath) return;\n  const parts = toPathParts(rawPath);\n  if (parts.length === 0) return;\n  let current: any = target;\n  parts.forEach((part, idx) => {\n    const isLast = idx === parts.length - 1;\n    const nextPart = parts[idx + 1];\n    const nextIsIndex = nextPart !== undefined && /^\\d+$/.test(nextPart);\n    if (isLast) {\n      if (part === '') return;\n      current[part] = value;\n      return;\n    }\n    if (current[part] == null || typeof current[part] !== 'object') {\n      current[part] = nextIsIndex ? [] : {};\n    }\n    current = current[part];\n  });\n}\n\nfunction readFieldValue(elements: Array<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>): any {\n  if (elements.length === 0) return undefined;\n  const first = elements[0];\n  if (first instanceof HTMLSelectElement && first.multiple) {\n    return Array.from(first.selectedOptions).map((opt) => opt.value);\n  }\n  if (first instanceof HTMLInputElement) {\n    if (first.type === 'radio') {\n      const checked = elements.find((el) => (el as HTMLInputElement).checked) as HTMLInputElement | undefined;\n      return checked ? checked.value : undefined;\n    }\n    if (first.type === 'checkbox') {\n      if (elements.length > 1) {\n        return elements.filter((el) => (el as HTMLInputElement).checked).map((el) => (el as HTMLInputElement).value);\n      }\n      return first.checked;\n    }\n  }\n  return first.value;\n}\n\nfunction setFieldValue(element: HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement, value: any): void {\n  if (value == null) return;\n  if (element instanceof HTMLInputElement) {\n    if (element.type === 'checkbox') {\n      if (Array.isArray(value)) {\n        element.checked = value.map(String).includes(element.value);\n      } else if (typeof value === 'boolean') {\n        element.checked = value;\n      } else {\n        element.checked = String(value) === element.value || value === true;\n      }\n      return;\n    }\n    if (element.type === 'radio') {\n      element.checked = String(value) === element.value;\n      return;\n    }\n  }\n  if (element instanceof HTMLSelectElement && element.multiple) {\n    const values = Array.isArray(value) ? value.map(String) : [String(value)];\n    Array.from(element.options).forEach((opt) => {\n      opt.selected = values.includes(opt.value);\n    });\n    return;\n  }\n  element.value = String(value);\n}\n\nfunction collectTemplates(root: HTMLElement): Map<string, BlockTemplate> {\n  const templates = new Map<string, BlockTemplate>();\n  root.querySelectorAll<HTMLTemplateElement>('template[data-block-template]').forEach((template) => {\n    const type = template.dataset.blockType?.trim();\n    if (!type) return;\n    const label = template.dataset.blockLabel?.trim() || type;\n    const icon = template.dataset.blockIcon?.trim();\n    const collapsed = parseBoolean(template.dataset.blockCollapsed);\n    templates.set(type, { type, label, icon: icon || undefined, collapsed, template });\n  });\n  return templates;\n}\n\nfunction ensureTypeField(item: HTMLElement, type: string): void {\n  const inputs = item.querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('[name=\"_type\"], [data-block-type-input]');\n  if (inputs.length === 0) {\n    const hidden = document.createElement('input');\n    hidden.type = 'hidden';\n    hidden.name = '_type';\n    hidden.value = type;\n    hidden.setAttribute('data-block-type-input', 'true');\n    hidden.setAttribute('data-block-ignore', 'true');\n    item.appendChild(hidden);\n    return;\n  }\n  inputs.forEach((input) => {\n    input.setAttribute('data-block-type-input', 'true');\n    input.setAttribute('data-block-ignore', 'true');\n    if (input instanceof HTMLInputElement) {\n      input.value = type;\n      input.readOnly = true;\n    } else if (input instanceof HTMLSelectElement) {\n      Array.from(input.options).forEach((opt) => {\n        opt.selected = opt.value === type;\n      });\n      input.disabled = true;\n    } else {\n      input.value = type;\n      input.readOnly = true;\n    }\n    const wrapper = input.closest<HTMLElement>('[data-component]');\n    if (wrapper) {\n      wrapper.classList.add('hidden');\n    }\n  });\n}\n\nfunction initBlockEditor(root: HTMLElement): void {\n  const elements = resolveElements(root);\n  if (!elements) return;\n  const config = resolveConfig(root);\n  const templates = collectTemplates(root);\n  const baseName = root.dataset.blockField || elements.output.name;\n  const sortableHint = parseBoolean(root.dataset.blockSortable);\n  const sortable = config.sortable ?? sortableHint ?? false;\n  const allowDrag = config.allowDrag ?? sortable;\n  const addLabel = config.addLabel || elements.addButton?.dataset.blockAddLabel || 'Add block';\n  const emptyLabel = config.emptyLabel || elements.emptyState?.dataset.blockEmptyLabel || 'No blocks added yet.';\n\n  if (elements.addButton) {\n    elements.addButton.textContent = addLabel;\n  }\n  if (elements.emptyState) {\n    elements.emptyState.textContent = emptyLabel;\n  }\n\n  const list = elements.list;\n  const output = elements.output;\n\n  const syncOutput = () => {\n    const items = Array.from(list.querySelectorAll<HTMLElement>('[data-block-item]'));\n    const payload = items.map((item) => {\n      const data: Record<string, any> = {};\n      const groups = new Map<string, Array<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>>();\n      item.querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('input, select, textarea').forEach((field) => {\n        if (field.dataset.blockIgnore === 'true' || field.hasAttribute('data-block-ignore')) return;\n        const key = field.getAttribute('data-block-field-name') || field.name || '';\n        if (!key) return;\n        if (!groups.has(key)) groups.set(key, []);\n        groups.get(key)!.push(field);\n      });\n      groups.forEach((group, key) => {\n        const value = readFieldValue(group);\n        if (value !== undefined) {\n          setByPath(data, key, value);\n        }\n      });\n      const blockType = item.dataset.blockType || data._type || '';\n      if (blockType) data._type = blockType;\n      return data;\n    });\n    output.value = JSON.stringify(payload);\n  };\n\n  const updateNames = () => {\n    const items = Array.from(list.querySelectorAll<HTMLElement>('[data-block-item]'));\n    items.forEach((item, index) => {\n      item.querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('input, select, textarea').forEach((field) => {\n        if (field.dataset.blockIgnore === 'true' || field.hasAttribute('data-block-ignore')) return;\n        const original = field.getAttribute('data-block-field-name') || field.name;\n        if (!original) return;\n        if (!field.hasAttribute('data-block-field-name')) {\n          field.setAttribute('data-block-field-name', original);\n        }\n        field.name = buildInputName(baseName, index, original);\n      });\n    });\n  };\n\n  const updateEmptyState = () => {\n    if (!elements.emptyState) return;\n    const hasItems = list.querySelector('[data-block-item]');\n    elements.emptyState.classList.toggle('hidden', Boolean(hasItems));\n  };\n\n  const syncAll = () => {\n    updateNames();\n    syncOutput();\n    updateEmptyState();\n  };\n\n  const form = root.closest('form');\n  if (form) {\n    form.addEventListener('submit', () => {\n      syncOutput();\n    });\n  }\n\n  const fillValues = (item: HTMLElement, values: Record<string, any>) => {\n    item.querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('input, select, textarea').forEach((field) => {\n      const key = field.getAttribute('data-block-field-name') || field.name;\n      if (!key) return;\n      const value = getByPath(values, key);\n      if (value !== undefined) {\n        setFieldValue(field, value);\n      }\n    });\n  };\n\n  const createBlockItem = (template: BlockTemplate, values?: Record<string, any>) => {\n    const wrapper = document.createElement('div');\n    wrapper.className = 'border border-gray-200 rounded-lg bg-white shadow-sm dark:bg-slate-900 dark:border-gray-700';\n    wrapper.setAttribute('data-block-item', 'true');\n    wrapper.dataset.blockType = template.type;\n    if (sortable) {\n      wrapper.setAttribute('draggable', 'true');\n    }\n\n    const header = document.createElement('div');\n    header.className = 'flex flex-wrap items-center justify-between gap-2 p-3 border-b border-gray-200 dark:border-gray-700';\n    header.setAttribute('data-block-header', 'true');\n\n    const titleWrap = document.createElement('div');\n    titleWrap.className = 'flex items-center gap-2 text-sm font-medium text-gray-900 dark:text-white';\n\n    const icon = document.createElement('span');\n    icon.className = 'inline-flex items-center justify-center h-6 min-w-[1.5rem] px-2 text-xs font-semibold uppercase rounded-full bg-gray-100 text-gray-700 dark:bg-slate-800 dark:text-slate-200';\n    icon.textContent = template.icon || template.label.slice(0, 1).toUpperCase();\n\n    const label = document.createElement('span');\n    label.textContent = template.label;\n\n    const typeBadge = document.createElement('span');\n    typeBadge.className = 'text-xs text-gray-500 dark:text-gray-400';\n    typeBadge.textContent = template.type;\n\n    titleWrap.appendChild(icon);\n    titleWrap.appendChild(label);\n    titleWrap.appendChild(typeBadge);\n\n    const actions = document.createElement('div');\n    actions.className = 'flex items-center gap-2';\n\n    if (sortable) {\n      const moveUp = document.createElement('button');\n      moveUp.type = 'button';\n      moveUp.className = 'text-xs text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white';\n      moveUp.textContent = 'Up';\n      moveUp.setAttribute('data-block-move-up', 'true');\n\n      const moveDown = document.createElement('button');\n      moveDown.type = 'button';\n      moveDown.className = 'text-xs text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white';\n      moveDown.textContent = 'Down';\n      moveDown.setAttribute('data-block-move-down', 'true');\n\n      actions.appendChild(moveUp);\n      actions.appendChild(moveDown);\n    }\n\n    const collapseBtn = document.createElement('button');\n    collapseBtn.type = 'button';\n    collapseBtn.className = 'text-xs text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white';\n    collapseBtn.textContent = 'Collapse';\n    collapseBtn.setAttribute('data-block-collapse', 'true');\n\n    const removeBtn = document.createElement('button');\n    removeBtn.type = 'button';\n    removeBtn.className = 'text-xs text-red-600 hover:text-red-700';\n    removeBtn.textContent = 'Remove';\n    removeBtn.setAttribute('data-block-remove', 'true');\n\n    actions.appendChild(collapseBtn);\n    actions.appendChild(removeBtn);\n\n    if (sortable) {\n      const dragHandle = document.createElement('span');\n      dragHandle.className = 'text-xs text-gray-400 cursor-move';\n      dragHandle.textContent = 'Drag';\n      dragHandle.setAttribute('data-block-drag-handle', 'true');\n      actions.appendChild(dragHandle);\n    }\n\n    header.appendChild(titleWrap);\n    header.appendChild(actions);\n\n    const body = document.createElement('div');\n    body.className = 'p-4 space-y-4';\n    body.setAttribute('data-block-body', 'true');\n\n    const fragment = template.template.content.cloneNode(true) as DocumentFragment;\n    body.appendChild(fragment);\n\n    wrapper.appendChild(header);\n    wrapper.appendChild(body);\n\n    ensureTypeField(wrapper, template.type);\n\n    if (values) {\n      fillValues(wrapper, values);\n    }\n\n    const shouldCollapse = template.collapsed ?? false;\n    if (shouldCollapse) {\n      body.classList.add('hidden');\n      wrapper.dataset.blockCollapsed = 'true';\n      collapseBtn.textContent = 'Expand';\n    }\n\n    return wrapper;\n  };\n\n  const addBlock = (type: string, values?: Record<string, any>) => {\n    const template = templates.get(type);\n    if (!template) return;\n    const item = createBlockItem(template, values);\n    list.appendChild(item);\n    syncAll();\n  };\n\n  const addButton = elements.addButton;\n  const addSelect = elements.addSelect;\n  if (addButton && addSelect) {\n    addButton.addEventListener('click', () => {\n      const type = addSelect.value.trim();\n      if (type) {\n        addBlock(type);\n        addSelect.value = '';\n      }\n    });\n  }\n\n  root.addEventListener('click', (event) => {\n    const target = event.target;\n    if (!(target instanceof HTMLElement)) return;\n    const item = target.closest<HTMLElement>('[data-block-item]');\n    if (!item) return;\n    if (target.closest('[data-block-remove]')) {\n      item.remove();\n      syncAll();\n      return;\n    }\n    if (target.closest('[data-block-collapse]')) {\n      const body = item.querySelector<HTMLElement>('[data-block-body]');\n      if (body) {\n        const isCollapsed = body.classList.toggle('hidden');\n        item.dataset.blockCollapsed = isCollapsed ? 'true' : 'false';\n        const button = target.closest<HTMLButtonElement>('[data-block-collapse]');\n        if (button) button.textContent = isCollapsed ? 'Expand' : 'Collapse';\n      }\n      return;\n    }\n    if (target.closest('[data-block-move-up]')) {\n      const prev = item.previousElementSibling;\n      if (prev) list.insertBefore(item, prev);\n      syncAll();\n      return;\n    }\n    if (target.closest('[data-block-move-down]')) {\n      const next = item.nextElementSibling;\n      if (next) list.insertBefore(next, item);\n      syncAll();\n      return;\n    }\n  });\n\n  root.addEventListener('input', (event) => {\n    const target = event.target;\n    if (!(target instanceof HTMLElement) || !target.closest('[data-block-item]')) return;\n    syncAll();\n  });\n  root.addEventListener('change', (event) => {\n    const target = event.target;\n    if (!(target instanceof HTMLElement) || !target.closest('[data-block-item]')) return;\n    syncAll();\n  });\n\n  if (sortable && allowDrag) {\n    let dragging: HTMLElement | null = null;\n    list.addEventListener('dragstart', (event) => {\n      const target = event.target;\n      if (!(target instanceof HTMLElement)) return;\n      const handle = target.closest('[data-block-drag-handle]');\n      if (!handle) {\n        event.preventDefault();\n        return;\n      }\n      const item = target.closest<HTMLElement>('[data-block-item]');\n      if (!item) return;\n      dragging = item;\n      item.classList.add('opacity-70');\n      event.dataTransfer?.setData('text/plain', 'block');\n    });\n    list.addEventListener('dragover', (event) => {\n      if (!dragging) return;\n      event.preventDefault();\n      const target = event.target instanceof HTMLElement ? event.target.closest<HTMLElement>('[data-block-item]') : null;\n      if (!target || target === dragging) return;\n      const rect = target.getBoundingClientRect();\n      const shouldInsertAfter = event.clientY > rect.top + rect.height / 2;\n      list.insertBefore(dragging, shouldInsertAfter ? target.nextSibling : target);\n    });\n    list.addEventListener('dragend', () => {\n      if (!dragging) return;\n      dragging.classList.remove('opacity-70');\n      dragging = null;\n      syncAll();\n    });\n  }\n\n  if (elements.addSelect) {\n    const placeholder = document.createElement('option');\n    placeholder.value = '';\n    placeholder.textContent = 'Select block type';\n    elements.addSelect.appendChild(placeholder);\n    templates.forEach((template) => {\n      const option = document.createElement('option');\n      option.value = template.type;\n      option.textContent = template.label;\n      elements.addSelect?.appendChild(option);\n    });\n    elements.addSelect.value = '';\n  }\n\n  const initialValue = output.value?.trim();\n  if (initialValue) {\n    try {\n      const parsed = JSON.parse(initialValue) as any;\n      if (Array.isArray(parsed)) {\n        parsed.forEach((entry) => {\n          const type = typeof entry === 'object' && entry ? (entry._type as string) : '';\n          if (type && templates.has(type)) {\n            addBlock(type, entry);\n          }\n        });\n      }\n    } catch {\n      // ignore malformed data\n    }\n  }\n\n  syncAll();\n}\n\nexport function initBlockEditors(scope: ParentNode = document): void {\n  const roots = Array.from(scope.querySelectorAll<HTMLElement>('[data-component=\"block\"], [data-block-editor]'));\n  roots.forEach((root) => initBlockEditor(root));\n}\n\nfunction onReady(fn: () => void): void {\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', fn, { once: true });\n  } else {\n    fn();\n  }\n}\n\nonReady(() => initBlockEditors());\n"],"names":["parseConfig","raw","parsed","resolveConfig","root","configRoot","parseBoolean","value","normalized","resolveElements","list","output","addSelect","addButton","emptyState","toPathParts","part","buildInputName","base","index","parts","result","getByPath","data","rawPath","current","setByPath","target","idx","isLast","nextPart","nextIsIndex","readFieldValue","elements","first","opt","checked","el","setFieldValue","element","values","collectTemplates","templates","template","type","label","icon","collapsed","ensureTypeField","item","inputs","hidden","input","wrapper","initBlockEditor","config","baseName","sortableHint","sortable","allowDrag","addLabel","emptyLabel","syncOutput","payload","groups","field","key","group","blockType","updateNames","original","updateEmptyState","hasItems","syncAll","form","fillValues","createBlockItem","header","titleWrap","typeBadge","actions","moveUp","moveDown","collapseBtn","removeBtn","dragHandle","body","fragment","addBlock","event","isCollapsed","button","prev","next","dragging","rect","shouldInsertAfter","placeholder","option","initialValue","entry","initBlockEditors","scope","onReady","fn"],"mappings":"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"}