{"version":3,"file":"block_editor.js","sources":["../../src/formgen/block_editor.ts"],"sourcesContent":["type BlockEditorConfig = {\n  sortable?: boolean;\n  addLabel?: string;\n  emptyLabel?: string;\n  allowDrag?: boolean;\n  /** Default schema version pattern: {type}@v1.0.0 */\n  schemaVersionPattern?: string;\n  /** Required fields per block type */\n  requiredFields?: Record<string, string[]>;\n  /** Enable validation on input */\n  validateOnInput?: boolean;\n  /** Legacy blocks for conflict detection */\n  legacyBlocks?: any[];\n  /** Show conflict detection UI when conflicts exist */\n  showConflicts?: boolean;\n};\n\ntype BlockTemplate = {\n  type: string;\n  label: string;\n  icon?: string;\n  collapsed?: boolean;\n  schemaVersion?: string;\n  requiredFields?: string[];\n  template: HTMLTemplateElement;\n};\n\ntype ValidationError = {\n  field: string;\n  message: string;\n};\n\ntype BlockConflict = {\n  blockIndex: number;\n  blockType: string;\n  field: string;\n  embeddedValue: any;\n  legacyValue: any;\n};\n\ntype ConflictReport = {\n  hasConflicts: boolean;\n  conflicts: BlockConflict[];\n  embeddedCount: number;\n  legacyCount: number;\n};\n\ntype BlockEditorElements = {\n  root: HTMLElement;\n  list: HTMLElement;\n  output: HTMLInputElement;\n  addSelect?: HTMLSelectElement;\n  addButton?: HTMLButtonElement;\n  emptyState?: HTMLElement;\n};\n\nfunction parseConfig(raw: string | null): BlockEditorConfig {\n  if (!raw) return {};\n  try {\n    const parsed = JSON.parse(raw) as unknown;\n    if (parsed && typeof parsed === 'object') {\n      return parsed as BlockEditorConfig;\n    }\n  } catch {\n    // ignore\n  }\n  return {};\n}\n\nfunction resolveConfig(root: HTMLElement): BlockEditorConfig {\n  const configRoot = root.closest<HTMLElement>('[data-component-config]');\n  return parseConfig(configRoot?.getAttribute('data-component-config') ?? null);\n}\n\nfunction parseBoolean(value?: string | null): boolean | undefined {\n  if (value == null) return undefined;\n  const normalized = value.trim().toLowerCase();\n  if (normalized === 'true') return true;\n  if (normalized === 'false') return false;\n  return undefined;\n}\n\nfunction resolveElements(root: HTMLElement): BlockEditorElements | null {\n  const list = root.querySelector<HTMLElement>('[data-block-list]');\n  const output = root.querySelector<HTMLInputElement>('input[data-block-output]');\n  if (!list || !output) return null;\n  const addSelect = root.querySelector<HTMLSelectElement>('[data-block-add-select]');\n  const addButton = root.querySelector<HTMLButtonElement>('[data-block-add]');\n  const emptyState = root.querySelector<HTMLElement>('[data-block-empty]');\n  return { root, list, output, addSelect: addSelect ?? undefined, addButton: addButton ?? undefined, emptyState: emptyState ?? undefined };\n}\n\nfunction toPathParts(raw: string): string[] {\n  const cleaned = raw.replace(/\\]/g, '');\n  return cleaned.split(/\\.|\\[/).map((part) => part.trim()).filter((part) => part.length > 0);\n}\n\nfunction buildInputName(base: string, index: number, raw: string): string {\n  if (!base) return raw;\n  const parts = toPathParts(raw);\n  let result = `${base}[${index}]`;\n  for (const part of parts) {\n    result += `[${part}]`;\n  }\n  return result;\n}\n\nfunction getByPath(data: any, rawPath: string): any {\n  if (!data || !rawPath) return undefined;\n  const parts = toPathParts(rawPath);\n  let current = data;\n  for (const part of parts) {\n    if (current == null) return undefined;\n    current = current[part];\n  }\n  return current;\n}\n\nfunction setByPath(target: Record<string, any>, rawPath: string, value: any): void {\n  if (!rawPath) return;\n  const parts = toPathParts(rawPath);\n  if (parts.length === 0) return;\n  let current: any = target;\n  parts.forEach((part, idx) => {\n    const isLast = idx === parts.length - 1;\n    const nextPart = parts[idx + 1];\n    const nextIsIndex = nextPart !== undefined && /^\\d+$/.test(nextPart);\n    if (isLast) {\n      if (part === '') return;\n      current[part] = value;\n      return;\n    }\n    if (current[part] == null || typeof current[part] !== 'object') {\n      current[part] = nextIsIndex ? [] : {};\n    }\n    current = current[part];\n  });\n}\n\nfunction readFieldValue(elements: Array<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>): any {\n  if (elements.length === 0) return undefined;\n  const first = elements[0];\n  if (first instanceof HTMLSelectElement && first.multiple) {\n    return Array.from(first.selectedOptions).map((opt) => opt.value);\n  }\n  if (first instanceof HTMLInputElement) {\n    if (first.type === 'radio') {\n      const checked = elements.find((el) => (el as HTMLInputElement).checked) as HTMLInputElement | undefined;\n      return checked ? checked.value : undefined;\n    }\n    if (first.type === 'checkbox') {\n      if (elements.length > 1) {\n        return elements.filter((el) => (el as HTMLInputElement).checked).map((el) => (el as HTMLInputElement).value);\n      }\n      return first.checked;\n    }\n  }\n  return first.value;\n}\n\nfunction setFieldValue(element: HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement, value: any): void {\n  if (value == null) return;\n  if (element instanceof HTMLInputElement) {\n    if (element.type === 'checkbox') {\n      if (Array.isArray(value)) {\n        element.checked = value.map(String).includes(element.value);\n      } else if (typeof value === 'boolean') {\n        element.checked = value;\n      } else {\n        element.checked = String(value) === element.value || value === true;\n      }\n      return;\n    }\n    if (element.type === 'radio') {\n      element.checked = String(value) === element.value;\n      return;\n    }\n  }\n  if (element instanceof HTMLSelectElement && element.multiple) {\n    const values = Array.isArray(value) ? value.map(String) : [String(value)];\n    Array.from(element.options).forEach((opt) => {\n      opt.selected = values.includes(opt.value);\n    });\n    return;\n  }\n  element.value = String(value);\n}\n\nfunction collectTemplates(root: HTMLElement, config: BlockEditorConfig): Map<string, BlockTemplate> {\n  const templates = new Map<string, BlockTemplate>();\n  root.querySelectorAll<HTMLTemplateElement>('template[data-block-template]').forEach((template) => {\n    const type = template.dataset.blockType?.trim();\n    if (!type) return;\n    const label = template.dataset.blockLabel?.trim() || type;\n    const icon = template.dataset.blockIcon?.trim();\n    const collapsed = parseBoolean(template.dataset.blockCollapsed);\n    const schemaVersion = template.dataset.blockSchemaVersion?.trim() || generateSchemaVersion(type, config.schemaVersionPattern);\n    const requiredFieldsRaw = template.dataset.blockRequiredFields?.trim();\n    const requiredFields = requiredFieldsRaw\n      ? requiredFieldsRaw.split(',').map((f) => f.trim()).filter(Boolean)\n      : config.requiredFields?.[type] || [];\n    templates.set(type, {\n      type,\n      label,\n      icon: icon || undefined,\n      collapsed,\n      schemaVersion,\n      requiredFields,\n      template,\n    });\n  });\n  return templates;\n}\n\n/**\n * Generate a schema version string for a block type\n */\nfunction generateSchemaVersion(type: string, pattern?: string): string {\n  if (pattern) {\n    return pattern.replace('{type}', type);\n  }\n  return `${type}@v1.0.0`;\n}\n\n/**\n * Validate a block's required fields\n */\nfunction validateBlock(\n  item: HTMLElement,\n  template: BlockTemplate\n): ValidationError[] {\n  const errors: ValidationError[] = [];\n  const requiredFields = template.requiredFields || [];\n\n  for (const fieldName of requiredFields) {\n    const field = item.querySelector<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>(\n      `[name=\"${fieldName}\"], [data-block-field-name=\"${fieldName}\"]`\n    );\n\n    if (!field) continue;\n\n    let isEmpty = false;\n    if (field instanceof HTMLInputElement) {\n      if (field.type === 'checkbox') {\n        isEmpty = !field.checked;\n      } else if (field.type === 'radio') {\n        const radioGroup = item.querySelectorAll<HTMLInputElement>(`[name=\"${field.name}\"]`);\n        isEmpty = !Array.from(radioGroup).some((r) => r.checked);\n      } else {\n        isEmpty = !field.value.trim();\n      }\n    } else if (field instanceof HTMLSelectElement) {\n      isEmpty = !field.value || field.value === '';\n    } else {\n      isEmpty = !field.value.trim();\n    }\n\n    if (isEmpty) {\n      errors.push({\n        field: fieldName,\n        message: `${fieldName} is required`,\n      });\n    }\n  }\n\n  return errors;\n}\n\n/**\n * Show validation errors on a block item\n */\nfunction showBlockErrors(item: HTMLElement, errors: ValidationError[]): void {\n  // Clear previous errors\n  clearBlockErrors(item);\n\n  if (errors.length === 0) return;\n\n  // Mark block as invalid\n  item.classList.add('block-item--invalid');\n  item.dataset.blockValid = 'false';\n\n  // Add error indicator to header\n  const header = item.querySelector('[data-block-header]');\n  if (header) {\n    const errorBadge = document.createElement('span');\n    errorBadge.className = 'block-error-badge text-xs text-red-600 bg-red-50 px-2 py-0.5 rounded-full dark:bg-red-900/20 dark:text-red-400';\n    errorBadge.textContent = `${errors.length} error${errors.length > 1 ? 's' : ''}`;\n    errorBadge.setAttribute('data-block-error-badge', 'true');\n    header.querySelector('.flex')?.appendChild(errorBadge);\n  }\n\n  // Mark individual fields\n  for (const error of errors) {\n    const field = item.querySelector<HTMLElement>(\n      `[name=\"${error.field}\"], [data-block-field-name=\"${error.field}\"]`\n    );\n    if (field) {\n      field.classList.add('border-red-500', 'focus:ring-red-500');\n      const wrapper = field.closest('[data-component]');\n      if (wrapper) {\n        const errorMsg = document.createElement('p');\n        errorMsg.className = 'block-field-error text-xs text-red-600 mt-1 dark:text-red-400';\n        errorMsg.textContent = error.message;\n        errorMsg.setAttribute('data-block-field-error', 'true');\n        wrapper.appendChild(errorMsg);\n      }\n    }\n  }\n}\n\n/**\n * Clear validation errors from a block item\n */\nfunction clearBlockErrors(item: HTMLElement): void {\n  item.classList.remove('block-item--invalid');\n  item.dataset.blockValid = 'true';\n\n  // Remove error badge\n  item.querySelectorAll('[data-block-error-badge]').forEach((el) => el.remove());\n\n  // Remove field error messages\n  item.querySelectorAll('[data-block-field-error]').forEach((el) => el.remove());\n\n  // Remove error styling from fields\n  item.querySelectorAll('.border-red-500').forEach((el) => {\n    el.classList.remove('border-red-500', 'focus:ring-red-500');\n  });\n}\n\n/**\n * Compare embedded blocks with legacy blocks to detect conflicts\n */\nfunction detectBlockConflicts(embedded: any[], legacy: any[]): ConflictReport {\n  const conflicts: BlockConflict[] = [];\n\n  if (!Array.isArray(embedded) || !Array.isArray(legacy)) {\n    return {\n      hasConflicts: false,\n      conflicts: [],\n      embeddedCount: Array.isArray(embedded) ? embedded.length : 0,\n      legacyCount: Array.isArray(legacy) ? legacy.length : 0,\n    };\n  }\n\n  // Count mismatch is a conflict\n  if (embedded.length !== legacy.length) {\n    // Still compare what we can\n  }\n\n  const maxLen = Math.max(embedded.length, legacy.length);\n  for (let i = 0; i < maxLen; i++) {\n    const embBlock = embedded[i] || {};\n    const legBlock = legacy[i] || {};\n    const blockType = embBlock._type || legBlock._type || `block_${i}`;\n\n    // Compare all fields\n    const allKeys = new Set([...Object.keys(embBlock), ...Object.keys(legBlock)]);\n    for (const key of allKeys) {\n      if (key.startsWith('_')) continue; // Skip metadata fields for comparison\n      const embVal = embBlock[key];\n      const legVal = legBlock[key];\n\n      if (!deepEqual(embVal, legVal)) {\n        conflicts.push({\n          blockIndex: i,\n          blockType,\n          field: key,\n          embeddedValue: embVal,\n          legacyValue: legVal,\n        });\n      }\n    }\n  }\n\n  return {\n    hasConflicts: conflicts.length > 0 || embedded.length !== legacy.length,\n    conflicts,\n    embeddedCount: embedded.length,\n    legacyCount: legacy.length,\n  };\n}\n\n/**\n * Deep equality check for conflict detection\n */\nfunction deepEqual(a: any, b: any): boolean {\n  if (a === b) return true;\n  if (a == null || b == null) return a === b;\n  if (typeof a !== typeof b) return false;\n\n  if (Array.isArray(a) && Array.isArray(b)) {\n    if (a.length !== b.length) return false;\n    return a.every((val, idx) => deepEqual(val, b[idx]));\n  }\n\n  if (typeof a === 'object') {\n    const keysA = Object.keys(a);\n    const keysB = Object.keys(b);\n    if (keysA.length !== keysB.length) return false;\n    return keysA.every((key) => deepEqual(a[key], b[key]));\n  }\n\n  return false;\n}\n\n/**\n * Create conflict report UI element\n */\nfunction createConflictReportUI(report: ConflictReport): HTMLElement {\n  const container = document.createElement('div');\n  container.className = 'block-conflict-report border border-amber-200 bg-amber-50 rounded-lg p-4 mb-4 dark:bg-amber-900/20 dark:border-amber-700';\n  container.setAttribute('data-block-conflict-report', 'true');\n\n  const header = document.createElement('div');\n  header.className = 'flex items-center gap-2 mb-3';\n\n  const icon = document.createElement('span');\n  icon.className = 'text-amber-600 dark:text-amber-400';\n  icon.innerHTML = `<svg class=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"></path></svg>`;\n\n  const title = document.createElement('span');\n  title.className = 'font-medium text-amber-800 dark:text-amber-200';\n  title.textContent = 'Block Conflicts Detected';\n\n  header.appendChild(icon);\n  header.appendChild(title);\n  container.appendChild(header);\n\n  // Summary\n  const summary = document.createElement('p');\n  summary.className = 'text-sm text-amber-700 dark:text-amber-300 mb-3';\n  summary.textContent = `Embedded blocks (${report.embeddedCount}) differ from legacy blocks (${report.legacyCount}). Embedded blocks are authoritative.`;\n  container.appendChild(summary);\n\n  if (report.conflicts.length > 0) {\n    const details = document.createElement('details');\n    details.className = 'text-sm';\n\n    const summaryEl = document.createElement('summary');\n    summaryEl.className = 'cursor-pointer text-amber-600 hover:text-amber-700 dark:text-amber-400 dark:hover:text-amber-300 font-medium';\n    summaryEl.textContent = `View ${report.conflicts.length} field conflict${report.conflicts.length > 1 ? 's' : ''}`;\n    details.appendChild(summaryEl);\n\n    const list = document.createElement('ul');\n    list.className = 'mt-2 space-y-1 pl-4';\n\n    for (const conflict of report.conflicts.slice(0, 10)) {\n      const item = document.createElement('li');\n      item.className = 'text-amber-700 dark:text-amber-300';\n      item.innerHTML = `<span class=\"font-mono text-xs\">${conflict.blockType}[${conflict.blockIndex}].${conflict.field}</span>: <span class=\"text-green-600 dark:text-green-400\">embedded</span> vs <span class=\"text-red-600 dark:text-red-400\">legacy</span>`;\n      list.appendChild(item);\n    }\n\n    if (report.conflicts.length > 10) {\n      const more = document.createElement('li');\n      more.className = 'text-amber-600 dark:text-amber-400 italic';\n      more.textContent = `...and ${report.conflicts.length - 10} more`;\n      list.appendChild(more);\n    }\n\n    details.appendChild(list);\n    container.appendChild(details);\n  }\n\n  // Actions\n  const actions = document.createElement('div');\n  actions.className = 'mt-3 flex gap-2';\n\n  const dismissBtn = document.createElement('button');\n  dismissBtn.type = 'button';\n  dismissBtn.className = 'text-xs px-3 py-1 rounded border border-amber-300 text-amber-700 hover:bg-amber-100 dark:border-amber-600 dark:text-amber-300 dark:hover:bg-amber-900/40';\n  dismissBtn.textContent = 'Dismiss';\n  dismissBtn.addEventListener('click', () => container.remove());\n\n  actions.appendChild(dismissBtn);\n  container.appendChild(actions);\n\n  return container;\n}\n\n/**\n * Show conflict report in the block editor\n */\nfunction showConflictReport(root: HTMLElement, report: ConflictReport): void {\n  // Remove any existing report\n  root.querySelector('[data-block-conflict-report]')?.remove();\n\n  if (!report.hasConflicts) return;\n\n  const reportUI = createConflictReportUI(report);\n  const list = root.querySelector('[data-block-list]');\n  if (list) {\n    list.parentElement?.insertBefore(reportUI, list);\n  } else {\n    root.insertBefore(reportUI, root.firstChild);\n  }\n}\n\nfunction ensureTypeField(item: HTMLElement, type: string): void {\n  const inputs = item.querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('[name=\"_type\"], [data-block-type-input]');\n  if (inputs.length === 0) {\n    const hidden = document.createElement('input');\n    hidden.type = 'hidden';\n    hidden.name = '_type';\n    hidden.value = type;\n    hidden.setAttribute('data-block-type-input', 'true');\n    hidden.setAttribute('data-block-ignore', 'true');\n    item.appendChild(hidden);\n    return;\n  }\n  inputs.forEach((input) => {\n    input.setAttribute('data-block-type-input', 'true');\n    input.setAttribute('data-block-ignore', 'true');\n    if (input instanceof HTMLInputElement) {\n      input.value = type;\n      input.readOnly = true;\n    } else if (input instanceof HTMLSelectElement) {\n      Array.from(input.options).forEach((opt) => {\n        opt.selected = opt.value === type;\n      });\n      input.disabled = true;\n    } else {\n      input.value = type;\n      input.readOnly = true;\n    }\n    const wrapper = input.closest<HTMLElement>('[data-component]');\n    if (wrapper) {\n      wrapper.classList.add('hidden');\n    }\n  });\n}\n\n/**\n * Ensure _schema field exists on the block item\n */\nfunction ensureSchemaField(item: HTMLElement, schemaVersion: string): void {\n  const inputs = item.querySelectorAll<HTMLInputElement>('[name=\"_schema\"], [data-block-schema-input]');\n  if (inputs.length === 0) {\n    const hidden = document.createElement('input');\n    hidden.type = 'hidden';\n    hidden.name = '_schema';\n    hidden.value = schemaVersion;\n    hidden.setAttribute('data-block-schema-input', 'true');\n    hidden.setAttribute('data-block-ignore', 'true');\n    item.appendChild(hidden);\n    return;\n  }\n  inputs.forEach((input) => {\n    input.setAttribute('data-block-schema-input', 'true');\n    input.setAttribute('data-block-ignore', 'true');\n    input.value = schemaVersion;\n    input.readOnly = true;\n    const wrapper = input.closest<HTMLElement>('[data-component]');\n    if (wrapper) {\n      wrapper.classList.add('hidden');\n    }\n  });\n}\n\nfunction initBlockEditor(root: HTMLElement): void {\n  const elements = resolveElements(root);\n  if (!elements) return;\n  const config = resolveConfig(root);\n  const templates = collectTemplates(root, config);\n  const baseName = root.dataset.blockField || elements.output.name;\n  const sortableHint = parseBoolean(root.dataset.blockSortable);\n  const sortable = config.sortable ?? sortableHint ?? false;\n  const allowDrag = config.allowDrag ?? sortable;\n  const addLabel = config.addLabel || elements.addButton?.dataset.blockAddLabel || 'Add block';\n  const emptyLabel = config.emptyLabel || elements.emptyState?.dataset.blockEmptyLabel || 'No blocks added yet.';\n  const validateOnInput = config.validateOnInput ?? true;\n\n  if (elements.addButton) {\n    elements.addButton.textContent = addLabel;\n  }\n  if (elements.emptyState) {\n    elements.emptyState.textContent = emptyLabel;\n  }\n\n  const list = elements.list;\n  const output = elements.output;\n\n  const syncOutput = () => {\n    const items = Array.from(list.querySelectorAll<HTMLElement>('[data-block-item]'));\n    let hasValidationErrors = false;\n\n    const payload = items.map((item) => {\n      const data: Record<string, any> = {};\n      const groups = new Map<string, Array<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>>();\n      item.querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('input, select, textarea').forEach((field) => {\n        if (field.dataset.blockIgnore === 'true' || field.hasAttribute('data-block-ignore')) return;\n        const key = field.getAttribute('data-block-field-name') || field.name || '';\n        if (!key) return;\n        if (!groups.has(key)) groups.set(key, []);\n        groups.get(key)!.push(field);\n      });\n      groups.forEach((group, key) => {\n        const value = readFieldValue(group);\n        if (value !== undefined) {\n          setByPath(data, key, value);\n        }\n      });\n      const blockType = item.dataset.blockType || data._type || '';\n      if (blockType) data._type = blockType;\n\n      // Add _schema version from template or item\n      const schemaVersion = item.dataset.blockSchema || data._schema;\n      if (schemaVersion) {\n        data._schema = schemaVersion;\n      } else {\n        const template = templates.get(blockType);\n        if (template?.schemaVersion) {\n          data._schema = template.schemaVersion;\n        }\n      }\n\n      // Validate block if enabled\n      if (validateOnInput) {\n        const template = templates.get(blockType);\n        if (template) {\n          const errors = validateBlock(item, template);\n          showBlockErrors(item, errors);\n          if (errors.length > 0) {\n            hasValidationErrors = true;\n          }\n        }\n      }\n\n      return data;\n    });\n    output.value = JSON.stringify(payload);\n\n    // Update root element validation state\n    root.dataset.blockEditorValid = hasValidationErrors ? 'false' : 'true';\n  };\n\n  const updateNames = () => {\n    const items = Array.from(list.querySelectorAll<HTMLElement>('[data-block-item]'));\n    items.forEach((item, index) => {\n      item.querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('input, select, textarea').forEach((field) => {\n        if (field.dataset.blockIgnore === 'true' || field.hasAttribute('data-block-ignore')) return;\n        const original = field.getAttribute('data-block-field-name') || field.name;\n        if (!original) return;\n        if (!field.hasAttribute('data-block-field-name')) {\n          field.setAttribute('data-block-field-name', original);\n        }\n        field.name = buildInputName(baseName, index, original);\n      });\n    });\n  };\n\n  const updateEmptyState = () => {\n    if (!elements.emptyState) return;\n    const hasItems = list.querySelector('[data-block-item]');\n    elements.emptyState.classList.toggle('hidden', Boolean(hasItems));\n  };\n\n  const syncAll = () => {\n    updateNames();\n    syncOutput();\n    updateEmptyState();\n  };\n\n  const form = root.closest('form');\n  if (form) {\n    form.addEventListener('submit', () => {\n      syncOutput();\n    });\n  }\n\n  const fillValues = (item: HTMLElement, values: Record<string, any>) => {\n    item.querySelectorAll<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>('input, select, textarea').forEach((field) => {\n      const key = field.getAttribute('data-block-field-name') || field.name;\n      if (!key) return;\n      const value = getByPath(values, key);\n      if (value !== undefined) {\n        setFieldValue(field, value);\n      }\n    });\n  };\n\n  const createBlockItem = (template: BlockTemplate, values?: Record<string, any>) => {\n    const wrapper = document.createElement('div');\n    wrapper.className = 'border border-gray-200 rounded-lg bg-white shadow-sm dark:bg-slate-900 dark:border-gray-700';\n    wrapper.setAttribute('data-block-item', 'true');\n    wrapper.dataset.blockType = template.type;\n    if (sortable) {\n      wrapper.setAttribute('draggable', 'true');\n    }\n\n    const header = document.createElement('div');\n    header.className = 'flex flex-wrap items-center justify-between gap-2 p-3 border-b border-gray-200 dark:border-gray-700';\n    header.setAttribute('data-block-header', 'true');\n\n    const titleWrap = document.createElement('div');\n    titleWrap.className = 'flex items-center gap-2 text-sm font-medium text-gray-900 dark:text-white';\n\n    const icon = document.createElement('span');\n    icon.className = 'inline-flex items-center justify-center h-6 min-w-[1.5rem] px-2 text-xs font-semibold uppercase rounded-full bg-gray-100 text-gray-700 dark:bg-slate-800 dark:text-slate-200';\n    icon.textContent = template.icon || template.label.slice(0, 1).toUpperCase();\n\n    const label = document.createElement('span');\n    label.textContent = template.label;\n\n    const typeBadge = document.createElement('span');\n    typeBadge.className = 'text-xs text-gray-500 dark:text-gray-400';\n    typeBadge.textContent = template.type;\n\n    titleWrap.appendChild(icon);\n    titleWrap.appendChild(label);\n    titleWrap.appendChild(typeBadge);\n\n    const actions = document.createElement('div');\n    actions.className = 'flex items-center gap-2';\n\n    if (sortable) {\n      const moveUp = document.createElement('button');\n      moveUp.type = 'button';\n      moveUp.className = 'text-xs text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white';\n      moveUp.textContent = 'Up';\n      moveUp.setAttribute('data-block-move-up', 'true');\n\n      const moveDown = document.createElement('button');\n      moveDown.type = 'button';\n      moveDown.className = 'text-xs text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white';\n      moveDown.textContent = 'Down';\n      moveDown.setAttribute('data-block-move-down', 'true');\n\n      actions.appendChild(moveUp);\n      actions.appendChild(moveDown);\n    }\n\n    const collapseBtn = document.createElement('button');\n    collapseBtn.type = 'button';\n    collapseBtn.className = 'text-xs text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white';\n    collapseBtn.textContent = 'Collapse';\n    collapseBtn.setAttribute('data-block-collapse', 'true');\n\n    const removeBtn = document.createElement('button');\n    removeBtn.type = 'button';\n    removeBtn.className = 'text-xs text-red-600 hover:text-red-700';\n    removeBtn.textContent = 'Remove';\n    removeBtn.setAttribute('data-block-remove', 'true');\n\n    actions.appendChild(collapseBtn);\n    actions.appendChild(removeBtn);\n\n    if (sortable) {\n      const dragHandle = document.createElement('span');\n      dragHandle.className = 'text-xs text-gray-400 cursor-move';\n      dragHandle.textContent = 'Drag';\n      dragHandle.setAttribute('data-block-drag-handle', 'true');\n      actions.appendChild(dragHandle);\n    }\n\n    header.appendChild(titleWrap);\n    header.appendChild(actions);\n\n    const body = document.createElement('div');\n    body.className = 'p-4 space-y-4';\n    body.setAttribute('data-block-body', 'true');\n\n    const fragment = template.template.content.cloneNode(true) as DocumentFragment;\n    body.appendChild(fragment);\n\n    wrapper.appendChild(header);\n    wrapper.appendChild(body);\n\n    ensureTypeField(wrapper, template.type);\n    ensureSchemaField(wrapper, template.schemaVersion || generateSchemaVersion(template.type));\n    wrapper.dataset.blockSchema = template.schemaVersion || generateSchemaVersion(template.type);\n\n    if (values) {\n      fillValues(wrapper, values);\n    }\n\n    const shouldCollapse = template.collapsed ?? false;\n    if (shouldCollapse) {\n      body.classList.add('hidden');\n      wrapper.dataset.blockCollapsed = 'true';\n      collapseBtn.textContent = 'Expand';\n    }\n\n    return wrapper;\n  };\n\n  const addBlock = (type: string, values?: Record<string, any>) => {\n    const template = templates.get(type);\n    if (!template) return;\n    const item = createBlockItem(template, values);\n    list.appendChild(item);\n    syncAll();\n  };\n\n  const addButton = elements.addButton;\n  const addSelect = elements.addSelect;\n  if (addButton && addSelect) {\n    addButton.addEventListener('click', () => {\n      const type = addSelect.value.trim();\n      if (type) {\n        addBlock(type);\n        addSelect.value = '';\n      }\n    });\n  }\n\n  root.addEventListener('click', (event) => {\n    const target = event.target;\n    if (!(target instanceof HTMLElement)) return;\n    const item = target.closest<HTMLElement>('[data-block-item]');\n    if (!item) return;\n    if (target.closest('[data-block-remove]')) {\n      item.remove();\n      syncAll();\n      return;\n    }\n    if (target.closest('[data-block-collapse]')) {\n      const body = item.querySelector<HTMLElement>('[data-block-body]');\n      if (body) {\n        const isCollapsed = body.classList.toggle('hidden');\n        item.dataset.blockCollapsed = isCollapsed ? 'true' : 'false';\n        const button = target.closest<HTMLButtonElement>('[data-block-collapse]');\n        if (button) button.textContent = isCollapsed ? 'Expand' : 'Collapse';\n      }\n      return;\n    }\n    if (target.closest('[data-block-move-up]')) {\n      const prev = item.previousElementSibling;\n      if (prev) list.insertBefore(item, prev);\n      syncAll();\n      return;\n    }\n    if (target.closest('[data-block-move-down]')) {\n      const next = item.nextElementSibling;\n      if (next) list.insertBefore(next, item);\n      syncAll();\n      return;\n    }\n  });\n\n  root.addEventListener('input', (event) => {\n    const target = event.target;\n    if (!(target instanceof HTMLElement) || !target.closest('[data-block-item]')) return;\n    syncAll();\n  });\n  root.addEventListener('change', (event) => {\n    const target = event.target;\n    if (!(target instanceof HTMLElement) || !target.closest('[data-block-item]')) return;\n    syncAll();\n  });\n\n  if (sortable && allowDrag) {\n    let dragging: HTMLElement | null = null;\n    list.addEventListener('dragstart', (event) => {\n      const target = event.target;\n      if (!(target instanceof HTMLElement)) return;\n      const handle = target.closest('[data-block-drag-handle]');\n      if (!handle) {\n        event.preventDefault();\n        return;\n      }\n      const item = target.closest<HTMLElement>('[data-block-item]');\n      if (!item) return;\n      dragging = item;\n      item.classList.add('opacity-70');\n      event.dataTransfer?.setData('text/plain', 'block');\n    });\n    list.addEventListener('dragover', (event) => {\n      if (!dragging) return;\n      event.preventDefault();\n      const target = event.target instanceof HTMLElement ? event.target.closest<HTMLElement>('[data-block-item]') : null;\n      if (!target || target === dragging) return;\n      const rect = target.getBoundingClientRect();\n      const shouldInsertAfter = event.clientY > rect.top + rect.height / 2;\n      list.insertBefore(dragging, shouldInsertAfter ? target.nextSibling : target);\n    });\n    list.addEventListener('dragend', () => {\n      if (!dragging) return;\n      dragging.classList.remove('opacity-70');\n      dragging = null;\n      syncAll();\n    });\n  }\n\n  if (elements.addSelect) {\n    const placeholder = document.createElement('option');\n    placeholder.value = '';\n    placeholder.textContent = 'Select block type';\n    elements.addSelect.appendChild(placeholder);\n    templates.forEach((template) => {\n      const option = document.createElement('option');\n      option.value = template.type;\n      option.textContent = template.label;\n      elements.addSelect?.appendChild(option);\n    });\n    elements.addSelect.value = '';\n  }\n\n  // Keyboard accessibility\n  root.addEventListener('keydown', (event) => {\n    const target = event.target;\n    if (!(target instanceof HTMLElement)) return;\n    const item = target.closest<HTMLElement>('[data-block-item]');\n    if (!item) return;\n\n    const isHeader = target.closest('[data-block-header]');\n    if (!isHeader) return;\n\n    switch (event.key) {\n      case 'Delete':\n      case 'Backspace':\n        if (event.shiftKey) {\n          event.preventDefault();\n          item.remove();\n          syncAll();\n          // Focus next or previous item\n          const next = list.querySelector<HTMLElement>('[data-block-item] [data-block-header]');\n          next?.focus();\n        }\n        break;\n      case 'ArrowUp':\n        if (event.altKey && sortable) {\n          event.preventDefault();\n          const prev = item.previousElementSibling;\n          if (prev) {\n            list.insertBefore(item, prev);\n            syncAll();\n            (item.querySelector('[data-block-header]') as HTMLElement)?.focus();\n          }\n        } else if (!event.altKey) {\n          event.preventDefault();\n          const prevItem = item.previousElementSibling as HTMLElement;\n          const prevHeader = prevItem?.querySelector<HTMLElement>('[data-block-header]');\n          prevHeader?.focus();\n        }\n        break;\n      case 'ArrowDown':\n        if (event.altKey && sortable) {\n          event.preventDefault();\n          const next = item.nextElementSibling;\n          if (next) {\n            list.insertBefore(next, item);\n            syncAll();\n            (item.querySelector('[data-block-header]') as HTMLElement)?.focus();\n          }\n        } else if (!event.altKey) {\n          event.preventDefault();\n          const nextItem = item.nextElementSibling as HTMLElement;\n          const nextHeader = nextItem?.querySelector<HTMLElement>('[data-block-header]');\n          nextHeader?.focus();\n        }\n        break;\n      case 'Enter':\n      case ' ':\n        if (target.matches('[data-block-collapse]')) {\n          event.preventDefault();\n          target.click();\n        } else if (target.matches('[data-block-remove]')) {\n          event.preventDefault();\n          target.click();\n        } else if (target.matches('[data-block-move-up]')) {\n          event.preventDefault();\n          target.click();\n        } else if (target.matches('[data-block-move-down]')) {\n          event.preventDefault();\n          target.click();\n        } else if (isHeader && !target.matches('button')) {\n          // Toggle collapse when pressing Enter on header\n          event.preventDefault();\n          const collapseBtn = item.querySelector<HTMLButtonElement>('[data-block-collapse]');\n          collapseBtn?.click();\n        }\n        break;\n      case 'Escape':\n        // Collapse the block\n        const body = item.querySelector<HTMLElement>('[data-block-body]');\n        if (body && !body.classList.contains('hidden')) {\n          event.preventDefault();\n          body.classList.add('hidden');\n          item.dataset.blockCollapsed = 'true';\n          const collapseBtn = item.querySelector<HTMLButtonElement>('[data-block-collapse]');\n          if (collapseBtn) collapseBtn.textContent = 'Expand';\n        }\n        break;\n    }\n  });\n\n  // Make block headers focusable for keyboard navigation\n  const makeHeadersFocusable = () => {\n    list.querySelectorAll<HTMLElement>('[data-block-header]').forEach((header) => {\n      if (!header.hasAttribute('tabindex')) {\n        header.setAttribute('tabindex', '0');\n        header.setAttribute('role', 'button');\n        header.setAttribute('aria-label', 'Block header - Press Enter to collapse/expand, Shift+Delete to remove');\n      }\n    });\n  };\n\n  // Observe for new blocks to make their headers focusable\n  const observer = new MutationObserver(() => {\n    makeHeadersFocusable();\n  });\n  observer.observe(list, { childList: true, subtree: true });\n\n  const initialValue = output.value?.trim();\n  let embeddedBlocks: any[] = [];\n  if (initialValue) {\n    try {\n      const parsed = JSON.parse(initialValue) as any;\n      if (Array.isArray(parsed)) {\n        embeddedBlocks = parsed;\n        parsed.forEach((entry) => {\n          const type = typeof entry === 'object' && entry ? (entry._type as string) : '';\n          if (type && templates.has(type)) {\n            addBlock(type, entry);\n          }\n        });\n      }\n    } catch {\n      // ignore malformed data\n    }\n  }\n\n  // Conflict detection\n  const showConflicts = config.showConflicts ?? true;\n  if (showConflicts && config.legacyBlocks && Array.isArray(config.legacyBlocks)) {\n    const report = detectBlockConflicts(embeddedBlocks, config.legacyBlocks);\n    if (report.hasConflicts) {\n      showConflictReport(root, report);\n    }\n  }\n\n  // Also check for legacy blocks from data attribute\n  const legacyBlocksAttr = root.dataset.blockLegacy;\n  if (showConflicts && legacyBlocksAttr) {\n    try {\n      const legacyBlocks = JSON.parse(legacyBlocksAttr);\n      if (Array.isArray(legacyBlocks)) {\n        const report = detectBlockConflicts(embeddedBlocks, legacyBlocks);\n        if (report.hasConflicts) {\n          showConflictReport(root, report);\n        }\n      }\n    } catch {\n      // ignore malformed legacy data\n    }\n  }\n\n  syncAll();\n}\n\nexport function initBlockEditors(scope: ParentNode = document): void {\n  const roots = Array.from(scope.querySelectorAll<HTMLElement>('[data-component=\"block\"], [data-block-editor]'));\n  roots.forEach((root) => initBlockEditor(root));\n}\n\nfunction onReady(fn: () => void): void {\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', fn, { once: true });\n  } else {\n    fn();\n  }\n}\n\nonReady(() => initBlockEditors());\n"],"names":["parseConfig","raw","parsed","resolveConfig","root","configRoot","parseBoolean","value","normalized","resolveElements","list","output","addSelect","addButton","emptyState","toPathParts","part","buildInputName","base","index","parts","result","getByPath","data","rawPath","current","setByPath","target","idx","isLast","nextPart","nextIsIndex","readFieldValue","elements","first","opt","checked","el","setFieldValue","element","values","collectTemplates","config","templates","template","type","label","icon","collapsed","schemaVersion","generateSchemaVersion","requiredFieldsRaw","requiredFields","pattern","validateBlock","item","errors","fieldName","field","isEmpty","radioGroup","r","showBlockErrors","clearBlockErrors","header","errorBadge","error","wrapper","errorMsg","detectBlockConflicts","embedded","legacy","conflicts","maxLen","i","embBlock","legBlock","blockType","allKeys","key","embVal","legVal","deepEqual","a","b","val","keysA","keysB","createConflictReportUI","report","container","title","summary","details","summaryEl","conflict","more","actions","dismissBtn","showConflictReport","reportUI","ensureTypeField","inputs","hidden","input","ensureSchemaField","initBlockEditor","baseName","sortableHint","sortable","allowDrag","addLabel","emptyLabel","validateOnInput","syncOutput","items","hasValidationErrors","payload","groups","group","updateNames","original","updateEmptyState","hasItems","syncAll","form","fillValues","createBlockItem","titleWrap","typeBadge","moveUp","moveDown","collapseBtn","removeBtn","dragHandle","body","fragment","addBlock","event","isCollapsed","button","prev","next","dragging","rect","shouldInsertAfter","placeholder","option","isHeader","makeHeadersFocusable","initialValue","embeddedBlocks","entry","showConflicts","legacyBlocksAttr","legacyBlocks","initBlockEditors","scope","onReady","fn"],"mappings":"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"}