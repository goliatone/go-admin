{"version":3,"file":"schema_editor.js","sources":["../../src/formgen/schema_editor.ts"],"sourcesContent":["/**\n * Schema editor component.\n * Adds JSON formatting, validation, and metadata helpers for schema payloads.\n */\n(() => {\n  const slugify = (value: string): string =>\n    value\n      .toLowerCase()\n      .trim()\n      .replace(/[^a-z0-9]+/g, '_')\n      .replace(/^_+|_+$/g, '') || 'block';\n\n  const guessSchemaVersion = (root: HTMLElement): string => {\n    const form = root.closest('form');\n    if (!form) {\n      return 'block@v1.0.0';\n    }\n    const candidates = [\n      'input[name=\"name\"]',\n      'input[name=\"type\"]',\n      'input[name=\"slug\"]',\n    ];\n    for (const selector of candidates) {\n      const input = form.querySelector<HTMLInputElement>(selector);\n      const value = input?.value?.trim();\n      if (value) {\n        return `${slugify(value)}@v1.0.0`;\n      }\n    }\n    return 'block@v1.0.0';\n  };\n\n  const parsePayload = (raw: string): { value: any; error?: string } => {\n    const trimmed = raw.trim();\n    if (!trimmed) {\n      return { value: {} };\n    }\n    try {\n      return { value: JSON.parse(trimmed) };\n    } catch (err) {\n      const msg = err instanceof Error ? err.message : 'Invalid JSON';\n      return { value: null, error: msg };\n    }\n  };\n\n  const formatPayload = (payload: any): string => JSON.stringify(payload, null, 2);\n\n  const ensureMetadata = (payload: any, version: string): any => {\n    const root = payload && typeof payload === 'object' ? payload : {};\n    const meta = (root.metadata && typeof root.metadata === 'object' && !Array.isArray(root.metadata))\n      ? root.metadata\n      : {};\n    if (!meta.schema_version) {\n      meta.schema_version = version;\n    }\n    root.metadata = meta;\n    return root;\n  };\n\n  const setStatus = (root: HTMLElement, message: string, state: 'ok' | 'error' | '') => {\n    const status = root.querySelector<HTMLElement>('[data-schema-status]');\n    if (!status) {\n      return;\n    }\n    status.textContent = message;\n    status.dataset.state = state;\n    status.classList.remove('text-green-600', 'text-red-600');\n    if (state === 'ok') {\n      status.classList.add('text-green-600');\n    } else if (state === 'error') {\n      status.classList.add('text-red-600');\n    }\n  };\n\n  const initSchemaEditor = () => {\n    document.querySelectorAll<HTMLElement>('[data-schema-editor]').forEach((root) => {\n      const textarea = root.querySelector<HTMLTextAreaElement>('[data-schema-input]');\n      if (!textarea) {\n        return;\n      }\n\n      const formatBtn = root.querySelector<HTMLButtonElement>('[data-schema-format]');\n      const validateBtn = root.querySelector<HTMLButtonElement>('[data-schema-validate]');\n      const metadataBtn = root.querySelector<HTMLButtonElement>('[data-schema-metadata]');\n\n      formatBtn?.addEventListener('click', () => {\n        const parsed = parsePayload(textarea.value);\n        if (parsed.error) {\n          setStatus(root, parsed.error, 'error');\n          return;\n        }\n        textarea.value = formatPayload(parsed.value);\n        setStatus(root, 'Formatted', 'ok');\n      });\n\n      validateBtn?.addEventListener('click', () => {\n        const parsed = parsePayload(textarea.value);\n        if (parsed.error) {\n          setStatus(root, parsed.error, 'error');\n          return;\n        }\n        setStatus(root, 'Valid JSON', 'ok');\n      });\n\n      metadataBtn?.addEventListener('click', () => {\n        const parsed = parsePayload(textarea.value);\n        if (parsed.error) {\n          setStatus(root, parsed.error, 'error');\n          return;\n        }\n        const version = guessSchemaVersion(root);\n        const updated = ensureMetadata(parsed.value, version);\n        textarea.value = formatPayload(updated);\n        setStatus(root, 'Metadata inserted', 'ok');\n      });\n\n      textarea.addEventListener('input', () => {\n        setStatus(root, '', '');\n      });\n    });\n  };\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', initSchemaEditor);\n  } else {\n    initSchemaEditor();\n  }\n})();\n"],"names":["slugify","value","guessSchemaVersion","root","form","candidates","selector","parsePayload","raw","trimmed","err","formatPayload","payload","ensureMetadata","version","meta","setStatus","message","state","status","initSchemaEditor","textarea","formatBtn","validateBtn","metadataBtn","parsed","updated"],"mappings":"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"}