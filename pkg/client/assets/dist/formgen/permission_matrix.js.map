{"version":3,"file":"permission_matrix.js","sources":["../../src/formgen/permission_matrix.ts"],"sourcesContent":["/**\n * Permission matrix component.\n * Syncs checkbox state and extra permissions into a hidden input.\n */\n(() => {\n  const parsePermissionList = (raw?: string) =>\n    (raw || \"\")\n      .split('\\n')\n      .map((item) => item.trim())\n      .filter((item) => item.length > 0);\n\n  const normalizePermission = (raw?: string) => (raw || \"\").trim();\n\n  const initPermissionMatrix = () => {\n    document.querySelectorAll<HTMLElement>('.permission-matrix').forEach((matrix) => {\n      const hidden = matrix.querySelector<HTMLInputElement>('.permission-matrix-value');\n      const checkboxes = matrix.querySelectorAll<HTMLInputElement>('.perm-checkbox');\n      const extraSelect = matrix.querySelector<HTMLSelectElement>('select.permission-matrix-extra');\n      const extraTextarea = matrix.querySelector<HTMLTextAreaElement>('textarea.permission-matrix-extra');\n      const extraInput = matrix.querySelector<HTMLInputElement>('.permission-matrix-extra-input');\n      const extraAdd = matrix.querySelector<HTMLButtonElement>('.permission-matrix-extra-add');\n      const checkboxMap: Record<string, HTMLInputElement> = {};\n\n      checkboxes.forEach((cb) => {\n        const perm = cb.dataset.permission;\n        if (perm) {\n          checkboxMap[perm] = cb;\n        }\n      });\n\n      if (!hidden || checkboxes.length === 0) {\n        return;\n      }\n\n      const collectExtraPermissions = () => {\n        if (extraSelect) {\n          const extras: string[] = [];\n          const seen: Record<string, boolean> = {};\n\n          Array.from(extraSelect.selectedOptions).forEach((option) => {\n            const perm = normalizePermission(option.value);\n            if (!perm) {\n              return;\n            }\n            const target = checkboxMap[perm];\n            if (target) {\n              target.checked = true;\n              return;\n            }\n            if (!seen[perm]) {\n              seen[perm] = true;\n              extras.push(perm);\n            }\n          });\n\n          return extras;\n        }\n\n        let raw = \"\";\n        if (extraTextarea) {\n          raw = extraTextarea.value || \"\";\n        } else if (matrix.dataset.extraPermissions) {\n          raw = matrix.dataset.extraPermissions || \"\";\n        }\n\n        const extras: string[] = [];\n        const seen: Record<string, boolean> = {};\n        parsePermissionList(raw).forEach((perm) => {\n          const target = checkboxMap[perm];\n          if (target) {\n            target.checked = true;\n            return;\n          }\n          if (!seen[perm]) {\n            seen[perm] = true;\n            extras.push(perm);\n          }\n        });\n        return extras;\n      };\n\n      const syncPermissions = () => {\n        const perms: string[] = [];\n        const seen: Record<string, boolean> = {};\n\n        collectExtraPermissions().forEach((perm) => {\n          if (!seen[perm]) {\n            seen[perm] = true;\n            perms.push(perm);\n          }\n        });\n\n        checkboxes.forEach((cb) => {\n          if (cb.checked && cb.dataset.permission) {\n            if (!seen[cb.dataset.permission]) {\n              seen[cb.dataset.permission] = true;\n              perms.push(cb.dataset.permission);\n            }\n          }\n        });\n\n        hidden.value = perms.join('\\n');\n      };\n\n      const addExtraPermission = (raw: string) => {\n        const permission = normalizePermission(raw);\n        if (!permission) {\n          return;\n        }\n\n        const target = checkboxMap[permission];\n        if (target) {\n          target.checked = true;\n          syncPermissions();\n          return;\n        }\n\n        if (extraSelect) {\n          let option = Array.from(extraSelect.options).find((item) => normalizePermission(item.value) === permission);\n          if (!option) {\n            option = document.createElement(\"option\");\n            option.value = permission;\n            option.textContent = permission;\n            extraSelect.appendChild(option);\n          }\n          option.selected = true;\n          extraSelect.dispatchEvent(new Event(\"change\", { bubbles: true }));\n          return;\n        }\n\n        if (extraTextarea) {\n          const existing = parsePermissionList(extraTextarea.value || \"\");\n          if (!existing.includes(permission)) {\n            existing.push(permission);\n            extraTextarea.value = existing.join(\"\\n\");\n          }\n          extraTextarea.dispatchEvent(new Event(\"input\", { bubbles: true }));\n        }\n      };\n\n      const submitExtraInput = () => {\n        if (!extraInput) {\n          return;\n        }\n        const value = extraInput.value;\n        addExtraPermission(value);\n        extraInput.value = \"\";\n      };\n\n      checkboxes.forEach((cb) => {\n        cb.addEventListener('change', syncPermissions);\n      });\n      if (extraSelect) {\n        extraSelect.addEventListener(\"change\", syncPermissions);\n      }\n      if (extraTextarea) {\n        extraTextarea.addEventListener('input', syncPermissions);\n      }\n      if (extraAdd) {\n        extraAdd.addEventListener(\"click\", submitExtraInput);\n      }\n      if (extraInput) {\n        extraInput.addEventListener(\"keydown\", (event) => {\n          if (event.key === \"Enter\" || event.key === \",\") {\n            event.preventDefault();\n            submitExtraInput();\n          }\n        });\n      }\n\n      syncPermissions();\n    });\n  };\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', initPermissionMatrix);\n  } else {\n    initPermissionMatrix();\n  }\n})();\n"],"names":["parsePermissionList","raw","item","normalizePermission","initPermissionMatrix","matrix","hidden","checkboxes","extraSelect","extraTextarea","extraInput","extraAdd","checkboxMap","cb","perm","collectExtraPermissions","extras","seen","option","target","syncPermissions","perms","addExtraPermission","permission","existing","submitExtraInput","value","event"],"mappings":"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"}