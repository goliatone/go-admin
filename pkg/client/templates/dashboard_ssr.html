{% extends "layout.html" %}

{% block title %}Dashboard - {{ title }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ asset_base_path }}/assets/dist/styles/widgets.css">
{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-admin-dark">Dashboard</h1>
  <div class="flex gap-3">
    <button id="dashboard-export" class="btn btn-secondary">â†‘ Export</button>
  </div>
</header>

<div id="save-status" class="px-8 py-3 bg-blue-50 text-blue-900 text-sm border-b border-blue-200">
  Drag widgets to rearrange, resize, or hide them. Changes save automatically.
</div>

<div class="flex-1 p-8 overflow-y-auto" data-widget-grid>
  <div class="dashboard-grid grid grid-cols-1 lg:grid-cols-3 gap-8">
    <section class="widget-area lg:col-span-2" data-area-code="admin.dashboard.main">
      <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Main Dashboard</h2>
      <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.main">
        {% for area in areas %}
          {% if area.code == "admin.dashboard.main" %}
            {% for widget in area.widgets %}
              {% include "dashboard_widget.html" %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      </div>
    </section>

    <aside class="widget-area" data-area-code="admin.dashboard.sidebar">
      <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Sidebar</h2>
      <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.sidebar">
        {% for area in areas %}
          {% if area.code == "admin.dashboard.sidebar" %}
            {% for widget in area.widgets %}
              {% include "dashboard_widget.html" %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      </div>
    </aside>

    <section class="widget-area lg:col-span-3" data-area-code="admin.dashboard.footer">
      <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Operations</h2>
      <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.footer">
        {% for area in areas %}
          {% if area.code == "admin.dashboard.footer" %}
            {% for widget in area.widgets %}
              {% include "dashboard_widget.html" %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      </div>
    </section>
  </div>
</div>

<script type="application/json" id="dashboard-state">
  {{ layout_json|safe }}
</script>
{% endblock %}

{% block scripts %}
<script type="module">
  import { WidgetGrid } from '{{ asset_base_path }}/assets/dist/dashboard/index.js';

  const chartScriptCache = new Map();
  const chartResizeObservers = new WeakMap();

  function normalizeChartAssetsHost(rawHost) {
    const trimmed = (rawHost || '').trim();
    if (!trimmed) {
      return '/dashboard/assets/echarts/';
    }
    return trimmed.endsWith('/') ? trimmed : `${trimmed}/`;
  }

  function ensureScript(src) {
    if (!src) {
      return Promise.resolve();
    }
    if (chartScriptCache.has(src)) {
      return chartScriptCache.get(src);
    }
    const existing = document.querySelector(`script[src="${src}"]`);
    if (existing) {
      const done = Promise.resolve();
      chartScriptCache.set(src, done);
      return done;
    }
    const pending = new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.async = true;
      script.onload = () => resolve();
      script.onerror = () => reject(new Error(`Failed to load chart asset: ${src}`));
      document.head.appendChild(script);
    });
    chartScriptCache.set(src, pending);
    return pending;
  }

  async function ensureEChartsAssets(theme, assetsHost) {
    const host = normalizeChartAssetsHost(assetsHost);
    await ensureScript(`${host}echarts.min.js`);
    if (theme && theme !== 'default') {
      await ensureScript(`${host}themes/${theme}.js`);
    }
  }

  function parseChartOptions(container) {
    const payloadEl = container.querySelector('script[data-chart-options]');
    if (!payloadEl?.textContent) {
      return null;
    }
    try {
      return JSON.parse(payloadEl.textContent);
    } catch (error) {
      console.error('Failed to parse chart options', error);
      return null;
    }
  }

  function mountChart(container) {
    const targetId = container.dataset.chartId;
    const theme = (container.dataset.chartTheme || 'westeros').trim();
    const options = parseChartOptions(container);
    const target = targetId ? document.getElementById(targetId) : null;
    if (!target || !options || !window.echarts) {
      return;
    }

    const chart = window.echarts.getInstanceByDom(target) || window.echarts.init(target, theme, { renderer: 'canvas' });
    chart.setOption(options, true);

    if (!chartResizeObservers.has(container) && window.ResizeObserver) {
      const observer = new ResizeObserver(() => {
        try {
          chart.resize();
        } catch (resizeError) {
          console.warn('Chart resize failed', resizeError);
        }
      });
      observer.observe(target);
      chartResizeObservers.set(container, observer);
    }
  }

  async function hydrateSSRCharts() {
    const containers = document.querySelectorAll('[data-echart-widget]');
    for (const container of containers) {
      const theme = (container.dataset.chartTheme || 'westeros').trim();
      const assetsHost = container.dataset.chartAssetsHost || '';
      try {
        await ensureEChartsAssets(theme, assetsHost);
        mountChart(container);
      } catch (error) {
        console.error('Failed to hydrate chart widget', error);
      }
    }
  }

  async function initDashboard() {
    try {
      const stateEl = document.getElementById('dashboard-state');
      const dashboardState = stateEl ? JSON.parse(stateEl.textContent) : null;

      const apiBasePath = '{{ api_base_path|default:"" }}';
      const basePath = '{{ base_path }}';
      const dashboardApi = apiBasePath ? `${apiBasePath}/dashboard` : `${basePath}/api/dashboard`;

      const exportBtn = document.getElementById('dashboard-export');
      if (exportBtn) {
        exportBtn.addEventListener('click', () => window.open(dashboardApi));
      }

      await hydrateSSRCharts();

      const grid = new WidgetGrid({
        apiEndpoint: dashboardApi,
        preferencesEndpoint: `${dashboardApi}/preferences`,
        areas: ['admin.dashboard.main', 'admin.dashboard.sidebar', 'admin.dashboard.footer'],
        selectors: {
          hideBtn: '.hide-widget',
          resizeBtn: '.resize-widget',
        },
        onSave: (layout) => {
          console.log('Layout saved:', layout);
        },
        onError: (error) => {
          console.error('Widget grid error:', error);
          const statusEl = document.getElementById('save-status');
          if (statusEl) {
            statusEl.textContent = 'Failed to save layout';
          }
        },
      });

      await grid.init(dashboardState);
      await hydrateSSRCharts();
    } catch (error) {
      console.error('Failed to initialize dashboard:', error);
    }
  }

  window.addEventListener('DOMContentLoaded', initDashboard);
</script>
{% endblock %}
