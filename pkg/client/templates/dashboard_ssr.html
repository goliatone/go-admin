<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Enterprise Admin</title>
  <link rel="stylesheet" href="{{ base_path }}/assets/output.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/iconoir-icons/iconoir@main/css/iconoir.css">
  <style>
/* Widget Grid System */
.widgets-grid {
  display: grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.widget {
  grid-column: span var(--span, 12);
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 0.75rem;
  padding: 1.5rem;
  cursor: grab;
  transition: all 200ms ease;
  position: relative;
}

.widget:active {
  cursor: grabbing;
}

.widget.dragging {
  opacity: 0.5;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
}

.widget[data-hidden="true"],
.widget.is-hidden {
  opacity: 0.3;
}

.widget__toolbar {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.widget__toolbar button {
  border: none;
  background: #e2e8f0;
  border-radius: 6px;
  padding: 0.2rem 0.6rem;
  cursor: pointer;
  font-size: 0.75rem;
}

.widget__toolbar button:hover:not(:disabled) {
  background: #cbd5db;
}

.widget__toolbar button:disabled {
  opacity: 0.45;
  cursor: not-allowed;
}

.widget__content {
  /* Content styling */
}

.widget-area__title {
  margin: 0;
}

/* Chart container */
.widget .chart-container {
  min-height: 250px;
}

/* Stat cards within widgets */
.widget .metrics {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.widget .metric {
  flex: 1;
  min-width: 140px;
  background: #0f172a;
  color: #f8fafc;
  border-radius: 0.625rem;
  padding: 0.875rem 1rem;
}

.widget .metric small {
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 0.7rem;
  color: #cbd5f5;
}

.widget .metric span {
  display: block;
  font-size: 1.4rem;
  font-weight: 600;
  margin-top: 0.3rem;
}
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
    <h1 class="text-3xl font-bold text-admin-dark">Dashboard</h1>
    <div class="flex gap-3">
      <button class="btn btn-secondary" onclick="window.open('{{ base_path }}/api/dashboard')">â†‘ Export</button>
    </div>
  </header>

  <!-- Save status indicator -->
  <div id="save-status" class="px-8 py-3 bg-blue-50 text-blue-900 text-sm border-b border-blue-200">
    Drag widgets to rearrange, resize, or hide them. Changes save automatically.
  </div>

  <div class="flex-1 p-8 overflow-y-auto" data-widget-grid>
    <!-- Widget Grid Container -->
    <div class="dashboard-grid grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Main Area -->
      <section class="widget-area lg:col-span-2" data-area-code="admin.dashboard.main">
        <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Main Dashboard</h2>
        <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.main">
          {% for area in areas %}
            {% if area.code == "admin.dashboard.main" %}
              {% for widget in area.widgets %}
                {% include "dashboard_widget.html" %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      </section>

      <!-- Sidebar Area -->
      <aside class="widget-area" data-area-code="admin.dashboard.sidebar">
        <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Sidebar</h2>
        <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.sidebar">
          {% for area in areas %}
            {% if area.code == "admin.dashboard.sidebar" %}
              {% for widget in area.widgets %}
                {% include "dashboard_widget.html" %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      </aside>

      <!-- Footer/Operations Area -->
      <section class="widget-area lg:col-span-3" data-area-code="admin.dashboard.footer">
        <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Operations</h2>
        <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.footer">
          {% for area in areas %}
            {% if area.code == "admin.dashboard.footer" %}
              {% for widget in area.widgets %}
                {% include "dashboard_widget.html" %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      </section>

    </div>
  </div>

  <!-- Inline Layout State for Hydration -->
  <script type="application/json" id="dashboard-state">
    {{ layout_json|safe }}
  </script>

  <script type="module">
    import { WidgetGrid } from '{{ base_path }}/assets/dist/dashboard/index.js';

    // Initialize dashboard with hydration from inline state
    async function initDashboard() {
      try {
        // Parse inline state
        const stateEl = document.getElementById('dashboard-state');
        const dashboardState = stateEl ? JSON.parse(stateEl.textContent) : null;

        // Initialize widget grid with drag & drop
        const grid = new WidgetGrid({
          apiEndpoint: '{{ base_path }}/api/dashboard',
          preferencesEndpoint: '{{ base_path }}/api/dashboard/preferences',
          areas: ['admin.dashboard.main', 'admin.dashboard.sidebar', 'admin.dashboard.footer'],
          selectors: {
            hideBtn: '.hide-widget',
            resizeBtn: '.resize-widget',
          },
          onSave: (layout) => {
            console.log('Layout saved:', layout);
          },
          onError: (error) => {
            console.error('Widget grid error:', error);
            document.getElementById('save-status').textContent = 'Failed to save layout';
          }
        });

        // Initialize with server-rendered state (hydration mode)
        await grid.init(dashboardState);

      } catch (error) {
        console.error('Failed to initialize dashboard:', error);
      }
    }

    // Load dashboard on page load
    window.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>

