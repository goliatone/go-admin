<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Enterprise Admin</title>
  <link rel="stylesheet" href="{{ base_path }}/assets/output.css">
  <link rel="stylesheet" href="{{ base_path }}/assets/dist/styles/widgets.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/iconoir-icons/iconoir@main/css/iconoir.css">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
    <h1 class="text-3xl font-bold text-admin-dark">Dashboard</h1>
    <div class="flex gap-3">
      <button id="dashboard-export" class="btn btn-secondary">â†‘ Export</button>
    </div>
  </header>

  <!-- Save status indicator -->
  <div id="save-status" class="px-8 py-3 bg-blue-50 text-blue-900 text-sm border-b border-blue-200">
    Drag widgets to rearrange, resize, or hide them. Changes save automatically.
  </div>

  <div class="flex-1 p-8 overflow-y-auto" data-widget-grid>
    <!-- Widget Grid Container -->
    <div class="dashboard-grid grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Main Area -->
      <section class="widget-area lg:col-span-2" data-area-code="admin.dashboard.main">
        <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Main Dashboard</h2>
        <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.main">
          {% for area in areas %}
            {% if area.code == "admin.dashboard.main" %}
              {% for widget in area.widgets %}
                {% include "dashboard_widget.html" %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      </section>

      <!-- Sidebar Area -->
      <aside class="widget-area" data-area-code="admin.dashboard.sidebar">
        <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Sidebar</h2>
        <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.sidebar">
          {% for area in areas %}
            {% if area.code == "admin.dashboard.sidebar" %}
              {% for widget in area.widgets %}
                {% include "dashboard_widget.html" %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      </aside>

      <!-- Footer/Operations Area -->
      <section class="widget-area lg:col-span-3" data-area-code="admin.dashboard.footer">
        <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Operations</h2>
        <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.footer">
          {% for area in areas %}
            {% if area.code == "admin.dashboard.footer" %}
              {% for widget in area.widgets %}
                {% include "dashboard_widget.html" %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      </section>

    </div>
  </div>

  <!-- Inline Layout State for Hydration -->
  <script type="application/json" id="dashboard-state">
    {{ layout_json|safe }}
  </script>

  <script type="module">
    import { WidgetGrid } from '{{ base_path }}/assets/dist/dashboard/index.js';

    // Initialize dashboard with hydration from inline state
    async function initDashboard() {
      try {
        // Parse inline state
        const stateEl = document.getElementById('dashboard-state');
        const dashboardState = stateEl ? JSON.parse(stateEl.textContent) : null;

        // Initialize widget grid with drag & drop
        const apiBasePath = '{{ api_base_path|default:"" }}';
        const basePath = '{{ base_path }}';
        const dashboardApi = apiBasePath ? `${apiBasePath}/dashboard` : `${basePath}/api/dashboard`;

        const exportBtn = document.getElementById('dashboard-export');
        if (exportBtn) {
          exportBtn.addEventListener('click', () => window.open(dashboardApi));
        }

        const grid = new WidgetGrid({
          apiEndpoint: dashboardApi,
          preferencesEndpoint: `${dashboardApi}/preferences`,
          areas: ['admin.dashboard.main', 'admin.dashboard.sidebar', 'admin.dashboard.footer'],
          selectors: {
            hideBtn: '.hide-widget',
            resizeBtn: '.resize-widget',
          },
          onSave: (layout) => {
            console.log('Layout saved:', layout);
          },
          onError: (error) => {
            console.error('Widget grid error:', error);
            document.getElementById('save-status').textContent = 'Failed to save layout';
          }
        });

        // Initialize with server-rendered state (hydration mode)
        await grid.init(dashboardState);

      } catch (error) {
        console.error('Failed to initialize dashboard:', error);
      }
    }

    // Load dashboard on page load
    window.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>
