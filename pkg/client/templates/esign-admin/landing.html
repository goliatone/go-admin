{% extends "layout.html" %}

{% block title %}E-Sign - {{ title }}{% endblock %}

{% block content %}
{% set agreements_index = adminURL("content/esign_agreements") %}
{% set agreements_new = adminURL("content/esign_agreements/new") %}
{% set documents_index = adminURL("content/esign_documents") %}
{% set documents_new = adminURL("content/esign_documents/new") %}
{% set google_integration = adminURL("esign/integrations/google") %}
<header class="px-8 py-6 bg-white border-b border-gray-200">
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-admin-dark">E-Sign</h1>
      <p class="text-sm text-zinc-500 mt-1">Create, send, and manage digital agreements</p>
    </div>
    <div class="flex gap-3">
      <a href="{{ agreements_new }}" class="btn btn-primary" aria-label="Create new agreement">
        <i class="iconoir-plus mr-2" aria-hidden="true"></i>
        New Agreement
      </a>
    </div>
  </div>
</header>

<div class="flex-1 p-8 overflow-y-auto">
  <!-- Quick Actions -->
  <section class="mb-8" aria-labelledby="quick-actions-title">
    <h2 id="quick-actions-title" class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Quick Actions</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Upload Document -->
      <a href="{{ documents_new }}"
         class="group bg-white rounded-xl border border-gray-200 p-6 hover:border-blue-300 hover:shadow-md transition-all"
         aria-label="Upload a new document">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors">
            <i class="iconoir-upload text-blue-600 text-xl" aria-hidden="true"></i>
          </div>
          <div>
            <h3 class="font-semibold text-admin-dark group-hover:text-blue-600 transition-colors">Upload Document</h3>
            <p class="text-sm text-zinc-500 mt-1">Upload a PDF to use as a source document</p>
          </div>
        </div>
      </a>

      <!-- Create Agreement -->
      <a href="{{ agreements_new }}"
         class="group bg-white rounded-xl border border-gray-200 p-6 hover:border-green-300 hover:shadow-md transition-all"
         aria-label="Create a new agreement">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center group-hover:bg-green-100 transition-colors">
            <i class="iconoir-edit-pencil text-green-600 text-xl" aria-hidden="true"></i>
          </div>
          <div>
            <h3 class="font-semibold text-admin-dark group-hover:text-green-600 transition-colors">Create Agreement</h3>
            <p class="text-sm text-zinc-500 mt-1">Set up recipients and fields for signing</p>
          </div>
        </div>
      </a>

      <!-- View Documents -->
      <a href="{{ documents_index }}"
         class="group bg-white rounded-xl border border-gray-200 p-6 hover:border-purple-300 hover:shadow-md transition-all"
         aria-label="Browse document library">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center group-hover:bg-purple-100 transition-colors">
            <i class="iconoir-folder text-purple-600 text-xl" aria-hidden="true"></i>
          </div>
          <div>
            <h3 class="font-semibold text-admin-dark group-hover:text-purple-600 transition-colors">Document Library</h3>
            <p class="text-sm text-zinc-500 mt-1">Browse and manage uploaded documents</p>
          </div>
        </div>
      </a>
    </div>
  </section>

  <!-- Status Overview -->
  <section class="mb-8" aria-labelledby="status-overview-title">
    <h2 id="status-overview-title" class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Agreement Status</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <!-- Draft -->
      <a href="{{ agreements_index }}?status=draft"
         class="bg-white rounded-xl border border-gray-200 p-5 hover:border-gray-300 hover:shadow-sm transition-all"
         aria-label="View draft agreements">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-3 h-3 rounded-full bg-gray-400" aria-hidden="true"></div>
          <span class="text-sm font-medium text-zinc-600">Drafts</span>
        </div>
        <p class="text-2xl font-bold text-admin-dark" data-esign-count="draft">{{ stats.draft|default:0 }}</p>
      </a>

      <!-- Pending (Sent + In Progress) -->
      <a href="{{ agreements_index }}?status=sent,in_progress"
         class="bg-white rounded-xl border border-gray-200 p-5 hover:border-amber-300 hover:shadow-sm transition-all"
         aria-label="View pending agreements">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-3 h-3 rounded-full bg-amber-400" aria-hidden="true"></div>
          <span class="text-sm font-medium text-zinc-600">Pending</span>
        </div>
        <p class="text-2xl font-bold text-admin-dark" data-esign-count="pending">{{ stats.pending|default:0 }}</p>
      </a>

      <!-- Completed -->
      <a href="{{ agreements_index }}?status=completed"
         class="bg-white rounded-xl border border-gray-200 p-5 hover:border-green-300 hover:shadow-sm transition-all"
         aria-label="View completed agreements">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-3 h-3 rounded-full bg-green-500" aria-hidden="true"></div>
          <span class="text-sm font-medium text-zinc-600">Completed</span>
        </div>
        <p class="text-2xl font-bold text-admin-dark" data-esign-count="completed">{{ stats.completed|default:0 }}</p>
      </a>

      <!-- Action Required -->
      <a href="{{ agreements_index }}?action_required=true"
         class="bg-white rounded-xl border border-gray-200 p-5 hover:border-red-300 hover:shadow-sm transition-all"
         aria-label="View agreements requiring action">
        <div class="flex items-center gap-3 mb-2">
          <div class="w-3 h-3 rounded-full bg-red-500" aria-hidden="true"></div>
          <span class="text-sm font-medium text-zinc-600">Action Required</span>
        </div>
        <p class="text-2xl font-bold text-admin-dark" data-esign-count="action_required">{{ stats.action_required|default:0 }}</p>
      </a>
    </div>
  </section>

  <!-- Recent Agreements -->
  <section aria-labelledby="recent-agreements-title">
    <div class="flex items-center justify-between mb-4">
      <h2 id="recent-agreements-title" class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Recent Agreements</h2>
      <a href="{{ agreements_index }}" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
        View All
        <i class="iconoir-arrow-right ml-1" aria-hidden="true"></i>
      </a>
    </div>

    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
      {% if recent_agreements and recent_agreements|length > 0 %}
      <table class="w-full" role="table" aria-label="Recent agreements">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th scope="col" class="text-left px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Title</th>
            <th scope="col" class="text-left px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
            <th scope="col" class="text-left px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Recipients</th>
            <th scope="col" class="text-left px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Updated</th>
            <th scope="col" class="text-right px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for agreement in recent_agreements %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
              <a href="{{ agreements_index }}/{{ agreement.id }}" class="font-medium text-admin-dark hover:text-blue-600">
                {{ agreement.title }}
              </a>
            </td>
            <td class="px-6 py-4">
              {% if agreement.status == "draft" %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700">Draft</span>
              {% elif agreement.status == "sent" %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">Sent</span>
              {% elif agreement.status == "in_progress" %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">In Progress</span>
              {% elif agreement.status == "completed" %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">Completed</span>
              {% elif agreement.status == "voided" %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">Voided</span>
              {% elif agreement.status == "declined" %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">Declined</span>
              {% elif agreement.status == "expired" %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Expired</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 text-sm text-zinc-600">
              {{ agreement.recipient_count|default:0 }} recipient{% if agreement.recipient_count != 1 %}s{% endif %}
            </td>
            <td class="px-6 py-4 text-sm text-zinc-500">
              {{ agreement.updated_at }}
            </td>
            <td class="px-6 py-4 text-right">
              <a href="{{ agreements_index }}/{{ agreement.id }}"
                 class="text-blue-600 hover:text-blue-700 text-sm font-medium"
                 aria-label="View agreement {{ agreement.title }}">
                View
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="p-12 text-center">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="iconoir-doc-star text-gray-400 text-2xl" aria-hidden="true"></i>
        </div>
        <h3 class="text-lg font-medium text-admin-dark mb-2">No agreements yet</h3>
        <p class="text-sm text-zinc-500 mb-4">Get started by creating your first agreement</p>
        <a href="{{ agreements_new }}" class="btn btn-primary">
          <i class="iconoir-plus mr-2" aria-hidden="true"></i>
          Create Agreement
        </a>
      </div>
      {% endif %}
    </div>
  </section>

  {% if feature("esign_google") %}
  <!-- Google Integration Section -->
  <section class="mt-8" aria-labelledby="integrations-title">
    <h2 id="integrations-title" class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Integrations</h2>
    <div class="bg-white rounded-xl border border-gray-200 p-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-white rounded-lg border border-gray-200 flex items-center justify-center">
            <svg class="w-6 h-6" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
          </div>
          <div>
            <h3 class="font-semibold text-admin-dark">Google Drive</h3>
            <p class="text-sm text-zinc-500">Import documents directly from Google Drive</p>
          </div>
        </div>
        <a href="{{ google_integration }}" class="btn btn-secondary">
          Configure
        </a>
      </div>
    </div>
  </section>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script type="module">
// Fetch and update agreement stats dynamically
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const basePath = '{{ base_path }}';
    const apiBasePath = '{{ api_base_path|default:"" }}' || `${basePath}/api`;
    const perPage = 200;
    let page = 1;
    let total = 0;
    const allRows = [];

    while (true) {
      const params = new URLSearchParams({
        page: String(page),
        per_page: String(perPage)
      });
      const response = await fetch(`${apiBasePath}/esign_agreements?${params.toString()}`, {
        headers: { 'Accept': 'application/json' }
      });
      if (!response.ok) break;

      const payload = await response.json();
      const rows = Array.isArray(payload.items)
        ? payload.items
        : (Array.isArray(payload.records) ? payload.records : []);
      allRows.push(...rows);

      const parsedTotal = Number(payload.total);
      total = Number.isFinite(parsedTotal) && parsedTotal > 0 ? parsedTotal : allRows.length;
      if (rows.length === 0 || allRows.length >= total) break;

      page += 1;
      if (page > 25) break;
    }

    if (allRows.length > 0) {
      const counters = {};
      for (const row of allRows) {
        const status = String(row?.status || '').trim().toLowerCase();
        if (!status) continue;
        counters[status] = (counters[status] || 0) + 1;
      }

      const pending = (counters.sent || 0) + (counters.in_progress || 0);
      const actionRequired = pending + (counters.declined || 0);

      const updateCount = (key, value) => {
        const el = document.querySelector(`[data-esign-count="${key}"]`);
        if (el) el.textContent = value || 0;
      };
      updateCount('draft', counters.draft || 0);
      updateCount('pending', pending);
      updateCount('completed', counters.completed || 0);
      updateCount('action_required', actionRequired);
    }
  } catch (err) {
    console.debug('Could not fetch agreement stats:', err);
  }
});
</script>
{% endblock %}
