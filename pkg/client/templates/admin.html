{% extends "layout.html" %}

{% block title %}Dashboard - {{ title }}{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-admin-dark">Dashboard</h1>
  <div class="flex gap-3">
    <button class="btn btn-secondary" onclick="window.open('{{ base_path }}/api/dashboard')">↑ Export</button>
  </div>
</header>

<!-- Save status indicator -->
<div id="save-status" class="px-8 py-3 bg-blue-50 text-blue-900 text-sm border-b border-blue-200">
  Drag widgets to rearrange, resize, or hide them. Changes save automatically.
</div>

<div class="flex-1 p-8 overflow-y-auto" data-widget-grid>
  <!-- Widget Grid Container -->
  <div class="dashboard-grid grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Main Area -->
    <section class="widget-area lg:col-span-2" data-area-code="admin.dashboard.main">
      <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Main Dashboard</h2>
      <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.main">
        <!-- Widgets will be rendered here -->
      </div>
    </section>

    <!-- Sidebar Area -->
    <aside class="widget-area" data-area-code="admin.dashboard.sidebar">
      <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Sidebar</h2>
      <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.sidebar">
        <!-- Widgets will be rendered here -->
      </div>
    </aside>

    <!-- Footer/Operations Area -->
    <section class="widget-area lg:col-span-3" data-area-code="admin.dashboard.footer">
      <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Operations</h2>
      <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.footer">
        <!-- Widgets will be rendered here -->
      </div>
    </section>

  </div>
</div>
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ base_path }}/assets/dist/styles/widgets.css">
{% endblock %}

{% block scripts %}
<script type="module">
import { WidgetGrid } from '{{ base_path }}/assets/dist/dashboard/index.js';

const activityActionLabels = {{ toJSON(activity_action_labels)|safe }};

// Widget rendering helpers
function renderWidgetContent(widget) {
  const def = widget.definition || '';
  const data = widget.data || {};
  const config = widget.config || {};

  // User stats widget
  if (def === 'admin.widget.user_stats') {
    const values = data.values || {
      Total: data.total,
      Active: data.active,
      'New Today': data.new_today,
    };
    if (data.trend) {
      values.Trend = data.trend;
    }
    return `
      <div class="metrics">
        ${Object.entries(values).map(([key, value]) => `
          <div class="metric">
            <small>${key}</small>
            <span>${formatNumber(value)}</span>
          </div>
        `).join('')}
      </div>
    `;
  }

  if (def === 'admin.widget.settings_overview') {
    const values = data.values || {};
    const entries = Object.entries(values);
    if (entries.length === 0) {
      return '<p class="text-gray-500">No settings to display</p>';
    }
    return `
      <dl class="space-y-2">
        ${entries.map(([key, val]) => {
          const value = typeof val === 'object' && val !== null ? val.value ?? val : val;
          return `
            <div class="flex items-start justify-between gap-4">
              <dt class="text-sm text-gray-600">${key}</dt>
              <dd class="text-sm font-semibold text-gray-900">${value ?? '—'}</dd>
            </div>
          `;
        }).join('')}
      </dl>
    `;
  }

  // Activity feed widget
  if (def === 'admin.widget.activity_feed') {
    const entries = data.entries || [];
    if (entries.length === 0) {
      return '<p class="text-gray-500">No recent activity</p>';
    }
    return `
      <ul class="space-y-3">
        ${entries.map(entry => `
          <li class="py-3 border-b border-gray-100 last:border-b-0">
            <div class="font-semibold text-gray-900 text-sm">${entry.actor}</div>
            <div class="text-gray-600 text-sm mt-1">${activityActionLabels?.[entry.action] || entry.action} ${entry.object}</div>
          </li>
        `).join('')}
      </ul>
    `;
  }

  if (def === 'admin.widget.quick_actions') {
    const actions = data.actions || [];
    if (actions.length === 0) {
      return '<p class="text-gray-500">No quick actions configured</p>';
    }
    return `
      <div class="space-y-2">
        ${actions.map(action => `
          <a class="block p-3 border border-gray-200 rounded-lg hover:border-blue-200 hover:bg-blue-50/50 transition" href="${action.url || '#'}" target="_blank" rel="noreferrer">
            <div class="flex items-center justify-between gap-2">
              <div class="font-semibold text-gray-900 text-sm">${action.label || 'Action'}</div>
              ${action.method ? `<span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">${action.method}</span>` : ''}
            </div>
            ${action.description ? `<div class="text-gray-600 text-sm mt-1">${action.description}</div>` : ''}
          </a>
        `).join('')}
      </div>
    `;
  }

  // Legacy chart_sample widget - show disabled message
  if (def === 'admin.widget.chart_sample') {
    if (data.disabled) {
      return '<p class="text-gray-500 text-sm italic">This legacy chart widget has been disabled.</p>';
    }
    // Should not reach here, but fall through to default
  }

  // System health widget
  if (def === 'admin.widget.system_health') {
    return `
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600">Status:</span>
          <span class="font-semibold text-green-600">${data.status || 'unknown'}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Uptime:</span>
          <span class="font-semibold">${data.uptime || 'N/A'}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">API Latency:</span>
          <span class="font-semibold">${data.api_latency || 'N/A'}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Database:</span>
          <span class="font-semibold ${data.db_status === 'connected' ? 'text-green-600' : 'text-red-600'}">${data.db_status || 'unknown'}</span>
        </div>
      </div>
    `;
  }

  // Content stats widget
  if (def === 'admin.widget.content_stats') {
    return `
      <div class="metrics">
        <div class="metric">
          <small>Published</small>
          <span>${formatNumber(data.published || 0)}</span>
        </div>
        <div class="metric">
          <small>Draft</small>
          <span>${formatNumber(data.draft || 0)}</span>
        </div>
        <div class="metric">
          <small>Scheduled</small>
          <span>${formatNumber(data.scheduled || 0)}</span>
        </div>
      </div>
    `;
  }

  // Storage stats widget
  if (def === 'admin.widget.storage_stats') {
    return `
      <div class="metrics">
        <div class="metric">
          <small>Used</small>
          <span>${data.used || '0 GB'}</span>
        </div>
        <div class="metric">
          <small>Total</small>
          <span>${data.total || '0 GB'}</span>
        </div>
        <div class="metric">
          <small>Usage</small>
          <span>${data.percentage || '0%'}</span>
        </div>
      </div>
    `;
  }

  // Notifications widget
  if (def === 'admin.widget.notifications') {
    const notifications = data.notifications || [];
    if (notifications.length === 0) {
      return '<p class="text-gray-500">No notifications</p>';
    }
    return `
      <ul class="space-y-3">
        ${notifications.slice(0, 5).map(notif => `
          <li class="py-3 border-b border-gray-100 last:border-b-0">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold text-gray-900 text-sm">${notif.title}</div>
                <div class="text-gray-600 text-sm mt-1">${notif.message}</div>
              </div>
              <span class="px-2 py-1 text-xs font-semibold ${notif.read ? 'text-gray-600 bg-gray-100' : 'text-white bg-blue-500'} rounded-full whitespace-nowrap">
                ${notif.read ? 'Read' : 'New'}
              </span>
            </div>
          </li>
        `).join('')}
      </ul>
    `;
  }

  // Chart widgets (bar, line, pie, gauge)
  if (def.includes('_chart') && data.chart_html) {
    const title = data.title || config.title || 'Chart';
    const subtitle = data.subtitle || config.subtitle || '';
    return `
      <div>
        ${subtitle ? `<p class="text-sm text-gray-500 mb-3">${subtitle}</p>` : ''}
        <div class="chart-container">${data.chart_html}</div>
      </div>
    `;
  }

  // Default: show raw data
  return `<pre class="text-xs text-gray-600 overflow-auto">${JSON.stringify(data, null, 2)}</pre>`;
}

function renderWidget(widget, areaCode) {
  const areaResizable = areaCode === 'admin.dashboard.main' || areaCode === 'admin.dashboard.footer';
  const span = widget.metadata?.layout?.width || widget.span || 12;
  const hidden = widget.hidden || false;
  const title = widget.data?.title || widget.config?.title || getWidgetTitle(widget.definition);
  const widgetId = widget.id || widget.definition || `widget-${Math.random().toString(36).substr(2, 9)}`;
  const widgetContent = renderWidgetContent(widget);

  // Build toolbar HTML
  let toolbarHTML = '<div class="widget__toolbar">';

  // Hide button
  toolbarHTML += '<button type="button" class="hide-widget">Toggle Hide</button>';

  // Resize button (only for resizable areas)
  if (areaResizable) {
    toolbarHTML += '<button type="button" class="resize-widget">Half Width</button>';
  } else {
    toolbarHTML += '<button type="button" class="resize-widget" disabled title="Resize only available in Main or Operations">Half Width</button>';
  }

  toolbarHTML += '</div>';

  return `
    <article class="widget"
             data-widget="${widgetId}"
             data-span="${span}"
             data-area-code="${areaCode}"
             data-resizable="${areaResizable}"
             ${hidden ? 'data-hidden="true"' : ''}
             style="--span: ${span}">
      ${toolbarHTML}
      <div class="widget__header mb-4">
        <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
      </div>
      <div class="widget__content">
        ${widgetContent}
      </div>
    </article>
  `;
}

function getWidgetTitle(definition) {
  const titles = {
    'admin.widget.user_stats': 'User Statistics',
    'admin.widget.activity_feed': 'Recent Activity',
    'admin.widget.quick_actions': 'Quick Actions',
    'admin.widget.notifications': 'Notifications',
    'admin.widget.settings_overview': 'Settings Overview',
    'admin.widget.content_stats': 'Content Stats',
    'admin.widget.storage_stats': 'Storage Stats',
    'admin.widget.system_health': 'System Health',
    'admin.widget.bar_chart': 'Bar Chart',
    'admin.widget.line_chart': 'Line Chart',
    'admin.widget.pie_chart': 'Pie Chart',
    'admin.widget.gauge_chart': 'Gauge',
    'admin.widget.scatter_chart': 'Scatter Chart',
  };
  return titles[definition] || definition;
}

function formatNumber(value) {
  if (typeof value === 'number') {
    return value.toLocaleString();
  }
  return value;
}

// Initialize dashboard
async function initDashboard() {
  try {
    // Fetch dashboard data
    const response = await fetch('{{ base_path }}/api/dashboard');
    const dashboardData = await response.json();

    // Group widgets by area
    const widgetsByArea = {};
    (dashboardData.widgets || []).forEach(widget => {
      const area = widget.area || 'admin.dashboard.main';
      if (!widgetsByArea[area]) {
        widgetsByArea[area] = [];
      }
      widgetsByArea[area].push(widget);
    });

    // Render widgets in each area
    Object.entries(widgetsByArea).forEach(([areaCode, widgets]) => {
      const container = document.querySelector(`[data-area-grid="${areaCode}"]`);
      if (container) {
        container.innerHTML = widgets.map(w => renderWidget(w, areaCode)).join('');
      }
    });

    // Execute any chart scripts
    document.querySelectorAll('.chart-container script').forEach(script => {
      const newScript = document.createElement('script');
      if (script.src) {
        newScript.src = script.src;
      } else {
        newScript.textContent = script.textContent;
      }
      document.body.appendChild(newScript);
    });

    // Initialize widget grid with drag & drop
    const grid = new WidgetGrid({
      apiEndpoint: '{{ base_path }}/api/dashboard',
      preferencesEndpoint: '{{ base_path }}/api/dashboard/preferences',
      areas: ['admin.dashboard.main', 'admin.dashboard.sidebar', 'admin.dashboard.footer'],
      selectors: {
        hideBtn: '.hide-widget',
        resizeBtn: '.resize-widget',
      },
      onSave: (layout) => {
        console.log('Layout saved:', layout);
      },
      onError: (error) => {
        console.error('Widget grid error:', error);
        document.getElementById('save-status').textContent = 'Failed to save layout';
      }
    });

    await grid.init();

  } catch (error) {
    console.error('Failed to load dashboard:', error);
  }
}

// Load dashboard on page load
window.addEventListener('DOMContentLoaded', initDashboard);
</script>
{% endblock %}
