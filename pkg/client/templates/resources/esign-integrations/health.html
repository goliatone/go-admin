{% extends "layout.html" %}

{% block title %}Integration Health - E-Sign Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <!-- Page Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Integration Health</h1>
      <p class="text-sm text-gray-500 mt-1">Real-time observability for CRM/HRIS integrations</p>
    </div>
    <div class="flex gap-3">
      <select id="time-range" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
        <option value="1h">Last 1 hour</option>
        <option value="6h">Last 6 hours</option>
        <option value="24h" selected>Last 24 hours</option>
        <option value="7d">Last 7 days</option>
        <option value="30d">Last 30 days</option>
      </select>
      <select id="provider-filter" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
        <option value="">All Providers</option>
        <option value="salesforce">Salesforce</option>
        <option value="hubspot">HubSpot</option>
        <option value="bamboohr">BambooHR</option>
        <option value="workday">Workday</option>
      </select>
      <button id="refresh-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
        Refresh
      </button>
    </div>
  </div>

  <!-- Health Score Summary -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <!-- Overall Health Score -->
    <div class="bg-white rounded-lg shadow p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Overall Health</p>
          <p id="health-score" class="text-3xl font-bold text-green-600">98%</p>
        </div>
        <div id="health-indicator" class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
      </div>
      <p id="health-trend" class="text-xs text-gray-400 mt-2">+2% from previous period</p>
    </div>

    <!-- Sync Success Rate -->
    <div class="bg-white rounded-lg shadow p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Sync Success Rate</p>
          <p id="sync-success-rate" class="text-3xl font-bold text-gray-900">96.5%</p>
        </div>
        <div class="text-right">
          <p id="sync-success-count" class="text-sm text-green-600">289 succeeded</p>
          <p id="sync-failed-count" class="text-sm text-red-600">11 failed</p>
        </div>
      </div>
      <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
        <div id="sync-success-bar" class="h-full bg-green-500" style="width: 96.5%"></div>
      </div>
    </div>

    <!-- Conflict Backlog -->
    <div class="bg-white rounded-lg shadow p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Conflict Backlog</p>
          <p id="conflict-count" class="text-3xl font-bold text-orange-600">7</p>
        </div>
        <div class="text-right">
          <p id="conflict-pending" class="text-sm text-orange-600">7 pending</p>
          <p id="conflict-resolved" class="text-sm text-green-600">42 resolved today</p>
        </div>
      </div>
      <p id="conflict-trend" class="text-xs text-gray-400 mt-2">-3 from previous period</p>
    </div>

    <!-- Sync Lag -->
    <div class="bg-white rounded-lg shadow p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Average Sync Lag</p>
          <p id="sync-lag" class="text-3xl font-bold text-gray-900">12m</p>
        </div>
        <div id="lag-status" class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
          Normal
        </div>
      </div>
      <p id="last-sync" class="text-xs text-gray-400 mt-2">Last sync: 3 minutes ago</p>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Sync Timeline Chart -->
    <div class="bg-white rounded-lg shadow p-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Sync Activity Timeline</h3>
        <div class="flex gap-4 text-xs">
          <span class="flex items-center gap-1">
            <span class="w-3 h-3 bg-green-500 rounded-full"></span> Success
          </span>
          <span class="flex items-center gap-1">
            <span class="w-3 h-3 bg-red-500 rounded-full"></span> Failed
          </span>
          <span class="flex items-center gap-1">
            <span class="w-3 h-3 bg-blue-500 rounded-full"></span> Running
          </span>
        </div>
      </div>
      <div id="sync-timeline-chart" class="h-64 relative">
        <!-- Chart will be rendered here -->
        <canvas id="sync-chart-canvas"></canvas>
      </div>
    </div>

    <!-- Conflict Trend Chart -->
    <div class="bg-white rounded-lg shadow p-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Conflict Trend</h3>
        <div class="flex gap-4 text-xs">
          <span class="flex items-center gap-1">
            <span class="w-3 h-3 bg-orange-500 rounded-full"></span> New
          </span>
          <span class="flex items-center gap-1">
            <span class="w-3 h-3 bg-green-500 rounded-full"></span> Resolved
          </span>
        </div>
      </div>
      <div id="conflict-trend-chart" class="h-64 relative">
        <!-- Chart will be rendered here -->
        <canvas id="conflict-chart-canvas"></canvas>
      </div>
    </div>
  </div>

  <!-- Retry Activity & Provider Health -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Retry Trend -->
    <div class="bg-white rounded-lg shadow p-4">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Retry Activity</h3>
      <div class="space-y-3">
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">Total Retries (24h)</span>
          <span id="retry-total" class="text-lg font-semibold text-gray-900">23</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">Recovery Rate</span>
          <span id="retry-recovery" class="text-lg font-semibold text-green-600">87%</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">Avg Attempts</span>
          <span id="retry-avg" class="text-lg font-semibold text-gray-900">1.4</span>
        </div>
        <hr class="my-2">
        <div class="text-xs text-gray-500">
          <p class="font-medium mb-2">Recent Retries</p>
          <div id="retry-list" class="space-y-1">
            <!-- Retry items rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Provider Health Breakdown -->
    <div class="bg-white rounded-lg shadow p-4 lg:col-span-2">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Provider Health</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500 border-b">
              <th class="pb-2 font-medium">Provider</th>
              <th class="pb-2 font-medium">Status</th>
              <th class="pb-2 font-medium">Success Rate</th>
              <th class="pb-2 font-medium">Last Sync</th>
              <th class="pb-2 font-medium">Conflicts</th>
              <th class="pb-2 font-medium">Lag</th>
            </tr>
          </thead>
          <tbody id="provider-health-table">
            <!-- Provider rows rendered here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Active Alerts -->
  <div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Active Alerts</h3>
      <span id="alert-count" class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">2 active</span>
    </div>
    <div id="alerts-list" class="space-y-3">
      <!-- Alert items rendered here -->
    </div>
    <div id="no-alerts" class="text-center py-8 text-gray-500 hidden">
      <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p>No active alerts</p>
    </div>
  </div>

  <!-- Recent Activity Feed -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
      <a href="{{ base_path }}/esign/integrations/sync-runs" class="text-sm text-blue-600 hover:underline">
        View all runs
      </a>
    </div>
    <div id="activity-feed" class="space-y-2 max-h-64 overflow-y-auto">
      <!-- Activity items rendered here -->
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script type="module">
import { bootstrapIntegrationHealth } from '{{ esign_module_path|default:base_path + "/assets/dist/esign/index.js" }}';

bootstrapIntegrationHealth({
  basePath: '{{ base_path|default:"/admin" }}',
  apiBasePath: '{{ api_base_path|default:"" }}' || '{{ base_path|default:"/admin" }}/api',
  autoRefreshInterval: 30000,
});
</script>
{% endblock %}
