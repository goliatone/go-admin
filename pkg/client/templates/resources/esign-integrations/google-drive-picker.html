{% extends "layout.html" %}

{% block title %}Import from Google Drive - {{ title }}{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <div>
    <p class="text-sm text-gray-500 mb-1">E-Sign Documents</p>
    <h1 class="text-3xl font-bold text-admin-dark">Import from Google Drive</h1>
  </div>
  <div class="flex gap-3">
    {% if routes.esign_documents %}
      <a href="{{ routes.esign_documents }}" class="btn btn-secondary" aria-label="Return to documents list">
        <i class="iconoir-arrow-left" aria-hidden="true"></i>
        Back to Documents
      </a>
    {% endif %}
  </div>
</header>

<div class="flex-1 p-8 overflow-y-auto">
  {# Live region for announcements #}
  <div id="drive-announcements" class="sr-only" role="alert" aria-live="polite"></div>

  <div class="max-w-5xl">

    {# Connection Check #}
    {% if not google_connected %}
      <div class="bg-amber-50 border border-amber-200 rounded-xl p-6" role="alert">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <svg class="w-6 h-6 text-amber-600" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
            </svg>
          </div>
          <div>
            <h2 class="text-lg font-semibold text-amber-800">Google Drive Not Connected</h2>
            <p class="mt-1 text-sm text-amber-700">
              You need to connect your Google account before importing documents.
            </p>
            <a href="{{ adminURL("esign/integrations/google") }}" data-base-href="{{ adminURL("esign/integrations/google") }}" id="connect-google-link" class="mt-3 inline-block text-sm font-medium text-amber-800 hover:text-amber-900 underline">
              Connect Google Account
            </a>
          </div>
        </div>
      </div>
    {% else %}

    <div class="flex gap-6">
      {# Left Panel: Search & Browse #}
      <div class="flex-1">
        {# Search Bar #}
        <div class="bg-white border border-gray-200 rounded-xl p-4 mb-4">
          <div class="relative">
            <input
              type="text"
              id="drive-search"
              placeholder="Search files in Google Drive..."
              aria-label="Search Google Drive files"
              aria-describedby="search-help"
              class="w-full px-4 py-3 pl-11 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
            >
            <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none" aria-hidden="true">
              <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
            <button
              type="button"
              id="clear-search-btn"
              class="hidden absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600"
              aria-label="Clear search"
            >
              <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <p id="search-help" class="mt-2 text-xs text-gray-500">
            Search by file name. Results include Google Docs that can be exported as PDF.
          </p>
          <p id="account-scope-help" class="mt-1 text-xs text-gray-500 hidden"></p>
        </div>

        {# Breadcrumb Navigation #}
        <nav id="breadcrumb" class="mb-4 hidden" aria-label="Folder navigation">
          <ol class="flex items-center gap-2 text-sm flex-wrap" role="list">
            <li>
              <button type="button" data-folder-id="root" class="breadcrumb-item text-blue-600 hover:text-blue-800 hover:underline">
                My Drive
              </button>
            </li>
            {# Additional crumbs added by JavaScript #}
          </ol>
        </nav>

        {# File List #}
        <div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
          <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
            <h2 class="font-medium text-gray-900 text-sm">
              <span id="list-title">My Drive</span>
              <span id="result-count" class="text-gray-500 font-normal ml-2"></span>
            </h2>
            <div class="flex items-center gap-2">
              <button
                type="button"
                id="view-list-btn"
                class="p-1.5 rounded hover:bg-gray-100"
                aria-label="List view"
                aria-pressed="true"
              >
                <svg class="w-4 h-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                </svg>
              </button>
              <button
                type="button"
                id="view-grid-btn"
                class="p-1.5 rounded hover:bg-gray-100"
                aria-label="Grid view"
                aria-pressed="false"
              >
                <svg class="w-4 h-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                </svg>
              </button>
              <button
                type="button"
                id="refresh-btn"
                class="p-1.5 rounded hover:bg-gray-100 ml-2"
                aria-label="Refresh file list"
              >
                <svg class="w-4 h-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
              </button>
            </div>
          </div>

          {# File List Content #}
          <div id="file-list" class="divide-y divide-gray-100" role="listbox" aria-label="Google Drive files">
            {# Loading State #}
            <div id="loading-state" class="p-8 text-center">
              <svg class="animate-spin h-8 w-8 mx-auto text-gray-400 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <p class="text-sm text-gray-500">Loading files...</p>
            </div>
          </div>

          {# Pagination #}
          <div id="pagination" class="hidden px-4 py-3 border-t border-gray-100 flex items-center justify-between">
            <button
              type="button"
              id="load-more-btn"
              class="text-sm text-blue-600 hover:text-blue-800"
            >
              Load more files
            </button>
            <span id="page-info" class="text-xs text-gray-500"></span>
          </div>
        </div>
      </div>

      {# Right Panel: Selection Preview #}
      <div class="w-80 flex-shrink-0">
        <div id="selection-panel" class="bg-white border border-gray-200 rounded-xl sticky top-4">
          {# Empty State #}
          <div id="no-selection" class="p-6 text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
              <svg class="w-8 h-8 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
              </svg>
            </div>
            <h3 class="text-sm font-medium text-gray-900 mb-1">Select a Document</h3>
            <p class="text-xs text-gray-500">Click on a Google Doc to preview and import</p>
          </div>

          {# Selected File Preview #}
          <div id="file-preview" class="hidden">
            <div class="p-4 border-b border-gray-100">
              <div class="flex items-center gap-3">
                <div id="preview-icon" class="w-12 h-12 rounded-lg flex items-center justify-center flex-shrink-0">
                  {# Icon set by JavaScript #}
                </div>
                <div class="min-w-0">
                  <h3 id="preview-title" class="font-medium text-gray-900 truncate">Document Title</h3>
                  <p id="preview-type" class="text-xs text-gray-500">Google Document</p>
                </div>
              </div>
            </div>

            {# Metadata #}
            <div class="p-4 space-y-3">
              <h4 class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Document Details</h4>

              <div class="space-y-2 text-sm">
                <div class="flex items-start gap-2">
                  <svg class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <div>
                    <p class="text-gray-700 font-medium">File ID</p>
                    <p id="preview-file-id" class="text-gray-500 text-xs font-mono break-all">-</p>
                  </div>
                </div>

                <div class="flex items-start gap-2">
                  <svg class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  <div>
                    <p class="text-gray-700 font-medium">Owner</p>
                    <p id="preview-owner" class="text-gray-500 text-xs">-</p>
                  </div>
                </div>

                <div class="flex items-start gap-2">
                  <svg class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                  </svg>
                  <div>
                    <p class="text-gray-700 font-medium">Location</p>
                    <p id="preview-location" class="text-gray-500 text-xs">-</p>
                  </div>
                </div>

                <div class="flex items-start gap-2">
                  <svg class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <div>
                    <p class="text-gray-700 font-medium">Last Modified</p>
                    <p id="preview-modified" class="text-gray-500 text-xs">-</p>
                  </div>
                </div>
              </div>

              {# Version Confirmation #}
              <div class="mt-4 p-3 bg-blue-50 border border-blue-100 rounded-lg" role="alert">
                <div class="flex items-start gap-2">
                  <svg class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <p class="text-xs text-blue-700">
                    <strong>Snapshot Warning:</strong> A PDF snapshot will be created from the current version.
                    Changes made after import will not be reflected.
                  </p>
                </div>
              </div>
            </div>

            {# Actions #}
            <div class="p-4 border-t border-gray-100 space-y-3">
              <button
                type="button"
                id="import-btn"
                class="w-full btn btn-primary flex items-center justify-center gap-2"
              >
                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                Import Document
              </button>

              <a
                id="open-in-google-btn"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                class="w-full btn btn-secondary flex items-center justify-center gap-2 text-sm"
              >
                <svg class="w-4 h-4" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                  <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                  <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                  <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Open in Google Docs
              </a>

              <button
                type="button"
                id="clear-selection-btn"
                class="w-full text-sm text-gray-500 hover:text-gray-700"
              >
                Clear Selection
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% endif %}{# end google_connected check #}
  </div>
</div>

{# Import Confirmation Modal #}
<div id="import-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="import-modal-title">
  <div class="fixed inset-0 bg-black/50" aria-hidden="true"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full">
      <div class="p-6 border-b border-gray-100">
        <h3 id="import-modal-title" class="text-lg font-semibold text-gray-900">Import Document</h3>
        <p class="mt-1 text-sm text-gray-500">Configure the import settings before proceeding.</p>
      </div>

      <form id="import-form" class="p-6 space-y-4">
        <input type="hidden" id="import-google-file-id" name="google_file_id" value="">

        <div>
          <label for="import-document-title" class="block text-sm font-medium text-gray-700 mb-1">
            Document Title <span class="text-red-500" aria-hidden="true">*</span>
          </label>
          <input
            type="text"
            id="import-document-title"
            name="document_title"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
          <p class="mt-1 text-xs text-gray-500">The title for the imported PDF document.</p>
        </div>

        <div>
          <label for="import-agreement-title" class="block text-sm font-medium text-gray-700 mb-1">
            Agreement Title
          </label>
          <input
            type="text"
            id="import-agreement-title"
            name="agreement_title"
            placeholder="Leave blank to create document only"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
          <p class="mt-1 text-xs text-gray-500">Optionally create a draft agreement with this document.</p>
        </div>

        <div class="p-3 bg-amber-50 border border-amber-100 rounded-lg">
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div class="text-xs text-amber-700">
              <p class="font-medium">This creates an immutable snapshot</p>
              <p class="mt-0.5">The PDF will be exported from Google Docs at this moment. Future changes to the Google Doc will not be reflected.</p>
            </div>
          </div>
        </div>
      </form>

      <div class="px-6 py-4 border-t border-gray-100 flex justify-end gap-3">
        <button
          type="button"
          id="import-cancel-btn"
          class="btn btn-secondary"
        >
          Cancel
        </button>
        <button
          type="button"
          id="import-confirm-btn"
          class="btn btn-primary"
        >
          <svg id="import-spinner" class="hidden animate-spin w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span id="import-btn-text">Import</span>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
import { bootstrapGoogleDrivePicker } from '{{ esign_module_path|default:base_path + "/assets/dist/esign/index.js" }}';

bootstrapGoogleDrivePicker({
  basePath: '{{ base_path|default:"/admin" }}',
  apiBasePath: '{{ api_base_path|default:"" }}' || '{{ base_path|default:"/admin" }}/api',
  userId: '{{ user_id|default:"" }}',
  googleAccountId: '{{ google_account_id|default:"" }}',
  googleConnected: {{ google_connected|default:false|yesno:"true,false" }},
  pickerRoutes: {
    integrations: '{{ adminURL("esign/integrations/google") }}',
    agreements: '{{ adminURL("content/esign_agreements") }}',
    documents: '{{ adminURL("content/esign_documents") }}',
  },
});
</script>
{% endblock %}
