{% extends "resources/shared/list-base.html" %}

{% block filter_row %}
<tr class="bg-gray-100" id="filter-row">
  <th data-role="selection" data-fixed="left"></th>
  {% for col in columns %}
  <th data-column="{{ col.field }}" class="px-6 py-2">
    {% if not col.filterable %}
    {% elif col.field == "status" %}
    <select data-filter-column="status" class="py-1.5 px-2 block w-full border-gray-300 rounded text-xs focus:border-blue-500 focus:ring-blue-500">
      <option value="">All</option>
      <option value="draft">Draft</option>
      <option value="published">Published</option>
      <option value="archived">Archived</option>
    </select>
    {% else %}
    <input type="text"
           data-filter-column="{{ col.field }}"
           placeholder="{% if col.field == "published_at" or col.field == "created_at" %}YYYY-MM-DD{% else %}Filter...{% endif %}"
           class="py-1.5 px-2 block w-full border-gray-300 rounded text-xs focus:border-blue-500 focus:ring-blue-500">
    {% endif %}
  </th>
  {% endfor %}
  <th data-role="actions" data-fixed="right"></th>
</tr>
{% endblock %}

{% block empty_state %}
<div class="text-center py-16">
  <div class="text-6xl mb-4">ğŸ“</div>
  <h3 class="text-xl font-semibold text-gray-900 mb-2">No {{ resource_label|default:resource|lower }} yet</h3>
  <p class="text-gray-500 mb-6">Get started by creating your first {{ resource_label|default:resource|lower }}</p>
  <a href="{{ routes.new }}" class="btn btn-primary">Create</a>
</div>
{% endblock %}

{% block datatable_scripts %}
<script type="module">
import { DataGrid, FilterBuilder, GoCrudSearchBehavior, GoCrudFilterBehavior, GoCrudPaginationBehavior, GoCrudSortBehavior, GoCrudExportBehavior, GoCrudBulkActionBehavior, ServerColumnVisibilityBehavior } from '{{ base_path }}/assets/dist/datatable/index.js';

const actionBasePath = '{{ routes.index }}';
const columns = {{ toJSON(columns)|safe }};
const exportConfig = {{ toJSON(export_config)|safe }};
const columnFields = columns.map(c => c.field);
const gridColumns = columns.map(col => ({
  ...col,
  hidden: col.default === false
}));

// Initialize DataGrid once DOM is ready

document.addEventListener('DOMContentLoaded', async function() {
  const columnVisibility = new ServerColumnVisibilityBehavior(columnFields, {
    resource: 'posts',
    localStorageKey: 'posts_datatable_columns'
  });
  await columnVisibility.loadFromServer();

  const grid = new DataGrid({
    tableId: '{{ datatable_id|default:resource }}-datatable',
    apiEndpoint: '/admin/crud/posts',
    actionBasePath: actionBasePath,
    columns: gridColumns,
    perPage: 10,
    searchDelay: 300,
    cellRenderers: {
      status: (value) => `<span class="status-badge status-${value}">${value}</span>`
    },
    behaviors: {
      search: new GoCrudSearchBehavior(['title', 'slug']),
      filter: new GoCrudFilterBehavior(),
      pagination: new GoCrudPaginationBehavior(),
      sort: new GoCrudSortBehavior(),
      export: new GoCrudExportBehavior(exportConfig),
      bulkActions: new GoCrudBulkActionBehavior('/admin/crud/posts'),
      columnVisibility: columnVisibility
    },
    selectors: {
      searchInput: '#table-search',
      perPageSelect: '#table-per-page',
      filterRow: '[data-filter-column]',
      columnToggleBtn: '#column-toggle-btn',
      columnToggleMenu: '#column-toggle-menu',
      exportBtn: '#export-btn',
      exportMenu: '#export-menu',
      paginationContainer: '#table-pagination',
      tableInfoStart: '#table-info-start',
      tableInfoEnd: '#table-info-end',
      tableInfoTotal: '#table-info-total',
      selectAllCheckbox: '#table-checkbox-all',
      rowCheckboxes: '.table-checkbox',
      bulkActionsBar: '#bulk-actions-overlay',
      selectedCount: '#selected-count'
    },
    notifier: window.toastManager
  });

  grid.init();

  const refreshBtn = document.getElementById('refresh-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      refreshBtn.classList.add('opacity-50');
      try {
        await grid.refresh();
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('opacity-50');
      }
    });
  }

  const filterBuilder = new FilterBuilder({
    notifier: window.toastManager,
    fields: [
      { name: 'title', label: 'Title', type: 'text' },
      { name: 'slug', label: 'Slug', type: 'text' },
      { name: 'status', label: 'Status', type: 'select', options: [
        { label: 'Draft', value: 'draft' },
        { label: 'Published', value: 'published' },
        { label: 'Archived', value: 'archived' }
      ]},
      { name: 'published_at', label: 'Published Date', type: 'date' },
      { name: 'created_at', label: 'Created Date', type: 'date' }
    ],
    onApply: (structure) => {
      const filters = [];
      structure.groups.forEach(group => {
        group.conditions.forEach(condition => {
          filters.push({
            column: condition.field,
            operator: condition.operator,
            value: condition.value
          });
        });
      });

      grid.state.filters = filters;
      grid.resetPagination();
      grid.syncURL();
      grid.refresh();
    },
    onClear: () => {
      grid.state.search = '';
      grid.state.filters = [];
      grid.syncURL();
      grid.refresh();
    }
  });
});
</script>
{% endblock %}
