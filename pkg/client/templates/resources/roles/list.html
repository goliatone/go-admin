{% extends "resources/shared/list-base.html" %}

{% block list_title %}{{ resource_label|default:resource|title }} - {{ title }}{% endblock %}

{% block datatable_scripts %}
<script type="module">
import { DataGrid, FilterBuilder, GoCrudFilterBehavior, GoCrudPaginationBehavior, GoCrudSortBehavior, GoCrudExportBehavior, DefaultColumnVisibilityBehavior, CommonRenderers } from '{{ base_path }}/assets/dist/datatable/index.js';
import { permissionPillsRenderer } from '{{ base_path }}/assets/dist/components/permission-pills.js';

const actionBasePath = '{{ routes.index }}';
const columns = {{ toJSON(columns)|safe }};
const filters = {{ toJSON(filters)|safe }};
const dataGridConfig = {{ toJSON(datagrid_config)|safe }} || {};
const exportConfig = dataGridConfig.export_config || {{ toJSON(export_config)|safe }};
const columnFields = columns.map(c => c.field);
const tableBaseId = dataGridConfig.table_id || '{{ datatable_id|default:resource }}';
const tableId = `${tableBaseId}-datatable`;
const listAPI = dataGridConfig.api_endpoint || '{{ list_api|default:"" }}';
const resolvedActionBasePath = dataGridConfig.action_base || actionBasePath;
const gridColumns = columns.map(col => ({
  ...col,
  hidden: col.default === false
}));
const filterFields = (filters || []).map(filter => ({
  name: filter.name,
  label: filter.label,
  type: normalizeFilterType(filter.type),
  options: normalizeFilterOptions(filter.options)
}));

class PanelSearchBehavior {
  buildQuery(term) {
    const value = term ? term.trim() : '';
    return value ? { search: value } : {};
  }

  async onSearch(term, grid) {
    grid.resetPagination();
    await grid.refresh();
  }
}

function normalizeFilterType(type) {
  switch ((type || '').toLowerCase()) {
    case 'select':
    case 'enum':
      return 'select';
    case 'number':
    case 'integer':
      return 'number';
    case 'date':
    case 'datetime':
    case 'time':
      return 'date';
    default:
      return 'text';
  }
}

function normalizeFilterOptions(options) {
  if (!Array.isArray(options)) return undefined;
  const normalized = options
    .map(option => {
      if (!option) return null;
      const value = option.value ?? '';
      const label = option.label ?? String(value);
      return { label: String(label), value: String(value) };
    })
    .filter(Boolean);
  return normalized.length > 0 ? normalized : undefined;
}

const apiBasePath = '{{ api_base_path|default:"" }}';
const apiEndpoint = listAPI || (apiBasePath ? `${apiBasePath}/roles` : '{{ base_path }}/api/roles');

{% verbatim %}
document.addEventListener('DOMContentLoaded', async function() {
  const tableEl = document.getElementById(tableId);
  if (!tableEl) {
    return;
  }

  const storageKey = dataGridConfig.column_storage_key || `${tableId.replace(/[^a-zA-Z0-9_]/g, '_')}_columns`;
  const columnVisibility = new DefaultColumnVisibilityBehavior(columnFields, storageKey);

  const grid = new DataGrid({
    tableId: tableId,
    apiEndpoint: apiEndpoint,
    actionBasePath: resolvedActionBasePath,
    columns: gridColumns,
    perPage: 10,
    searchDelay: 300,
    cellRenderers: {
      'permissions': permissionPillsRenderer,
      'is_system': CommonRenderers.booleanChip()
    },
    behaviors: {
      search: new PanelSearchBehavior(),
      filter: new GoCrudFilterBehavior(),
      pagination: new GoCrudPaginationBehavior(),
      sort: new GoCrudSortBehavior(),
      export: new GoCrudExportBehavior(exportConfig),
      columnVisibility: columnVisibility
    },
    selectors: {
      searchInput: '#table-search',
      perPageSelect: '#table-per-page',
      filterRow: '[data-filter-column]',
      columnToggleBtn: '#column-toggle-btn',
      columnToggleMenu: '#column-toggle-menu',
      exportBtn: '#export-btn',
      exportMenu: '#export-menu',
      paginationContainer: '#table-pagination',
      tableInfoStart: '#table-info-start',
      tableInfoEnd: '#table-info-end',
      tableInfoTotal: '#table-info-total',
      selectAllCheckbox: '#table-checkbox-all',
      rowCheckboxes: '.table-checkbox',
      bulkActionsBar: '#bulk-actions-overlay',
      selectedCount: '#selected-count'
    },
    notifier: window.toastManager
  });

  grid.init();

  const refreshBtn = document.getElementById('refresh-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      refreshBtn.classList.add('opacity-50');
      try {
        await grid.refresh();
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('opacity-50');
      }
    });
  }

  const filterToggleBtn = document.getElementById('filter-toggle-btn');
  if (filterFields.length > 0) {
    new FilterBuilder({
      notifier: window.toastManager,
      fields: filterFields,
      onApply: (structure) => {
        const appliedFilters = [];
        structure.groups.forEach(group => {
          group.conditions.forEach(condition => {
            appliedFilters.push({
              column: condition.field,
              operator: condition.operator,
              value: condition.value
            });
          });
        });

        grid.state.filters = appliedFilters;
        grid.resetPagination();
        grid.syncURL();
        grid.refresh();
      },
      onClear: () => {
        grid.state.search = '';
        grid.state.filters = [];
        grid.syncURL();
        grid.refresh();
      }
    });
  } else if (filterToggleBtn) {
    filterToggleBtn.disabled = true;
    filterToggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
});
{% endverbatim %}
</script>
{% endblock %}
