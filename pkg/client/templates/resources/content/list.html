{% extends "resources/shared/list-base.html" %}

{% block list_title %}{{ resource_label|default:"Content" }} - {{ title }}{% endblock %}

{% block empty_state %}
<div class="text-center py-16">
  <div class="text-6xl mb-4">ðŸ“„</div>
  <h3 class="text-xl font-semibold text-gray-900 mb-2">No {{ resource_label|default:"content"|lower }} yet</h3>
  <p class="text-gray-500 mb-6">Create your first {{ resource_label|default:"content"|lower }} entry</p>
  <a href="{{ routes.new }}" class="btn btn-primary">Create</a>
</div>
{% endblock %}

{% block quick_filters %}
<!-- Phase 19.2: Quick filter for incomplete translations -->
<button type="button"
        id="incomplete-translations-filter"
        class="h-10 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50"
        aria-pressed="false"
        title="Show only content with incomplete translations">
  <svg class="h-4 w-4 text-amber-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
  </svg>
  Incomplete
</button>
{% endblock %}

{% block datatable_scripts %}
<script type="module">
import {
  DataGrid,
  FilterBuilder,
  GoCrudFilterBehavior,
  GoCrudSortBehavior,
  ServerColumnVisibilityBehavior,
  SchemaActionBuilder,
  extractSchemaActions,
  showTranslationBlocker,
  extractTranslationContext,
  renderLocaleBadge,
  renderTranslationStatusCell,
  // Phase 19 productization: translation readiness
  extractTranslationReadiness,
  hasTranslationReadiness,
  renderReadinessIndicator,
  renderPublishReadinessBadge,
  renderLocaleCompleteness,
  // Phase 19.2: Missing translations affordance
  renderMissingTranslationsBadge,
  hasMissingTranslations
} from '{{ base_path }}/assets/dist/datatable/index.js';

const basePath = '{{ base_path }}';
const apiBasePath = '{{ api_base_path|default:"" }}';
const apiEndpoint = '{{ list_api }}';
const actionBasePath = '{{ action_base }}';
const columns = {{ toJSON(columns)|safe }};
const filters = {{ toJSON(filters)|safe }};
const env = {{ toJSON(env)|safe }};
const locale = {{ toJSON(locale)|safe }};
const panelName = '{{ panel_name }}';
const columnFields = columns.map(c => c.field);
const gridColumns = columns.map(col => ({
  ...col,
  hidden: col.default === false
}));
const filterFields = (filters || []).map(filter => ({
  name: filter.name,
  label: filter.label,
  type: normalizeFilterType(filter.type),
  options: normalizeFilterOptions(filter.options),
  operators: normalizeFilterOperators(filter.operators, filter.default_operator)
}));

// Schema action builder for server-authoritative row actions
let schemaActionBuilder = null;
let cachedSchemaActions = null;

class PanelPaginationBehavior {
  buildQuery(page, perPage) {
    const params = { page, per_page: perPage };
    if (env) params.env = env;
    return params;
  }
  async onPageChange(page, grid) {
    await grid.refresh();
  }
}

class PanelSearchBehavior {
  buildQuery(term) {
    const params = {};
    const value = term ? term.trim() : '';
    if (value) params.search = value;
    if (env) params.env = env;
    return params;
  }
  async onSearch(term, grid) {
    grid.resetPagination();
    await grid.refresh();
  }
}

function normalizeFilterType(type) {
  switch ((type || '').toLowerCase()) {
    case 'select':
    case 'enum':
      return 'select';
    case 'number':
    case 'integer':
      return 'number';
    case 'date':
    case 'datetime':
    case 'time':
      return 'date';
    default:
      return 'text';
  }
}

function normalizeFilterOptions(options) {
  if (!Array.isArray(options)) return undefined;
  const normalized = options
    .map(option => {
      if (!option) return null;
      const value = option.value ?? '';
      const label = option.label ?? String(value);
      return { label: String(label), value: String(value) };
    })
    .filter(Boolean);
  return normalized.length > 0 ? normalized : undefined;
}

function normalizeFilterOperators(operators, defaultOperator) {
  if (!Array.isArray(operators) || operators.length === 0) return undefined;
  const normalized = operators
    .map(op => String(op || '').trim().toLowerCase())
    .filter(Boolean);
  if (normalized.length === 0) return undefined;
  const deduped = Array.from(new Set(normalized));
  const preferred = defaultOperator ? String(defaultOperator).trim().toLowerCase() : '';
  if (preferred && deduped.includes(preferred)) {
    return [preferred, ...deduped.filter(op => op !== preferred)];
  }
  return deduped;
}

const envQuery = env ? `?env=${encodeURIComponent(env)}` : '';
const datatableId = '{{ datatable_id|default:resource }}-datatable';

let grid;

document.addEventListener('DOMContentLoaded', async function() {
  const tableEl = document.getElementById(datatableId);
  if (!tableEl) {
    return;
  }

  const preferencesEndpoint = apiBasePath ? `${apiBasePath}/preferences` : `${basePath}/api/preferences`;
  const columnVisibility = new ServerColumnVisibilityBehavior(columnFields, {
    resource: '{{ panel_name }}',
    localStorageKey: `content_${'{{ panel_name }}'}_datatable_columns`,
    preferencesEndpoint: preferencesEndpoint
  });
  await columnVisibility.loadFromServer();

  // Initialize schema action builder
  schemaActionBuilder = new SchemaActionBuilder({
    apiEndpoint: apiEndpoint,
    actionBasePath: actionBasePath,
    actionContext: 'row',
    locale: locale || undefined,
    environment: env || undefined,
    panelName: panelName,
    useDefaultFallback: true,
    onTranslationBlocker: async (info) => {
      // Modal-first translation blocker handling
      await showTranslationBlocker({
        transition: info.transition,
        entityType: info.entityType,
        recordId: info.recordId,
        missingLocales: info.missingLocales,
        missingFieldsByLocale: info.missingFieldsByLocale,
        requestedLocale: info.requestedLocale,
        environment: info.environment,
        apiEndpoint: apiEndpoint,
        navigationBasePath: actionBasePath,
        panelName: panelName,
        onCreateSuccess: async (locale, result) => {
          if (window.toastManager) {
            window.toastManager.success(`Created ${locale} translation`);
          }
          // Refresh grid to show updated state
          await grid.refresh();
        },
        onRetry: async () => {
          if (typeof info.retry !== 'function') {
            await grid.refresh();
            return;
          }
          try {
            const retryResult = await info.retry();
            if (retryResult.success) {
              await grid.refresh();
            }
          } catch (err) {
            // onActionError already handles non-blocker action errors.
          }
        },
        onError: (message) => {
          if (window.toastManager) {
            window.toastManager.error(message);
          }
        },
        onDismiss: () => {
          // User dismissed modal without action
        }
      });
    },
    onActionSuccess: async (actionName, result) => {
      console.log('[Content List] Action success:', actionName, result);
      if (window.toastManager) {
        window.toastManager.success(`${actionName} completed successfully`);
      }
      await grid.refresh();
    },
    onActionError: (actionName, error) => {
      console.error('[Content List] Action error:', actionName, error);
      if (window.toastManager) {
        window.toastManager.error(error.message || `${actionName} failed`);
      }
    }
  });

  // Custom cell renderers for translation context
  const translationCellRenderers = {
    // Locale column - shows locale badge with fallback indicator
    locale: (value, record) => {
      const ctx = extractTranslationContext(record);
      if (!ctx.resolvedLocale) {
        return value ? `<span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">${String(value).toUpperCase()}</span>` : '-';
      }
      return renderLocaleBadge(ctx, { showFallbackIndicator: true, size: 'sm' });
    },
    // Translation status column - shows locale + available locales
    translation_status: (value, record) => {
      return renderTranslationStatusCell(record, { size: 'sm', maxLocales: 3 });
    },
    // Available locales column
    available_locales: (value, record) => {
      const ctx = extractTranslationContext(record);
      if (ctx.availableLocales.length === 0) {
        return '<span class="text-gray-400">-</span>';
      }
      return ctx.availableLocales.map(loc => {
        const isResolved = loc === ctx.resolvedLocale;
        const pillClass = isResolved
          ? 'px-1.5 py-0.5 text-[10px] rounded bg-blue-100 text-blue-700 font-medium'
          : 'px-1.5 py-0.5 text-[10px] rounded bg-gray-100 text-gray-600';
        return `<span class="${pillClass}">${loc.toUpperCase()}</span>`;
      }).join(' ');
    },
    // Phase 19: Translation readiness indicator (uses canonical backend fields)
    translation_readiness: (value, record) => {
      // Prefer productized readiness metadata when available
      if (hasTranslationReadiness(record)) {
        return renderReadinessIndicator(record, { size: 'sm', showDetailedTooltip: true });
      }
      // Legacy fallback: show nothing if no readiness metadata
      return '<span class="text-gray-400">-</span>';
    },
    // Phase 19: Publish readiness badge (compact ready/not ready)
    publish_readiness: (value, record) => {
      if (hasTranslationReadiness(record)) {
        return renderPublishReadinessBadge(record, { size: 'sm' });
      }
      return '';
    },
    // Phase 19: Locale completeness (X/Y format)
    locale_completeness: (value, record) => {
      return renderLocaleCompleteness(record, { size: 'sm' });
    },
    // Phase 19.2: Missing translations badge (prominent affordance)
    missing_translations: (value, record) => {
      // First-class affordance for identifying incomplete content
      return renderMissingTranslationsBadge(record, { size: 'sm' });
    }
  };

  const extensionCellRenderers = (window.contentEntryCellRenderers && typeof window.contentEntryCellRenderers === 'object')
    ? window.contentEntryCellRenderers
    : {};
  const mergedCellRenderers = {
    ...extensionCellRenderers,
    ...translationCellRenderers
  };

  grid = new DataGrid({
    tableId: datatableId,
    apiEndpoint: apiEndpoint,
    actionBasePath: actionBasePath,
    columns: gridColumns,
    perPage: 10,
    searchDelay: 300,
    cellRenderers: mergedCellRenderers,
    rowActions: (item) => {
      // Use schema actions if available, otherwise fall back to defaults
      const schema = grid.getSchema();
      const schemaActions = schema?.actions || cachedSchemaActions;
      return schemaActionBuilder.buildRowActions(item, schemaActions);
    },
    behaviors: {
      search: new PanelSearchBehavior(),
      filter: new GoCrudFilterBehavior(),
      pagination: new PanelPaginationBehavior(),
      sort: new GoCrudSortBehavior(),
      columnVisibility: columnVisibility
    },
    selectors: {
      searchInput: '#table-search',
      perPageSelect: '#table-per-page',
      filterRow: '[data-filter-column]',
      columnToggleBtn: '#column-toggle-btn',
      columnToggleMenu: '#column-toggle-menu',
      exportBtn: '#export-btn',
      exportMenu: '#export-menu',
      paginationContainer: '#table-pagination',
      tableInfoStart: '#table-info-start',
      tableInfoEnd: '#table-info-end',
      tableInfoTotal: '#table-info-total',
      selectAllCheckbox: '#table-checkbox-all',
      rowCheckboxes: '.table-checkbox',
      bulkActionsBar: '#bulk-actions-overlay',
      selectedCount: '#selected-count'
    },
    notifier: window.toastManager
  });

  // Cache schema actions after each refresh for row action rendering
  // Override refresh before init() to ensure caching on first load
  const originalRefresh = grid.refresh.bind(grid);
  grid.refresh = async function() {
    await originalRefresh();
    const schema = grid.getSchema();
    if (schema?.actions) {
      cachedSchemaActions = schema.actions;
    }
  };

  grid.init();

  const refreshBtn = document.getElementById('refresh-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      refreshBtn.classList.add('opacity-50');
      try {
        await grid.refresh();
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('opacity-50');
      }
    });
  }

  const filterToggleBtn = document.getElementById('filter-toggle-btn');
  if (filterFields.length > 0) {
    new FilterBuilder({
      notifier: window.toastManager,
      fields: filterFields,
      onApply: (structure) => {
        const appliedFilters = [];
        structure.groups.forEach(group => {
          group.conditions.forEach(condition => {
            appliedFilters.push({
              column: condition.field,
              operator: condition.operator,
              value: condition.value
            });
          });
        });
        grid.state.filters = appliedFilters;
        grid.resetPagination();
        grid.syncURL();
        grid.refresh();
      },
      onClear: () => {
        grid.state.search = '';
        grid.state.filters = [];
        grid.syncURL();
        grid.refresh();
      }
    });
  } else if (filterToggleBtn) {
    filterToggleBtn.disabled = true;
    filterToggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }

  // Phase 19.2: Quick filter toggle for missing translations
  const incompleteFilterBtn = document.getElementById('incomplete-translations-filter');
  if (incompleteFilterBtn) {
    let isFilterActive = false;

    incompleteFilterBtn.addEventListener('click', async () => {
      isFilterActive = !isFilterActive;

      if (isFilterActive) {
        // Activate filter: show only incomplete translations
        incompleteFilterBtn.classList.add('bg-amber-100', 'border-amber-300', 'text-amber-800');
        incompleteFilterBtn.classList.remove('bg-white', 'text-gray-800');
        incompleteFilterBtn.setAttribute('aria-pressed', 'true');

        // Add canonical incomplete filter.
        const incompleteFilter = {
          column: 'incomplete',
          operator: 'eq',
          value: 'true'
        };
        grid.state.filters = [...grid.state.filters.filter(f => f.column !== 'incomplete'), incompleteFilter];
      } else {
        // Deactivate filter: show all
        incompleteFilterBtn.classList.remove('bg-amber-100', 'border-amber-300', 'text-amber-800');
        incompleteFilterBtn.classList.add('bg-white', 'text-gray-800');
        incompleteFilterBtn.setAttribute('aria-pressed', 'false');

        // Remove canonical incomplete filter
        grid.state.filters = grid.state.filters.filter(f => f.column !== 'incomplete');
      }

      grid.resetPagination();
      grid.syncURL();
      await grid.refresh();
    });
  }
});
</script>
{% endblock %}
