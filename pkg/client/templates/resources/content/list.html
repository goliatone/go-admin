{% extends "resources/shared/list-base.html" %}

{% block list_title %}{{ resource_label|default:"Content" }} - {{ title }}{% endblock %}

{% block empty_state %}
<div class="text-center py-16">
  <div class="text-6xl mb-4">ðŸ“„</div>
  <h3 class="text-xl font-semibold text-gray-900 mb-2">No {{ resource_label|default:"content"|lower }} yet</h3>
  <p class="text-gray-500 mb-6">Create your first {{ resource_label|default:"content"|lower }} entry</p>
  {% if routes.new %}
  <a href="{{ routes.new }}" class="btn btn-primary">Create</a>
  {% endif %}
</div>
{% endblock %}

{% block quick_filters %}
{% if datagrid_config and datagrid_config.translation_ux_enabled %}
<!-- Translation UX: Quick filters container -->
<div id="translation-quick-filters" class="inline-flex items-center" data-quick-filters data-size="sm"></div>
{% endif %}
{% endblock %}

{% block toolbar_right_extra %}
{% if datagrid_config and datagrid_config.translation_ux_enabled %}
<!-- Translation UX: Status legend (Phase 1 contract: always visible, non-collapsible) -->
<div id="translation-status-legend" data-status-legend data-size="sm" data-orientation="horizontal"></div>

<!-- Translation UX: View mode toggle (flat/grouped/matrix) -->
<div class="inline-flex items-center gap-2 border border-gray-200 rounded-lg bg-white p-1">
  <button type="button"
          data-view-mode="flat"
          class="translation-view-mode-btn px-2.5 py-1.5 text-xs font-medium rounded text-gray-700 hover:bg-gray-100"
          title="Flat list view">
    Flat
  </button>
  <button type="button"
          data-view-mode="grouped"
          class="translation-view-mode-btn px-2.5 py-1.5 text-xs font-medium rounded text-gray-700 hover:bg-gray-100"
          title="Grouped by translation group">
    Grouped
  </button>
  <button type="button"
          data-view-mode="matrix"
          class="translation-view-mode-btn px-2.5 py-1.5 text-xs font-medium rounded text-gray-700 hover:bg-gray-100"
          title="Matrix summary view mode">
    Matrix Summary
  </button>
</div>

<!-- Translation UX: Expand/Collapse controls for grouped mode -->
<div class="inline-flex items-center gap-1 border border-gray-200 rounded-lg bg-white p-1">
  <button type="button"
          id="group-expand-all-btn"
          class="px-2.5 py-1.5 text-xs font-medium rounded text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
          title="Expand all translation groups">
    Expand All
  </button>
  <button type="button"
          id="group-collapse-all-btn"
          class="px-2.5 py-1.5 text-xs font-medium rounded text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
          title="Collapse all translation groups">
    Collapse All
  </button>
</div>
{% endif %}
{% endblock %}

{% block datatable_scripts %}
<script type="module">
import {
  DataGrid,
  FilterBuilder,
  GoCrudFilterBehavior,
  GoCrudSortBehavior,
  ServerColumnVisibilityBehavior,
  SchemaActionBuilder,
  extractSchemaActions,
  showTranslationBlocker,
  extractTranslationContext,
  renderLocaleBadge,
  renderTranslationStatusCell,
  renderTranslationMatrixCell,
  // Phase 19 productization: translation readiness
  extractTranslationReadiness,
  hasTranslationReadiness,
  renderReadinessIndicator,
  renderPublishReadinessBadge,
  renderLocaleCompleteness,
  // Phase 19.2: Missing translations affordance
  renderMissingTranslationsBadge,
  hasMissingTranslations,
  // Phase 2 (TX-088): Translation UX primitives with template-level initialization
  createStatusLegend,
  createTranslationQuickFilters
} from '{{ base_path }}/assets/dist/datatable/index.js';

const basePath = '{{ base_path }}';
const apiBasePath = '{{ api_base_path|default:"" }}';
const dataGridConfig = {{ toJSON(datagrid_config)|safe }} || {};
const apiEndpoint = dataGridConfig.api_endpoint || '{{ list_api|default:"" }}';
const actionBasePath = dataGridConfig.action_base || '{{ action_base|default:"" }}';
const columns = {{ toJSON(columns)|safe }};
const filters = {{ toJSON(filters)|safe }};
const env = {{ toJSON(env)|safe }};
const locale = {{ toJSON(locale)|safe }};
const panelName = '{{ panel_name }}';
const columnFields = columns.map(c => c.field);
const gridColumns = columns.map(col => ({
  ...col,
  hidden: col.default === false
}));
const filterFields = (filters || []).map(filter => ({
  name: filter.name,
  label: filter.label,
  type: normalizeFilterType(filter.type),
  options: normalizeFilterOptions(filter.options),
  operators: normalizeFilterOperators(filter.operators, filter.default_operator)
}));
const translationUXEnabled = dataGridConfig.translation_ux_enabled === true;
const groupedModeEnabled = dataGridConfig.enable_grouped_mode === true;
const groupByField = String(dataGridConfig.group_by_field || 'translation_group_id').trim() || 'translation_group_id';
const defaultViewMode = normalizeViewMode(dataGridConfig.default_view_mode, groupedModeEnabled ? 'grouped' : 'flat');

// Schema action builder for server-authoritative row actions
let schemaActionBuilder = null;
let cachedSchemaActions = null;

class PanelPaginationBehavior {
  buildQuery(page, perPage) {
    const params = { page, per_page: perPage };
    if (env) params.env = env;
    return params;
  }
  async onPageChange(page, grid) {
    await grid.refresh();
  }
}

class PanelSearchBehavior {
  buildQuery(term) {
    const params = {};
    const value = term ? term.trim() : '';
    if (value) params.search = value;
    if (env) params.env = env;
    return params;
  }
  async onSearch(term, grid) {
    grid.resetPagination();
    await grid.refresh();
  }
}

function normalizeFilterType(type) {
  switch ((type || '').toLowerCase()) {
    case 'select':
    case 'enum':
      return 'select';
    case 'number':
    case 'integer':
      return 'number';
    case 'date':
    case 'datetime':
    case 'time':
      return 'date';
    default:
      return 'text';
  }
}

function normalizeFilterOptions(options) {
  if (!Array.isArray(options)) return undefined;
  const normalized = options
    .map(option => {
      if (!option) return null;
      const value = option.value ?? '';
      const label = option.label ?? String(value);
      return { label: String(label), value: String(value) };
    })
    .filter(Boolean);
  return normalized.length > 0 ? normalized : undefined;
}

function normalizeFilterOperators(operators, defaultOperator) {
  if (!Array.isArray(operators) || operators.length === 0) return undefined;
  const normalized = operators
    .map(op => String(op || '').trim().toLowerCase())
    .filter(Boolean);
  if (normalized.length === 0) return undefined;
  const deduped = Array.from(new Set(normalized));
  const preferred = defaultOperator ? String(defaultOperator).trim().toLowerCase() : '';
  if (preferred && deduped.includes(preferred)) {
    return [preferred, ...deduped.filter(op => op !== preferred)];
  }
  return deduped;
}

function normalizeViewMode(value, fallback = 'flat') {
  const mode = String(value || '').trim().toLowerCase();
  if (mode === 'flat' || mode === 'grouped' || mode === 'matrix') {
    return mode;
  }
  return fallback;
}

function normalizeStateStoreMode(value, fallback = 'local') {
  const mode = String(value || '').trim().toLowerCase();
  if (mode === 'local' || mode === 'preferences') {
    return mode;
  }
  return fallback;
}

function normalizePositiveInt(value, fallback) {
  const parsed = Number(value);
  if (Number.isFinite(parsed) && parsed > 0) {
    return Math.trunc(parsed);
  }
  return fallback;
}

function normalizeBoolean(value, fallback = true) {
  if (typeof value === 'boolean') {
    return value;
  }
  if (typeof value === 'string') {
    const normalized = value.trim().toLowerCase();
    if (normalized === 'true' || normalized === '1') {
      return true;
    }
    if (normalized === 'false' || normalized === '0') {
      return false;
    }
  }
  return fallback;
}

function resolveObject(value) {
  if (!value || typeof value !== 'object' || Array.isArray(value)) {
    return {};
  }
  return value;
}

const envQuery = env ? `?env=${encodeURIComponent(env)}` : '';
const datatableBaseId = dataGridConfig.table_id || '{{ datatable_id|default:resource }}';
const datatableId = `${datatableBaseId}-datatable`;
const columnStorageKey = dataGridConfig.column_storage_key || `content_${'{{ panel_name }}'}_datatable_columns`;

let grid;

document.addEventListener('DOMContentLoaded', async function() {
  const tableEl = document.getElementById(datatableId);
  if (!tableEl) {
    return;
  }

  const preferencesEndpoint = apiBasePath ? `${apiBasePath}/preferences` : `${basePath}/api/preferences`;
  const stateStoreOptions = resolveObject(dataGridConfig.state_store);
  const urlStateOptions = resolveObject(dataGridConfig.url_state);
  const stateStoreMode = normalizeStateStoreMode(
    stateStoreOptions.mode || dataGridConfig.state_store_mode,
    'local'
  );
  const stateStoreConfig = {
    mode: stateStoreMode,
    resource: String(
      stateStoreOptions.resource ||
      dataGridConfig.state_store_resource ||
      panelName
    ).trim() || panelName,
    syncDebounceMs: normalizePositiveInt(
      stateStoreOptions.sync_debounce_ms ?? dataGridConfig.state_store_sync_debounce_ms,
      1000
    ),
    maxShareEntries: normalizePositiveInt(
      stateStoreOptions.max_share_entries ?? dataGridConfig.state_store_max_share_entries,
      20
    )
  };
  if (stateStoreMode === 'preferences') {
    stateStoreConfig.preferencesEndpoint = preferencesEndpoint;
  }
  const urlStateConfig = {
    maxURLLength: normalizePositiveInt(
      urlStateOptions.max_url_length ?? dataGridConfig.url_state_max_url_length,
      1800
    ),
    maxFiltersLength: normalizePositiveInt(
      urlStateOptions.max_filters_length ?? dataGridConfig.url_state_max_filters_length,
      600
    ),
    enableStateToken: normalizeBoolean(
      urlStateOptions.enable_state_token ?? dataGridConfig.url_state_enable_token,
      true
    )
  };

  const columnVisibility = new ServerColumnVisibilityBehavior(columnFields, {
    resource: '{{ panel_name }}',
    localStorageKey: columnStorageKey,
    preferencesEndpoint: preferencesEndpoint
  });
  await columnVisibility.loadFromServer();

  // Initialize schema action builder
  schemaActionBuilder = new SchemaActionBuilder({
    apiEndpoint: apiEndpoint,
    actionBasePath: actionBasePath,
    actionContext: 'row',
    locale: locale || undefined,
    environment: env || undefined,
    panelName: panelName,
    useDefaultFallback: true,
    onTranslationBlocker: async (info) => {
      // Modal-first translation blocker handling
      await showTranslationBlocker({
        transition: info.transition,
        entityType: info.entityType,
        recordId: info.recordId,
        missingLocales: info.missingLocales,
        missingFieldsByLocale: info.missingFieldsByLocale,
        requestedLocale: info.requestedLocale,
        environment: info.environment,
        apiEndpoint: apiEndpoint,
        navigationBasePath: actionBasePath,
        panelName: panelName,
        onCreateSuccess: async (locale, result) => {
          if (window.toastManager) {
            window.toastManager.success(`Created ${locale} translation`);
          }
          // Refresh grid to show updated state
          await grid.refresh();
        },
        onRetry: async () => {
          if (typeof info.retry !== 'function') {
            await grid.refresh();
            return;
          }
          try {
            const retryResult = await info.retry();
            if (retryResult.success) {
              await grid.refresh();
            }
          } catch (err) {
            // onActionError already handles non-blocker action errors.
          }
        },
        onError: (message) => {
          if (window.toastManager) {
            window.toastManager.error(message);
          }
        },
        onDismiss: () => {
          // User dismissed modal without action
        }
      });
    },
    onActionSuccess: async (actionName, result) => {
      console.log('[Content List] Action success:', actionName, result);
      if (window.toastManager) {
        window.toastManager.success(`${actionName} completed successfully`);
      }
      await grid.refresh();
    },
    onActionError: (actionName, error) => {
      console.error('[Content List] Action error:', actionName, error);
      if (window.toastManager) {
        window.toastManager.error(error.message || `${actionName} failed`);
      }
    }
  });

  // Custom cell renderers for translation context
  const translationCellRenderers = {
    // Locale column - shows locale badge with fallback indicator
    locale: (value, record) => {
      const ctx = extractTranslationContext(record);
      if (!ctx.resolvedLocale) {
        return value ? `<span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-600">${String(value).toUpperCase()}</span>` : '-';
      }
      return renderLocaleBadge(ctx, { showFallbackIndicator: true, size: 'sm' });
    },
    // Translation status column - shows locale + available locales
    translation_status: (value, record) => {
      const mode = grid ? normalizeViewMode(grid.getViewMode(), defaultViewMode) : defaultViewMode;
      if (mode === 'matrix') {
        return renderTranslationMatrixCell(record, { size: 'sm', maxLocales: 6 });
      }
      return renderTranslationStatusCell(record, { size: 'sm', maxLocales: 3 });
    },
    // Available locales column
    available_locales: (value, record) => {
      const ctx = extractTranslationContext(record);
      if (ctx.availableLocales.length === 0) {
        return '<span class="text-gray-400">-</span>';
      }
      return ctx.availableLocales.map(loc => {
        const isResolved = loc === ctx.resolvedLocale;
        const pillClass = isResolved
          ? 'px-1.5 py-0.5 text-[10px] rounded bg-blue-100 text-blue-700 font-medium'
          : 'px-1.5 py-0.5 text-[10px] rounded bg-gray-100 text-gray-600';
        return `<span class="${pillClass}">${loc.toUpperCase()}</span>`;
      }).join(' ');
    },
    // Phase 19: Translation readiness indicator (uses canonical backend fields)
    translation_readiness: (value, record) => {
      // Prefer productized readiness metadata when available
      if (hasTranslationReadiness(record)) {
        return renderReadinessIndicator(record, { size: 'sm', showDetailedTooltip: true });
      }
      // Legacy fallback: show nothing if no readiness metadata
      return '<span class="text-gray-400">-</span>';
    },
    // Phase 19: Publish readiness badge (compact ready/not ready)
    publish_readiness: (value, record) => {
      if (hasTranslationReadiness(record)) {
        return renderPublishReadinessBadge(record, { size: 'sm' });
      }
      return '';
    },
    // Phase 19: Locale completeness (X/Y format)
    locale_completeness: (value, record) => {
      return renderLocaleCompleteness(record, { size: 'sm' });
    },
    // Phase 19.2: Missing translations badge (prominent affordance)
    missing_translations: (value, record) => {
      // First-class affordance for identifying incomplete content
      return renderMissingTranslationsBadge(record, { size: 'sm' });
    }
  };

  const extensionCellRenderers = (window.contentEntryCellRenderers && typeof window.contentEntryCellRenderers === 'object')
    ? window.contentEntryCellRenderers
    : {};
  const mergedCellRenderers = {
    ...extensionCellRenderers,
    ...translationCellRenderers
  };

  grid = new DataGrid({
    tableId: datatableId,
    apiEndpoint: apiEndpoint,
    actionBasePath: actionBasePath,
    panelId: panelName,
    enableGroupedMode: groupedModeEnabled,
    defaultViewMode: defaultViewMode,
    groupByField: groupByField,
    stateStoreConfig: stateStoreConfig,
    urlState: urlStateConfig,
    columns: gridColumns,
    perPage: 10,
    searchDelay: 300,
    cellRenderers: mergedCellRenderers,
    rowActions: (item) => {
      // Use schema actions if available, otherwise fall back to defaults
      const schema = grid.getSchema();
      const schemaActions = schema?.actions || cachedSchemaActions;
      return schemaActionBuilder.buildRowActions(item, schemaActions);
    },
    behaviors: {
      search: new PanelSearchBehavior(),
      filter: new GoCrudFilterBehavior(),
      pagination: new PanelPaginationBehavior(),
      sort: new GoCrudSortBehavior(),
      columnVisibility: columnVisibility
    },
    selectors: {
      searchInput: '#table-search',
      perPageSelect: '#table-per-page',
      filterRow: '[data-filter-column]',
      columnToggleBtn: '#column-toggle-btn',
      columnToggleMenu: '#column-toggle-menu',
      exportBtn: '#export-btn',
      exportMenu: '#export-menu',
      paginationContainer: '#table-pagination',
      tableInfoStart: '#table-info-start',
      tableInfoEnd: '#table-info-end',
      tableInfoTotal: '#table-info-total',
      selectAllCheckbox: '#table-checkbox-all',
      rowCheckboxes: '.table-checkbox',
      bulkActionsBar: '#bulk-actions-overlay',
      selectedCount: '#selected-count'
    },
    notifier: window.toastManager
  });

  const viewModeButtons = Array.from(document.querySelectorAll('.translation-view-mode-btn'));
  const expandAllBtn = document.getElementById('group-expand-all-btn');
  const collapseAllBtn = document.getElementById('group-collapse-all-btn');

  const syncTranslationViewControls = () => {
    if (!translationUXEnabled || !groupedModeEnabled) {
      return;
    }
    const currentMode = normalizeViewMode(grid.getViewMode(), defaultViewMode);
    viewModeButtons.forEach((button) => {
      const mode = normalizeViewMode(button.dataset.viewMode, 'flat');
      const isActive = mode === currentMode;
      button.classList.toggle('bg-blue-100', isActive);
      button.classList.toggle('text-blue-700', isActive);
      button.classList.toggle('text-gray-700', !isActive);
      button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });

    const groupedData = grid.getGroupedData();
    const groupedLayoutMode = currentMode === 'grouped' || currentMode === 'matrix';
    const canToggleGroups = groupedLayoutMode && groupedData && Array.isArray(groupedData.groups) && groupedData.groups.length > 0;
    if (expandAllBtn) expandAllBtn.disabled = !canToggleGroups;
    if (collapseAllBtn) collapseAllBtn.disabled = !canToggleGroups;
  };

  if (translationUXEnabled && groupedModeEnabled) {
    viewModeButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const mode = normalizeViewMode(button.dataset.viewMode, defaultViewMode);
        grid.setViewMode(mode);
        syncTranslationViewControls();
      });
    });

    if (expandAllBtn) {
      expandAllBtn.addEventListener('click', () => {
        grid.expandAllGroups();
        syncTranslationViewControls();
      });
    }

    if (collapseAllBtn) {
      collapseAllBtn.addEventListener('click', () => {
        grid.collapseAllGroups();
        syncTranslationViewControls();
      });
    }
  }

  // Cache schema actions after each refresh for row action rendering
  // Override refresh before init() to ensure caching on first load
  const originalRefresh = grid.refresh.bind(grid);
  grid.refresh = async function() {
    await originalRefresh();
    const schema = grid.getSchema();
    if (schema?.actions) {
      cachedSchemaActions = schema.actions;
    }
    syncTranslationViewControls();
  };

  grid.init();
  syncTranslationViewControls();

  // ============================================================================
  // Translation UX Primitives Initialization (TX-088)
  // ============================================================================

  // Initialize status legend if container exists
  const statusLegendContainer = document.getElementById('translation-status-legend');
  if (statusLegendContainer && translationUXEnabled) {
    createStatusLegend({
      container: statusLegendContainer,
      size: 'sm',
      orientation: 'horizontal'
    });
  }

  // Initialize quick filters if container exists
  const quickFiltersContainer = document.getElementById('translation-quick-filters');
  const canonicalIncompleteFilter = {
    column: 'incomplete',
    operator: 'eq',
    value: 'true'
  };
  const incompleteFilterButtonSelector = '[id="incomplete-translations-filter"]';
  let quickFiltersInstance = null;
  if (quickFiltersContainer && translationUXEnabled) {
    quickFiltersInstance = createTranslationQuickFilters(
      quickFiltersContainer,
      async (filter) => {
        if (filter === null) {
          // Clear filter - remove readiness_state and fallback_used filters
          grid.state.filters = grid.state.filters.filter(f =>
            f.column !== 'readiness_state' && f.column !== 'fallback_used' && f.column !== 'incomplete'
          );
        } else {
          // Apply quick filter
          // Remove any existing readiness/fallback filter first
          grid.state.filters = grid.state.filters.filter(f =>
            f.column !== 'readiness_state' && f.column !== 'fallback_used' && f.column !== 'incomplete'
          );
          // Canonical quick-filter predicate for translation incompleteness.
          const useCanonicalIncompletePredicate = filter.key === 'missing_locales' || filter.key === 'missing_fields' || filter.key === 'incomplete';
          if (useCanonicalIncompletePredicate) {
            grid.state.filters.push({
              ...canonicalIncompleteFilter
            });
          } else {
            grid.state.filters.push({
              column: filter.field,
              operator: 'eq',
              value: filter.value
            });
          }
        }
        grid.resetPagination();
        grid.syncURL();
        await grid.refresh();
      },
      { size: 'sm' }
    );
    const existingIncompleteBtn = quickFiltersContainer.querySelector(incompleteFilterButtonSelector);
    if (!existingIncompleteBtn) {
      const preferredIncompleteBtn = quickFiltersContainer.querySelector('[data-filter-key="missing_fields"]')
        || quickFiltersContainer.querySelector('[data-filter-key="missing_locales"]');
      if (preferredIncompleteBtn instanceof HTMLElement) {
        preferredIncompleteBtn.id = 'incomplete-translations-filter';
      }
    }
  }

  const refreshBtn = document.getElementById('refresh-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      refreshBtn.classList.add('opacity-50');
      try {
        await grid.refresh();
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('opacity-50');
      }
    });
  }

  const filterToggleBtn = document.getElementById('filter-toggle-btn');
  if (filterFields.length > 0) {
    new FilterBuilder({
      notifier: window.toastManager,
      fields: filterFields,
      onApply: (structure) => {
        const appliedFilters = [];
        structure.groups.forEach(group => {
          group.conditions.forEach(condition => {
            appliedFilters.push({
              column: condition.field,
              operator: condition.operator,
              value: condition.value
            });
          });
        });
        grid.state.filters = appliedFilters;
        grid.resetPagination();
        grid.syncURL();
        grid.refresh();
      },
      onClear: () => {
        grid.state.search = '';
        grid.state.filters = [];
        grid.syncURL();
        grid.refresh();
      }
    });
  } else if (filterToggleBtn) {
    filterToggleBtn.disabled = true;
    filterToggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }

});

</script>
{% endblock %}
