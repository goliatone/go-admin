{% extends "layout.html" %}

{% block title %}{% if is_edit %}Edit{% else %}New{% endif %} {{ resource_label|default:"Content" }} - {{ title }}{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <div>
    <p class="text-sm text-gray-500 mb-1">{{ resource_label|default:"Content" }}</p>
    <h1 class="text-3xl font-bold text-admin-dark">{% if is_edit %}Edit{% else %}Create{% endif %} {{ resource_label|default:"Content" }}</h1>
  </div>
  <div class="flex gap-3">
    {% if preview_url %}
      <a href="{{ preview_url }}" class="btn btn-secondary" target="_blank" rel="noopener">
        Preview
      </a>
    {% endif %}
    {% if routes.index %}
      <a href="{{ routes.index }}" class="btn btn-secondary">
        <i class="iconoir-arrow-left"></i>
        Back to {{ resource_label|default:"Content" }}
      </a>
    {% endif %}
  </div>
</header>

{% if is_edit and resource_item %}
  {% set fallback_requested_locale = resource_item.requested_locale %}
  {% if not fallback_requested_locale and resource_item.translation and resource_item.translation.meta %}
    {% set fallback_requested_locale = resource_item.translation.meta.requested_locale %}
  {% endif %}
  {% set fallback_resolved_locale = resource_item.resolved_locale %}
  {% if not fallback_resolved_locale and resource_item.locale %}
    {% set fallback_resolved_locale = resource_item.locale %}
  {% endif %}
  {% if not fallback_resolved_locale and resource_item.translation and resource_item.translation.meta %}
    {% set fallback_resolved_locale = resource_item.translation.meta.resolved_locale %}
  {% endif %}
  {% set fallback_mode = resource_item.fallback_used %}
  {% if not fallback_mode and resource_item.translation and resource_item.translation.meta and resource_item.translation.meta.fallback_used %}
    {% set fallback_mode = true %}
  {% endif %}
{% endif %}

<div class="flex-1 p-8 overflow-y-auto"
     {% if is_edit and resource_item %}
     data-record-id="{{ resource_item.id }}"
     data-panel-name="{{ panel_name }}"
     {% if fallback_mode %}
     data-fallback-mode="true"
     data-requested-locale="{{ fallback_requested_locale }}"
     data-resolved-locale="{{ fallback_resolved_locale }}"
     {% endif %}
     {% endif %}>

  {# Translation Summary for multilingual content in edit mode #}
  {% if is_edit and resource_item %}
    {% set has_translation_context = resource_item.translation_group_id %}
    {% if not has_translation_context and resource_item.translation and resource_item.translation.meta and resource_item.translation.meta.translation_group_id %}
      {% set has_translation_context = resource_item.translation.meta.translation_group_id %}
    {% endif %}
    {% if has_translation_context %}
      {% set translation_group_id = resource_item.translation_group_id %}
      {% if not translation_group_id and resource_item.translation and resource_item.translation.meta %}
        {% set translation_group_id = resource_item.translation.meta.translation_group_id %}
      {% endif %}
      {% set requested_locale = resource_item.requested_locale %}
      {% if not requested_locale and resource_item.translation and resource_item.translation.meta %}
        {% set requested_locale = resource_item.translation.meta.requested_locale %}
      {% endif %}
      {% set resolved_locale = resource_item.resolved_locale %}
      {% if not resolved_locale and resource_item.locale %}
        {% set resolved_locale = resource_item.locale %}
      {% endif %}
      {% if not resolved_locale and resource_item.translation and resource_item.translation.meta %}
        {% set resolved_locale = resource_item.translation.meta.resolved_locale %}
      {% endif %}
      {% set available_locales = resource_item.available_locales %}
      {% if not available_locales and resource_item.translation and resource_item.translation.meta %}
        {% set available_locales = resource_item.translation.meta.available_locales %}
      {% endif %}
      {% set missing_requested_locale = resource_item.missing_requested_locale %}
      {% if not missing_requested_locale and resource_item.translation and resource_item.translation.meta and resource_item.translation.meta.missing_requested_locale %}
        {% set missing_requested_locale = true %}
      {% endif %}
      {% set fallback_used = resource_item.fallback_used %}
      {% if not fallback_used and resource_item.translation and resource_item.translation.meta and resource_item.translation.meta.fallback_used %}
        {% set fallback_used = true %}
      {% endif %}
      {# Phase 19.3: Pass translation_readiness for productized mode #}
      {% set translation_readiness = resource_item.translation_readiness %}
      {% include "partials/translation-summary.html" with translation_group_id=translation_group_id requested_locale=requested_locale resolved_locale=resolved_locale available_locales=available_locales missing_requested_locale=missing_requested_locale fallback_used=fallback_used panel_name=panel_name record_id=resource_item.id show_create_actions=true compact=false translation_readiness=translation_readiness %}
    {% endif %}
  {% endif %}

  {{ form_html|safe }}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ adminURL("runtime/formgen-behaviors.min.js") }}" defer></script>
<script src="{{ adminURL("runtime/formgen-relationships.min.js") }}" defer></script>
<script type="module">
  import { executeActionRequest } from '{{ base_path }}/assets/dist/toast/error-helpers.js';

  window.addEventListener("DOMContentLoaded", () => {
    // Initialize formgen relationships
    const api = window.FormgenRelationships;
    if (api && typeof api.initRelationships === "function") {
      api.initRelationships();
    }

    // Handle create-translation actions from translation summary
    document.querySelectorAll('[data-action="create-translation"]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const locale = btn.dataset.locale;
        const panelName = btn.dataset.panel;
        const recordId = btn.dataset.recordId;

        if (!locale || !panelName || !recordId) {
          console.error('[ContentForm] Missing data for create-translation action');
          return;
        }

        const endpoint = `{{ base_path }}/api/${panelName}/actions/create_translation`;
        const payload = {
          id: recordId,
          locale: locale,
          {% if env %}environment: '{{ env }}',{% endif %}
        };

        btn.disabled = true;
        btn.classList.add('opacity-50');

        try {
          const result = await executeActionRequest(endpoint, payload);
          if (result.success && result.data?.id) {
            // Navigate to the newly created translation
            const newUrl = `{{ base_path }}/${panelName}/${result.data.id}/edit?locale=${locale}{% if env %}&env={{ env }}{% endif %}`;
            window.location.href = newUrl;
          } else if (result.success) {
            // Reload to show updated state
            window.location.reload();
          }
        } catch (error) {
          console.error('[ContentForm] Create translation failed:', error);
          if (window.toastManager) {
            window.toastManager.error(error.message || 'Failed to create translation');
          } else {
            alert(error.message || 'Failed to create translation');
          }
        } finally {
          btn.disabled = false;
          btn.classList.remove('opacity-50');
        }
      });
    });

    // Disable form submission in fallback mode
    const container = document.querySelector('[data-fallback-mode="true"]');
    if (container) {
      const form = container.querySelector('form');
      if (form) {
        // Disable submit buttons
        form.querySelectorAll('button[type="submit"], input[type="submit"]').forEach(btn => {
          btn.disabled = true;
          btn.title = 'Create the translation first to enable editing';
          btn.classList.add('opacity-50', 'cursor-not-allowed');
        });

        // Prevent form submission
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          if (window.toastManager) {
            window.toastManager.warning('Cannot save in fallback mode. Create the translation first.');
          } else {
            alert('Cannot save in fallback mode. Create the translation first.');
          }
        });
      }
    }
  });
</script>
{% endblock %}
