{% extends "layout.html" %}

{% block title %}{{ resource_label|default:resource|title }} - {{ title }}{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-admin-dark">{{ resource_label|default:resource|title }}</h1>
  <div class="flex gap-3">
    <a href="{{ routes.new }}" class="btn btn-primary">+ New {{ singularize(resource_label|default:resource)|title }}</a>
  </div>
</header>

<div class="flex-1 p-8 overflow-y-auto">
  {# DataGrid Toolbar #}
  <div class="bg-white border border-gray-200 rounded-xl mb-4 p-4">
    <div class="flex flex-wrap gap-4 items-center">
      {# Search #}
      <div class="flex-1 min-w-[200px]">
        <input
          type="text"
          id="table-search"
          placeholder="Search tenants..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>

      {# Filter Button #}
      <button
        id="filter-toggle-btn"
        class="btn btn-secondary flex items-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        Filters
      </button>

      {# Column Visibility #}
      <div class="relative">
        <button
          id="column-toggle-btn"
          data-dropdown-toggle="column-toggle-menu"
          class="btn btn-secondary flex items-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Columns
        </button>
        <div id="column-toggle-menu" class="hidden absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
          <div class="p-2 space-y-1">
            {# Populated by ColumnVisibility behavior #}
          </div>
        </div>
      </div>

      {# Export #}
      <div class="relative">
        <button
          id="export-btn"
          data-dropdown-toggle="export-menu"
          class="btn btn-secondary flex items-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Export
        </button>
        <div id="export-menu" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
          <button data-export-format="csv" class="export-btn w-full flex items-center gap-2 text-left px-4 py-2 hover:bg-gray-100 text-sm disabled:opacity-50 disabled:pointer-events-none">
            <span class="export-icon w-4 h-4 text-green-600">CSV</span>
            <span class="export-spinner hidden w-4 h-4 border-2 border-gray-300 border-t-gray-600 rounded-full animate-spin"></span>
          </button>
          <button data-export-format="json" class="export-btn w-full flex items-center gap-2 text-left px-4 py-2 hover:bg-gray-100 text-sm disabled:opacity-50 disabled:pointer-events-none">
            <span class="export-icon w-4 h-4 text-indigo-600">JSON</span>
            <span class="export-spinner hidden w-4 h-4 border-2 border-gray-300 border-t-gray-600 rounded-full animate-spin"></span>
          </button>
          <button data-export-format="excel" class="export-btn w-full flex items-center gap-2 text-left px-4 py-2 hover:bg-gray-100 text-sm disabled:opacity-50 disabled:pointer-events-none">
            <span class="export-icon w-4 h-4 text-emerald-600">Excel</span>
            <span class="export-spinner hidden w-4 h-4 border-2 border-gray-300 border-t-gray-600 rounded-full animate-spin"></span>
          </button>
        </div>
      </div>

      {# Refresh #}
      <button
        id="refresh-btn"
        class="btn btn-secondary flex items-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refresh
      </button>
    </div>

    {# Applied Filter Preview #}
    <div id="applied-filter-preview" class="hidden mt-4 text-sm text-gray-600">
      <span class="font-medium">Applied filter:</span>
      <span id="filter-preview-text" class="ml-1"></span>
      <button type="button" id="clear-filters-btn" class="ml-2 text-red-600 hover:text-red-800" aria-label="Clear filters">
        <svg class="inline h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>
        </svg>
      </button>
    </div>

    {# Filter Panel (rendered by FilterBuilder) #}
    <div id="filter-panel" class="hidden fixed z-50 bg-white border border-gray-200 rounded-lg shadow-xl p-4 max-h-[80vh] overflow-y-auto" style="width: 800px;">
      {# Panel content is rendered by FilterBuilder #}
    </div>
  </div>

  {# DataGrid Table #}
  <div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
    <div class="overflow-x-auto">
      <table id="tenants-datatable" class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" data-role="selection" data-fixed="left" class="px-6 py-3 text-start">
              <input type="checkbox" id="table-checkbox-all" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
            </th>
            <th scope="col" data-column="name" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
              Name
              <button class="sort-btn ml-1" data-sort-column="name">
                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
              </button>
            </th>
            <th scope="col" data-column="slug" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
              Slug
              <button class="sort-btn ml-1" data-sort-column="slug">
                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
              </button>
            </th>
            <th scope="col" data-column="status" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
              Status
              <button class="sort-btn ml-1" data-sort-column="status">
                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
              </button>
            </th>
            <th scope="col" data-column="created_at" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
              Created
              <button class="sort-btn ml-1" data-sort-column="created_at">
                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
              </button>
            </th>
            <th scope="col" data-role="actions" data-fixed="right" class="px-6 py-3 text-end text-xs font-medium text-gray-500 uppercase tracking-wider">
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {# Rows populated by DataGrid #}
        </tbody>
      </table>
    </div>

  </div>

  {# Pagination #}
  <div class="mt-4 flex justify-between items-center bg-white border border-gray-200 rounded-xl p-4">
    <div class="text-sm text-gray-600">
      Showing <span id="table-info-start">0</span> to <span id="table-info-end">0</span> of <span id="table-info-total">0</span> results
    </div>
    <div class="flex gap-2 items-center">
      <nav id="table-pagination" class="flex items-center gap-x-1"></nav>
      <select id="table-per-page" class="ml-4 border border-gray-300 rounded-lg px-3 py-2 text-sm">
        <option value="10">10 per page</option>
        <option value="25">25 per page</option>
        <option value="50">50 per page</option>
        <option value="100">100 per page</option>
      </select>
    </div>
  </div>

  {# Overlay for filter panel #}
  <div id="filter-overlay" class="hidden fixed inset-0 bg-black opacity-30 z-40"></div>

  <!-- Floating Bulk Actions Bar -->
  <div id="bulk-actions-overlay" class="bulk-actions-overlay hidden">
    <div class="bulk-actions-bar" id="bulk-actions-bar">
      <div class="flex items-center gap-4">
        <button id="bulk-clear-selection" class="bulk-close-btn" aria-label="Clear selection">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
        <span class="bulk-count-text">Selected: <span id="selected-count">0</span></span>
      </div>

      <div class="flex items-center gap-2">
        <button class="bulk-action-btn" data-bulk-action="activate">Activate</button>
        <button class="bulk-action-btn" data-bulk-action="suspend">Suspend</button>
        <button class="bulk-action-btn" data-bulk-action="archive">Archive</button>
        <button class="bulk-action-btn bulk-action-btn--danger" data-bulk-action="delete">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
  import {
    DataGrid,
    FilterBuilder,
    GoCrudSearchBehavior,
    GoCrudFilterBehavior,
    GoCrudPaginationBehavior,
    GoCrudSortBehavior,
    GoCrudExportBehavior,
    DefaultColumnVisibilityBehavior
  } from '{{ base_path }}/assets/dist/datatable/index.js';

  // Action base path for view/edit/delete
  const basePath = '{{ base_path }}';
  const actionBasePath = window.location.pathname.replace('/list', '');
  const exportConfig = {{ toJSON(export_config)|safe }};
  const bulkEndpoint = `${basePath}/crud/tenants/bulk`;

  // Initialize DataGrid
  const grid = new DataGrid({
    tableId: 'tenants-datatable',
    apiEndpoint: `${basePath}/crud/tenants`,
    actionBasePath: actionBasePath,
    columns: [
      { field: 'name', label: 'Name', sortable: true, filterable: true },
      { field: 'slug', label: 'Slug', sortable: true, filterable: true },
      { field: 'status', label: 'Status', sortable: true, filterable: true, render: (value) => `<span class="status-badge status-${value}">${value}</span>` },
      { field: 'created_at', label: 'Created', sortable: true, filterable: true }
    ],
    bulkActions: [
      {
        id: 'activate',
        label: 'Activate',
        endpoint: `${bulkEndpoint}/activate`,
        confirm: 'Activate {count} tenant(s)?'
      },
      {
        id: 'suspend',
        label: 'Suspend',
        endpoint: `${bulkEndpoint}/suspend`,
        confirm: 'Suspend {count} tenant(s)?'
      },
      {
        id: 'archive',
        label: 'Archive',
        endpoint: `${bulkEndpoint}/archive`,
        confirm: 'Archive {count} tenant(s)?'
      },
      {
        id: 'delete',
        label: 'Delete',
        endpoint: `${bulkEndpoint}/delete`,
        confirm: 'Delete {count} tenant(s)?'
      }
    ],
    perPage: 10,
    searchDelay: 300,
    behaviors: {
      search: new GoCrudSearchBehavior(['name', 'slug']),
      filter: new GoCrudFilterBehavior(),
      pagination: new GoCrudPaginationBehavior(),
      sort: new GoCrudSortBehavior(),
      export: new GoCrudExportBehavior(exportConfig),
      columnVisibility: new DefaultColumnVisibilityBehavior(
        ['name', 'slug', 'status', 'created_at'],
        'tenants_datatable_columns'
      )
    }
  });

  // Initialize FilterBuilder
  new FilterBuilder({
    fields: [
      { name: 'name', label: 'Name', type: 'text' },
      { name: 'slug', label: 'Slug', type: 'text' },
      { name: 'status', label: 'Status', type: 'select', options: [
        { label: 'Active', value: 'active' },
        { label: 'Suspended', value: 'suspended' },
        { label: 'Archived', value: 'archived' }
      ]},
      { name: 'created_at', label: 'Created Date', type: 'date' }
    ],
    onApply: (structure) => {
      const filters = [];
      structure.groups.forEach(group => {
        group.conditions.forEach(condition => {
          filters.push({
            column: condition.field,
            operator: condition.operator,
            value: condition.value
          });
        });
      });
      grid.state.filters = filters;
      grid.resetPagination();
      grid.syncURL();
      grid.refresh();
    },
    onClear: () => {
      grid.state.filters = [];
      grid.resetPagination();
      grid.syncURL();
      grid.refresh();
    }
  });

  document.getElementById('refresh-btn').addEventListener('click', () => {
    grid.refresh();
  });

  // Initialize grid
  grid.init();
</script>
{% endblock %}
