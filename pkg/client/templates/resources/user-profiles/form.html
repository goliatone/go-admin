{% extends "layout.html" %}

{% block title %}{% if is_edit %}Edit {{ singularize(resource_label|default:resource)|title }}{% else %}New {{ singularize(resource_label|default:resource)|title }}{% endif %} - {{ title }}{% endblock %}

{% block content %}
  <header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
    <h1 class="text-3xl font-bold text-admin-dark">{% if is_edit %}Edit{% else %}Create{% endif %} {{ singularize(resource_label|default:resource)|title }}</h1>
    {% if routes.index %}
      <a href="{{ routes.index }}" class="btn btn-secondary">
        <i class="iconoir-arrow-left"></i>
        Back to {{ resource_label|default:resource|title }}
      </a>
    {% endif %}
  </header>

  <div class="flex-1 p-8 overflow-y-auto">
    {{ form_html|safe }}
  </div>

  {% include "partials/modals/user_create.html" %}
{% endblock %}

{% block scripts %}
  <script src="{{ adminURL("runtime/formgen-relationships.min.js") }}" defer></script>
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const api = window.FormgenRelationships;
      if (!api?.initRelationships) {
        return;
      }

      const basePath = "{{ base_path }}";

      const openModal = (modal) => {
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.setAttribute("aria-hidden", "false");
      };

      const closeModal = (modal) => {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        modal.setAttribute("aria-hidden", "true");
      };

      const waitForSubmit = (form) =>
        new Promise((resolve) => {
          const onSubmit = (event) => {
            event.preventDefault();
            form.removeEventListener("submit", onSubmit);
            resolve(new FormData(form));
          };
          const onCancel = () => {
            form.removeEventListener("submit", onSubmit);
            resolve(null);
          };
          form.addEventListener("submit", onSubmit, { once: true });
          form.querySelectorAll("[data-fg-modal-close]").forEach((btn) => {
            btn.addEventListener("click", onCancel, { once: true });
          });
        });

      const unwrapRecord = (payload) => {
        if (!payload) {
          return null;
        }
        if (payload.data && typeof payload.data === "object") {
          return payload.data;
        }
        return payload;
      };

      api.initRelationships({
        onCreateAction: async (_context, detail) => {
          if (!detail || detail.actionId !== "user") {
            return;
          }

          const modal = document.querySelector('[data-fg-create-modal="user"]');
          const form = document.getElementById("form-user-create");
          if (!(modal instanceof HTMLElement) || !(form instanceof HTMLFormElement)) {
            return;
          }

          const usernameInput = form.querySelector('input[name="username"]');
          if (usernameInput instanceof HTMLInputElement && detail.query) {
            usernameInput.value = detail.query;
          }

          openModal(modal);
          const data = await waitForSubmit(form);
          closeModal(modal);
          if (!data) {
            return;
          }

          const payload = Object.fromEntries(data.entries());
          const response = await fetch(`${basePath}/crud/users`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            console.error("user create failed", response.status);
            return;
          }

          let record = null;
          try {
            record = unwrapRecord(await response.json());
          } catch (err) {
            console.error("user create failed to parse response", err);
            return;
          }

          const value = record?.id || payload.username || payload.email;
          const label = record?.label || record?.username || record?.email || payload.username || payload.email;
          if (!value || !label) {
            return;
          }

          return { value: String(value), label: String(label) };
        },
      });
    });
  </script>
{% endblock %}
