{% extends "layout.html" %}

{% block title %}{% if is_edit %}Edit{% else %}Create{% endif %} Agreement - {{ title }}{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <div>
    <p class="text-sm text-gray-500 mb-1">E-Sign Agreements</p>
    <h1 class="text-3xl font-bold text-admin-dark">{% if is_edit %}Edit{% else %}Create{% endif %} Agreement</h1>
  </div>
  <div class="flex items-center gap-4">
    <div id="sync-status-indicator" class="hidden flex items-center gap-2 text-sm" role="status" aria-live="polite">
      <span id="sync-status-icon" class="w-2 h-2 rounded-full bg-green-500"></span>
      <span id="sync-status-text" class="text-gray-600">Saved</span>
      <button type="button" id="sync-retry-btn" class="hidden text-xs text-blue-600 hover:text-blue-700 underline">Retry</button>
    </div>
    <div class="flex gap-3">
      {% if routes.index %}
        <a href="{{ routes.index }}" class="btn btn-secondary" aria-label="Return to agreements list">
          <i class="iconoir-arrow-left" aria-hidden="true"></i>
          Back to Agreements
        </a>
      {% endif %}
    </div>
  </div>
</header>

{# Resume Draft Dialog Modal #}
<div id="resume-dialog-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="resume-dialog-title">
  <div class="fixed inset-0 bg-black/50" aria-hidden="true"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
          <svg class="w-5 h-5 text-blue-600" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
        <h3 id="resume-dialog-title" class="text-lg font-semibold text-gray-900">Resume Agreement?</h3>
      </div>
      <p class="text-sm text-gray-600 mb-2">You have an incomplete agreement:</p>
      <div class="p-3 bg-gray-50 rounded-lg mb-4">
        <p class="text-sm font-medium text-gray-900" id="resume-draft-title">Untitled Agreement</p>
        <p class="text-xs text-gray-500 mt-1">
          Step <span id="resume-draft-step">1</span> of 6 &middot; Last edited <span id="resume-draft-time">just now</span>
        </p>
      </div>
      <div class="flex flex-col gap-2">
        <button type="button" id="resume-continue-btn" class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
          Continue where I left off
        </button>
        <button type="button" id="resume-new-btn" class="w-full px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
          Start new agreement
        </button>
        <button type="button" id="resume-discard-btn" class="w-full px-4 py-2 text-red-600 text-sm font-medium rounded-lg hover:bg-red-50 transition-colors">
          Discard saved progress
        </button>
      </div>
    </div>
  </div>
</div>

{# Conflict Resolution Dialog Modal #}
<div id="conflict-dialog-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="conflict-dialog-title">
  <div class="fixed inset-0 bg-black/50" aria-hidden="true"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
          <svg class="w-5 h-5 text-amber-600" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        <h3 id="conflict-dialog-title" class="text-lg font-semibold text-gray-900">Version Conflict</h3>
      </div>
      <p class="text-sm text-gray-600 mb-4">
        This agreement was modified elsewhere. Your changes could not be saved because they conflict with the newer version.
      </p>
      <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg mb-4 text-xs text-amber-800">
        <p><strong>Your version:</strong> <span id="conflict-local-time">-</span></p>
        <p><strong>Server version:</strong> <span id="conflict-server-time">-</span> (revision <span id="conflict-server-revision">-</span>)</p>
      </div>
      <div class="flex flex-col gap-2">
        <button type="button" id="conflict-reload-btn" class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
          Load server version
        </button>
        <button type="button" id="conflict-force-btn" class="w-full px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
          Keep my changes (overwrite server)
        </button>
        <button type="button" id="conflict-dismiss-btn" class="w-full px-4 py-2 text-gray-500 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
          Dismiss (keep editing locally)
        </button>
      </div>
    </div>
  </div>
</div>

{# Six-Step Wizard Navigation #}
<div class="px-8 py-4 bg-gray-50 border-b border-gray-200">
  <nav aria-label="Agreement creation progress">
    <ol class="flex items-center justify-between max-w-4xl mx-auto" role="list">
      <li class="flex items-center" role="listitem">
        <button type="button" class="wizard-step-btn flex items-center gap-2 text-sm font-medium text-blue-600" data-step="1" aria-current="step">
          <span class="wizard-step-number w-7 h-7 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs font-bold">1</span>
          <span class="hidden sm:inline">Document</span>
        </button>
      </li>
      <li class="flex-1 mx-2"><div class="wizard-connector h-0.5 bg-gray-300"></div></li>
      <li class="flex items-center" role="listitem">
        <button type="button" class="wizard-step-btn flex items-center gap-2 text-sm font-medium text-gray-500" data-step="2">
          <span class="wizard-step-number w-7 h-7 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">2</span>
          <span class="hidden sm:inline">Details</span>
        </button>
      </li>
      <li class="flex-1 mx-2"><div class="wizard-connector h-0.5 bg-gray-300"></div></li>
      <li class="flex items-center" role="listitem">
        <button type="button" class="wizard-step-btn flex items-center gap-2 text-sm font-medium text-gray-500" data-step="3">
          <span class="wizard-step-number w-7 h-7 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">3</span>
          <span class="hidden sm:inline">Participants</span>
        </button>
      </li>
      <li class="flex-1 mx-2"><div class="wizard-connector h-0.5 bg-gray-300"></div></li>
      <li class="flex items-center" role="listitem">
        <button type="button" class="wizard-step-btn flex items-center gap-2 text-sm font-medium text-gray-500" data-step="4">
          <span class="wizard-step-number w-7 h-7 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">4</span>
          <span class="hidden sm:inline">Fields</span>
        </button>
      </li>
      <li class="flex-1 mx-2"><div class="wizard-connector h-0.5 bg-gray-300"></div></li>
      <li class="flex items-center" role="listitem">
        <button type="button" class="wizard-step-btn flex items-center gap-2 text-sm font-medium text-gray-500" data-step="5">
          <span class="wizard-step-number w-7 h-7 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">5</span>
          <span class="hidden sm:inline">Placement</span>
        </button>
      </li>
      <li class="flex-1 mx-2"><div class="wizard-connector h-0.5 bg-gray-300"></div></li>
      <li class="flex items-center" role="listitem">
        <button type="button" class="wizard-step-btn flex items-center gap-2 text-sm font-medium text-gray-500" data-step="6">
          <span class="wizard-step-number w-7 h-7 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">6</span>
          <span class="hidden sm:inline">Review</span>
        </button>
      </li>
    </ol>
  </nav>
</div>

<div class="flex-1 p-8 overflow-y-auto">
  {# Live region for form validation announcements #}
  <div id="form-announcements" class="sr-only" role="alert" aria-live="polite"></div>
  {% if create_success %}
    <div class="max-w-4xl mb-4 rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-800" role="status" aria-live="polite">
      Agreement created successfully. You can continue editing before sending for signature.
    </div>
  {% endif %}

  <form id="agreement-form" method="POST" action="{{ form_action|default:routes.create }}" class="max-w-4xl space-y-8" aria-describedby="form-announcements">
    <input type="hidden" name="recipients_present" value="1">
    <input type="hidden" name="fields_present" value="1">
    <input type="hidden" name="field_instances_present" value="1">

    {# Step 1: Document Selection #}
    <div id="wizard-step-1" class="wizard-step bg-white border border-gray-200 rounded-xl p-6" data-step="1">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">1</div>
        <h2 class="text-lg font-semibold text-gray-900">Select Document</h2>
      </div>

      <div id="document-selector" class="space-y-4">
        <input type="hidden" id="document_id" name="document_id" value="{{ resource_item.document_id|default:"" }}" required>

        {# Selected Document Preview #}
        <div id="selected-document" class="{% if not resource_item.document_id %}hidden{% endif %} p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
              </div>
              <div>
                <div class="font-medium text-gray-900" id="selected-document-title">{{ resource_item.document_title|default:"" }}</div>
                <div class="text-sm text-gray-500" id="selected-document-info">{{ resource_item.document_page_count|default:"" }} pages</div>
              </div>
            </div>
            <button type="button" id="change-document-btn" class="text-sm text-blue-600 hover:text-blue-800">
              Change
            </button>
          </div>
        </div>

        {# Document Picker #}
        <div id="document-picker" class="{% if resource_item.document_id %}hidden{% endif %}" role="search" aria-label="Document search">
          <div class="relative">
            <input
              type="text"
              id="document-search"
              placeholder="Search documents..."
              aria-label="Search for documents by title"
              aria-controls="document-list"
              aria-autocomplete="list"
              class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none" aria-hidden="true">
              <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
          </div>
          <div id="document-list" class="mt-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg" role="listbox" aria-label="Available documents">
            <div class="p-4 text-center text-gray-500 text-sm" role="status">Loading documents...</div>
          </div>
          <p class="mt-2 text-xs text-gray-500" id="document-picker-help">
            Select the PDF document to use for this agreement.
            <a href="{{ adminURL("content/esign_documents/new") }}" class="text-blue-600 hover:underline">Upload a new document</a>
          </p>
        </div>
      </div>
    </div>

    {# Step 2: Agreement Details #}
    <div id="wizard-step-2" class="wizard-step hidden bg-white border border-gray-200 rounded-xl p-6" data-step="2">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">2</div>
        <h2 class="text-lg font-semibold text-gray-900">Agreement Details</h2>
      </div>

      <div class="space-y-4">
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
            Agreement Title <span class="text-red-500" aria-hidden="true">*</span>
            <span class="sr-only">(required)</span>
          </label>
          <input
            type="text"
            id="title"
            name="title"
            value="{{ resource_item.title|default:"" }}"
            required
            aria-required="true"
            aria-describedby="title-help"
            placeholder="e.g., Employment Agreement - John Doe"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
          <p class="mt-1 text-xs text-gray-500" id="title-help">A descriptive title that will be shown to recipients.</p>
        </div>

        <div>
          <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
            Message to Recipients
          </label>
          <textarea
            id="message"
            name="message"
            rows="3"
            placeholder="Please review and sign this document at your earliest convenience."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >{{ resource_item.message|default:"" }}</textarea>
          <p class="mt-1 text-xs text-gray-500">This message will be included in the signing invitation email.</p>
        </div>
      </div>
    </div>

    {# Step 3: Participants #}
    <div id="wizard-step-3" class="wizard-step hidden bg-white border border-gray-200 rounded-xl p-6" data-step="3">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">3</div>
          <h2 class="text-lg font-semibold text-gray-900">Participants</h2>
        </div>
        <button type="button" id="add-participant-btn" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1" aria-label="Add a new participant to this agreement">
          <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Participant
        </button>
      </div>

      <div id="participants-container" class="space-y-4" role="list" aria-label="Agreement participants">
        {# Participant template - cloned for each participant #}
        <template id="participant-template">
          <div class="participant-entry p-4 border border-gray-200 rounded-lg" data-participant-id="" role="listitem">
            <input type="hidden" name="participants[].id" class="participant-id-input" value="">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <input
                    type="text"
                    name="participants[].name"
                    placeholder="John Doe"
                    aria-label="Participant name"
                    autocomplete="name"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Email <span class="text-red-500" aria-hidden="true">*</span>
                    <span class="sr-only">(required)</span>
                  </label>
                  <input
                    type="email"
                    name="participants[].email"
                    placeholder="john@example.com"
                    required
                    aria-required="true"
                    aria-label="Participant email address"
                    autocomplete="email"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                  <select
                    name="participants[].role"
                    aria-label="Participant role"
                    class="participant-role-select w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="signer">Signer</option>
                    <option value="cc">CC (Copy Only)</option>
                  </select>
                </div>
                <div class="signing-stage-wrapper">
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Signing Stage
                    <span class="text-xs text-gray-400 font-normal">(order)</span>
                  </label>
                  <input
                    type="number"
                    name="participants[].signing_stage"
                    min="1"
                    value="1"
                    aria-label="Signing stage order"
                    class="signing-stage-input w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                  <p class="mt-1 text-xs text-gray-400">Signers in the same stage sign in parallel</p>
                </div>
              </div>
              <button type="button" class="remove-participant-btn p-2 text-gray-400 hover:text-red-600" aria-label="Remove this participant">
                <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
        </template>

        {# Initial recipient entries will be rendered here #}
      </div>

    </div>

    {# Step 4: Field Definitions (Logical Fields) #}
    <div id="wizard-step-4" class="wizard-step hidden bg-white border border-gray-200 rounded-xl p-6" data-step="4">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">4</div>
          <h2 class="text-lg font-semibold text-gray-900">Signing Fields</h2>
        </div>
        <button type="button" id="add-field-btn" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1" aria-label="Add a new field to this agreement">
          <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Field
        </button>
      </div>

      <p class="text-sm text-gray-600 mb-4">Define the fields signers need to complete. Each signer must have at least one signature field.</p>

      {# Field Type Descriptions #}
      <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Available Field Types</h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-xs">
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Signature</span>
              <p class="text-gray-500">Drawn or typed signature</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Name</span>
              <p class="text-gray-500">Full name text input</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-purple-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Date Signed</span>
              <p class="text-gray-500">Auto-filled by system</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-gray-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Text</span>
              <p class="text-gray-500">Free-form text input</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-indigo-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Checkbox</span>
              <p class="text-gray-500">Yes/no selection</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-orange-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Initials</span>
              <p class="text-gray-500">Abbreviated signature</p>
            </div>
          </div>
        </div>
      </div>

      {# Field Definitions List #}
      <div id="field-definitions-container" class="space-y-3" role="list" aria-label="Agreement signing fields">
        {# Field definition template - cloned for each field #}
        <template id="field-definition-template">
          <div class="field-definition-entry p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-field-definition-id="" role="listitem">
            <input type="hidden" name="field_definitions[].id" class="field-definition-id-input" value="">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Field Type <span class="text-red-500" aria-hidden="true">*</span>
                    <span class="sr-only">(required)</span>
                  </label>
                  <select
                    name="field_definitions[].type"
                    required
                    aria-required="true"
                    aria-label="Field type"
                    class="field-type-select w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="signature">Signature</option>
                    <option value="name">Name</option>
                    <option value="date_signed">Date Signed</option>
                    <option value="text">Text</option>
                    <option value="checkbox">Checkbox</option>
                    <option value="initials">Initials</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Assigned To <span class="text-red-500" aria-hidden="true">*</span>
                    <span class="sr-only">(required)</span>
                  </label>
                  <select
                    name="field_definitions[].participant_id"
                    required
                    aria-required="true"
                    aria-label="Assign field to participant"
                    class="field-participant-select w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">Select signer...</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Page</label>
                  <input
                    type="number"
                    name="field_definitions[].page"
                    min="1"
                    value="1"
                    aria-label="Page number for this field"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                </div>
                <div class="flex items-center gap-4">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="field_definitions[].required" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700">Required</span>
                  </label>
                </div>
              </div>
              <button type="button" class="remove-field-definition-btn p-2 text-gray-400 hover:text-red-600" aria-label="Remove this field">
                <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            {# Date Signed Info (shown conditionally) #}
            <div class="field-date-signed-info hidden mt-3 p-2 bg-purple-50 border border-purple-100 rounded text-xs text-purple-700" role="note">
              <svg class="w-3 h-3 inline-block mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <strong>Auto-filled:</strong> This field will be automatically populated with the signature date/time. Signers cannot edit this value.
            </div>
          </div>
        </template>

        {# Existing fields will be rendered here #}
      </div>

      {# Empty state #}
      <div id="field-definitions-empty-state" class="{% if resource_item.field_definitions and resource_item.field_definitions|length > 0 %}hidden{% elif resource_item.fields and resource_item.fields|length > 0 %}hidden{% endif %} text-center py-8 border-2 border-dashed border-gray-200 rounded-lg">
        <svg class="mx-auto w-12 h-12 text-gray-300 mb-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <p class="text-sm text-gray-500 mb-2">No signing fields added yet</p>
        <p class="text-xs text-gray-400 mb-3">Add at least one signature field for each signer</p>
        <button type="button" id="add-field-definition-empty-btn" class="text-sm text-blue-600 hover:text-blue-800">
          + Add your first field
        </button>
      </div>

      {# Validation note #}
      <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg" role="note" aria-label="Field requirement notice">
        <div class="flex items-start gap-2">
          <svg class="w-4 h-4 text-blue-600 mt-0.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <p class="text-xs text-blue-700">
            <strong>Before sending:</strong> Each signer must have at least one required signature field assigned. Date Signed fields are automatically filled when the signer completes their signature.
          </p>
        </div>
      </div>
    </div>

    {# Step 5: Field Placement #}
    <div id="wizard-step-5" class="wizard-step hidden bg-white border border-gray-200 rounded-xl p-6" data-step="5">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">5</div>
          <div>
            <h2 class="text-lg font-semibold text-gray-900">Place Fields on Document</h2>
            <p class="text-sm text-gray-500">Position signature and form fields on the document pages</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <label for="placement-policy-preset" class="text-xs text-gray-500">Strategy:</label>
            <select id="placement-policy-preset" class="text-sm border border-gray-300 rounded-md px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" aria-label="Placement strategy preset">
              <option value="balanced">Balanced</option>
              <option value="accuracy-first">Accuracy First</option>
              <option value="cost-first">Cost Optimized</option>
              <option value="speed-first">Speed Optimized</option>
            </select>
          </div>
          <button type="button" id="auto-place-btn" class="btn btn-secondary text-sm" aria-label="Auto-place fields using smart detection">
            <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            Auto-place
          </button>
        </div>
      </div>

      {# Placement Editor Container #}
      <div id="placement-editor-container" class="border border-gray-200 rounded-lg overflow-hidden">
        {# Toolbar #}
        <div class="bg-gray-50 border-b border-gray-200 px-4 py-2 flex items-center justify-between">
          <div class="flex items-center gap-4">
            {# Page Navigation #}
            <div class="flex items-center gap-2">
              <button type="button" id="placement-prev-page" class="p-1 rounded hover:bg-gray-200 disabled:opacity-50" aria-label="Previous page">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
              </button>
              <span class="text-sm text-gray-600">
                Page <span id="placement-current-page">1</span> of <span id="placement-total-pages">1</span>
              </span>
              <button type="button" id="placement-next-page" class="p-1 rounded hover:bg-gray-200 disabled:opacity-50" aria-label="Next page">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </button>
            </div>

            {# Zoom Controls #}
            <div class="flex items-center gap-2 border-l border-gray-300 pl-4">
              <button type="button" id="placement-zoom-out" class="p-1 rounded hover:bg-gray-200" aria-label="Zoom out">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                </svg>
              </button>
              <span id="placement-zoom-level" class="text-sm text-gray-600 w-12 text-center">100%</span>
              <button type="button" id="placement-zoom-in" class="p-1 rounded hover:bg-gray-200" aria-label="Zoom in">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
              </button>
              <button type="button" id="placement-zoom-fit" class="p-1 rounded hover:bg-gray-200 text-xs" aria-label="Fit to width">
                Fit
              </button>
            </div>
          </div>

          {# Field Legend #}
          <div class="flex items-center gap-3 text-xs">
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-blue-500"></span> Signature</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-green-500"></span> Name</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-purple-500"></span> Date</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-gray-500"></span> Text</span>
          </div>
        </div>

        {# Document Viewer with Overlays #}
        <div class="flex">
          {# PDF Viewer #}
          <div id="placement-viewer" class="flex-1 bg-gray-100 relative overflow-auto" style="height: 600px;">
            <div id="placement-canvas-container" class="relative mx-auto" style="transform-origin: top center;">
              <canvas id="placement-pdf-canvas" class="shadow-lg"></canvas>
              <div id="placement-overlays-container" class="absolute inset-0 pointer-events-none"></div>
            </div>

            {# Loading State #}
            <div id="placement-loading" class="absolute inset-0 flex items-center justify-center bg-gray-100">
              <div class="text-center">
                <svg class="animate-spin w-8 h-8 mx-auto text-blue-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-sm text-gray-600">Loading document...</p>
              </div>
            </div>

            {# No Document State #}
            <div id="placement-no-document" class="hidden absolute inset-0 flex items-center justify-center bg-gray-50">
              <div class="text-center">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                <p class="text-sm text-gray-600 mb-2">No document selected</p>
                <p class="text-xs text-gray-400">Go back to Step 1 to select a document</p>
              </div>
            </div>
          </div>

          {# Fields Panel #}
          <div id="placement-fields-panel" class="w-72 border-l border-gray-200 bg-white overflow-y-auto" style="max-height: 600px;">
            <div class="p-4 border-b border-gray-200">
              <h3 class="font-medium text-gray-900 text-sm">Field Definitions</h3>
              <p class="text-xs text-gray-500 mt-1">Drag fields onto the document to place them</p>
            </div>
            <div id="placement-fields-list" class="p-2 space-y-1"></div>

            {# Placement Stats #}
            <div class="p-4 border-t border-gray-200 bg-gray-50">
              <h4 class="text-xs font-medium text-gray-700 mb-2">Placement Status</h4>
              <div id="placement-stats" class="space-y-1 text-xs">
                <div class="flex justify-between">
                  <span class="text-gray-600">Total fields:</span>
                  <span id="placement-total-fields" class="font-medium">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Placed:</span>
                  <span id="placement-placed-count" class="font-medium text-green-600">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Unplaced:</span>
                  <span id="placement-unplaced-count" class="font-medium text-amber-600">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {# Field Instances Hidden Inputs Container #}
      <div id="field-instances-container" class="hidden"></div>

      {# Placement Help #}
      <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg" role="note">
        <div class="flex items-start gap-2">
          <svg class="w-4 h-4 text-amber-600 mt-0.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <div class="text-xs text-amber-700">
            <p><strong>Tip:</strong> Click and drag fields from the panel onto the document. You can resize and reposition fields after placing them. Each required field must be placed before sending.</p>
          </div>
        </div>
      </div>
    </div>

    {# Step 6: Review & Send #}
    <div id="wizard-step-6" class="wizard-step hidden bg-white border border-gray-200 rounded-xl p-6" data-step="6">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">6</div>
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Review & Send</h2>
          <p class="text-sm text-gray-500">Verify all details before sending for signature</p>
        </div>
      </div>

      {# Send Readiness Check #}
      <div id="send-readiness-container" class="space-y-6">
        {# Loading State #}
        <div id="send-readiness-loading" class="text-center py-8">
          <svg class="animate-spin w-8 h-8 mx-auto text-blue-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="text-sm text-gray-600">Checking send readiness...</p>
        </div>

        {# Readiness Results #}
        <div id="send-readiness-results" class="hidden space-y-4">
          {# Agreement Summary #}
          <div class="p-4 bg-gray-50 rounded-lg">
            <h3 class="text-sm font-medium text-gray-900 mb-3">Agreement Summary</h3>
            <dl class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <dt class="text-gray-500">Title</dt>
                <dd id="review-agreement-title" class="font-medium text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-gray-500">Document</dt>
                <dd id="review-document-title" class="font-medium text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-gray-500">Participants</dt>
                <dd id="review-participant-count" class="font-medium text-gray-900">-</dd>
              </div>
              <div>
                <dt class="text-gray-500">Signing Stages</dt>
                <dd id="review-stage-count" class="font-medium text-gray-900">-</dd>
              </div>
            </dl>
          </div>

          {# Validation Status #}
          <div id="send-validation-status" class="p-4 rounded-lg"></div>

          {# Validation Issues #}
          <div id="send-validation-issues" class="hidden">
            <h3 class="text-sm font-medium text-gray-900 mb-3">Issues to Resolve</h3>
            <ul id="send-issues-list" class="space-y-2" role="list"></ul>
          </div>

          {# Participants Review #}
          <div class="p-4 bg-gray-50 rounded-lg">
            <h3 class="text-sm font-medium text-gray-900 mb-3">Participants</h3>
            <div id="review-participants-list" class="space-y-2"></div>
          </div>

          {# Fields Review #}
          <div class="p-4 bg-gray-50 rounded-lg">
            <h3 class="text-sm font-medium text-gray-900 mb-3">Field Placements</h3>
            <div id="review-fields-summary" class="text-sm text-gray-600"></div>
          </div>
        </div>
      </div>

      {# Send Confirmation #}
      <div id="send-confirmation" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-blue-600 mt-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
          <div class="flex-1">
            <p class="text-sm text-blue-800 font-medium">Ready to send!</p>
            <p class="text-xs text-blue-700 mt-1">All participants will receive an email invitation to sign this agreement. You can track progress from the agreement detail page.</p>
          </div>
        </div>
      </div>
    </div>

    {# Wizard Navigation Actions #}
    <div id="wizard-navigation" class="flex justify-between gap-3 pt-4">
      <div>
        <button type="button" id="wizard-prev-btn" class="btn btn-secondary hidden">
          <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Previous
        </button>
      </div>
      <div class="flex gap-3">
        <a href="{{ routes.index }}" class="btn btn-secondary">Cancel</a>
        <button type="button" id="wizard-next-btn" class="btn btn-primary">
          Next
          <svg class="w-4 h-4 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
        <button type="button" id="wizard-save-btn" class="btn btn-secondary hidden">
          <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
          </svg>
          Save Draft
        </button>
        <button type="submit" id="submit-btn" class="btn btn-primary hidden">
          <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
          Send for Signature
        </button>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const basePath = '{{ base_path }}';
  const apiBase = '{{ api_base_path|default:"" }}' || `${basePath}/api`;
  const normalizedAPIBase = apiBase.replace(/\/+$/, '');
  const apiVersionBase = /\/v\d+$/i.test(normalizedAPIBase) ? normalizedAPIBase : `${normalizedAPIBase}/v1`;
  const draftsEndpoint = `${apiVersionBase}/esign/drafts`;
  const isEditMode = {{ is_edit|default:false|yesno:"true,false" }};
  const createSuccess = {{ create_success|default:false|yesno:"true,false" }};

  // =============================================================================
  // Wizard State Persistence (Phase 30)
  // =============================================================================

  const WIZARD_STATE_VERSION = 1;
  const WIZARD_STORAGE_KEY = 'esign_wizard_state_v1';
  const WIZARD_CHANNEL_NAME = 'esign_wizard_sync';
  const SYNC_DEBOUNCE_MS = 2000;
  const SYNC_RETRY_DELAYS = [1000, 2000, 5000, 10000, 30000];

  /**
   * WizardSessionState schema (v1)
   * @typedef {Object} WizardSessionState
   * @property {string} wizardId - Unique wizard session ID
   * @property {number} version - Schema version for migrations
   * @property {string} createdAt - ISO timestamp
   * @property {string} updatedAt - ISO timestamp
   * @property {number} currentStep - 1-6
   * @property {Object} document - Step 1 data
   * @property {Object} details - Step 2 data
   * @property {Array} participants - Step 3 data
   * @property {Array} fieldDefinitions - Step 4 data
   * @property {Array} fieldPlacements - Step 5 data
   * @property {string|null} serverDraftId - Server draft ID
   * @property {number} serverRevision - Server revision for optimistic concurrency
   * @property {string|null} lastSyncedAt - Last successful server sync
   * @property {boolean} syncPending - Dirty flag for sync
   */

  /**
   * WizardStateManager - handles sessionStorage persistence and state management
   */
  class WizardStateManager {
    constructor() {
      this.state = null;
      this.listeners = [];
      this.init();
    }

    init() {
      this.state = this.loadFromSession() || this.createInitialState();
    }

    createInitialState() {
      return {
        wizardId: this.generateWizardId(),
        version: WIZARD_STATE_VERSION,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        currentStep: 1,
        document: { id: null, title: null, pageCount: null },
        details: { title: '', message: '' },
        participants: [],
        fieldDefinitions: [],
        fieldPlacements: [],
        serverDraftId: null,
        serverRevision: 0,
        lastSyncedAt: null,
        syncPending: false
      };
    }

    generateWizardId() {
      return `wizard_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    loadFromSession() {
      try {
        const stored = sessionStorage.getItem(WIZARD_STORAGE_KEY);
        if (!stored) return null;

        const state = JSON.parse(stored);

        // Schema version check
        if (state.version !== WIZARD_STATE_VERSION) {
          console.warn('Wizard state version mismatch, migrating...');
          return this.migrateState(state);
        }

        return state;
      } catch (error) {
        console.error('Failed to load wizard state from session:', error);
        return null;
      }
    }

    migrateState(oldState) {
      // Future migrations can be added here
      // For v1, just reset if version doesn't match
      console.warn('Discarding incompatible wizard state');
      return null;
    }

    saveToSession() {
      try {
        this.state.updatedAt = new Date().toISOString();
        sessionStorage.setItem(WIZARD_STORAGE_KEY, JSON.stringify(this.state));
      } catch (error) {
        console.error('Failed to save wizard state to session:', error);
      }
    }

    getState() {
      return this.state;
    }

    updateState(partial) {
      this.state = { ...this.state, ...partial, syncPending: true, updatedAt: new Date().toISOString() };
      this.saveToSession();
      this.notifyListeners();
    }

    updateStep(step) {
      this.updateState({ currentStep: step });
    }

    updateDocument(doc) {
      this.updateState({ document: { ...this.state.document, ...doc } });
    }

    updateDetails(details) {
      this.updateState({ details: { ...this.state.details, ...details } });
    }

    updateParticipants(participants) {
      this.updateState({ participants });
    }

    updateFieldDefinitions(fieldDefinitions) {
      this.updateState({ fieldDefinitions });
    }

    updateFieldPlacements(fieldPlacements) {
      this.updateState({ fieldPlacements });
    }

    markSynced(serverDraftId, serverRevision) {
      this.state.serverDraftId = serverDraftId;
      this.state.serverRevision = serverRevision;
      this.state.lastSyncedAt = new Date().toISOString();
      this.state.syncPending = false;
      this.saveToSession();
      this.notifyListeners();
    }

    clear() {
      this.state = this.createInitialState();
      sessionStorage.removeItem(WIZARD_STORAGE_KEY);
      this.notifyListeners();
    }

    hasResumableState() {
      if (!this.state) return false;
      return (
        this.state.currentStep > 1 ||
        this.state.document.id !== null ||
        this.state.participants.length > 0 ||
        this.state.details.title.trim() !== ''
      );
    }

    onStateChange(callback) {
      this.listeners.push(callback);
      return () => {
        this.listeners = this.listeners.filter(l => l !== callback);
      };
    }

    notifyListeners() {
      this.listeners.forEach(cb => cb(this.state));
    }

    collectFormState() {
      // Collect current form state into wizard state
      const docId = document.getElementById('document_id')?.value || null;
      const docTitle = document.getElementById('selected-document-title')?.textContent?.trim() || null;

      const titleInput = document.getElementById('title');
      const messageInput = document.getElementById('message');

      const participants = [];
      document.querySelectorAll('.participant-entry').forEach(entry => {
        const id = entry.getAttribute('data-participant-id');
        const name = entry.querySelector('input[name*=".name"]')?.value || '';
        const email = entry.querySelector('input[name*=".email"]')?.value || '';
        const role = entry.querySelector('select[name*=".role"]')?.value || 'signer';
        const signingStage = parseInt(entry.querySelector('.signing-stage-input')?.value || '1', 10);
        participants.push({ tempId: id, name, email, role, signingStage });
      });

      const fieldDefinitions = [];
      document.querySelectorAll('.field-definition-entry').forEach(entry => {
        const id = entry.getAttribute('data-field-definition-id');
        const type = entry.querySelector('.field-type-select')?.value || 'signature';
        const participantId = entry.querySelector('.field-participant-select')?.value || '';
        const page = parseInt(entry.querySelector('input[name*=".page"]')?.value || '1', 10);
        const required = entry.querySelector('input[name*=".required"]')?.checked ?? true;
        fieldDefinitions.push({ tempId: id, type, participantTempId: participantId, page, required });
      });

      return {
        document: { id: docId, title: docTitle, pageCount: null },
        details: {
          title: titleInput?.value || '',
          message: messageInput?.value || ''
        },
        participants,
        fieldDefinitions,
        fieldPlacements: placementState?.fieldInstances || []
      };
    }

    restoreFormState() {
      const state = this.state;
      if (!state) return;

      // Restore document selection
      if (state.document.id) {
        const docIdInput = document.getElementById('document_id');
        const selectedDoc = document.getElementById('selected-document');
        const docPicker = document.getElementById('document-picker');
        const docTitle = document.getElementById('selected-document-title');
        const docInfo = document.getElementById('selected-document-info');

        if (docIdInput) docIdInput.value = state.document.id;
        if (docTitle) docTitle.textContent = state.document.title || 'Selected Document';
        if (docInfo) docInfo.textContent = state.document.pageCount ? `${state.document.pageCount} pages` : '';
        if (selectedDoc) selectedDoc.classList.remove('hidden');
        if (docPicker) docPicker.classList.add('hidden');
      }

      // Restore details
      const titleInput = document.getElementById('title');
      const messageInput = document.getElementById('message');
      if (titleInput && state.details.title) titleInput.value = state.details.title;
      if (messageInput && state.details.message) messageInput.value = state.details.message;

      // Participants and field definitions will be restored after their respective
      // initialization code runs, via restoreParticipants() and restoreFieldDefinitions()
    }
  }

  /**
   * DraftSyncService - handles server draft persistence
   */
  class DraftSyncService {
    constructor(stateManager) {
      this.stateManager = stateManager;
      this.pendingSync = null;
      this.retryCount = 0;
      this.retryTimeout = null;
    }

    async create(state) {
      const payload = {
        wizard_id: state.wizardId,
        wizard_state: state,
        title: state.details.title || 'Untitled Agreement',
        current_step: state.currentStep,
        document_id: state.document.id || null
      };

      const response = await fetch(draftsEndpoint, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error?.message || `HTTP ${response.status}`);
      }

      return response.json();
    }

    async update(draftId, state, expectedRevision) {
      const payload = {
        expected_revision: expectedRevision,
        wizard_state: state,
        title: state.details.title || 'Untitled Agreement',
        current_step: state.currentStep,
        document_id: state.document.id || null
      };

      const response = await fetch(`${draftsEndpoint}/${draftId}`, {
        method: 'PUT',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.status === 409) {
        const error = await response.json().catch(() => ({}));
        const err = new Error('stale_revision');
        err.code = 'stale_revision';
        err.currentRevision = error.error?.details?.current_revision;
        throw err;
      }

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error?.message || `HTTP ${response.status}`);
      }

      return response.json();
    }

    async load(draftId) {
      const response = await fetch(`${draftsEndpoint}/${draftId}`, {
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      return response.json();
    }

    async delete(draftId) {
      const response = await fetch(`${draftsEndpoint}/${draftId}`, {
        method: 'DELETE',
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
      });

      if (!response.ok && response.status !== 404) {
        throw new Error(`HTTP ${response.status}`);
      }
    }

    async list() {
      const response = await fetch(`${draftsEndpoint}?limit=10`, {
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      return response.json();
    }

    async sync() {
      const state = this.stateManager.getState();
      if (!state.syncPending) return;

      try {
        let result;
        if (state.serverDraftId) {
          result = await this.update(state.serverDraftId, state, state.serverRevision);
        } else {
          result = await this.create(state);
        }

        this.stateManager.markSynced(result.id, result.revision);
        this.retryCount = 0;
        return { success: true, result };
      } catch (error) {
        if (error.code === 'stale_revision') {
          return { success: false, conflict: true, currentRevision: error.currentRevision };
        }
        return { success: false, error: error.message };
      }
    }
  }

  /**
   * SyncOrchestrator - coordinates sync timing and retry logic
   */
  class SyncOrchestrator {
    constructor(stateManager, syncService, statusUpdater) {
      this.stateManager = stateManager;
      this.syncService = syncService;
      this.statusUpdater = statusUpdater;
      this.debounceTimer = null;
      this.retryTimer = null;
      this.retryCount = 0;
      this.isSyncing = false;
      this.channel = null;
      this.isOwner = true;

      this.initBroadcastChannel();
      this.initEventListeners();
    }

    initBroadcastChannel() {
      if (typeof BroadcastChannel === 'undefined') return;

      try {
        this.channel = new BroadcastChannel(WIZARD_CHANNEL_NAME);
        this.channel.onmessage = (event) => this.handleChannelMessage(event.data);
        // Announce presence
        this.channel.postMessage({ type: 'presence', tabId: this.getTabId() });
      } catch (error) {
        console.warn('BroadcastChannel not available:', error);
      }
    }

    getTabId() {
      if (!window._wizardTabId) {
        window._wizardTabId = `tab_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }
      return window._wizardTabId;
    }

    handleChannelMessage(data) {
      switch (data.type) {
        case 'presence':
          // Another tab is active, negotiate ownership
          if (data.tabId !== this.getTabId()) {
            this.channel?.postMessage({ type: 'ownership_claim', tabId: this.getTabId() });
          }
          break;
        case 'ownership_claim':
          // Yield ownership to the newer tab
          this.isOwner = false;
          break;
        case 'state_updated':
          // Another tab updated state, reload from session
          if (data.tabId !== this.getTabId()) {
            const state = this.stateManager.loadFromSession();
            if (state) {
              this.stateManager.state = state;
              this.stateManager.notifyListeners();
            }
          }
          break;
        case 'sync_completed':
          // Another tab completed sync, update our state
          if (data.tabId !== this.getTabId() && data.draftId && data.revision) {
            this.stateManager.markSynced(data.draftId, data.revision);
          }
          break;
      }
    }

    broadcastStateUpdate() {
      this.channel?.postMessage({
        type: 'state_updated',
        tabId: this.getTabId()
      });
    }

    broadcastSyncCompleted(draftId, revision) {
      this.channel?.postMessage({
        type: 'sync_completed',
        tabId: this.getTabId(),
        draftId,
        revision
      });
    }

    initEventListeners() {
      // Force sync on visibility change
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          this.forceSync();
        }
      });

      // Force sync on page hide
      window.addEventListener('pagehide', () => {
        this.forceSync();
      });

      // Force sync on beforeunload
      window.addEventListener('beforeunload', () => {
        this.forceSync();
      });
    }

    scheduleSync() {
      if (this.debounceTimer) {
        clearTimeout(this.debounceTimer);
      }

      this.statusUpdater('pending');

      this.debounceTimer = setTimeout(() => {
        this.performSync();
      }, SYNC_DEBOUNCE_MS);
    }

    async forceSync() {
      if (this.debounceTimer) {
        clearTimeout(this.debounceTimer);
        this.debounceTimer = null;
      }

      // Use sendBeacon for pagehide if available
      const state = this.stateManager.getState();
      if (state.syncPending && state.serverDraftId && navigator.sendBeacon) {
        const payload = JSON.stringify({
          expected_revision: state.serverRevision,
          wizard_state: state,
          title: state.details.title || 'Untitled Agreement',
          current_step: state.currentStep,
          document_id: state.document.id || null
        });
        navigator.sendBeacon(`${draftsEndpoint}/${state.serverDraftId}`, new Blob([payload], { type: 'application/json' }));
      } else {
        await this.performSync();
      }
    }

    async performSync() {
      if (this.isSyncing) return;
      if (!this.isOwner) return;

      const state = this.stateManager.getState();
      if (!state.syncPending) {
        this.statusUpdater('saved');
        return;
      }

      this.isSyncing = true;
      this.statusUpdater('saving');

      const result = await this.syncService.sync();

      this.isSyncing = false;

      if (result.success) {
        this.statusUpdater('saved');
        this.retryCount = 0;
        this.broadcastSyncCompleted(result.result.id, result.result.revision);
      } else if (result.conflict) {
        this.statusUpdater('conflict');
        this.showConflictDialog(result.currentRevision);
      } else {
        this.statusUpdater('error');
        this.scheduleRetry();
      }
    }

    scheduleRetry() {
      if (this.retryCount >= SYNC_RETRY_DELAYS.length) {
        console.error('Max sync retries reached');
        return;
      }

      const delay = SYNC_RETRY_DELAYS[this.retryCount];
      this.retryCount++;

      this.retryTimer = setTimeout(() => {
        this.performSync();
      }, delay);
    }

    manualRetry() {
      this.retryCount = 0;
      if (this.retryTimer) {
        clearTimeout(this.retryTimer);
        this.retryTimer = null;
      }
      this.performSync();
    }

    showConflictDialog(serverRevision) {
      const modal = document.getElementById('conflict-dialog-modal');
      const state = this.stateManager.getState();

      document.getElementById('conflict-local-time').textContent = formatRelativeTime(state.updatedAt);
      document.getElementById('conflict-server-revision').textContent = serverRevision;
      document.getElementById('conflict-server-time').textContent = 'newer version';

      modal?.classList.remove('hidden');
    }
  }

  // Helper function for relative time formatting
  function formatRelativeTime(isoString) {
    if (!isoString) return 'unknown';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    return date.toLocaleDateString();
  }

  // Sync status UI updater
  function updateSyncStatus(status) {
    const indicator = document.getElementById('sync-status-indicator');
    const icon = document.getElementById('sync-status-icon');
    const text = document.getElementById('sync-status-text');
    const retryBtn = document.getElementById('sync-retry-btn');

    if (!indicator || !icon || !text) return;

    indicator.classList.remove('hidden');

    switch (status) {
      case 'saved':
        icon.className = 'w-2 h-2 rounded-full bg-green-500';
        text.textContent = 'Saved';
        text.className = 'text-gray-600';
        retryBtn?.classList.add('hidden');
        break;
      case 'saving':
        icon.className = 'w-2 h-2 rounded-full bg-blue-500 animate-pulse';
        text.textContent = 'Saving...';
        text.className = 'text-gray-600';
        retryBtn?.classList.add('hidden');
        break;
      case 'pending':
        icon.className = 'w-2 h-2 rounded-full bg-gray-400';
        text.textContent = 'Unsaved changes';
        text.className = 'text-gray-500';
        retryBtn?.classList.add('hidden');
        break;
      case 'error':
        icon.className = 'w-2 h-2 rounded-full bg-amber-500';
        text.textContent = 'Not synced';
        text.className = 'text-amber-600';
        retryBtn?.classList.remove('hidden');
        break;
      case 'conflict':
        icon.className = 'w-2 h-2 rounded-full bg-red-500';
        text.textContent = 'Conflict';
        text.className = 'text-red-600';
        retryBtn?.classList.add('hidden');
        break;
      default:
        indicator.classList.add('hidden');
    }
  }

  // Initialize state manager and sync service
  const stateManager = new WizardStateManager();
  const syncService = new DraftSyncService(stateManager);
  const syncOrchestrator = new SyncOrchestrator(stateManager, syncService, updateSyncStatus);

  if (createSuccess) {
    const state = stateManager.getState();
    const serverDraftId = state?.serverDraftId;
    stateManager.clear();
    syncOrchestrator.broadcastStateUpdate();

    if (serverDraftId) {
      syncService.delete(serverDraftId).catch((error) => {
        console.warn('Failed to delete server draft after successful create:', error);
      });
    }
  }

  // Wire up retry button
  document.getElementById('sync-retry-btn')?.addEventListener('click', () => {
    syncOrchestrator.manualRetry();
  });

  // Wire up conflict dialog buttons
  document.getElementById('conflict-reload-btn')?.addEventListener('click', async () => {
    const state = stateManager.getState();
    if (state.serverDraftId) {
      try {
        const serverDraft = await syncService.load(state.serverDraftId);
        if (serverDraft.wizard_state) {
          stateManager.state = { ...serverDraft.wizard_state, serverDraftId: serverDraft.id, serverRevision: serverDraft.revision };
          stateManager.saveToSession();
          window.location.reload();
        }
      } catch (error) {
        console.error('Failed to load server draft:', error);
      }
    }
    document.getElementById('conflict-dialog-modal')?.classList.add('hidden');
  });

  document.getElementById('conflict-force-btn')?.addEventListener('click', async () => {
    // Force overwrite by incrementing to current server revision
    const serverRevision = parseInt(document.getElementById('conflict-server-revision')?.textContent || '0', 10);
    stateManager.state.serverRevision = serverRevision;
    stateManager.state.syncPending = true;
    stateManager.saveToSession();
    syncOrchestrator.performSync();
    document.getElementById('conflict-dialog-modal')?.classList.add('hidden');
  });

  document.getElementById('conflict-dismiss-btn')?.addEventListener('click', () => {
    document.getElementById('conflict-dialog-modal')?.classList.add('hidden');
  });

  // Resume dialog handlers
  function showResumeDialog() {
    const modal = document.getElementById('resume-dialog-modal');
    const state = stateManager.getState();

    document.getElementById('resume-draft-title').textContent = state.details.title || 'Untitled Agreement';
    document.getElementById('resume-draft-step').textContent = state.currentStep;
    document.getElementById('resume-draft-time').textContent = formatRelativeTime(state.updatedAt);

    modal?.classList.remove('hidden');
  }

  document.getElementById('resume-continue-btn')?.addEventListener('click', () => {
    document.getElementById('resume-dialog-modal')?.classList.add('hidden');
    stateManager.restoreFormState();
    // Navigate to saved step after form is initialized
    window._resumeToStep = stateManager.getState().currentStep;
  });

  document.getElementById('resume-new-btn')?.addEventListener('click', () => {
    // Keep local state but don't restore - user will start fresh
    document.getElementById('resume-dialog-modal')?.classList.add('hidden');
    stateManager.clear();
  });

  document.getElementById('resume-discard-btn')?.addEventListener('click', async () => {
    const state = stateManager.getState();
    if (state.serverDraftId) {
      try {
        await syncService.delete(state.serverDraftId);
      } catch (error) {
        console.warn('Failed to delete server draft:', error);
      }
    }
    stateManager.clear();
    document.getElementById('resume-dialog-modal')?.classList.add('hidden');
  });

  // Check for resumable state on load (only for create mode, not edit)
  if (!isEditMode && stateManager.hasResumableState()) {
    showResumeDialog();
  }

  // Track state changes for persistence
  function trackWizardStateChanges() {
    // Collect and update state when form changes
    const formState = stateManager.collectFormState();
    stateManager.updateState(formState);
    syncOrchestrator.scheduleSync();
    syncOrchestrator.broadcastStateUpdate();
  }

  // Document Selection
  const documentIdInput = document.getElementById('document_id');
  const selectedDocument = document.getElementById('selected-document');
  const documentPicker = document.getElementById('document-picker');
  const documentSearch = document.getElementById('document-search');
  const documentList = document.getElementById('document-list');
  const changeDocumentBtn = document.getElementById('change-document-btn');
  const selectedDocumentTitle = document.getElementById('selected-document-title');
  const selectedDocumentInfo = document.getElementById('selected-document-info');

  let documents = [];

  function hydrateSelectedDocumentFromList() {
    const currentID = (documentIdInput?.value || '').trim();
    if (!currentID) return;
    const selected = documents.find(doc => String(doc.id || '').trim() === currentID);
    if (!selected) return;

    if (!selectedDocumentTitle.textContent.trim()) {
      selectedDocumentTitle.textContent = selected.title || 'Untitled';
    }
    if (!selectedDocumentInfo.textContent.trim() || selectedDocumentInfo.textContent.trim() === 'pages') {
      selectedDocumentInfo.textContent = `${selected.page_count || 0} pages`;
    }
    selectedDocument.classList.remove('hidden');
    documentPicker.classList.add('hidden');
  }

  async function loadDocuments() {
    try {
      const response = await fetch(`${apiBase}/esign_documents?per_page=100`, {
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
      });
      const data = await response.json();
      documents = data.records || data.items || [];
      renderDocumentList(documents);
      hydrateSelectedDocumentFromList();
    } catch (error) {
      documentList.innerHTML = '<div class="p-4 text-center text-red-500 text-sm">Failed to load documents</div>';
    }
  }

  function renderDocumentList(docs) {
    if (docs.length === 0) {
      documentList.innerHTML = `
        <div class="p-4 text-center text-gray-500 text-sm">
          No documents found.
          <a href="{{ adminURL("content/esign_documents/new") }}" class="text-blue-600 hover:underline">Upload one</a>
        </div>
      `;
      return;
    }

    documentList.innerHTML = docs.map((doc, index) => `
      <button type="button" class="document-option w-full p-3 flex items-center gap-3 hover:bg-gray-50 border-b border-gray-100 last:border-0 text-left focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500"
              role="option"
              aria-selected="false"
              tabindex="${index === 0 ? '0' : '-1'}"
              data-document-id="${doc.id}"
              data-document-title="${escapeHtml(doc.title || 'Untitled')}"
              data-document-pages="${doc.page_count || 0}">
        <div class="w-8 h-8 rounded bg-red-100 flex items-center justify-center flex-shrink-0" aria-hidden="true">
          <svg class="w-4 h-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-medium text-gray-900 truncate">${escapeHtml(doc.title || 'Untitled')}</div>
          <div class="text-xs text-gray-500">${doc.page_count || 0} pages</div>
        </div>
      </button>
    `).join('');

    // Attach click and keyboard handlers
    const options = documentList.querySelectorAll('.document-option');
    options.forEach((btn, index) => {
      btn.addEventListener('click', () => selectDocument(btn));
      btn.addEventListener('keydown', (e) => {
        let nextIndex = index;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          nextIndex = Math.min(index + 1, options.length - 1);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          nextIndex = Math.max(index - 1, 0);
        } else if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectDocument(btn);
          return;
        } else if (e.key === 'Home') {
          e.preventDefault();
          nextIndex = 0;
        } else if (e.key === 'End') {
          e.preventDefault();
          nextIndex = options.length - 1;
        }
        if (nextIndex !== index) {
          options[nextIndex].focus();
          options[nextIndex].setAttribute('tabindex', '0');
          btn.setAttribute('tabindex', '-1');
        }
      });
    });
  }

  function selectDocument(btn) {
    const id = btn.getAttribute('data-document-id');
    const title = btn.getAttribute('data-document-title');
    const pages = btn.getAttribute('data-document-pages');

    documentIdInput.value = id;
    selectedDocumentTitle.textContent = title;
    selectedDocumentInfo.textContent = `${pages} pages`;

    selectedDocument.classList.remove('hidden');
    documentPicker.classList.add('hidden');
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  if (changeDocumentBtn) {
    changeDocumentBtn.addEventListener('click', () => {
      selectedDocument.classList.add('hidden');
      documentPicker.classList.remove('hidden');
    });
  }

  if (documentSearch) {
    documentSearch.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = documents.filter(doc =>
        (doc.title || '').toLowerCase().includes(term)
      );
      renderDocumentList(filtered);
    });
  }

  // Load documents on page load
  loadDocuments();

  // Participants Management (v2 ID-based)
  const participantsContainer = document.getElementById('participants-container');
  const participantTemplate = document.getElementById('participant-template');
  const addParticipantBtn = document.getElementById('add-participant-btn');
  let participantCounter = 0;
  let participantFormIndex = 0;

  function generateParticipantId() {
    // Generate a temporary client-side ID for new participants
    // Backend will assign permanent IDs on save
    return `temp_${Date.now()}_${participantCounter++}`;
  }

  function addParticipant(data = {}) {
    const clone = participantTemplate.content.cloneNode(true);
    const entry = clone.querySelector('.participant-entry');

    // Use existing ID or generate a new one
    const participantId = data.id || generateParticipantId();
    entry.setAttribute('data-participant-id', participantId);

    const idInput = entry.querySelector('.participant-id-input');
    const nameInput = entry.querySelector('input[name="participants[].name"]');
    const emailInput = entry.querySelector('input[name="participants[].email"]');
    const roleSelect = entry.querySelector('select[name="participants[].role"]');
    const signingStageInput = entry.querySelector('input[name="participants[].signing_stage"]');
    const signingStageWrapper = entry.querySelector('.signing-stage-wrapper');

    // Use stable entity IDs in values while preserving index-addressed form arrays.
    const formIndex = participantFormIndex++;
    idInput.name = `participants[${formIndex}].id`;
    idInput.value = participantId;
    nameInput.name = `participants[${formIndex}].name`;
    emailInput.name = `participants[${formIndex}].email`;
    roleSelect.name = `participants[${formIndex}].role`;
    if (signingStageInput) {
      signingStageInput.name = `participants[${formIndex}].signing_stage`;
    }

    if (data.name) nameInput.value = data.name;
    if (data.email) emailInput.value = data.email;
    if (data.role) roleSelect.value = data.role;
    if (signingStageInput && data.signing_stage) {
      signingStageInput.value = data.signing_stage;
    }

    const syncSigningStageVisibility = () => {
      if (!signingStageWrapper || !signingStageInput) return;
      const isSigner = roleSelect.value === 'signer';
      signingStageWrapper.classList.toggle('hidden', !isSigner);
      if (!isSigner) {
        signingStageInput.value = '';
      } else if (!signingStageInput.value) {
        signingStageInput.value = '1';
      }
    };
    syncSigningStageVisibility();

    entry.querySelector('.remove-participant-btn').addEventListener('click', () => {
      entry.remove();
      updateFieldParticipantOptions();
    });

    roleSelect.addEventListener('change', () => {
      syncSigningStageVisibility();
      updateFieldParticipantOptions();
    });

    participantsContainer.appendChild(clone);
  }

  addParticipantBtn.addEventListener('click', () => addParticipant());

  // Initialize with existing participants or add one empty.
  {% if resource_item.participants and resource_item.participants|length > 0 %}
    {% for participant in resource_item.participants %}
    addParticipant({
      id: '{{ participant.id|default:"" }}',
      name: '{{ participant.name|default:"" }}',
      email: '{{ participant.email|default:"" }}',
      role: '{{ participant.role|default:"signer" }}',
      signing_stage: {{ participant.signing_stage|default:1 }}
    });
    {% endfor %}
  {% else %}
    addParticipant();
  {% endif %}

  // Field Definitions Management (v2 ID-based)
  const fieldDefinitionsContainer = document.getElementById('field-definitions-container');
  const fieldDefinitionTemplate = document.getElementById('field-definition-template');
  const addFieldBtn = document.getElementById('add-field-btn');
  const addFieldDefinitionEmptyBtn = document.getElementById('add-field-definition-empty-btn');
  const fieldDefinitionsEmptyState = document.getElementById('field-definitions-empty-state');
  let fieldDefinitionCounter = 0;
  let fieldInstanceFormIndex = 0;

  function generateFieldDefinitionId() {
    // Generate a temporary client-side ID for new field definitions
    // Backend will assign permanent IDs on save
    return `temp_field_${Date.now()}_${fieldDefinitionCounter++}`;
  }

  function getSignerParticipants() {
    const entries = participantsContainer.querySelectorAll('.participant-entry');
    const signers = [];
    entries.forEach((entry) => {
      const participantId = entry.getAttribute('data-participant-id');
      const roleSelect = entry.querySelector('select[name*=".role"]');
      const nameInput = entry.querySelector('input[name*=".name"]');
      const emailInput = entry.querySelector('input[name*=".email"]');
      if (roleSelect.value === 'signer') {
        signers.push({
          id: participantId,
          name: nameInput.value || emailInput.value || `Signer`,
          email: emailInput.value
        });
      }
    });
    return signers;
  }

  function updateFieldParticipantOptions() {
    const signers = getSignerParticipants();
    const participantSelects = fieldDefinitionsContainer.querySelectorAll('.field-participant-select');

    participantSelects.forEach(select => {
      const currentValue = select.value;
      select.innerHTML = '<option value="">Select signer...</option>';
      signers.forEach(signer => {
        const option = document.createElement('option');
        option.value = signer.id;
        option.textContent = signer.name;
        select.appendChild(option);
      });
      // Restore selection if still valid
      if (currentValue && signers.some(s => s.id === currentValue)) {
        select.value = currentValue;
      }
    });
  }

  function addFieldDefinition(data = {}) {
    const clone = fieldDefinitionTemplate.content.cloneNode(true);
    const entry = clone.querySelector('.field-definition-entry');

    // Use existing ID or generate a new one
    const fieldDefinitionId = data.id || generateFieldDefinitionId();
    entry.setAttribute('data-field-definition-id', fieldDefinitionId);

    const idInput = entry.querySelector('.field-definition-id-input');
    const typeSelect = entry.querySelector('select[name="field_definitions[].type"]');
    const participantSelect = entry.querySelector('select[name="field_definitions[].participant_id"]');
    const pageInput = entry.querySelector('input[name="field_definitions[].page"]');
    const requiredCheckbox = entry.querySelector('input[name="field_definitions[].required"]');
    const dateSignedInfo = entry.querySelector('.field-date-signed-info');

    // Use stable entity IDs in values while preserving index-addressed form arrays.
    const formIndex = fieldInstanceFormIndex++;
    idInput.name = `field_instances[${formIndex}].id`;
    idInput.value = fieldDefinitionId;
    typeSelect.name = `field_instances[${formIndex}].type`;
    participantSelect.name = `field_instances[${formIndex}].participant_id`;
    pageInput.name = `field_instances[${formIndex}].page`;
    requiredCheckbox.name = `field_instances[${formIndex}].required`;

    if (data.type) typeSelect.value = data.type;
    if (data.page) pageInput.value = data.page;
    if (data.required !== undefined) requiredCheckbox.checked = data.required;

    // Populate participant options
    const signers = getSignerParticipants();
    participantSelect.innerHTML = '<option value="">Select signer...</option>';
    signers.forEach(signer => {
      const option = document.createElement('option');
      option.value = signer.id;
      option.textContent = signer.name;
      participantSelect.appendChild(option);
    });
    // Set participant_id when provided.
    if (data.participant_id) {
      participantSelect.value = data.participant_id;
    }

    // Show date_signed info when that type is selected
    typeSelect.addEventListener('change', () => {
      if (typeSelect.value === 'date_signed') {
        dateSignedInfo.classList.remove('hidden');
      } else {
        dateSignedInfo.classList.add('hidden');
      }
    });
    // Initialize date_signed info visibility
    if (typeSelect.value === 'date_signed') {
      dateSignedInfo.classList.remove('hidden');
    }

    entry.querySelector('.remove-field-definition-btn').addEventListener('click', () => {
      entry.remove();
      updateFieldDefinitionsEmptyState();
    });

    fieldDefinitionsContainer.appendChild(clone);
    updateFieldDefinitionsEmptyState();
  }

  function updateFieldDefinitionsEmptyState() {
    const fields = fieldDefinitionsContainer.querySelectorAll('.field-definition-entry');
    if (fields.length === 0) {
      fieldDefinitionsEmptyState.classList.remove('hidden');
    } else {
      fieldDefinitionsEmptyState.classList.add('hidden');
    }
  }

  // Watch for participant changes to update field assignments
  const participantObserver = new MutationObserver(() => {
    updateFieldParticipantOptions();
  });
  participantObserver.observe(participantsContainer, { childList: true, subtree: true });

  // Also update when role changes
  participantsContainer.addEventListener('change', (e) => {
    if (e.target.matches('select[name*=".role"]') || e.target.matches('input[name*=".name"]') || e.target.matches('input[name*=".email"]')) {
      updateFieldParticipantOptions();
    }
  });
  participantsContainer.addEventListener('input', (e) => {
    if (e.target.matches('input[name*=".name"]') || e.target.matches('input[name*=".email"]')) {
      updateFieldParticipantOptions();
    }
  });

  addFieldBtn.addEventListener('click', () => addFieldDefinition());
  addFieldDefinitionEmptyBtn.addEventListener('click', () => addFieldDefinition());

  window._initialFieldPlacementsData = [];

  // Initialize with existing field instances.
  {% if resource_item.field_instances and resource_item.field_instances|length > 0 %}
    {% for field_def in resource_item.field_instances %}
    addFieldDefinition({
      id: '{{ field_def.id|default:"" }}',
      type: '{{ field_def.type|default:"signature" }}',
      participant_id: '{{ field_def.participant_id|default:"" }}',
      page: {{ field_def.page|default:1 }},
      required: {% if field_def.required %}true{% else %}false{% endif %}
    });
    window._initialFieldPlacementsData.push({
      id: '{{ field_def.id|default:"" }}',
      definitionId: '{{ field_def.id|default:"" }}',
      type: '{{ field_def.type|default:"text" }}',
      participantId: '{{ field_def.participant_id|default:"" }}',
      participantName: '',
      page: {{ field_def.page|default:1 }},
      x: {{ field_def.x|default:0 }},
      y: {{ field_def.y|default:0 }},
      width: {{ field_def.width|default:150 }},
      height: {{ field_def.height|default:32 }},
      placementSource: 'manual'
    });
    {% endfor %}
  {% endif %}
  updateFieldDefinitionsEmptyState();

  // Form submission
  const form = document.getElementById('agreement-form');
  const submitBtn = document.getElementById('submit-btn');
  const formAnnouncements = document.getElementById('form-announcements');

  function announceError(message) {
    if (formAnnouncements) {
      formAnnouncements.textContent = message;
    }
    if (window.toastManager) {
      window.toastManager.error(message);
    } else {
      alert(message);
    }
  }

  function findSignersMissingRequiredSignatureField() {
    const signers = getSignerParticipants();
    const signerSignatureFields = new Map(); // participantId -> hasSignatureField

    signers.forEach((signer) => {
      signerSignatureFields.set(signer.id, false);
    });

    const fieldDefinitionEntries = fieldDefinitionsContainer.querySelectorAll('.field-definition-entry');
    fieldDefinitionEntries.forEach((field) => {
      const typeSelect = field.querySelector('.field-type-select');
      const participantSelect = field.querySelector('.field-participant-select');
      const requiredCheckbox = field.querySelector('input[name*=".required"]');
      if (typeSelect?.value === 'signature' && participantSelect?.value && requiredCheckbox?.checked) {
        signerSignatureFields.set(participantSelect.value, true);
      }
    });

    return signers.filter((signer) => !signerSignatureFields.get(signer.id));
  }

  function missingSignatureFieldMessage(missingSigners) {
    if (!Array.isArray(missingSigners) || missingSigners.length === 0) {
      return 'Each signer requires at least one required signature field.';
    }
    const names = missingSigners
      .map((signer) => signer?.name?.trim())
      .filter((name) => Boolean(name));
    if (names.length === 0) {
      return 'Each signer requires at least one required signature field.';
    }
    return `Each signer requires at least one required signature field. Missing: ${names.join(', ')}`;
  }

  form.addEventListener('submit', function(e) {
    // Validate document selected
    if (!documentIdInput.value) {
      e.preventDefault();
      announceError('Please select a document');
      documentSearch.focus();
      return;
    }

    // Validate at least one participant
    const participantEntries = participantsContainer.querySelectorAll('.participant-entry');
    if (participantEntries.length === 0) {
      e.preventDefault();
      announceError('Please add at least one participant');
      addParticipantBtn.focus();
      return;
    }

    // Validate at least one signer
    let hasSigners = false;
    participantEntries.forEach(entry => {
      const roleSelect = entry.querySelector('select[name*=".role"]');
      if (roleSelect.value === 'signer') {
        hasSigners = true;
      }
    });

    if (!hasSigners) {
      e.preventDefault();
      announceError('At least one signer is required');
      const firstRoleSelect = participantEntries[0]?.querySelector('select[name*=".role"]');
      if (firstRoleSelect) firstRoleSelect.focus();
      return;
    }

    const fieldDefinitionEntries = fieldDefinitionsContainer.querySelectorAll('.field-definition-entry');
    const missingSigners = findSignersMissingRequiredSignatureField();
    if (missingSigners.length > 0) {
      e.preventDefault();
      announceError(missingSignatureFieldMessage(missingSigners));
      goToStep(4);
      addFieldBtn.focus();
      return;
    }

    // Validate that all field participant assignments are valid
    let invalidFieldAssignment = false;
    fieldDefinitionEntries.forEach(field => {
      const participantSelect = field.querySelector('.field-participant-select');
      if (!participantSelect.value) {
        invalidFieldAssignment = true;
      }
    });

    if (invalidFieldAssignment) {
      e.preventDefault();
      announceError('Please assign all fields to a signer');
      const firstUnassigned = fieldDefinitionsContainer.querySelector('.field-participant-select:invalid, .field-participant-select[value=""]');
      if (firstUnassigned) firstUnassigned.focus();
      return;
    }

    const hasSaveAsDraftIntent = Boolean(form.querySelector('input[name="save_as_draft"]'));
    const shouldSendForSignature = currentStep === TOTAL_STEPS && !hasSaveAsDraftIntent;

    if (shouldSendForSignature) {
      let sendIntentInput = form.querySelector('input[name="send_for_signature"]');
      if (!sendIntentInput) {
        sendIntentInput = document.createElement('input');
        sendIntentInput.type = 'hidden';
        sendIntentInput.name = 'send_for_signature';
        form.appendChild(sendIntentInput);
      }
      sendIntentInput.value = '1';
    } else {
      form.querySelector('input[name="send_for_signature"]')?.remove();
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <svg class="animate-spin w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      ${shouldSendForSignature ? 'Sending...' : 'Saving...'}
    `;
  });

  // =============================================================================
  // Wizard Navigation
  // =============================================================================
  const TOTAL_STEPS = 6;
  let currentStep = 1;

  const wizardStepBtns = document.querySelectorAll('.wizard-step-btn');
  const wizardSteps = document.querySelectorAll('.wizard-step');
  const wizardConnectors = document.querySelectorAll('.wizard-connector');
  const wizardPrevBtn = document.getElementById('wizard-prev-btn');
  const wizardNextBtn = document.getElementById('wizard-next-btn');
  const wizardSaveBtn = document.getElementById('wizard-save-btn');

  function updateWizardUI() {
    // Update step buttons and connectors
    wizardStepBtns.forEach((btn, index) => {
      const stepNum = index + 1;
      const stepNumber = btn.querySelector('.wizard-step-number');

      if (stepNum < currentStep) {
        // Completed step
        btn.classList.remove('text-gray-500', 'text-blue-600');
        btn.classList.add('text-green-600');
        stepNumber.classList.remove('bg-gray-300', 'text-gray-600', 'bg-blue-600', 'text-white');
        stepNumber.classList.add('bg-green-600', 'text-white');
        btn.removeAttribute('aria-current');
      } else if (stepNum === currentStep) {
        // Current step
        btn.classList.remove('text-gray-500', 'text-green-600');
        btn.classList.add('text-blue-600');
        stepNumber.classList.remove('bg-gray-300', 'text-gray-600', 'bg-green-600');
        stepNumber.classList.add('bg-blue-600', 'text-white');
        btn.setAttribute('aria-current', 'step');
      } else {
        // Future step
        btn.classList.remove('text-blue-600', 'text-green-600');
        btn.classList.add('text-gray-500');
        stepNumber.classList.remove('bg-blue-600', 'text-white', 'bg-green-600');
        stepNumber.classList.add('bg-gray-300', 'text-gray-600');
        btn.removeAttribute('aria-current');
      }
    });

    // Update connectors
    wizardConnectors.forEach((connector, index) => {
      if (index < currentStep - 1) {
        connector.classList.remove('bg-gray-300');
        connector.classList.add('bg-green-600');
      } else {
        connector.classList.remove('bg-green-600');
        connector.classList.add('bg-gray-300');
      }
    });

    // Show/hide step content
    wizardSteps.forEach(step => {
      const stepNum = parseInt(step.dataset.step, 10);
      if (stepNum === currentStep) {
        step.classList.remove('hidden');
      } else {
        step.classList.add('hidden');
      }
    });

    // Update navigation buttons
    wizardPrevBtn.classList.toggle('hidden', currentStep === 1);
    wizardNextBtn.classList.toggle('hidden', currentStep === TOTAL_STEPS);
    wizardSaveBtn.classList.toggle('hidden', currentStep !== TOTAL_STEPS);
    submitBtn.classList.toggle('hidden', currentStep !== TOTAL_STEPS);

    // Update next button text based on step
    if (currentStep < TOTAL_STEPS) {
      const nextStepName = ['Details', 'Participants', 'Fields', 'Placement', 'Review'][currentStep - 1] || 'Next';
      wizardNextBtn.innerHTML = `
        ${nextStepName}
        <svg class="w-4 h-4 ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      `;
    }

    // Run step-specific initialization
    if (currentStep === 5) {
      initPlacementEditor();
    } else if (currentStep === 6) {
      initSendReadinessCheck();
    }
  }

  function validateStep(stepNum) {
    switch (stepNum) {
      case 1:
        if (!documentIdInput.value) {
          announceError('Please select a document');
          return false;
        }
        return true;

      case 2:
        const titleInput = document.getElementById('title');
        if (!titleInput.value.trim()) {
          announceError('Please enter an agreement title');
          titleInput.focus();
          return false;
        }
        return true;

      case 3:
        const participantEntries = participantsContainer.querySelectorAll('.participant-entry');
        if (participantEntries.length === 0) {
          announceError('Please add at least one participant');
          return false;
        }
        let hasSigners = false;
        participantEntries.forEach(entry => {
          const roleSelect = entry.querySelector('select[name*=".role"]');
          if (roleSelect.value === 'signer') hasSigners = true;
        });
        if (!hasSigners) {
          announceError('At least one signer is required');
          return false;
        }
        return true;

      case 4:
        // Field definitions are optional but if present, must be assigned
        const fieldEntries = fieldDefinitionsContainer.querySelectorAll('.field-definition-entry');
        for (const field of fieldEntries) {
          const participantSelect = field.querySelector('.field-participant-select');
          if (!participantSelect.value) {
            announceError('Please assign all fields to a signer');
            participantSelect.focus();
            return false;
          }
        }
        const missingSigners = findSignersMissingRequiredSignatureField();
        if (missingSigners.length > 0) {
          announceError(missingSignatureFieldMessage(missingSigners));
          addFieldBtn.focus();
          return false;
        }
        return true;

      case 5:
        // Placement validation - warn but don't block
        return true;

      default:
        return true;
    }
  }

  function goToStep(stepNum) {
    if (stepNum < 1 || stepNum > TOTAL_STEPS) return;

    // Validate current step before moving forward
    if (stepNum > currentStep) {
      for (let i = currentStep; i < stepNum; i++) {
        if (!validateStep(i)) return;
      }
    }

    currentStep = stepNum;
    updateWizardUI();

    // Persist step change
    stateManager.updateStep(stepNum);
    trackWizardStateChanges();
    syncOrchestrator.forceSync(); // Force sync on step change

    // Scroll to top of form
    document.querySelector('.wizard-step:not(.hidden)')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // Wizard step button clicks
  wizardStepBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetStep = parseInt(btn.dataset.step, 10);
      goToStep(targetStep);
    });
  });

  // Previous/Next button handlers
  wizardPrevBtn.addEventListener('click', () => goToStep(currentStep - 1));
  wizardNextBtn.addEventListener('click', () => goToStep(currentStep + 1));

  // Save Draft button
  wizardSaveBtn.addEventListener('click', () => {
    // Submit form as draft
    const draftInput = document.createElement('input');
    draftInput.type = 'hidden';
    draftInput.name = 'save_as_draft';
    draftInput.value = '1';
    form.appendChild(draftInput);
    form.submit();
  });

  // =============================================================================
  // Step 5: Placement Editor (PDF Viewer + Drag/Resize Field Overlays)
  // =============================================================================
  function normalizePlacementInstance(instance, index) {
    const raw = instance || {};
    const id = String(raw.id || `fi_init_${index || 0}`);
    const definitionId = String(raw.definitionId || raw.definition_id || raw.field_definition_id || id);
    const page = parseInt(raw.page || raw.page_number || '1', 10);
    const x = parseFloat(raw.x || raw.pos_x || '0');
    const y = parseFloat(raw.y || raw.pos_y || '0');
    const width = parseFloat(raw.width || '150');
    const height = parseFloat(raw.height || '32');
    return {
      id,
      definitionId,
      type: String(raw.type || 'text'),
      participantId: String(raw.participantId || raw.participant_id || ''),
      participantName: String(raw.participantName || raw.participant_name || 'Unassigned'),
      page: Number.isFinite(page) && page > 0 ? page : 1,
      x: Number.isFinite(x) && x >= 0 ? x : 0,
      y: Number.isFinite(y) && y >= 0 ? y : 0,
      width: Number.isFinite(width) && width > 0 ? width : 150,
      height: Number.isFinite(height) && height > 0 ? height : 32,
      placementSource: String(raw.placementSource || raw.placement_source || 'manual')
    };
  }

  const initialPlacementInstances = Array.isArray(window._initialFieldPlacementsData)
    ? window._initialFieldPlacementsData.map((instance, index) => normalizePlacementInstance(instance, index))
    : [];

  let placementState = {
    pdfDoc: null,
    currentPage: 1,
    totalPages: 1,
    scale: 1.0,
    fieldInstances: initialPlacementInstances, // { id, definitionId, type, participantId, page, x, y, width, height }
    selectedFieldId: null,
    isDragging: false,
    isResizing: false,
    dragOffset: { x: 0, y: 0 },
    uiHandlersBound: false
  };

  const TYPE_COLORS = {
    signature: { bg: 'bg-blue-500', border: 'border-blue-500', fill: 'rgba(59, 130, 246, 0.2)' },
    name: { bg: 'bg-green-500', border: 'border-green-500', fill: 'rgba(34, 197, 94, 0.2)' },
    date_signed: { bg: 'bg-purple-500', border: 'border-purple-500', fill: 'rgba(168, 85, 247, 0.2)' },
    text: { bg: 'bg-gray-500', border: 'border-gray-500', fill: 'rgba(107, 114, 128, 0.2)' },
    checkbox: { bg: 'bg-indigo-500', border: 'border-indigo-500', fill: 'rgba(99, 102, 241, 0.2)' },
    initials: { bg: 'bg-orange-500', border: 'border-orange-500', fill: 'rgba(249, 115, 22, 0.2)' }
  };

  const DEFAULT_FIELD_SIZES = {
    signature: { width: 200, height: 50 },
    name: { width: 180, height: 30 },
    date_signed: { width: 120, height: 30 },
    text: { width: 150, height: 30 },
    checkbox: { width: 24, height: 24 },
    initials: { width: 80, height: 40 }
  };

  async function initPlacementEditor() {
    const placementLoading = document.getElementById('placement-loading');
    const placementNoDocument = document.getElementById('placement-no-document');
    const placementFieldsList = document.getElementById('placement-fields-list');
    const placementTotalFields = document.getElementById('placement-total-fields');
    const placementPlacedCount = document.getElementById('placement-placed-count');
    const placementUnplacedCount = document.getElementById('placement-unplaced-count');
    const placementViewer = document.getElementById('placement-viewer');
    const placementCanvas = document.getElementById('placement-pdf-canvas');
    const placementOverlays = document.getElementById('placement-overlays-container');
    const placementCanvasContainer = document.getElementById('placement-canvas-container');
    const currentPageSpan = document.getElementById('placement-current-page');
    const totalPagesSpan = document.getElementById('placement-total-pages');
    const zoomLevelSpan = document.getElementById('placement-zoom-level');

    if (!documentIdInput.value) {
      placementLoading.classList.add('hidden');
      placementNoDocument.classList.remove('hidden');
      return;
    }

    // Show loading state
    placementLoading.classList.remove('hidden');
    placementNoDocument.classList.add('hidden');

    // Load field definitions into the panel
    const fieldEntries = fieldDefinitionsContainer.querySelectorAll('.field-definition-entry');
    const signers = getSignerParticipants();

    placementFieldsList.innerHTML = '';

    fieldEntries.forEach((field, index) => {
      const definitionId = field.getAttribute('data-field-definition-id');
      const typeSelect = field.querySelector('.field-type-select');
      const participantSelect = field.querySelector('.field-participant-select');
      const fieldType = typeSelect.value;
      const participantId = participantSelect.value;
      const participant = signers.find(s => s.id === participantId);

      placementState.fieldInstances.forEach(instance => {
        if (instance.definitionId === definitionId) {
          instance.type = fieldType;
          instance.participantId = participantId;
          instance.participantName = participant?.name || 'Unassigned';
        }
      });

      const colors = TYPE_COLORS[fieldType] || TYPE_COLORS.text;
      const isPlaced = placementState.fieldInstances.some(f => f.definitionId === definitionId);

      const fieldItem = document.createElement('div');
      fieldItem.className = `placement-field-item p-2 border border-gray-200 rounded cursor-move hover:bg-gray-50 flex items-center gap-2 ${isPlaced ? 'opacity-50' : ''}`;
      fieldItem.draggable = !isPlaced;
      fieldItem.dataset.definitionId = definitionId;
      fieldItem.dataset.fieldType = fieldType;
      fieldItem.dataset.participantId = participantId;
      fieldItem.dataset.participantName = participant?.name || 'Unassigned';

      fieldItem.innerHTML = `
        <span class="w-3 h-3 rounded ${colors.bg}"></span>
        <div class="flex-1 text-xs">
          <div class="font-medium capitalize">${fieldType.replace('_', ' ')}</div>
          <div class="text-gray-500">${participant?.name || 'Unassigned'}</div>
        </div>
        <span class="placement-status text-xs ${isPlaced ? 'text-green-600' : 'text-amber-600'}">
          ${isPlaced ? 'Placed' : 'Not placed'}
        </span>
      `;

      // Drag start handler
      fieldItem.addEventListener('dragstart', (e) => {
        if (isPlaced) {
          e.preventDefault();
          return;
        }
        e.dataTransfer.setData('application/json', JSON.stringify({
          definitionId,
          fieldType,
          participantId,
          participantName: participant?.name || 'Unassigned'
        }));
        e.dataTransfer.effectAllowed = 'copy';
        fieldItem.classList.add('opacity-50');
      });

      fieldItem.addEventListener('dragend', () => {
        fieldItem.classList.remove('opacity-50');
      });

      placementFieldsList.appendChild(fieldItem);
    });

    // Try to load PDF
    try {
      // Load PDF.js from CDN if not already loaded
      if (!window.pdfjsLib) {
        await loadPdfJs();
      }

      // Fetch document PDF URL
      const docResponse = await fetch(`${apiBase}/esign_documents/${documentIdInput.value}`, {
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
      });
      if (!docResponse.ok) {
        throw new Error(`Failed to load document metadata (${docResponse.status})`);
      }
      const docPayload = await docResponse.json();
      const docData = (docPayload && typeof docPayload === 'object' && docPayload.data && typeof docPayload.data === 'object')
        ? docPayload.data
        : docPayload;
      const sourceObjectKey = String(docData?.source_object_key || '').trim().replace(/^\/+/, '');
      const sourceAssetUrl = sourceObjectKey
        ? `${basePath}/assets/${sourceObjectKey.split('/').map(encodeURIComponent).join('/')}`
        : '';
      const pdfUrl = String(
        docData?.file_url ||
        docData?.url ||
        docData?.source_url ||
        docData?.download_url ||
        sourceAssetUrl
      ).trim();

      if (!pdfUrl) {
        throw new Error('No PDF URL found');
      }

      // Load PDF document
      const loadingTask = window.pdfjsLib.getDocument(pdfUrl);
      placementState.pdfDoc = await loadingTask.promise;
      placementState.totalPages = placementState.pdfDoc.numPages;
      placementState.currentPage = 1;

      // Update page count
      totalPagesSpan.textContent = placementState.totalPages;

      // Render first page
      await renderPage(placementState.currentPage);

      // Hide loading
      placementLoading.classList.add('hidden');

      if (!placementState.uiHandlersBound) {
        // Bind these handlers once to avoid duplicate listeners when step 5 is revisited.
        setupDropZone(placementViewer, placementOverlays);
        setupPageNavigation();
        setupZoomControls();
        placementState.uiHandlersBound = true;
      }

      // Render existing field instances
      renderFieldOverlays();

    } catch (error) {
      console.error('Failed to load PDF:', error);
      placementLoading.innerHTML = `
        <div class="text-center py-8">
          <svg class="w-16 h-16 mx-auto text-red-300 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <p class="text-sm text-red-600 mb-2">Failed to load PDF</p>
          <p class="text-xs text-gray-400">${error.message}</p>
        </div>
      `;
    }

    updatePlacementStats();
    updateFieldInstancesFormData();
  }

  async function loadPdfJs() {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
      script.onload = () => {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        resolve();
      };
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function renderPage(pageNum) {
    if (!placementState.pdfDoc) return;

    const canvas = document.getElementById('placement-pdf-canvas');
    const container = document.getElementById('placement-canvas-container');
    const ctx = canvas.getContext('2d');

    const page = await placementState.pdfDoc.getPage(pageNum);
    const viewport = page.getViewport({ scale: placementState.scale });

    canvas.width = viewport.width;
    canvas.height = viewport.height;
    container.style.width = `${viewport.width}px`;
    container.style.height = `${viewport.height}px`;

    await page.render({
      canvasContext: ctx,
      viewport: viewport
    }).promise;

    // Update page number display
    document.getElementById('placement-current-page').textContent = pageNum;

    // Update field overlays for current page
    renderFieldOverlays();
  }

  function setupDropZone(viewer, overlaysContainer) {
    const canvas = document.getElementById('placement-pdf-canvas');

    viewer.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
      canvas.classList.add('ring-2', 'ring-blue-500', 'ring-inset');
    });

    viewer.addEventListener('dragleave', (e) => {
      canvas.classList.remove('ring-2', 'ring-blue-500', 'ring-inset');
    });

    viewer.addEventListener('drop', (e) => {
      e.preventDefault();
      canvas.classList.remove('ring-2', 'ring-blue-500', 'ring-inset');

      const data = e.dataTransfer.getData('application/json');
      if (!data) return;

      const fieldData = JSON.parse(data);

      // Calculate drop position relative to canvas
      const canvasRect = canvas.getBoundingClientRect();
      const x = (e.clientX - canvasRect.left) / placementState.scale;
      const y = (e.clientY - canvasRect.top) / placementState.scale;

      // Add field instance
      addFieldInstance(fieldData, x, y);
    });
  }

  function addFieldInstance(fieldData, x, y, options = {}) {
    const sizes = DEFAULT_FIELD_SIZES[fieldData.fieldType] || DEFAULT_FIELD_SIZES.text;
    const instanceId = `fi_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const placementSource = options.placementSource || 'manual';

    const instance = {
      id: instanceId,
      definitionId: fieldData.definitionId,
      type: fieldData.fieldType,
      participantId: fieldData.participantId,
      participantName: fieldData.participantName,
      page: placementState.currentPage,
      x: Math.max(0, x - sizes.width / 2),
      y: Math.max(0, y - sizes.height / 2),
      width: sizes.width,
      height: sizes.height,
      placementSource
    };

    placementState.fieldInstances.push(instance);

    // Mark field as placed in the panel
    const fieldItem = document.querySelector(`.placement-field-item[data-definition-id="${fieldData.definitionId}"]`);
    if (fieldItem) {
      fieldItem.classList.add('opacity-50');
      fieldItem.draggable = false;
      const status = fieldItem.querySelector('.placement-status');
      if (status) {
        status.textContent = 'Placed';
        status.classList.remove('text-amber-600');
        status.classList.add('text-green-600');
      }
    }

    renderFieldOverlays();
    updatePlacementStats();
    updateFieldInstancesFormData();
  }

  function renderFieldOverlays() {
    const container = document.getElementById('placement-overlays-container');
    container.innerHTML = '';
    container.style.pointerEvents = 'auto';

    placementState.fieldInstances
      .filter(f => f.page === placementState.currentPage)
      .forEach(instance => {
        const colors = TYPE_COLORS[instance.type] || TYPE_COLORS.text;
        const isSelected = placementState.selectedFieldId === instance.id;

        const overlay = document.createElement('div');
        overlay.className = `field-overlay absolute cursor-move ${colors.border} border-2 rounded`;
        overlay.style.cssText = `
          left: ${instance.x * placementState.scale}px;
          top: ${instance.y * placementState.scale}px;
          width: ${instance.width * placementState.scale}px;
          height: ${instance.height * placementState.scale}px;
          background-color: ${colors.fill};
          ${isSelected ? 'box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);' : ''}
        `;
        overlay.dataset.instanceId = instance.id;

        // Label
        const label = document.createElement('div');
        label.className = 'absolute -top-5 left-0 text-xs whitespace-nowrap px-1 rounded text-white ' + colors.bg;
        label.textContent = `${instance.type.replace('_', ' ')} - ${instance.participantName}`;
        overlay.appendChild(label);

        // Resize handle
        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'absolute bottom-0 right-0 w-3 h-3 bg-white border border-gray-400 cursor-se-resize';
        resizeHandle.style.cssText = 'transform: translate(50%, 50%);';
        overlay.appendChild(resizeHandle);

        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-600';
        deleteBtn.innerHTML = '';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          removeFieldInstance(instance.id);
        });
        overlay.appendChild(deleteBtn);

        // Drag handlers
        overlay.addEventListener('mousedown', (e) => {
          if (e.target === resizeHandle) {
            startResize(e, instance);
          } else if (e.target !== deleteBtn) {
            startDrag(e, instance, overlay);
          }
        });

        overlay.addEventListener('click', () => {
          placementState.selectedFieldId = instance.id;
          renderFieldOverlays();
        });

        container.appendChild(overlay);
      });
  }

  function startDrag(e, instance, overlay) {
    e.preventDefault();
    placementState.isDragging = true;
    placementState.selectedFieldId = instance.id;

    const startX = e.clientX;
    const startY = e.clientY;
    const startLeft = instance.x * placementState.scale;
    const startTop = instance.y * placementState.scale;

    function onMouseMove(e) {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      instance.x = Math.max(0, (startLeft + dx) / placementState.scale);
      instance.y = Math.max(0, (startTop + dy) / placementState.scale);
      instance.placementSource = 'manual';

      overlay.style.left = `${instance.x * placementState.scale}px`;
      overlay.style.top = `${instance.y * placementState.scale}px`;
    }

    function onMouseUp() {
      placementState.isDragging = false;
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
      updateFieldInstancesFormData();
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }

  function startResize(e, instance) {
    e.preventDefault();
    e.stopPropagation();
    placementState.isResizing = true;

    const startX = e.clientX;
    const startY = e.clientY;
    const startWidth = instance.width;
    const startHeight = instance.height;

    function onMouseMove(e) {
      const dx = (e.clientX - startX) / placementState.scale;
      const dy = (e.clientY - startY) / placementState.scale;

      instance.width = Math.max(30, startWidth + dx);
      instance.height = Math.max(20, startHeight + dy);
      instance.placementSource = 'manual';

      renderFieldOverlays();
    }

    function onMouseUp() {
      placementState.isResizing = false;
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
      updateFieldInstancesFormData();
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }

  function removeFieldInstance(instanceId) {
    const instance = placementState.fieldInstances.find(f => f.id === instanceId);
    if (!instance) return;

    placementState.fieldInstances = placementState.fieldInstances.filter(f => f.id !== instanceId);

    // Unmark field in panel
    const fieldItem = document.querySelector(`.placement-field-item[data-definition-id="${instance.definitionId}"]`);
    if (fieldItem) {
      fieldItem.classList.remove('opacity-50');
      fieldItem.draggable = true;
      const status = fieldItem.querySelector('.placement-status');
      if (status) {
        status.textContent = 'Not placed';
        status.classList.remove('text-green-600');
        status.classList.add('text-amber-600');
      }
    }

    renderFieldOverlays();
    updatePlacementStats();
    updateFieldInstancesFormData();
  }

  function setupPageNavigation() {
    const prevBtn = document.getElementById('placement-prev-page');
    const nextBtn = document.getElementById('placement-next-page');

    prevBtn.addEventListener('click', async () => {
      if (placementState.currentPage > 1) {
        placementState.currentPage--;
        await renderPage(placementState.currentPage);
      }
    });

    nextBtn.addEventListener('click', async () => {
      if (placementState.currentPage < placementState.totalPages) {
        placementState.currentPage++;
        await renderPage(placementState.currentPage);
      }
    });
  }

  function setupZoomControls() {
    const zoomIn = document.getElementById('placement-zoom-in');
    const zoomOut = document.getElementById('placement-zoom-out');
    const zoomFit = document.getElementById('placement-zoom-fit');
    const zoomLevel = document.getElementById('placement-zoom-level');

    zoomIn.addEventListener('click', async () => {
      placementState.scale = Math.min(3.0, placementState.scale + 0.25);
      zoomLevel.textContent = `${Math.round(placementState.scale * 100)}%`;
      await renderPage(placementState.currentPage);
    });

    zoomOut.addEventListener('click', async () => {
      placementState.scale = Math.max(0.5, placementState.scale - 0.25);
      zoomLevel.textContent = `${Math.round(placementState.scale * 100)}%`;
      await renderPage(placementState.currentPage);
    });

    zoomFit.addEventListener('click', async () => {
      const viewer = document.getElementById('placement-viewer');
      const page = await placementState.pdfDoc.getPage(placementState.currentPage);
      const viewport = page.getViewport({ scale: 1.0 });
      placementState.scale = (viewer.clientWidth - 40) / viewport.width;
      zoomLevel.textContent = `${Math.round(placementState.scale * 100)}%`;
      await renderPage(placementState.currentPage);
    });
  }

  function updatePlacementStats() {
    const totalFields = document.querySelectorAll('.placement-field-item').length;
    const placedCount = placementState.fieldInstances.length;
    const unplacedCount = totalFields - placedCount;

    document.getElementById('placement-total-fields').textContent = totalFields;
    document.getElementById('placement-placed-count').textContent = placedCount;
    document.getElementById('placement-unplaced-count').textContent = unplacedCount;
  }

  function updateFieldInstancesFormData() {
    const container = document.getElementById('field-instances-container');
    container.innerHTML = '';

    placementState.fieldInstances.forEach((instance, index) => {
      const inputs = [
        { name: `field_placements[${index}].id`, value: instance.id },
        { name: `field_placements[${index}].definition_id`, value: instance.definitionId },
        { name: `field_placements[${index}].page`, value: instance.page },
        { name: `field_placements[${index}].x`, value: Math.round(instance.x) },
        { name: `field_placements[${index}].y`, value: Math.round(instance.y) },
        { name: `field_placements[${index}].width`, value: Math.round(instance.width) },
        { name: `field_placements[${index}].height`, value: Math.round(instance.height) }
      ];

      inputs.forEach(({ name, value }) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        container.appendChild(input);
      });
    });
  }

  // Ensure placement geometry is included in form posts before any interaction.
  updateFieldInstancesFormData();

  // =============================================================================
  // Auto-Placement Engine Integration (Phase 27)
  // =============================================================================

  let autoPlaceState = {
    currentRunId: null,
    suggestions: [],
    resolverScores: [],
    policy: null,
    isRunning: false
  };

  // Auto-place button handler - wired to placement orchestrator
  const autoPlaceBtn = document.getElementById('auto-place-btn');
  if (autoPlaceBtn) {
    autoPlaceBtn.addEventListener('click', async () => {
      if (autoPlaceState.isRunning) return;

      const unplacedFields = document.querySelectorAll('.placement-field-item:not(.opacity-50)');
      if (unplacedFields.length === 0) {
        showToast('All fields are already placed', 'info');
        return;
      }

      const agreementId = document.querySelector('input[name="id"]')?.value;
      if (!agreementId) {
        // Fallback to simple placement for unsaved agreements
        autoPlaceFallback();
        return;
      }

      autoPlaceState.isRunning = true;
      autoPlaceBtn.disabled = true;
      autoPlaceBtn.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Analyzing...
      `;

      try {
        // Call placement orchestrator API
        const response = await fetch(`${apiBase}/esign-agreements/${agreementId}/actions/auto-place`, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            policy_preset: getSelectedPolicyPreset()
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Auto-placement failed');
        }

        const result = await response.json();
        autoPlaceState.currentRunId = result.run_id;
        autoPlaceState.suggestions = result.suggestions || [];
        autoPlaceState.resolverScores = result.resolver_scores || [];

        if (autoPlaceState.suggestions.length === 0) {
          showToast('No placement suggestions found. Try placing fields manually.', 'warning');
          autoPlaceFallback();
        } else {
          openSuggestionsModal(result);
        }

      } catch (error) {
        console.error('Auto-place error:', error);
        showToast(`Auto-placement failed: ${error.message}`, 'error');
        // Fallback to simple placement
        autoPlaceFallback();
      } finally {
        autoPlaceState.isRunning = false;
        autoPlaceBtn.disabled = false;
        autoPlaceBtn.innerHTML = `
          <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          Auto-place
        `;
      }
    });
  }

  function getSelectedPolicyPreset() {
    const policySelect = document.getElementById('placement-policy-preset');
    return policySelect?.value || 'balanced';
  }

  function autoPlaceFallback() {
    // Simple auto-placement: stack fields vertically on the last page
    const unplacedFields = document.querySelectorAll('.placement-field-item:not(.opacity-50)');
    let yOffset = 100;

    unplacedFields.forEach(fieldItem => {
      const fieldData = {
        definitionId: fieldItem.dataset.definitionId,
        fieldType: fieldItem.dataset.fieldType,
        participantId: fieldItem.dataset.participantId,
        participantName: fieldItem.dataset.participantName
      };

      const sizes = DEFAULT_FIELD_SIZES[fieldData.fieldType] || DEFAULT_FIELD_SIZES.text;

      // Place on last page
      placementState.currentPage = placementState.totalPages;
      addFieldInstance(fieldData, 300, yOffset + sizes.height / 2, { placementSource: 'auto_fallback' });
      yOffset += sizes.height + 20;
    });

    // Render the last page
    if (placementState.pdfDoc) {
      renderPage(placementState.totalPages);
    }

    showToast('Fields placed using fallback layout', 'info');
  }

  function openSuggestionsModal(result) {
    // Create or get modal
    let modal = document.getElementById('placement-suggestions-modal');
    if (!modal) {
      modal = createSuggestionsModal();
      document.body.appendChild(modal);
    }

    // Populate suggestions
    const suggestionsContainer = modal.querySelector('#suggestions-list');
    const resolverInfo = modal.querySelector('#resolver-info');
    const runStats = modal.querySelector('#run-stats');

    // Show resolver scores
    resolverInfo.innerHTML = autoPlaceState.resolverScores.map(rs => `
      <div class="flex items-center justify-between text-xs py-1 border-b border-gray-100 last:border-0">
        <span class="font-medium capitalize">${rs.resolver_id.replace(/_/g, ' ')}</span>
        <div class="flex items-center gap-2">
          ${rs.supported ? `
            <span class="px-1.5 py-0.5 rounded text-xs ${getScoreBadgeClass(rs.score)}">
              ${(rs.score * 100).toFixed(0)}%
            </span>
          ` : `
            <span class="px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 text-xs">N/A</span>
          `}
        </div>
      </div>
    `).join('');

    // Show run stats
    runStats.innerHTML = `
      <div class="flex items-center gap-4 text-xs text-gray-600">
        <span>Run: <code class="bg-gray-100 px-1 rounded">${result.run_id?.slice(0, 8) || 'N/A'}</code></span>
        <span>Status: <span class="font-medium ${result.status === 'completed' ? 'text-green-600' : 'text-amber-600'}">${result.status || 'unknown'}</span></span>
        <span>Time: ${result.elapsed_ms || 0}ms</span>
      </div>
    `;

    // Render suggestions with accept/reject controls
    suggestionsContainer.innerHTML = autoPlaceState.suggestions.map((suggestion, index) => {
      const fieldDef = getFieldDefinitionById(suggestion.field_definition_id);
      const colors = TYPE_COLORS[fieldDef?.type] || TYPE_COLORS.text;

      return `
        <div class="suggestion-item p-3 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors" data-index="${index}" data-suggestion-id="${suggestion.id}">
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded ${colors.bg}"></span>
              <div>
                <div class="font-medium text-sm capitalize">${(fieldDef?.type || 'field').replace('_', ' ')}</div>
                <div class="text-xs text-gray-500">Page ${suggestion.page_number}, (${Math.round(suggestion.x)}, ${Math.round(suggestion.y)})</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="confidence-badge px-2 py-0.5 rounded-full text-xs font-medium ${getConfidenceBadgeClass(suggestion.confidence)}">
                ${(suggestion.confidence * 100).toFixed(0)}%
              </span>
              <span class="resolver-badge px-2 py-0.5 rounded bg-gray-100 text-gray-600 text-xs">
                ${formatResolverLabel(suggestion.resolver_id)}
              </span>
            </div>
          </div>
          <div class="flex items-center gap-2 mt-3">
            <button type="button" class="accept-suggestion-btn flex-1 px-3 py-1.5 bg-green-50 text-green-700 text-xs font-medium rounded hover:bg-green-100 transition-colors" data-index="${index}">
              <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Accept
            </button>
            <button type="button" class="reject-suggestion-btn flex-1 px-3 py-1.5 bg-red-50 text-red-700 text-xs font-medium rounded hover:bg-red-100 transition-colors" data-index="${index}">
              <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
              Reject
            </button>
            <button type="button" class="preview-suggestion-btn px-3 py-1.5 bg-blue-50 text-blue-700 text-xs font-medium rounded hover:bg-blue-100 transition-colors" data-index="${index}">
              <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              Preview
            </button>
          </div>
        </div>
      `;
    }).join('');

    // Bind suggestion action handlers
    bindSuggestionActions(modal);

    // Show modal
    modal.classList.remove('hidden');
  }

  function createSuggestionsModal() {
    const modal = document.createElement('div');
    modal.id = 'placement-suggestions-modal';
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden';
    modal.innerHTML = `
      <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
          <div>
            <h2 class="text-lg font-semibold text-gray-900">Smart Placement Suggestions</h2>
            <p class="text-sm text-gray-500 mt-0.5">Review and apply AI-generated field placements</p>
          </div>
          <button type="button" id="close-suggestions-modal" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <div id="run-stats"></div>
            <div class="flex items-center gap-2">
              <button type="button" id="accept-all-btn" class="px-3 py-1.5 bg-green-600 text-white text-xs font-medium rounded hover:bg-green-700 transition-colors">
                Accept All
              </button>
              <button type="button" id="reject-all-btn" class="px-3 py-1.5 bg-gray-200 text-gray-700 text-xs font-medium rounded hover:bg-gray-300 transition-colors">
                Reject All
              </button>
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto">
          <div class="grid grid-cols-2 gap-4 p-6">
            <div>
              <h3 class="text-sm font-medium text-gray-700 mb-3">Suggestions</h3>
              <div id="suggestions-list" class="space-y-3"></div>
            </div>
            <div>
              <h3 class="text-sm font-medium text-gray-700 mb-3">Resolver Ranking</h3>
              <div id="resolver-info" class="bg-gray-50 rounded-lg p-3"></div>

              <h3 class="text-sm font-medium text-gray-700 mt-4 mb-3">Policy Preset</h3>
              <select id="placement-policy-preset-modal" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                <option value="balanced">Balanced (Recommended)</option>
                <option value="accuracy-first">Accuracy First</option>
                <option value="cost-first">Cost Optimized</option>
                <option value="speed-first">Speed Optimized</option>
              </select>
              <p class="text-xs text-gray-500 mt-1">Change preset and re-run for different results</p>
            </div>
          </div>
        </div>

        <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
          <button type="button" id="rerun-placement-btn" class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">
            Re-run with New Policy
          </button>
          <button type="button" id="apply-suggestions-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
            Apply Selected
          </button>
        </div>
      </div>
    `;

    // Close button handler
    modal.querySelector('#close-suggestions-modal').addEventListener('click', () => {
      modal.classList.add('hidden');
    });

    // Click outside to close
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });

    // Accept all handler
    modal.querySelector('#accept-all-btn').addEventListener('click', () => {
      modal.querySelectorAll('.suggestion-item').forEach(item => {
        item.classList.add('border-green-500', 'bg-green-50');
        item.classList.remove('border-red-500', 'bg-red-50');
        item.dataset.accepted = 'true';
      });
    });

    // Reject all handler
    modal.querySelector('#reject-all-btn').addEventListener('click', () => {
      modal.querySelectorAll('.suggestion-item').forEach(item => {
        item.classList.add('border-red-500', 'bg-red-50');
        item.classList.remove('border-green-500', 'bg-green-50');
        item.dataset.accepted = 'false';
      });
    });

    // Apply suggestions handler
    modal.querySelector('#apply-suggestions-btn').addEventListener('click', () => {
      applyAcceptedSuggestions();
      modal.classList.add('hidden');
    });

    // Re-run handler
    modal.querySelector('#rerun-placement-btn').addEventListener('click', () => {
      modal.classList.add('hidden');
      // Sync policy preset
      const modalPreset = modal.querySelector('#placement-policy-preset-modal');
      const mainPreset = document.getElementById('placement-policy-preset');
      if (mainPreset && modalPreset) {
        mainPreset.value = modalPreset.value;
      }
      // Trigger auto-place again
      autoPlaceBtn?.click();
    });

    return modal;
  }

  function bindSuggestionActions(modal) {
    // Accept single suggestion
    modal.querySelectorAll('.accept-suggestion-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const item = btn.closest('.suggestion-item');
        item.classList.add('border-green-500', 'bg-green-50');
        item.classList.remove('border-red-500', 'bg-red-50');
        item.dataset.accepted = 'true';
      });
    });

    // Reject single suggestion
    modal.querySelectorAll('.reject-suggestion-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const item = btn.closest('.suggestion-item');
        item.classList.add('border-red-500', 'bg-red-50');
        item.classList.remove('border-green-500', 'bg-green-50');
        item.dataset.accepted = 'false';
      });
    });

    // Preview suggestion
    modal.querySelectorAll('.preview-suggestion-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const index = parseInt(btn.dataset.index, 10);
        const suggestion = autoPlaceState.suggestions[index];
        if (suggestion) {
          previewSuggestionOnDocument(suggestion);
        }
      });
    });
  }

  function previewSuggestionOnDocument(suggestion) {
    // Navigate to the page and highlight the suggested position
    if (suggestion.page_number !== placementState.currentPage) {
      placementState.currentPage = suggestion.page_number;
      renderPage(suggestion.page_number);
    }

    // Create temporary highlight overlay
    const overlaysContainer = document.getElementById('placement-overlays-container');
    const existingPreview = document.getElementById('suggestion-preview-overlay');
    if (existingPreview) existingPreview.remove();

    const preview = document.createElement('div');
    preview.id = 'suggestion-preview-overlay';
    preview.className = 'absolute pointer-events-none animate-pulse';
    preview.style.cssText = `
      left: ${suggestion.x * placementState.scale}px;
      top: ${suggestion.y * placementState.scale}px;
      width: ${suggestion.width * placementState.scale}px;
      height: ${suggestion.height * placementState.scale}px;
      border: 3px dashed #3b82f6;
      background: rgba(59, 130, 246, 0.15);
      border-radius: 4px;
    `;
    overlaysContainer.appendChild(preview);

    // Remove preview after 3 seconds
    setTimeout(() => preview.remove(), 3000);
  }

  function applyAcceptedSuggestions() {
    const modal = document.getElementById('placement-suggestions-modal');
    const acceptedItems = modal.querySelectorAll('.suggestion-item[data-accepted="true"]');

    acceptedItems.forEach(item => {
      const index = parseInt(item.dataset.index, 10);
      const suggestion = autoPlaceState.suggestions[index];
      if (!suggestion) return;

      const fieldDef = getFieldDefinitionById(suggestion.field_definition_id);
      if (!fieldDef) return;

      // Find the placement field item
      const fieldItem = document.querySelector(`.placement-field-item[data-definition-id="${suggestion.field_definition_id}"]`);
      if (!fieldItem || fieldItem.classList.contains('opacity-50')) return;

      const fieldData = {
        definitionId: suggestion.field_definition_id,
        fieldType: fieldDef.type,
        participantId: fieldDef.participant_id,
        participantName: fieldItem.dataset.participantName
      };

      // Set current page and add instance
      placementState.currentPage = suggestion.page_number;
      addFieldInstanceFromSuggestion(fieldData, suggestion);
    });

    // Render current page
    if (placementState.pdfDoc) {
      renderPage(placementState.currentPage);
    }

    // Send feedback to API for future improvement
    sendPlacementFeedback(acceptedItems.length, autoPlaceState.suggestions.length - acceptedItems.length);

    showToast(`Applied ${acceptedItems.length} placement${acceptedItems.length !== 1 ? 's' : ''}`, 'success');
  }

  function addFieldInstanceFromSuggestion(fieldData, suggestion) {
    const instance = {
      id: `instance_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      definitionId: fieldData.definitionId,
      type: fieldData.fieldType,
      participantId: fieldData.participantId,
      participantName: fieldData.participantName,
      page: suggestion.page_number,
      x: suggestion.x,
      y: suggestion.y,
      width: suggestion.width,
      height: suggestion.height,
      // Track placement source for audit
      placementSource: 'auto',
      resolverId: suggestion.resolver_id,
      confidence: suggestion.confidence,
      placementRunId: autoPlaceState.currentRunId
    };

    placementState.fieldInstances.push(instance);

    // Mark field as placed in panel
    const fieldItem = document.querySelector(`.placement-field-item[data-definition-id="${fieldData.definitionId}"]`);
    if (fieldItem) {
      fieldItem.classList.add('opacity-50');
      fieldItem.draggable = false;
      const status = fieldItem.querySelector('.placement-status');
      if (status) {
        status.textContent = 'Placed';
        status.classList.remove('text-amber-600');
        status.classList.add('text-green-600');
      }
    }

    renderFieldOverlays();
    updatePlacementStats();
    updateFieldInstancesFormData();
  }

  function getFieldDefinitionById(definitionId) {
    const fieldEntry = document.querySelector(`.field-definition-entry[data-field-definition-id="${definitionId}"]`);
    if (!fieldEntry) return null;

    return {
      id: definitionId,
      type: fieldEntry.querySelector('.field-type-select')?.value || 'text',
      participant_id: fieldEntry.querySelector('.field-participant-select')?.value || ''
    };
  }

  function getConfidenceBadgeClass(confidence) {
    if (confidence >= 0.9) return 'bg-green-100 text-green-800';
    if (confidence >= 0.7) return 'bg-blue-100 text-blue-800';
    if (confidence >= 0.5) return 'bg-yellow-100 text-yellow-800';
    return 'bg-red-100 text-red-800';
  }

  function getScoreBadgeClass(score) {
    if (score >= 0.8) return 'bg-green-100 text-green-800';
    if (score >= 0.6) return 'bg-blue-100 text-blue-800';
    if (score >= 0.4) return 'bg-yellow-100 text-yellow-800';
    return 'bg-gray-100 text-gray-600';
  }

  function formatResolverLabel(resolverId) {
    if (!resolverId) return 'Unknown';
    return resolverId.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  }

  async function sendPlacementFeedback(acceptedCount, rejectedCount) {
    if (!autoPlaceState.currentRunId) return;

    try {
      const agreementId = document.querySelector('input[name="id"]')?.value;
      if (!agreementId) return;

      await fetch(`${apiBase}/esign-agreements/${agreementId}/placement-runs/${autoPlaceState.currentRunId}/feedback`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          accepted_count: acceptedCount,
          rejected_count: rejectedCount,
          manual_override_count: placementState.fieldInstances.filter(f => f.placementSource === 'manual').length
        })
      });
    } catch (error) {
      console.warn('Failed to send placement feedback:', error);
      // Non-critical, don't show error to user
    }
  }

  function showToast(message, type = 'info') {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg text-sm font-medium z-50 transition-all duration-300 ${
      type === 'success' ? 'bg-green-600 text-white' :
      type === 'error' ? 'bg-red-600 text-white' :
      type === 'warning' ? 'bg-amber-500 text-white' :
      'bg-gray-800 text-white'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // =============================================================================
  // Step 6: Send Readiness Check
  // =============================================================================
  function initSendReadinessCheck() {
    const sendReadinessLoading = document.getElementById('send-readiness-loading');
    const sendReadinessResults = document.getElementById('send-readiness-results');
    const sendValidationStatus = document.getElementById('send-validation-status');
    const sendValidationIssues = document.getElementById('send-validation-issues');
    const sendIssuesList = document.getElementById('send-issues-list');
    const sendConfirmation = document.getElementById('send-confirmation');

    const reviewAgreementTitle = document.getElementById('review-agreement-title');
    const reviewDocumentTitle = document.getElementById('review-document-title');
    const reviewParticipantCount = document.getElementById('review-participant-count');
    const reviewStageCount = document.getElementById('review-stage-count');
    const reviewParticipantsList = document.getElementById('review-participants-list');
    const reviewFieldsSummary = document.getElementById('review-fields-summary');

    // Gather data from form
    const title = document.getElementById('title').value || 'Untitled';
    const docTitle = selectedDocumentTitle.textContent || 'No document';
    const participantEntries = participantsContainer.querySelectorAll('.participant-entry');
    const fieldEntries = fieldDefinitionsContainer.querySelectorAll('.field-definition-entry');
    const signers = getSignerParticipants();

    // Calculate stages
    const stages = new Set();
    participantEntries.forEach(entry => {
      const stageInput = entry.querySelector('.signing-stage-input');
      const roleSelect = entry.querySelector('select[name*=".role"]');
      if (roleSelect.value === 'signer' && stageInput?.value) {
        stages.add(parseInt(stageInput.value, 10));
      }
    });

    // Populate summary
    reviewAgreementTitle.textContent = title;
    reviewDocumentTitle.textContent = docTitle;
    reviewParticipantCount.textContent = `${participantEntries.length} (${signers.length} signers)`;
    reviewStageCount.textContent = stages.size > 0 ? stages.size : '1';

    // Populate participants list
    reviewParticipantsList.innerHTML = '';
    participantEntries.forEach(entry => {
      const nameInput = entry.querySelector('input[name*=".name"]');
      const emailInput = entry.querySelector('input[name*=".email"]');
      const roleSelect = entry.querySelector('select[name*=".role"]');
      const stageInput = entry.querySelector('.signing-stage-input');

      const div = document.createElement('div');
      div.className = 'flex items-center justify-between text-sm';
      div.innerHTML = `
        <div>
          <span class="font-medium">${escapeHtml(nameInput.value || emailInput.value)}</span>
          <span class="text-gray-500 ml-2">${escapeHtml(emailInput.value)}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 rounded text-xs ${roleSelect.value === 'signer' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'}">
            ${roleSelect.value === 'signer' ? 'Signer' : 'CC'}
          </span>
          ${roleSelect.value === 'signer' && stageInput?.value ? `<span class="text-xs text-gray-500">Stage ${stageInput.value}</span>` : ''}
        </div>
      `;
      reviewParticipantsList.appendChild(div);
    });

    // Populate fields summary
    reviewFieldsSummary.textContent = `${fieldEntries.length} field${fieldEntries.length !== 1 ? 's' : ''} defined`;

    // Validation
    const issues = [];

    // Check for document
    if (!documentIdInput.value) {
      issues.push({ severity: 'error', message: 'No document selected', action: 'Go to Step 1', step: 1 });
    }

    // Check for signers
    if (signers.length === 0) {
      issues.push({ severity: 'error', message: 'No signers added', action: 'Go to Step 3', step: 3 });
    }

    // Check each signer has a required signature field
    const missingSigners = findSignersMissingRequiredSignatureField();
    missingSigners.forEach((signer) => {
      issues.push({
        severity: 'error',
        message: `${signer.name} has no required signature field`,
        action: 'Add signature field',
        step: 4
      });
    });

    // Check stage continuity
    const stageArray = Array.from(stages).sort((a, b) => a - b);
    for (let i = 0; i < stageArray.length; i++) {
      if (stageArray[i] !== i + 1) {
        issues.push({
          severity: 'warning',
          message: 'Signing stages should be sequential starting from 1',
          action: 'Review stages',
          step: 3
        });
        break;
      }
    }

    // Display validation results
    const hasErrors = issues.some(i => i.severity === 'error');
    const hasWarnings = issues.some(i => i.severity === 'warning');

    if (hasErrors) {
      sendValidationStatus.className = 'p-4 rounded-lg bg-red-50 border border-red-200';
      sendValidationStatus.innerHTML = `
        <div class="flex items-center gap-2 text-red-800">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="font-medium">Cannot send - issues must be resolved</span>
        </div>
      `;
      sendConfirmation.classList.add('hidden');
      submitBtn.disabled = true;
    } else if (hasWarnings) {
      sendValidationStatus.className = 'p-4 rounded-lg bg-amber-50 border border-amber-200';
      sendValidationStatus.innerHTML = `
        <div class="flex items-center gap-2 text-amber-800">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span class="font-medium">Ready with warnings - review before sending</span>
        </div>
      `;
      sendConfirmation.classList.remove('hidden');
      submitBtn.disabled = false;
    } else {
      sendValidationStatus.className = 'p-4 rounded-lg bg-green-50 border border-green-200';
      sendValidationStatus.innerHTML = `
        <div class="flex items-center gap-2 text-green-800">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="font-medium">All checks passed - ready to send</span>
        </div>
      `;
      sendConfirmation.classList.remove('hidden');
      submitBtn.disabled = false;
    }

    // Display issues
    if (issues.length > 0) {
      sendValidationIssues.classList.remove('hidden');
      sendIssuesList.innerHTML = '';
      issues.forEach(issue => {
        const li = document.createElement('li');
        li.className = `p-3 rounded-lg flex items-center justify-between ${issue.severity === 'error' ? 'bg-red-50' : 'bg-amber-50'}`;
        li.innerHTML = `
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 ${issue.severity === 'error' ? 'text-red-500' : 'text-amber-500'}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${issue.severity === 'error' ? 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' : 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'}"/>
            </svg>
            <span class="text-sm">${escapeHtml(issue.message)}</span>
          </div>
          <button type="button" class="text-xs text-blue-600 hover:text-blue-800" onclick="goToStep(${issue.step})">
            ${escapeHtml(issue.action)}
          </button>
        `;
        sendIssuesList.appendChild(li);
      });
    } else {
      sendValidationIssues.classList.add('hidden');
    }

    // Hide loading, show results
    sendReadinessLoading.classList.add('hidden');
    sendReadinessResults.classList.remove('hidden');
  }

  // Make goToStep available globally for issue action buttons
  window.goToStep = goToStep;

  // =============================================================================
  // Wire up state change tracking
  // =============================================================================

  // Debounced tracking function for input events
  let trackingTimeout = null;
  function debouncedTrackChanges() {
    if (trackingTimeout) clearTimeout(trackingTimeout);
    trackingTimeout = setTimeout(() => {
      trackWizardStateChanges();
    }, 500);
  }

  // Track document selection changes (documentIdInput already declared above)
  if (documentIdInput) {
    const observer = new MutationObserver(() => {
      trackWizardStateChanges();
    });
    observer.observe(documentIdInput, { attributes: true, attributeFilter: ['value'] });
  }

  // Track agreement details changes
  const titleInput = document.getElementById('title');
  const messageInput = document.getElementById('message');
  titleInput?.addEventListener('input', debouncedTrackChanges);
  messageInput?.addEventListener('input', debouncedTrackChanges);

  // Track participant changes (handled via MutationObserver and change events)
  participantsContainer.addEventListener('input', debouncedTrackChanges);
  participantsContainer.addEventListener('change', debouncedTrackChanges);

  // Track field definition changes
  fieldDefinitionsContainer.addEventListener('input', debouncedTrackChanges);
  fieldDefinitionsContainer.addEventListener('change', debouncedTrackChanges);

  // Track placement changes (already have updateFieldInstancesFormData)
  const originalUpdateFieldInstancesFormData = updateFieldInstancesFormData;
  updateFieldInstancesFormData = function() {
    originalUpdateFieldInstancesFormData();
    trackWizardStateChanges();
  };

  // Restore participants from state if resuming
  function restoreParticipantsFromState() {
    const state = stateManager.getState();
    if (!state.participants || state.participants.length === 0) return;

    // Clear existing participants (the default one added)
    participantsContainer.innerHTML = '';
    participantFormIndex = 0;

    // Restore from state
    state.participants.forEach(p => {
      addParticipant({
        id: p.tempId,
        name: p.name,
        email: p.email,
        role: p.role,
        signing_stage: p.signingStage
      });
    });
  }

  // Restore field definitions from state if resuming
  function restoreFieldDefinitionsFromState() {
    const state = stateManager.getState();
    if (!state.fieldDefinitions || state.fieldDefinitions.length === 0) return;

    // Clear existing field definitions
    fieldDefinitionsContainer.innerHTML = '';
    fieldInstanceFormIndex = 0;

    // Restore from state
    state.fieldDefinitions.forEach(f => {
      addFieldDefinition({
        id: f.tempId,
        type: f.type,
        participant_id: f.participantTempId,
        page: f.page,
        required: f.required
      });
    });

    updateFieldDefinitionsEmptyState();
  }

  function restoreFieldPlacementsFromState() {
    const state = stateManager.getState();
    if (!Array.isArray(state.fieldPlacements) || state.fieldPlacements.length === 0) return;
    placementState.fieldInstances = state.fieldPlacements.map((instance, index) => normalizePlacementInstance(instance, index));
    updateFieldInstancesFormData();
  }

  // Check if we need to restore state after initialization
  if (window._resumeToStep) {
    // Restore participants and field definitions
    restoreParticipantsFromState();
    restoreFieldDefinitionsFromState();
    restoreFieldPlacementsFromState();

    // Navigate to saved step
    currentStep = window._resumeToStep;
    updateWizardUI();
    delete window._resumeToStep;
  } else {
    // Initialize wizard normally
    updateWizardUI();
  }

  // If editing an existing agreement, don't show sync indicator until changes are made
  if (isEditMode) {
    document.getElementById('sync-status-indicator')?.classList.add('hidden');
  }
});
</script>
{% endblock %}
