{% extends "layout.html" %}

{% block title %}{% if is_edit %}Edit{% else %}Create{% endif %} Agreement - {{ title }}{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <div>
    <p class="text-sm text-gray-500 mb-1">E-Sign Agreements</p>
    <h1 class="text-3xl font-bold text-admin-dark">{% if is_edit %}Edit{% else %}Create{% endif %} Agreement</h1>
  </div>
  <div class="flex gap-3">
    {% if routes.index %}
      <a href="{{ routes.index }}" class="btn btn-secondary" aria-label="Return to agreements list">
        <i class="iconoir-arrow-left" aria-hidden="true"></i>
        Back to Agreements
      </a>
    {% endif %}
  </div>
</header>

<div class="flex-1 p-8 overflow-y-auto">
  {# Live region for form validation announcements #}
  <div id="form-announcements" class="sr-only" role="alert" aria-live="polite"></div>

  <form id="agreement-form" method="POST" action="{{ form_action|default:routes.create }}" class="max-w-4xl space-y-8" aria-describedby="form-announcements">

    {# Step 1: Document Selection #}
    <div class="bg-white border border-gray-200 rounded-xl p-6">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">1</div>
        <h2 class="text-lg font-semibold text-gray-900">Select Document</h2>
      </div>

      <div id="document-selector" class="space-y-4">
        <input type="hidden" id="document_id" name="document_id" value="{{ resource_item.document_id|default:"" }}" required>

        {# Selected Document Preview #}
        <div id="selected-document" class="{% if not resource_item.document_id %}hidden{% endif %} p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
              </div>
              <div>
                <div class="font-medium text-gray-900" id="selected-document-title">{{ resource_item.document_title|default:"" }}</div>
                <div class="text-sm text-gray-500" id="selected-document-info">{{ resource_item.document_page_count|default:"" }} pages</div>
              </div>
            </div>
            <button type="button" id="change-document-btn" class="text-sm text-blue-600 hover:text-blue-800">
              Change
            </button>
          </div>
        </div>

        {# Document Picker #}
        <div id="document-picker" class="{% if resource_item.document_id %}hidden{% endif %}" role="search" aria-label="Document search">
          <div class="relative">
            <input
              type="text"
              id="document-search"
              placeholder="Search documents..."
              aria-label="Search for documents by title"
              aria-controls="document-list"
              aria-autocomplete="list"
              class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none" aria-hidden="true">
              <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
          </div>
          <div id="document-list" class="mt-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg" role="listbox" aria-label="Available documents">
            <div class="p-4 text-center text-gray-500 text-sm" role="status">Loading documents...</div>
          </div>
          <p class="mt-2 text-xs text-gray-500" id="document-picker-help">
            Select the PDF document to use for this agreement.
            <a href="{{ base_path }}/esign/documents/new" class="text-blue-600 hover:underline">Upload a new document</a>
          </p>
        </div>
      </div>
    </div>

    {# Step 2: Agreement Details #}
    <div class="bg-white border border-gray-200 rounded-xl p-6">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">2</div>
        <h2 class="text-lg font-semibold text-gray-900">Agreement Details</h2>
      </div>

      <div class="space-y-4">
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
            Agreement Title <span class="text-red-500" aria-hidden="true">*</span>
            <span class="sr-only">(required)</span>
          </label>
          <input
            type="text"
            id="title"
            name="title"
            value="{{ resource_item.title|default:"" }}"
            required
            aria-required="true"
            aria-describedby="title-help"
            placeholder="e.g., Employment Agreement - John Doe"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
          <p class="mt-1 text-xs text-gray-500" id="title-help">A descriptive title that will be shown to recipients.</p>
        </div>

        <div>
          <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
            Message to Recipients
          </label>
          <textarea
            id="message"
            name="message"
            rows="3"
            placeholder="Please review and sign this document at your earliest convenience."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >{{ resource_item.message|default:"" }}</textarea>
          <p class="mt-1 text-xs text-gray-500">This message will be included in the signing invitation email.</p>
        </div>
      </div>
    </div>

    {# Step 3: Recipients (v1: single signer constraint) #}
    <div class="bg-white border border-gray-200 rounded-xl p-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">3</div>
          <h2 class="text-lg font-semibold text-gray-900">Recipients</h2>
        </div>
        <button type="button" id="add-recipient-btn" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1" aria-label="Add a new recipient to this agreement">
          <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Recipient
        </button>
      </div>

      <div id="recipients-container" class="space-y-4" role="list" aria-label="Agreement recipients">
        {# Recipient template - cloned for each recipient #}
        <template id="recipient-template">
          <div class="recipient-entry p-4 border border-gray-200 rounded-lg" data-recipient-index="" role="listitem">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <input
                    type="text"
                    name="recipients[].name"
                    placeholder="John Doe"
                    aria-label="Recipient name"
                    autocomplete="name"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Email <span class="text-red-500" aria-hidden="true">*</span>
                    <span class="sr-only">(required)</span>
                  </label>
                  <input
                    type="email"
                    name="recipients[].email"
                    placeholder="john@example.com"
                    required
                    aria-required="true"
                    aria-label="Recipient email address"
                    autocomplete="email"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                  <select
                    name="recipients[].role"
                    aria-label="Recipient role"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="signer">Signer</option>
                    <option value="cc">CC (Copy Only)</option>
                  </select>
                </div>
              </div>
              <button type="button" class="remove-recipient-btn p-2 text-gray-400 hover:text-red-600" aria-label="Remove this recipient">
                <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
        </template>

        {# Initial recipient entries will be rendered here #}
      </div>

      <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg" role="note" aria-label="Recipient limitation notice">
        <div class="flex items-start gap-2">
          <svg class="w-4 h-4 text-amber-600 mt-0.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <p class="text-xs text-amber-700">
            <strong>V1 Constraint:</strong> Currently limited to one signer per agreement. CC recipients receive copies but do not sign.
          </p>
        </div>
      </div>
    </div>

    {# Step 4: Signing Fields #}
    <div class="bg-white border border-gray-200 rounded-xl p-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">4</div>
          <h2 class="text-lg font-semibold text-gray-900">Signing Fields</h2>
        </div>
        <button type="button" id="add-field-btn" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1" aria-label="Add a new field to this agreement">
          <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Field
        </button>
      </div>

      <p class="text-sm text-gray-600 mb-4">Define the fields signers need to complete. Each signer must have at least one signature field.</p>

      {# Field Type Descriptions #}
      <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Available Field Types</h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-xs">
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Signature</span>
              <p class="text-gray-500">Drawn or typed signature</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Name</span>
              <p class="text-gray-500">Full name text input</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-purple-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Date Signed</span>
              <p class="text-gray-500">Auto-filled by system</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-gray-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Text</span>
              <p class="text-gray-500">Free-form text input</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-indigo-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Checkbox</span>
              <p class="text-gray-500">Yes/no selection</p>
            </div>
          </div>
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-orange-600 mt-0.5 flex-shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
            </svg>
            <div>
              <span class="font-medium text-gray-900">Initials</span>
              <p class="text-gray-500">Abbreviated signature</p>
            </div>
          </div>
        </div>
      </div>

      {# Fields List #}
      <div id="fields-container" class="space-y-3" role="list" aria-label="Agreement signing fields">
        {# Field template - cloned for each field #}
        <template id="field-template">
          <div class="field-entry p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-colors" data-field-index="" role="listitem">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Field Type <span class="text-red-500" aria-hidden="true">*</span>
                    <span class="sr-only">(required)</span>
                  </label>
                  <select
                    name="fields[].type"
                    required
                    aria-required="true"
                    aria-label="Field type"
                    class="field-type-select w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="signature">Signature</option>
                    <option value="name">Name</option>
                    <option value="date_signed">Date Signed</option>
                    <option value="text">Text</option>
                    <option value="checkbox">Checkbox</option>
                    <option value="initials">Initials</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Assigned To <span class="text-red-500" aria-hidden="true">*</span>
                    <span class="sr-only">(required)</span>
                  </label>
                  <select
                    name="fields[].recipient_index"
                    required
                    aria-required="true"
                    aria-label="Assign field to recipient"
                    class="field-recipient-select w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">Select signer...</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Page</label>
                  <input
                    type="number"
                    name="fields[].page"
                    min="1"
                    value="1"
                    aria-label="Page number for this field"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                </div>
                <div class="flex items-center gap-4">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="fields[].required" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700">Required</span>
                  </label>
                </div>
              </div>
              <button type="button" class="remove-field-btn p-2 text-gray-400 hover:text-red-600" aria-label="Remove this field">
                <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            {# Date Signed Info (shown conditionally) #}
            <div class="field-date-signed-info hidden mt-3 p-2 bg-purple-50 border border-purple-100 rounded text-xs text-purple-700" role="note">
              <svg class="w-3 h-3 inline-block mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <strong>Auto-filled:</strong> This field will be automatically populated with the signature date/time. Signers cannot edit this value.
            </div>
          </div>
        </template>

        {# Existing fields will be rendered here #}
      </div>

      {# Empty state #}
      <div id="fields-empty-state" class="{% if resource_item.fields and resource_item.fields|length > 0 %}hidden{% endif %} text-center py-8 border-2 border-dashed border-gray-200 rounded-lg">
        <svg class="mx-auto w-12 h-12 text-gray-300 mb-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <p class="text-sm text-gray-500 mb-2">No signing fields added yet</p>
        <p class="text-xs text-gray-400 mb-3">Add at least one signature field for each signer</p>
        <button type="button" id="add-field-empty-btn" class="text-sm text-blue-600 hover:text-blue-800">
          + Add your first field
        </button>
      </div>

      {# Validation note #}
      <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg" role="note" aria-label="Field requirement notice">
        <div class="flex items-start gap-2">
          <svg class="w-4 h-4 text-blue-600 mt-0.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <p class="text-xs text-blue-700">
            <strong>Before sending:</strong> Each signer must have at least one required signature field assigned. Date Signed fields are automatically filled when the signer completes their signature.
          </p>
        </div>
      </div>
    </div>

    {# Form Actions #}
    <div class="flex justify-end gap-3 pt-4">
      <a href="{{ routes.index }}" class="btn btn-secondary">Cancel</a>
      <button type="submit" id="submit-btn" class="btn btn-primary">
        {% if is_edit %}
          <i class="iconoir-save"></i>
          Save Changes
        {% else %}
          <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Create Agreement
        {% endif %}
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const basePath = '{{ base_path }}';
  const apiBase = '{{ api_base_path|default:basePath + "/api" }}';

  // Document Selection
  const documentIdInput = document.getElementById('document_id');
  const selectedDocument = document.getElementById('selected-document');
  const documentPicker = document.getElementById('document-picker');
  const documentSearch = document.getElementById('document-search');
  const documentList = document.getElementById('document-list');
  const changeDocumentBtn = document.getElementById('change-document-btn');
  const selectedDocumentTitle = document.getElementById('selected-document-title');
  const selectedDocumentInfo = document.getElementById('selected-document-info');

  let documents = [];

  async function loadDocuments() {
    try {
      const response = await fetch(`${apiBase}/esign_documents?per_page=100`, {
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' }
      });
      const data = await response.json();
      documents = data.records || data.items || [];
      renderDocumentList(documents);
    } catch (error) {
      documentList.innerHTML = '<div class="p-4 text-center text-red-500 text-sm">Failed to load documents</div>';
    }
  }

  function renderDocumentList(docs) {
    if (docs.length === 0) {
      documentList.innerHTML = `
        <div class="p-4 text-center text-gray-500 text-sm">
          No documents found.
          <a href="${basePath}/esign/documents/new" class="text-blue-600 hover:underline">Upload one</a>
        </div>
      `;
      return;
    }

    documentList.innerHTML = docs.map((doc, index) => `
      <button type="button" class="document-option w-full p-3 flex items-center gap-3 hover:bg-gray-50 border-b border-gray-100 last:border-0 text-left focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500"
              role="option"
              aria-selected="false"
              tabindex="${index === 0 ? '0' : '-1'}"
              data-document-id="${doc.id}"
              data-document-title="${escapeHtml(doc.title || 'Untitled')}"
              data-document-pages="${doc.page_count || 0}">
        <div class="w-8 h-8 rounded bg-red-100 flex items-center justify-center flex-shrink-0" aria-hidden="true">
          <svg class="w-4 h-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-medium text-gray-900 truncate">${escapeHtml(doc.title || 'Untitled')}</div>
          <div class="text-xs text-gray-500">${doc.page_count || 0} pages</div>
        </div>
      </button>
    `).join('');

    // Attach click and keyboard handlers
    const options = documentList.querySelectorAll('.document-option');
    options.forEach((btn, index) => {
      btn.addEventListener('click', () => selectDocument(btn));
      btn.addEventListener('keydown', (e) => {
        let nextIndex = index;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          nextIndex = Math.min(index + 1, options.length - 1);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          nextIndex = Math.max(index - 1, 0);
        } else if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectDocument(btn);
          return;
        } else if (e.key === 'Home') {
          e.preventDefault();
          nextIndex = 0;
        } else if (e.key === 'End') {
          e.preventDefault();
          nextIndex = options.length - 1;
        }
        if (nextIndex !== index) {
          options[nextIndex].focus();
          options[nextIndex].setAttribute('tabindex', '0');
          btn.setAttribute('tabindex', '-1');
        }
      });
    });
  }

  function selectDocument(btn) {
    const id = btn.getAttribute('data-document-id');
    const title = btn.getAttribute('data-document-title');
    const pages = btn.getAttribute('data-document-pages');

    documentIdInput.value = id;
    selectedDocumentTitle.textContent = title;
    selectedDocumentInfo.textContent = `${pages} pages`;

    selectedDocument.classList.remove('hidden');
    documentPicker.classList.add('hidden');
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  if (changeDocumentBtn) {
    changeDocumentBtn.addEventListener('click', () => {
      selectedDocument.classList.add('hidden');
      documentPicker.classList.remove('hidden');
    });
  }

  if (documentSearch) {
    documentSearch.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = documents.filter(doc =>
        (doc.title || '').toLowerCase().includes(term)
      );
      renderDocumentList(filtered);
    });
  }

  // Load documents on page load
  loadDocuments();

  // Recipients Management
  const recipientsContainer = document.getElementById('recipients-container');
  const recipientTemplate = document.getElementById('recipient-template');
  const addRecipientBtn = document.getElementById('add-recipient-btn');
  let recipientIndex = 0;

  function addRecipient(data = {}) {
    const clone = recipientTemplate.content.cloneNode(true);
    const entry = clone.querySelector('.recipient-entry');
    entry.setAttribute('data-recipient-index', recipientIndex);

    const nameInput = entry.querySelector('input[name="recipients[].name"]');
    const emailInput = entry.querySelector('input[name="recipients[].email"]');
    const roleSelect = entry.querySelector('select[name="recipients[].role"]');

    nameInput.name = `recipients[${recipientIndex}].name`;
    emailInput.name = `recipients[${recipientIndex}].email`;
    roleSelect.name = `recipients[${recipientIndex}].role`;

    if (data.name) nameInput.value = data.name;
    if (data.email) emailInput.value = data.email;
    if (data.role) roleSelect.value = data.role;

    entry.querySelector('.remove-recipient-btn').addEventListener('click', () => {
      entry.remove();
      enforceSignerConstraint();
    });

    roleSelect.addEventListener('change', enforceSignerConstraint);

    recipientsContainer.appendChild(clone);
    recipientIndex++;

    enforceSignerConstraint();
  }

  function enforceSignerConstraint() {
    // V1: Only one signer allowed
    const entries = recipientsContainer.querySelectorAll('.recipient-entry');
    let signerCount = 0;

    entries.forEach(entry => {
      const roleSelect = entry.querySelector('select[name*=".role"]');
      if (roleSelect.value === 'signer') {
        signerCount++;
      }
    });

    // If we have a signer, disable signer option on other entries
    entries.forEach(entry => {
      const roleSelect = entry.querySelector('select[name*=".role"]');
      const signerOption = roleSelect.querySelector('option[value="signer"]');
      if (roleSelect.value !== 'signer' && signerCount >= 1) {
        signerOption.disabled = true;
      } else {
        signerOption.disabled = false;
      }
    });
  }

  addRecipientBtn.addEventListener('click', () => addRecipient());

  // Initialize with existing recipients or add one empty
  {% if resource_item.recipients and resource_item.recipients|length > 0 %}
    {% for recipient in resource_item.recipients %}
    addRecipient({
      name: '{{ recipient.name|default:"" }}',
      email: '{{ recipient.email|default:"" }}',
      role: '{{ recipient.role|default:"signer" }}'
    });
    {% endfor %}
  {% else %}
    addRecipient();
  {% endif %}

  // Fields Management
  const fieldsContainer = document.getElementById('fields-container');
  const fieldTemplate = document.getElementById('field-template');
  const addFieldBtn = document.getElementById('add-field-btn');
  const addFieldEmptyBtn = document.getElementById('add-field-empty-btn');
  const fieldsEmptyState = document.getElementById('fields-empty-state');
  let fieldIndex = 0;

  function getSignerRecipients() {
    const entries = recipientsContainer.querySelectorAll('.recipient-entry');
    const signers = [];
    entries.forEach((entry, index) => {
      const roleSelect = entry.querySelector('select[name*=".role"]');
      const nameInput = entry.querySelector('input[name*=".name"]');
      const emailInput = entry.querySelector('input[name*=".email"]');
      if (roleSelect.value === 'signer') {
        signers.push({
          index: index,
          name: nameInput.value || emailInput.value || `Signer ${index + 1}`,
          email: emailInput.value
        });
      }
    });
    return signers;
  }

  function updateFieldRecipientOptions() {
    const signers = getSignerRecipients();
    const recipientSelects = fieldsContainer.querySelectorAll('.field-recipient-select');

    recipientSelects.forEach(select => {
      const currentValue = select.value;
      select.innerHTML = '<option value="">Select signer...</option>';
      signers.forEach(signer => {
        const option = document.createElement('option');
        option.value = signer.index;
        option.textContent = signer.name;
        select.appendChild(option);
      });
      // Restore selection if still valid
      if (currentValue && signers.some(s => s.index.toString() === currentValue)) {
        select.value = currentValue;
      }
    });
  }

  function addField(data = {}) {
    const clone = fieldTemplate.content.cloneNode(true);
    const entry = clone.querySelector('.field-entry');
    entry.setAttribute('data-field-index', fieldIndex);

    const typeSelect = entry.querySelector('select[name="fields[].type"]');
    const recipientSelect = entry.querySelector('select[name="fields[].recipient_index"]');
    const pageInput = entry.querySelector('input[name="fields[].page"]');
    const requiredCheckbox = entry.querySelector('input[name="fields[].required"]');
    const dateSignedInfo = entry.querySelector('.field-date-signed-info');

    typeSelect.name = `fields[${fieldIndex}].type`;
    recipientSelect.name = `fields[${fieldIndex}].recipient_index`;
    pageInput.name = `fields[${fieldIndex}].page`;
    requiredCheckbox.name = `fields[${fieldIndex}].required`;

    if (data.type) typeSelect.value = data.type;
    if (data.recipient_index !== undefined) recipientSelect.value = data.recipient_index;
    if (data.page) pageInput.value = data.page;
    if (data.required !== undefined) requiredCheckbox.checked = data.required;

    // Populate recipient options
    const signers = getSignerRecipients();
    recipientSelect.innerHTML = '<option value="">Select signer...</option>';
    signers.forEach(signer => {
      const option = document.createElement('option');
      option.value = signer.index;
      option.textContent = signer.name;
      recipientSelect.appendChild(option);
    });
    if (data.recipient_index !== undefined) {
      recipientSelect.value = data.recipient_index;
    }

    // Show date_signed info when that type is selected
    typeSelect.addEventListener('change', () => {
      if (typeSelect.value === 'date_signed') {
        dateSignedInfo.classList.remove('hidden');
      } else {
        dateSignedInfo.classList.add('hidden');
      }
    });
    // Initialize date_signed info visibility
    if (typeSelect.value === 'date_signed') {
      dateSignedInfo.classList.remove('hidden');
    }

    entry.querySelector('.remove-field-btn').addEventListener('click', () => {
      entry.remove();
      updateFieldsEmptyState();
    });

    fieldsContainer.appendChild(clone);
    fieldIndex++;
    updateFieldsEmptyState();
  }

  function updateFieldsEmptyState() {
    const fields = fieldsContainer.querySelectorAll('.field-entry');
    if (fields.length === 0) {
      fieldsEmptyState.classList.remove('hidden');
    } else {
      fieldsEmptyState.classList.add('hidden');
    }
  }

  // Watch for recipient changes to update field assignments
  const recipientObserver = new MutationObserver(() => {
    updateFieldRecipientOptions();
  });
  recipientObserver.observe(recipientsContainer, { childList: true, subtree: true });

  // Also update when role changes
  recipientsContainer.addEventListener('change', (e) => {
    if (e.target.matches('select[name*=".role"]') || e.target.matches('input[name*=".name"]') || e.target.matches('input[name*=".email"]')) {
      updateFieldRecipientOptions();
    }
  });
  recipientsContainer.addEventListener('input', (e) => {
    if (e.target.matches('input[name*=".name"]') || e.target.matches('input[name*=".email"]')) {
      updateFieldRecipientOptions();
    }
  });

  addFieldBtn.addEventListener('click', () => addField());
  addFieldEmptyBtn.addEventListener('click', () => addField());

  // Initialize with existing fields
  {% if resource_item.fields and resource_item.fields|length > 0 %}
    {% for field in resource_item.fields %}
    addField({
      type: '{{ field.type|default:"signature" }}',
      recipient_index: {{ field.recipient_index|default:0 }},
      page: {{ field.page|default:1 }},
      required: {% if field.required %}true{% else %}false{% endif %}
    });
    {% endfor %}
  {% endif %}
  updateFieldsEmptyState();

  // Form submission
  const form = document.getElementById('agreement-form');
  const submitBtn = document.getElementById('submit-btn');
  const formAnnouncements = document.getElementById('form-announcements');

  function announceError(message) {
    if (formAnnouncements) {
      formAnnouncements.textContent = message;
    }
    if (window.toastManager) {
      window.toastManager.error(message);
    } else {
      alert(message);
    }
  }

  form.addEventListener('submit', function(e) {
    // Validate document selected
    if (!documentIdInput.value) {
      e.preventDefault();
      announceError('Please select a document');
      documentSearch.focus();
      return;
    }

    // Validate at least one recipient
    const entries = recipientsContainer.querySelectorAll('.recipient-entry');
    if (entries.length === 0) {
      e.preventDefault();
      announceError('Please add at least one recipient');
      addRecipientBtn.focus();
      return;
    }

    // Validate at least one signer
    let hasSigners = false;
    entries.forEach(entry => {
      const roleSelect = entry.querySelector('select[name*=".role"]');
      if (roleSelect.value === 'signer') {
        hasSigners = true;
      }
    });

    if (!hasSigners) {
      e.preventDefault();
      announceError('At least one signer is required');
      const firstRoleSelect = entries[0]?.querySelector('select[name*=".role"]');
      if (firstRoleSelect) firstRoleSelect.focus();
      return;
    }

    // Validate fields: each signer should have at least one signature field
    const fieldEntries = fieldsContainer.querySelectorAll('.field-entry');
    const signerSignatureFields = new Map(); // recipientIndex -> hasSignatureField

    // Initialize all signers as having no signature field
    entries.forEach((entry, index) => {
      const roleSelect = entry.querySelector('select[name*=".role"]');
      if (roleSelect.value === 'signer') {
        signerSignatureFields.set(index.toString(), false);
      }
    });

    // Check fields for signature assignments
    fieldEntries.forEach(field => {
      const typeSelect = field.querySelector('.field-type-select');
      const recipientSelect = field.querySelector('.field-recipient-select');
      const requiredCheckbox = field.querySelector('input[name*=".required"]');
      if (typeSelect.value === 'signature' && recipientSelect.value && requiredCheckbox.checked) {
        signerSignatureFields.set(recipientSelect.value, true);
      }
    });

    // Check if any signer is missing a signature field
    let missingSignatureField = false;
    signerSignatureFields.forEach((hasField, recipientIndex) => {
      if (!hasField) {
        missingSignatureField = true;
      }
    });

    if (missingSignatureField && fieldEntries.length > 0) {
      // Only warn, don't block - fields can be added later in draft state
      console.warn('Some signers do not have a required signature field assigned');
    }

    // Validate that all field recipient assignments are valid
    let invalidFieldAssignment = false;
    fieldEntries.forEach(field => {
      const recipientSelect = field.querySelector('.field-recipient-select');
      if (!recipientSelect.value) {
        invalidFieldAssignment = true;
      }
    });

    if (invalidFieldAssignment) {
      e.preventDefault();
      announceError('Please assign all fields to a signer');
      const firstUnassigned = fieldsContainer.querySelector('.field-recipient-select:invalid, .field-recipient-select[value=""]');
      if (firstUnassigned) firstUnassigned.focus();
      return;
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <svg class="animate-spin w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Saving...
    `;
  });
});
</script>
{% endblock %}
