{% extends "resources/shared/detail-base.html" %}

{% set avatar_type = "agreement" %}

{% block header_pretitle %}
  <p class="text-sm text-gray-500 mb-1">E-Sign Agreement</p>
{% endblock %}

{% block header_title %}{{ resource_item.title|default:"Agreement" }}{% endblock %}

{% block header_actions %}
  {% block header_actions_prepend %}{% endblock %}
  {# Status-dependent actions #}
  {% set status = resource_item.status|lower %}
  {% if status == "draft" %}
    <button type="button" class="btn btn-primary" data-action="send" data-agreement-id="{{ resource_item.id }}"
            aria-label="Send agreement for signature" title="Send this agreement to recipients for signing">
      <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
      </svg>
      Send for Signature
    </button>
    {% if resource_item.actions.edit %}
      <a href="{{ resource_item.actions.edit }}" class="btn btn-secondary" aria-label="Edit agreement details">
        <i class="iconoir-edit-pencil" aria-hidden="true"></i>
        Edit
      </a>
    {% endif %}
  {% elif status == "sent" or status == "in_progress" %}
    <button type="button" class="btn btn-warning" data-action="resend" data-agreement-id="{{ resource_item.id }}"
            aria-label="Resend signing invitation" title="Resend signing request to pending recipients">
      <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
      Resend
    </button>
    <button type="button" class="btn btn-danger" data-action="void" data-agreement-id="{{ resource_item.id }}"
            aria-label="Void this agreement" title="Cancel this agreement and prevent further signing">
      <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
      Void
    </button>
  {% elif status == "completed" %}
    <button type="button" class="btn btn-primary" data-action="download-executed" data-agreement-id="{{ resource_item.id }}"
            aria-label="Download executed PDF" title="Download the fully signed document">
      <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      Download Executed PDF
    </button>
  {% endif %}
  {% if routes.index %}
    <a href="{{ routes.index }}" class="btn btn-secondary" aria-label="Return to agreements list">
      <i class="iconoir-arrow-left" aria-hidden="true"></i>
      Back to Agreements
    </a>
  {% endif %}
  {% block header_actions_append %}{% endblock %}
{% endblock %}

{% block identity_avatar %}
  {% set status = resource_item.status|lower %}
  {% if status == "completed" %}
  <div class="w-14 h-14 rounded-lg bg-green-100 flex items-center justify-center">
    <svg class="w-8 h-8 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
  </div>
  {% elif status == "voided" or status == "declined" %}
  <div class="w-14 h-14 rounded-lg bg-red-100 flex items-center justify-center">
    <svg class="w-8 h-8 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
  </div>
  {% elif status == "expired" %}
  <div class="w-14 h-14 rounded-lg bg-purple-100 flex items-center justify-center">
    <svg class="w-8 h-8 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
  </div>
  {% elif status == "sent" or status == "in_progress" %}
  <div class="w-14 h-14 rounded-lg bg-blue-100 flex items-center justify-center">
    <svg class="w-8 h-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
    </svg>
  </div>
  {% else %}
  <div class="w-14 h-14 rounded-lg bg-gray-100 flex items-center justify-center">
    <svg class="w-8 h-8 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
    </svg>
  </div>
  {% endif %}
{% endblock %}

{% block identity_title %}{{ resource_item.title|default:"Untitled Agreement" }}{% endblock %}

{% block identity_subtitle %}
  <div class="flex items-center gap-3 text-sm text-gray-500">
    {% if resource_item.recipient_count %}
      <span class="inline-flex items-center gap-1">
        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        {{ resource_item.recipient_count }} recipient{% if resource_item.recipient_count != 1 %}s{% endif %}
      </span>
    {% endif %}
    {% if resource_item.document_id %}
      <span class="inline-flex items-center gap-1">
        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
        </svg>
        <span class="truncate max-w-[150px]">{{ resource_item.document_title|default:"Linked Document" }}</span>
      </span>
    {% endif %}
  </div>
{% endblock %}

{% block identity_status %}
  {% set status = resource_item.status|lower %}
  {% if status == "draft" %}
    <span role="status" aria-label="Agreement status: Draft" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
      <span class="w-1.5 h-1.5 rounded-full bg-gray-400" aria-hidden="true"></span>
      Draft
    </span>
  {% elif status == "sent" %}
    <span role="status" aria-label="Agreement status: Sent" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
      <span class="w-1.5 h-1.5 rounded-full bg-blue-500" aria-hidden="true"></span>
      Sent
    </span>
  {% elif status == "in_progress" %}
    <span role="status" aria-label="Agreement status: In Progress" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">
      <span class="w-1.5 h-1.5 rounded-full bg-yellow-500" aria-hidden="true"></span>
      In Progress
    </span>
  {% elif status == "completed" %}
    <span role="status" aria-label="Agreement status: Completed" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
      <span class="w-1.5 h-1.5 rounded-full bg-green-500" aria-hidden="true"></span>
      Completed
    </span>
  {% elif status == "voided" %}
    <span role="status" aria-label="Agreement status: Voided" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">
      <span class="w-1.5 h-1.5 rounded-full bg-red-500" aria-hidden="true"></span>
      Voided
    </span>
  {% elif status == "declined" %}
    <span role="status" aria-label="Agreement status: Declined" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700">
      <span class="w-1.5 h-1.5 rounded-full bg-orange-500" aria-hidden="true"></span>
      Declined
    </span>
  {% elif status == "expired" %}
    <span role="status" aria-label="Agreement status: Expired" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
      <span class="w-1.5 h-1.5 rounded-full bg-purple-500" aria-hidden="true"></span>
      Expired
    </span>
  {% else %}
    <span role="status" aria-label="Agreement status: {{ resource_item.status|title }}" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
      <span class="w-1.5 h-1.5 rounded-full bg-gray-400" aria-hidden="true"></span>
      {{ resource_item.status|title }}
    </span>
  {% endif %}
{% endblock %}

{% block fields_section %}
<div class="p-6">
  <div class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-4">Agreement Details</div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="flex flex-col">
      <div class="text-sm text-gray-500 mb-1">Agreement ID</div>
      <div class="text-base font-mono text-gray-900 break-all">{{ resource_item.id|default:"-" }}</div>
    </div>

    <div class="flex flex-col">
      <div class="text-sm text-gray-500 mb-1">Document</div>
      <div class="text-base text-gray-900">
        {% if resource_item.document_id %}
          {# Use pre-resolved URL if available, otherwise build from base_path #}
          {% set document_link = resource_item.document_url|default:base_path + "/esign-documents/" + resource_item.document_id %}
          <a href="{{ document_link }}" class="text-blue-600 hover:underline">
            {{ resource_item.document_title|default:resource_item.document_id }}
          </a>
        {% else %}
          -
        {% endif %}
      </div>
    </div>

    <div class="flex flex-col">
      <div class="text-sm text-gray-500 mb-1">Created</div>
      <div class="text-base text-gray-900" id="agreement-created-at" data-timestamp="{{ resource_item.created_at }}">
        {{ resource_item.created_at|default:"-" }}
      </div>
    </div>

    <div class="flex flex-col">
      <div class="text-sm text-gray-500 mb-1">Last Updated</div>
      <div class="text-base text-gray-900" id="agreement-updated-at" data-timestamp="{{ resource_item.updated_at }}">
        {{ resource_item.updated_at|default:"-" }}
      </div>
    </div>

    {% if resource_item.sent_at %}
    <div class="flex flex-col">
      <div class="text-sm text-gray-500 mb-1">Sent</div>
      <div class="text-base text-gray-900" id="agreement-sent-at" data-timestamp="{{ resource_item.sent_at }}">
        {{ resource_item.sent_at }}
      </div>
    </div>
    {% endif %}

    {% if resource_item.completed_at %}
    <div class="flex flex-col">
      <div class="text-sm text-gray-500 mb-1">Completed</div>
      <div class="text-base text-gray-900" id="agreement-completed-at" data-timestamp="{{ resource_item.completed_at }}">
        {{ resource_item.completed_at }}
      </div>
    </div>
    {% endif %}

    {% if resource_item.voided_at %}
    <div class="flex flex-col">
      <div class="text-sm text-gray-500 mb-1">Voided</div>
      <div class="text-base text-gray-900" id="agreement-voided-at" data-timestamp="{{ resource_item.voided_at }}">
        {{ resource_item.voided_at }}
      </div>
    </div>
    {% endif %}

    {% if resource_item.declined_at %}
    <div class="flex flex-col">
      <div class="text-sm text-gray-500 mb-1">Declined</div>
      <div class="text-base text-gray-900" id="agreement-declined-at" data-timestamp="{{ resource_item.declined_at }}">
        {{ resource_item.declined_at }}
      </div>
    </div>
    {% endif %}
  </div>

  {% if resource_item.message %}
  <div class="mt-6 pt-6 border-t border-gray-100">
    <div class="text-sm text-gray-500 mb-2">Message to Recipients</div>
    <div class="text-gray-700 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{{ resource_item.message }}</div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_sections %}
{# Recipients Section #}
{% if resource_item.recipients and resource_item.recipients|length > 0 %}
<div class="p-6 border-t border-gray-200">
  <div class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-4">Recipients</div>
  <div class="space-y-3">
    {% for recipient in resource_item.recipients %}
    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">
          {{ recipient.name|default:recipient.email|slice:"0:1"|upper }}
        </div>
        <div>
          <div class="font-medium text-gray-900">{{ recipient.name|default:recipient.email }}</div>
          <div class="text-sm text-gray-500">{{ recipient.email }}</div>
        </div>
        {% if recipient.role == "cc" %}
        <span class="ml-2 px-2 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-600">CC</span>
        {% endif %}
      </div>
      <div class="flex items-center gap-2">
        {% set rstatus = recipient.status|lower %}
        {% if rstatus == "pending" %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
            <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
            Pending
          </span>
        {% elif rstatus == "signed" or rstatus == "completed" %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
            Signed
          </span>
        {% elif rstatus == "declined" %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">
            <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span>
            Declined
          </span>
        {% elif rstatus == "delivered" %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
            Delivered
          </span>
        {% else %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
            {{ recipient.status|default:"Pending"|title }}
          </span>
        {% endif %}
        {# Action buttons for active recipients #}
        {% set status = resource_item.status|lower %}
        {% if (status == "sent" or status == "in_progress") and recipient.role != "cc" %}
          <button type="button" class="text-sm text-blue-600 hover:text-blue-800"
                  data-action="resend-recipient" data-recipient-id="{{ recipient.id }}"
                  aria-label="Resend signing invitation to {{ recipient.name|default:recipient.email }}"
                  title="Resend signing request to this recipient">
            Resend
          </button>
          <button type="button" class="text-sm text-gray-600 hover:text-gray-800"
                  data-action="rotate-token" data-recipient-id="{{ recipient.id }}"
                  aria-label="Rotate signing token for {{ recipient.name|default:recipient.email }}"
                  title="Generate a new signing link for this recipient">
            Rotate Token
          </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{# Void Reason (if voided) #}
{% set status = resource_item.status|lower %}
{% if status == "voided" and resource_item.void_reason %}
<div class="p-6 border-t border-gray-200 bg-red-50">
  <div class="flex items-start gap-3">
    <div class="flex-shrink-0">
      <svg class="w-5 h-5 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
    </div>
    <div>
      <h4 class="text-sm font-medium text-red-800">Void Reason</h4>
      <p class="text-sm text-red-700 mt-1">{{ resource_item.void_reason }}</p>
    </div>
  </div>
</div>
{% endif %}

{# Decline Reason (if declined) #}
{% if status == "declined" and resource_item.decline_reason %}
<div class="p-6 border-t border-gray-200 bg-orange-50">
  <div class="flex items-start gap-3">
    <div class="flex-shrink-0">
      <svg class="w-5 h-5 text-orange-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
    </div>
    <div>
      <h4 class="text-sm font-medium text-orange-800">Decline Reason</h4>
      <p class="text-sm text-orange-700 mt-1">{{ resource_item.decline_reason }}</p>
      {% if resource_item.declined_by %}
        <p class="text-xs text-orange-600 mt-1">Declined by: {{ resource_item.declined_by }}</p>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

{# Agreement Timeline Section #}
<div class="p-6 border-t border-gray-200">
  <div class="flex items-center justify-between mb-4">
    <div class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Activity Timeline</div>
    <button type="button" id="timeline-refresh" class="text-sm text-blue-600 hover:text-blue-800 inline-flex items-center gap-1"
            aria-label="Refresh timeline">
      <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
      Refresh
    </button>
  </div>
  <div id="agreement-timeline" class="relative" role="list" aria-label="Agreement activity timeline">
    <div class="timeline-loading flex items-center justify-center gap-3 py-8 text-gray-500">
      <div class="w-5 h-5 border-2 border-gray-300 border-t-blue-500 rounded-full animate-spin"></div>
      <span>Loading timeline...</span>
    </div>
  </div>
</div>

{# Recipient Status Progression Section #}
{% if resource_item.recipients and resource_item.recipients|length > 0 %}
<div class="p-6 border-t border-gray-200">
  <div class="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-4">Recipient Progress</div>
  <div class="space-y-4" id="recipient-progress" role="list" aria-label="Recipient signing progress">
    {% for recipient in resource_item.recipients %}
    <div class="bg-gray-50 rounded-lg p-4" role="listitem">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-sm font-medium text-blue-700">
            {{ recipient.name|default:recipient.email|slice:"0:1"|upper }}
          </div>
          <div>
            <div class="font-medium text-gray-900 text-sm">{{ recipient.name|default:recipient.email }}</div>
            <div class="text-xs text-gray-500">{{ recipient.email }}</div>
          </div>
          {% if recipient.role == "cc" %}
          <span class="px-2 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-600">CC</span>
          {% endif %}
        </div>
        {% set rstatus = recipient.status|lower %}
        {% if rstatus == "pending" %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600" role="status">
            <span class="w-1.5 h-1.5 rounded-full bg-gray-400" aria-hidden="true"></span>
            Pending
          </span>
        {% elif rstatus == "signed" or rstatus == "completed" %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700" role="status">
            <span class="w-1.5 h-1.5 rounded-full bg-green-500" aria-hidden="true"></span>
            Signed
          </span>
        {% elif rstatus == "declined" %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700" role="status">
            <span class="w-1.5 h-1.5 rounded-full bg-red-500" aria-hidden="true"></span>
            Declined
          </span>
        {% elif rstatus == "delivered" %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700" role="status">
            <span class="w-1.5 h-1.5 rounded-full bg-blue-500" aria-hidden="true"></span>
            Delivered
          </span>
        {% elif rstatus == "viewed" %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700" role="status">
            <span class="w-1.5 h-1.5 rounded-full bg-purple-500" aria-hidden="true"></span>
            Viewed
          </span>
        {% else %}
          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600" role="status">
            {{ recipient.status|default:"Pending"|title }}
          </span>
        {% endif %}
      </div>
      {# Recipient timeline milestones #}
      <div class="flex items-center gap-1 mt-2" role="list" aria-label="Recipient milestones for {{ recipient.name|default:recipient.email }}">
        {# Sent milestone #}
        <div class="flex-1">
          <div class="flex items-center gap-2">
            {% if recipient.sent_at or resource_item.sent_at %}
            <div class="w-4 h-4 rounded-full bg-blue-500 flex items-center justify-center" aria-hidden="true">
              <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            </div>
            {% else %}
            <div class="w-4 h-4 rounded-full bg-gray-200" aria-hidden="true"></div>
            {% endif %}
            <div class="h-0.5 flex-1 {% if recipient.sent_at or resource_item.sent_at %}bg-blue-500{% else %}bg-gray-200{% endif %}"></div>
          </div>
          <div class="mt-1 text-xs text-gray-500">
            <div class="font-medium">Sent</div>
            {% if recipient.sent_at %}
            <div data-timestamp="{{ recipient.sent_at }}" class="recipient-timestamp">{{ recipient.sent_at }}</div>
            {% elif resource_item.sent_at %}
            <div data-timestamp="{{ resource_item.sent_at }}" class="recipient-timestamp">{{ resource_item.sent_at }}</div>
            {% endif %}
          </div>
        </div>
        {# Viewed milestone (only for signers) #}
        {% if recipient.role != "cc" %}
        <div class="flex-1">
          <div class="flex items-center gap-2">
            {% if recipient.first_view_at %}
            <div class="w-4 h-4 rounded-full bg-purple-500 flex items-center justify-center" aria-hidden="true">
              <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            </div>
            {% else %}
            <div class="w-4 h-4 rounded-full bg-gray-200" aria-hidden="true"></div>
            {% endif %}
            <div class="h-0.5 flex-1 {% if recipient.first_view_at %}bg-purple-500{% else %}bg-gray-200{% endif %}"></div>
          </div>
          <div class="mt-1 text-xs text-gray-500">
            <div class="font-medium">Viewed</div>
            {% if recipient.first_view_at %}
            <div data-timestamp="{{ recipient.first_view_at }}" class="recipient-timestamp">{{ recipient.first_view_at }}</div>
            {% endif %}
          </div>
        </div>
        {# Signed milestone #}
        <div class="flex-1">
          <div class="flex items-center gap-2">
            {% if recipient.signed_at or recipient.status|lower == "signed" or recipient.status|lower == "completed" %}
            <div class="w-4 h-4 rounded-full bg-green-500 flex items-center justify-center" aria-hidden="true">
              <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            </div>
            {% elif recipient.status|lower == "declined" %}
            <div class="w-4 h-4 rounded-full bg-red-500 flex items-center justify-center" aria-hidden="true">
              <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            </div>
            {% else %}
            <div class="w-4 h-4 rounded-full bg-gray-200" aria-hidden="true"></div>
            {% endif %}
            <div class="h-0.5 flex-1 {% if recipient.signed_at or recipient.status|lower == "signed" or recipient.status|lower == "completed" %}bg-green-500{% elif recipient.status|lower == "declined" %}bg-red-500{% else %}bg-gray-200{% endif %}"></div>
          </div>
          <div class="mt-1 text-xs text-gray-500">
            <div class="font-medium">{% if recipient.status|lower == "declined" %}Declined{% else %}Signed{% endif %}</div>
            {% if recipient.signed_at %}
            <div data-timestamp="{{ recipient.signed_at }}" class="recipient-timestamp">{{ recipient.signed_at }}</div>
            {% elif recipient.declined_at %}
            <div data-timestamp="{{ recipient.declined_at }}" class="recipient-timestamp">{{ recipient.declined_at }}</div>
            {% endif %}
          </div>
        </div>
        {% endif %}
        {# Delivered milestone (for CC recipients) #}
        {% if recipient.role == "cc" %}
        <div class="flex-1">
          <div class="flex items-center gap-2">
            {% if recipient.delivered_at or recipient.status|lower == "delivered" %}
            <div class="w-4 h-4 rounded-full bg-green-500 flex items-center justify-center" aria-hidden="true">
              <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            </div>
            {% else %}
            <div class="w-4 h-4 rounded-full bg-gray-200" aria-hidden="true"></div>
            {% endif %}
            <div class="h-0.5 flex-1 bg-transparent"></div>
          </div>
          <div class="mt-1 text-xs text-gray-500">
            <div class="font-medium">Delivered</div>
            {% if recipient.delivered_at %}
            <div data-timestamp="{{ recipient.delivered_at }}" class="recipient-timestamp">{{ recipient.delivered_at }}</div>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{# Delivery Status Section - Job/Email failures and retry actions #}
{% set status = resource_item.status|lower %}
{% if status != "draft" %}
<div class="p-6 border-t border-gray-200">
  <div class="flex items-center justify-between mb-4">
    <div class="text-xs uppercase tracking-wider text-gray-500 font-semibold">Delivery Status</div>
    <button type="button" id="delivery-refresh" class="text-sm text-blue-600 hover:text-blue-800 inline-flex items-center gap-1"
            aria-label="Refresh delivery status">
      <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
      Refresh
    </button>
  </div>

  <div id="delivery-status-container" class="space-y-4" role="list" aria-label="Delivery status and job information">
    {# Email Delivery Status #}
    {% if resource_item.email_logs and resource_item.email_logs|length > 0 %}
    <div class="bg-gray-50 rounded-lg p-4">
      <div class="flex items-center gap-2 mb-3">
        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
        <span class="font-medium text-gray-700">Email Notifications</span>
      </div>
      <div class="space-y-2">
        {% for email in resource_item.email_logs %}
        <div class="flex items-center justify-between bg-white rounded border border-gray-200 p-3">
          <div class="flex items-center gap-3">
            {% set email_status = email.status|lower %}
            {% if email_status == "sent" or email_status == "delivered" %}
            <span class="w-2 h-2 rounded-full bg-green-500" aria-hidden="true"></span>
            {% elif email_status == "failed" or email_status == "bounced" %}
            <span class="w-2 h-2 rounded-full bg-red-500" aria-hidden="true"></span>
            {% elif email_status == "pending" or email_status == "queued" %}
            <span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse" aria-hidden="true"></span>
            {% elif email_status == "retrying" %}
            <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse" aria-hidden="true"></span>
            {% else %}
            <span class="w-2 h-2 rounded-full bg-gray-400" aria-hidden="true"></span>
            {% endif %}
            <div>
              <div class="text-sm font-medium text-gray-900">{{ email.recipient_email|default:email.to }}</div>
              <div class="text-xs text-gray-500">
                {{ email.type|default:"Signing Request"|title }}
                {% if email.sent_at %}
                <span class="ml-1" data-timestamp="{{ email.sent_at }}">{{ email.sent_at }}</span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            {% if email_status == "sent" or email_status == "delivered" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700" role="status">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              {{ email_status|title }}
            </span>
            {% elif email_status == "failed" or email_status == "bounced" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700" role="status">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
              Failed
            </span>
            <button type="button" class="btn btn-sm btn-warning" data-action="retry-email" data-email-id="{{ email.id }}" data-recipient-id="{{ email.recipient_id }}"
                    aria-label="Retry sending email to {{ email.recipient_email|default:email.to }}" title="Retry sending this email">
              <svg class="w-3 h-3 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              Retry
            </button>
            {% elif email_status == "retrying" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-orange-100 text-orange-700" role="status">
              <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Retrying ({{ email.retry_count|default:0 }}/{{ email.max_retries|default:3 }})
            </span>
            {% elif email_status == "pending" or email_status == "queued" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700" role="status">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
              </svg>
              Pending
            </span>
            {% else %}
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600" role="status">
              {{ email_status|title }}
            </span>
            {% endif %}
          </div>
        </div>
        {% if email.error_message %}
        <div class="ml-5 text-xs text-red-600 bg-red-50 rounded p-2 border border-red-100">
          <span class="font-medium">Error:</span> {{ email.error_message }}
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {# Job/Artifact Status #}
    {% if resource_item.jobs and resource_item.jobs|length > 0 %}
    <div class="bg-gray-50 rounded-lg p-4">
      <div class="flex items-center gap-2 mb-3">
        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
        </svg>
        <span class="font-medium text-gray-700">Processing Jobs</span>
      </div>
      <div class="space-y-2">
        {% for job in resource_item.jobs %}
        <div class="flex items-center justify-between bg-white rounded border border-gray-200 p-3">
          <div class="flex items-center gap-3">
            {% set job_status = job.status|lower %}
            {% if job_status == "completed" or job_status == "success" %}
            <span class="w-2 h-2 rounded-full bg-green-500" aria-hidden="true"></span>
            {% elif job_status == "failed" or job_status == "error" %}
            <span class="w-2 h-2 rounded-full bg-red-500" aria-hidden="true"></span>
            {% elif job_status == "running" or job_status == "processing" %}
            <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse" aria-hidden="true"></span>
            {% elif job_status == "pending" or job_status == "queued" %}
            <span class="w-2 h-2 rounded-full bg-yellow-500" aria-hidden="true"></span>
            {% elif job_status == "retrying" %}
            <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse" aria-hidden="true"></span>
            {% else %}
            <span class="w-2 h-2 rounded-full bg-gray-400" aria-hidden="true"></span>
            {% endif %}
            <div>
              <div class="text-sm font-medium text-gray-900">{{ job.name|default:job.type|title }}</div>
              <div class="text-xs text-gray-500">
                {% if job.completed_at %}
                Completed <span data-timestamp="{{ job.completed_at }}">{{ job.completed_at }}</span>
                {% elif job.started_at %}
                Started <span data-timestamp="{{ job.started_at }}">{{ job.started_at }}</span>
                {% elif job.created_at %}
                Created <span data-timestamp="{{ job.created_at }}">{{ job.created_at }}</span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            {% if job_status == "completed" or job_status == "success" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700" role="status">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              Completed
            </span>
            {% elif job_status == "failed" or job_status == "error" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700" role="status">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
              Failed
            </span>
            <button type="button" class="btn btn-sm btn-warning" data-action="retry-job" data-job-id="{{ job.id }}" data-job-type="{{ job.type }}"
                    aria-label="Retry {{ job.name|default:job.type|title }}" title="Retry this job">
              <svg class="w-3 h-3 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              Retry
            </button>
            {% elif job_status == "running" or job_status == "processing" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700" role="status">
              <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Processing
            </span>
            {% elif job_status == "retrying" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-orange-100 text-orange-700" role="status">
              <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Retrying ({{ job.retry_count|default:0 }}/{{ job.max_retries|default:3 }})
            </span>
            {% elif job_status == "pending" or job_status == "queued" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700" role="status">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
              </svg>
              Pending
            </span>
            {% else %}
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600" role="status">
              {{ job_status|title }}
            </span>
            {% endif %}
          </div>
        </div>
        {% if job.error_message %}
        <div class="ml-5 text-xs text-red-600 bg-red-50 rounded p-2 border border-red-100">
          <span class="font-medium">Error:</span> {{ job.error_message }}
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {# Artifact Generation Status #}
    {% if resource_item.artifacts %}
    <div class="bg-gray-50 rounded-lg p-4">
      <div class="flex items-center gap-2 mb-3">
        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <span class="font-medium text-gray-700">Generated Artifacts</span>
      </div>
      <div class="space-y-2">
        {# Executed PDF #}
        {% if resource_item.artifacts.executed %}
        <div class="flex items-center justify-between bg-white rounded border border-gray-200 p-3">
          <div class="flex items-center gap-3">
            {% set executed = resource_item.artifacts.executed %}
            {% if executed.status|lower == "ready" or executed.object_key %}
            <span class="w-2 h-2 rounded-full bg-green-500" aria-hidden="true"></span>
            {% elif executed.status|lower == "failed" %}
            <span class="w-2 h-2 rounded-full bg-red-500" aria-hidden="true"></span>
            {% elif executed.status|lower == "pending" or executed.status|lower == "generating" %}
            <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse" aria-hidden="true"></span>
            {% else %}
            <span class="w-2 h-2 rounded-full bg-gray-400" aria-hidden="true"></span>
            {% endif %}
            <div>
              <div class="text-sm font-medium text-gray-900">Executed PDF</div>
              <div class="text-xs text-gray-500">
                {% if executed.sha256 %}
                SHA256: <span class="font-mono">{{ executed.sha256|slice:"0:16" }}...</span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            {% if executed.status|lower == "ready" or executed.object_key %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700" role="status">
              Ready
            </span>
            <button type="button" class="btn btn-sm btn-primary" data-action="download-executed" data-agreement-id="{{ resource_item.id }}"
                    aria-label="Download executed PDF" title="Download the signed document">
              <svg class="w-3 h-3 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Download
            </button>
            {% elif executed.status|lower == "failed" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700" role="status">
              Failed
            </span>
            <button type="button" class="btn btn-sm btn-warning" data-action="retry-artifact" data-artifact-type="executed"
                    aria-label="Retry generating executed PDF" title="Retry artifact generation">
              <svg class="w-3 h-3 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              Retry
            </button>
            {% elif executed.status|lower == "pending" or executed.status|lower == "generating" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700" role="status">
              <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Generating
            </span>
            {% endif %}
          </div>
        </div>
        {% endif %}
        {# Certificate #}
        {% if resource_item.artifacts.certificate %}
        <div class="flex items-center justify-between bg-white rounded border border-gray-200 p-3">
          <div class="flex items-center gap-3">
            {% set cert = resource_item.artifacts.certificate %}
            {% if cert.status|lower == "ready" or cert.object_key %}
            <span class="w-2 h-2 rounded-full bg-green-500" aria-hidden="true"></span>
            {% elif cert.status|lower == "failed" %}
            <span class="w-2 h-2 rounded-full bg-red-500" aria-hidden="true"></span>
            {% elif cert.status|lower == "pending" or cert.status|lower == "generating" %}
            <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse" aria-hidden="true"></span>
            {% else %}
            <span class="w-2 h-2 rounded-full bg-gray-400" aria-hidden="true"></span>
            {% endif %}
            <div>
              <div class="text-sm font-medium text-gray-900">Signing Certificate</div>
              <div class="text-xs text-gray-500">
                {% if cert.timeline_hash %}
                Hash: <span class="font-mono">{{ cert.timeline_hash|slice:"0:16" }}...</span>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            {% if cert.status|lower == "ready" or cert.object_key %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700" role="status">
              Ready
            </span>
            <button type="button" class="btn btn-sm btn-secondary" data-action="download-certificate" data-agreement-id="{{ resource_item.id }}"
                    aria-label="Download signing certificate" title="Download the signing certificate">
              <svg class="w-3 h-3 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Download
            </button>
            {% elif cert.status|lower == "failed" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700" role="status">
              Failed
            </span>
            <button type="button" class="btn btn-sm btn-warning" data-action="retry-artifact" data-artifact-type="certificate"
                    aria-label="Retry generating certificate" title="Retry certificate generation">
              <svg class="w-3 h-3 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              Retry
            </button>
            {% elif cert.status|lower == "pending" or cert.status|lower == "generating" %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700" role="status">
              <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Generating
            </span>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {# Empty state when no delivery data available #}
    {% if not resource_item.email_logs and not resource_item.jobs and not resource_item.artifacts %}
    <div class="text-center py-6 text-gray-500">
      <svg class="w-10 h-10 mx-auto mb-2 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <p class="text-sm">No delivery information available</p>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}

{% block detail_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Format timestamps
  function formatTimestamp(ts) {
    if (!ts) return '-';
    try {
      const date = new Date(ts);
      return date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } catch {
      return ts;
    }
  }

  // Format relative time
  function formatRelativeTime(ts) {
    if (!ts) return '';
    try {
      const date = new Date(ts);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return formatTimestamp(ts);
    } catch {
      return ts;
    }
  }

  // Format all timestamp elements
  document.querySelectorAll('[data-timestamp]').forEach(el => {
    const ts = el.getAttribute('data-timestamp');
    if (ts) {
      el.textContent = formatTimestamp(ts);
    }
  });

  // Format recipient timestamps
  document.querySelectorAll('.recipient-timestamp').forEach(el => {
    const ts = el.getAttribute('data-timestamp');
    if (ts) {
      el.textContent = formatRelativeTime(ts);
    }
  });

  // Action handlers
  const basePath = '{{ base_path }}';
  const apiBase = '{{ api_base_path|default:"" }}' || `${basePath}/api`;
  const agreementId = '{{ resource_item.id }}';
  const panelName = '{{ panel_name|default:"esign_agreements" }}';

  async function executeAction(action, payload = {}) {
    const endpoint = `${apiBase}/${panelName}/actions/${action}`;
    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ id: agreementId, ...payload })
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error?.message || data.message || `Action failed: ${response.status}`);
      }

      if (window.toastManager) {
        window.toastManager.success(`${action} completed successfully`);
      }
      window.location.reload();
    } catch (error) {
      if (window.toastManager) {
        window.toastManager.error(error.message || `${action} failed`);
      } else {
        alert(error.message || `${action} failed`);
      }
    }
  }

  // Send action
  document.querySelectorAll('[data-action="send"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const idempotencyKey = `send-${agreementId}-${Date.now()}`;
      await executeAction('send', { idempotency_key: idempotencyKey });
    });
  });

  // Void action
  document.querySelectorAll('[data-action="void"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const reason = prompt('Enter reason for voiding this agreement:');
      if (reason === null) return;
      if (!reason.trim()) {
        if (window.toastManager) {
          window.toastManager.error('Void reason is required');
        } else {
          alert('Void reason is required');
        }
        return;
      }
      await executeAction('void', { reason: reason.trim() });
    });
  });

  // Resend action
  document.querySelectorAll('[data-action="resend"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (window.toastManager) {
        const confirmed = await window.toastManager.confirm(
          'Resend signing request to all pending recipients?',
          { title: 'Resend Agreement', confirmText: 'Resend', cancelText: 'Cancel' }
        );
        if (!confirmed) return;
      } else if (!confirm('Resend signing request to all pending recipients?')) {
        return;
      }
      await executeAction('resend', {});
    });
  });

  // Per-recipient resend
  document.querySelectorAll('[data-action="resend-recipient"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const recipientId = btn.getAttribute('data-recipient-id');
      await executeAction('resend', { recipient_id: recipientId });
    });
  });

  // Rotate token
  document.querySelectorAll('[data-action="rotate-token"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const recipientId = btn.getAttribute('data-recipient-id');
      await executeAction('rotate_token', { recipient_id: recipientId });
    });
  });

  // Download executed PDF
  document.querySelectorAll('[data-action="download-executed"]').forEach(btn => {
    btn.addEventListener('click', () => {
      window.location.href = `${apiBase}/${panelName}/${agreementId}/artifact/executed`;
    });
  });

  // Download certificate
  document.querySelectorAll('[data-action="download-certificate"]').forEach(btn => {
    btn.addEventListener('click', () => {
      window.location.href = `${apiBase}/${panelName}/${agreementId}/artifact/certificate`;
    });
  });

  // Retry email action
  document.querySelectorAll('[data-action="retry-email"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const emailId = btn.getAttribute('data-email-id');
      const recipientId = btn.getAttribute('data-recipient-id');
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-3 h-3 mr-1 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Retrying...';
      await executeAction('retry_email', { email_id: emailId, recipient_id: recipientId });
    });
  });

  // Retry job action
  document.querySelectorAll('[data-action="retry-job"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const jobId = btn.getAttribute('data-job-id');
      const jobType = btn.getAttribute('data-job-type');
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-3 h-3 mr-1 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Retrying...';
      await executeAction('retry_job', { job_id: jobId, job_type: jobType });
    });
  });

  // Retry artifact generation action
  document.querySelectorAll('[data-action="retry-artifact"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const artifactType = btn.getAttribute('data-artifact-type');
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-3 h-3 mr-1 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Retrying...';
      await executeAction('retry_artifact', { artifact_type: artifactType });
    });
  });

  // Delivery refresh button
  const deliveryRefreshBtn = document.getElementById('delivery-refresh');
  if (deliveryRefreshBtn) {
    deliveryRefreshBtn.addEventListener('click', () => {
      window.location.reload();
    });
  }

  // Timeline rendering
  const timelineContainer = document.getElementById('agreement-timeline');
  const timelineRefreshBtn = document.getElementById('timeline-refresh');

  // Event type configuration for display
  const eventConfig = {
    'agreement.created': { icon: 'plus', color: 'green', label: 'Agreement Created' },
    'agreement.updated': { icon: 'edit-pencil', color: 'blue', label: 'Agreement Updated' },
    'agreement.sent': { icon: 'send', color: 'blue', label: 'Sent for Signature' },
    'agreement.resent': { icon: 'refresh', color: 'yellow', label: 'Invitation Resent' },
    'agreement.voided': { icon: 'cancel', color: 'red', label: 'Agreement Voided' },
    'agreement.declined': { icon: 'xmark', color: 'orange', label: 'Agreement Declined' },
    'agreement.expired': { icon: 'clock', color: 'purple', label: 'Agreement Expired' },
    'agreement.completed': { icon: 'check-circle', color: 'green', label: 'Agreement Completed' },
    'recipient.added': { icon: 'user-plus', color: 'green', label: 'Recipient Added' },
    'recipient.removed': { icon: 'user-minus', color: 'red', label: 'Recipient Removed' },
    'recipient.viewed': { icon: 'eye', color: 'purple', label: 'Document Viewed' },
    'recipient.signed': { icon: 'edit', color: 'green', label: 'Signed' },
    'recipient.declined': { icon: 'xmark', color: 'orange', label: 'Declined to Sign' },
    'recipient.consent': { icon: 'check', color: 'blue', label: 'Consent Given' },
    'recipient.submitted': { icon: 'check-circle', color: 'green', label: 'Submitted Signature' },
    'field.created': { icon: 'plus', color: 'gray', label: 'Field Added' },
    'field.updated': { icon: 'edit-pencil', color: 'gray', label: 'Field Updated' },
    'field.deleted': { icon: 'trash', color: 'gray', label: 'Field Removed' },
    'field_value.updated': { icon: 'edit-pencil', color: 'blue', label: 'Field Value Set' },
    'signature.attached': { icon: 'edit', color: 'blue', label: 'Signature Attached' },
    'token.rotated': { icon: 'refresh', color: 'yellow', label: 'Token Rotated' },
    'token.revoked': { icon: 'lock', color: 'red', label: 'Token Revoked' },
    'artifact.generated': { icon: 'document', color: 'green', label: 'Artifact Generated' },
    'email.sent': { icon: 'mail', color: 'blue', label: 'Email Sent' },
    'email.failed': { icon: 'warning-triangle', color: 'red', label: 'Email Failed' },
    'email.delivered': { icon: 'check', color: 'green', label: 'Email Delivered' }
  };

  const colorClasses = {
    green: { bg: 'bg-green-100', text: 'text-green-700', dot: 'bg-green-500' },
    blue: { bg: 'bg-blue-100', text: 'text-blue-700', dot: 'bg-blue-500' },
    red: { bg: 'bg-red-100', text: 'text-red-700', dot: 'bg-red-500' },
    orange: { bg: 'bg-orange-100', text: 'text-orange-700', dot: 'bg-orange-500' },
    yellow: { bg: 'bg-yellow-100', text: 'text-yellow-700', dot: 'bg-yellow-500' },
    purple: { bg: 'bg-purple-100', text: 'text-purple-700', dot: 'bg-purple-500' },
    gray: { bg: 'bg-gray-100', text: 'text-gray-700', dot: 'bg-gray-400' }
  };

  function getEventDisplay(eventType) {
    return eventConfig[eventType] || { icon: 'info-circle', color: 'gray', label: eventType.replace('.', ' ').replace(/_/g, ' ') };
  }

  function renderTimelineEntry(event) {
    const display = getEventDisplay(event.event_type || event.action);
    const colors = colorClasses[display.color] || colorClasses.gray;
    const timestamp = formatRelativeTime(event.created_at || event.timestamp);
    const fullTimestamp = formatTimestamp(event.created_at || event.timestamp);
    const actor = event.actor || event.actor_id || 'System';
    const actorDisplay = actor.includes('@') ? actor : (actor === 'system' ? 'System' : actor);

    // Build metadata display
    let metadataHtml = '';
    if (event.metadata && Object.keys(event.metadata).length > 0) {
      const metaItems = [];
      for (const [key, value] of Object.entries(event.metadata)) {
        if (value && !key.startsWith('_') && key !== 'correlation_id') {
          const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          metaItems.push(`<span class="text-gray-500">${displayKey}:</span> <span class="font-medium">${value}</span>`);
        }
      }
      if (metaItems.length > 0) {
        metadataHtml = `
          <button type="button" class="timeline-meta-toggle mt-2 text-xs text-gray-500 hover:text-gray-700 inline-flex items-center gap-1"
                  aria-expanded="false" data-event-id="${event.id}">
            <svg class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
            Details
          </button>
          <div class="timeline-meta-content hidden mt-2 text-xs bg-gray-50 rounded p-2 space-y-1" data-event-content="${event.id}">
            ${metaItems.map(item => `<div>${item}</div>`).join('')}
          </div>
        `;
      }
    }

    return `
      <div class="timeline-entry relative pl-8 pb-6 last:pb-0" role="listitem">
        <div class="absolute left-0 top-1 w-4 h-4 rounded-full ${colors.dot} ring-4 ring-white" aria-hidden="true"></div>
        <div class="absolute left-[7px] top-5 bottom-0 w-0.5 bg-gray-200 last:hidden" aria-hidden="true"></div>
        <div class="bg-white border border-gray-200 rounded-lg p-3 hover:border-gray-300 transition-colors">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${colors.bg} ${colors.text}">
                  ${display.label}
                </span>
              </div>
              <div class="text-sm text-gray-700">
                <span class="font-medium">${actorDisplay}</span>
                ${event.recipient_email ? `<span class="text-gray-500">  ${event.recipient_email}</span>` : ''}
              </div>
              ${metadataHtml}
            </div>
            <div class="text-right flex-shrink-0">
              <div class="text-xs text-gray-500" title="${fullTimestamp}">${timestamp}</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderTimeline(events) {
    if (!events || events.length === 0) {
      timelineContainer.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <p class="font-medium">No activity yet</p>
          <p class="text-sm">Timeline events will appear here as the agreement progresses.</p>
        </div>
      `;
      return;
    }

    // Sort events by timestamp (newest first)
    const sortedEvents = [...events].sort((a, b) => {
      const dateA = new Date(a.created_at || a.timestamp);
      const dateB = new Date(b.created_at || b.timestamp);
      return dateB - dateA;
    });

    // Group by date
    const groups = {};
    sortedEvents.forEach(event => {
      const date = new Date(event.created_at || event.timestamp);
      const dateKey = date.toLocaleDateString();
      if (!groups[dateKey]) {
        groups[dateKey] = [];
      }
      groups[dateKey].push(event);
    });

    let html = '<div class="relative">';

    for (const [dateKey, dateEvents] of Object.entries(groups)) {
      const dateLabel = getDateLabel(new Date(dateEvents[0].created_at || dateEvents[0].timestamp));
      html += `
        <div class="mb-6">
          <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 pl-8">${dateLabel}</div>
          ${dateEvents.map(event => renderTimelineEntry(event)).join('')}
        </div>
      `;
    }

    html += '</div>';
    timelineContainer.innerHTML = html;

    // Wire up metadata toggles
    timelineContainer.querySelectorAll('.timeline-meta-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const eventId = btn.getAttribute('data-event-id');
        const content = timelineContainer.querySelector(`[data-event-content="${eventId}"]`);
        const isExpanded = btn.getAttribute('aria-expanded') === 'true';

        btn.setAttribute('aria-expanded', !isExpanded);
        content.classList.toggle('hidden', isExpanded);
        btn.querySelector('svg').style.transform = isExpanded ? '' : 'rotate(180deg)';
      });
    });
  }

  function getDateLabel(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    if (date.toDateString() === today.toDateString()) {
      return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
      return 'Yesterday';
    } else {
      return date.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' });
    }
  }

  async function loadTimeline() {
    const inlineTimeline = {% if resource_item.timeline %}{{ toJSON(resource_item.timeline)|safe }}{% else %}[]{% endif %};
    const inlineAuditEvents = {% if resource_item.audit_events %}{{ toJSON(resource_item.audit_events)|safe }}{% else %}[]{% endif %};

    if (inlineTimeline.length > 0) {
      renderTimeline(inlineTimeline);
      return;
    }
    if (inlineAuditEvents.length > 0) {
      renderTimeline(inlineAuditEvents);
      return;
    }
    renderTimeline([]);
  }

  // Initial load
  loadTimeline();

  // Refresh button
  if (timelineRefreshBtn) {
    timelineRefreshBtn.addEventListener('click', () => {
      timelineContainer.innerHTML = `
        <div class="timeline-loading flex items-center justify-center gap-3 py-8 text-gray-500">
          <div class="w-5 h-5 border-2 border-gray-300 border-t-blue-500 rounded-full animate-spin"></div>
          <span>Loading timeline...</span>
        </div>
      `;
      loadTimeline();
    });
  }
});
</script>
{% endblock %}
