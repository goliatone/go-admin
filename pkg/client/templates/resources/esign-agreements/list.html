{% extends "resources/shared/list-base.html" %}

{% block list_title %}Agreements - {{ title }}{% endblock %}

{% block header_actions %}
  {% block header_actions_prepend %}{% endblock %}
  <a href="{{ routes.new }}" class="btn btn-primary" aria-label="Create a new agreement">
    <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
    </svg>
    New Agreement
  </a>
  {% block header_actions_append %}{% endblock %}
{% endblock %}

{% block empty_state %}
<div class="text-center py-16" role="status" aria-label="No agreements found">
  <div class="mx-auto w-24 h-24 mb-6 rounded-full bg-gray-100 flex items-center justify-center" aria-hidden="true">
    <svg class="w-12 h-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
    </svg>
  </div>
  <h3 class="text-xl font-semibold text-gray-900 mb-2">No agreements yet</h3>
  <p class="text-gray-500 mb-6 max-w-sm mx-auto">
    Create your first agreement to start collecting electronic signatures.
  </p>
  <a href="{{ routes.new }}" class="btn btn-primary" aria-label="Create your first agreement">
    <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
    </svg>
    Create Agreement
  </a>
</div>
{% endblock %}

{% block datatable_scripts %}
<script type="module">
import {
  DataGrid,
  FilterBuilder,
  GoCrudFilterBehavior,
  ServerColumnVisibilityBehavior,
  SchemaActionBuilder,
  extractSchemaActions
} from '{{ base_path }}/assets/dist/datatable/index.js';

const basePath = '{{ base_path }}';
const apiBasePath = '{{ api_base_path|default:"" }}';
const apiEndpoint = '{{ list_api }}';
const actionBasePath = '{{ action_base }}';
const columns = {{ toJSON(columns)|safe }};
const filters = {{ toJSON(filters)|safe }};
const env = {{ toJSON(env)|safe }};
const locale = {{ toJSON(locale)|safe }};
const panelName = '{{ panel_name }}';
const columnFields = columns.map(c => c.field);
const gridColumns = columns.map(col => ({
  ...col,
  hidden: col.default === false
}));
const filterFields = (filters || []).map(filter => ({
  name: filter.name,
  label: filter.label,
  type: normalizeFilterType(filter.type),
  options: normalizeFilterOptions(filter.options),
  operators: normalizeFilterOperators(filter.operators, filter.default_operator)
}));

let schemaActionBuilder = null;
let cachedSchemaActions = null;

// Status configuration for agreement states
const statusConfig = {
  draft: { label: 'Draft', bg: 'bg-gray-100', text: 'text-gray-700', dot: 'bg-gray-400' },
  sent: { label: 'Sent', bg: 'bg-blue-100', text: 'text-blue-700', dot: 'bg-blue-500' },
  in_progress: { label: 'In Progress', bg: 'bg-yellow-100', text: 'text-yellow-700', dot: 'bg-yellow-500' },
  completed: { label: 'Completed', bg: 'bg-green-100', text: 'text-green-700', dot: 'bg-green-500' },
  voided: { label: 'Voided', bg: 'bg-red-100', text: 'text-red-700', dot: 'bg-red-500' },
  declined: { label: 'Declined', bg: 'bg-orange-100', text: 'text-orange-700', dot: 'bg-orange-500' },
  expired: { label: 'Expired', bg: 'bg-purple-100', text: 'text-purple-700', dot: 'bg-purple-500' }
};

// Custom cell renderers for agreement-specific fields
const agreementCellRenderers = {
  status: (value) => {
    const status = (value || '').toLowerCase().replace(/ /g, '_');
    const config = statusConfig[status] || statusConfig.draft;
    return `
      <span role="status" aria-label="Status: ${config.label}" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${config.bg} ${config.text}">
        <span class="w-1.5 h-1.5 rounded-full ${config.dot}" aria-hidden="true"></span>
        ${config.label}
      </span>
    `;
  },
  recipient_count: (value) => {
    if (!value) return '-';
    const count = parseInt(value, 10);
    return count === 1 ? '1 recipient' : `${count} recipients`;
  },
  updated_at: (value) => {
    if (!value) return '-';
    try {
      const date = new Date(value);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } catch {
      return value;
    }
  },
  sent_at: (value) => {
    if (!value) return '-';
    try {
      const date = new Date(value);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } catch {
      return value;
    }
  }
};

class PanelPaginationBehavior {
  buildQuery(page, perPage) {
    const params = { page, per_page: perPage };
    if (env) params.env = env;
    return params;
  }
  async onPageChange(page, grid) {
    await grid.refresh();
  }
}

class PanelSearchBehavior {
  buildQuery(term) {
    const params = {};
    const value = term ? term.trim() : '';
    if (value) params.search = value;
    if (env) params.env = env;
    return params;
  }
  async onSearch(term, grid) {
    grid.resetPagination();
    await grid.refresh();
  }
}

function normalizeFilterType(type) {
  switch ((type || '').toLowerCase()) {
    case 'select':
    case 'enum':
      return 'select';
    case 'number':
    case 'integer':
      return 'number';
    case 'date':
    case 'datetime':
    case 'time':
      return 'date';
    default:
      return 'text';
  }
}

function normalizeFilterOptions(options) {
  if (!Array.isArray(options)) return undefined;
  const normalized = options
    .map(option => {
      if (!option) return null;
      const value = option.value ?? '';
      const label = option.label ?? String(value);
      return { label: String(label), value: String(value) };
    })
    .filter(Boolean);
  return normalized.length > 0 ? normalized : undefined;
}

function normalizeFilterOperators(operators, defaultOperator) {
  if (!Array.isArray(operators) || operators.length === 0) return undefined;
  const normalized = operators
    .map(op => String(op || '').trim().toLowerCase())
    .filter(Boolean);
  if (normalized.length === 0) return undefined;
  const deduped = Array.from(new Set(normalized));
  const preferred = defaultOperator ? String(defaultOperator).trim().toLowerCase() : '';
  if (preferred && deduped.includes(preferred)) {
    return [preferred, ...deduped.filter(op => op !== preferred)];
  }
  return deduped;
}

const datatableId = '{{ datatable_id|default:resource }}-datatable';

let grid;

document.addEventListener('DOMContentLoaded', async function() {
  const tableEl = document.getElementById(datatableId);
  if (!tableEl) return;

  const preferencesEndpoint = apiBasePath ? `${apiBasePath}/preferences` : `${basePath}/api/preferences`;
  const columnVisibility = new ServerColumnVisibilityBehavior(columnFields, {
    resource: panelName,
    localStorageKey: `esign_agreements_datatable_columns`,
    preferencesEndpoint: preferencesEndpoint
  });
  await columnVisibility.loadFromServer();

  schemaActionBuilder = new SchemaActionBuilder({
    apiEndpoint: apiEndpoint,
    actionBasePath: actionBasePath,
    locale: locale || undefined,
    environment: env || undefined,
    panelName: panelName,
    useDefaultFallback: true,
    onActionSuccess: async (actionName, result) => {
      if (window.toastManager) {
        window.toastManager.success(`${actionName} completed successfully`);
      }
      await grid.refresh();
    },
    onActionError: (actionName, error) => {
      if (window.toastManager) {
        window.toastManager.error(error.message || `${actionName} failed`);
      }
    }
  });

  grid = new DataGrid({
    tableId: datatableId,
    apiEndpoint: apiEndpoint,
    actionBasePath: actionBasePath,
    columns: gridColumns,
    perPage: 10,
    searchDelay: 300,
    cellRenderers: agreementCellRenderers,
    rowActions: (item) => {
      const schema = grid.getSchema();
      const schemaActions = schema?.actions || cachedSchemaActions;
      return schemaActionBuilder.buildRowActions(item, schemaActions);
    },
    behaviors: {
      search: new PanelSearchBehavior(),
      filter: new GoCrudFilterBehavior(),
      pagination: new PanelPaginationBehavior(),
      columnVisibility: columnVisibility
    },
    selectors: {
      searchInput: '#table-search',
      perPageSelect: '#table-per-page',
      filterRow: '[data-filter-column]',
      columnToggleBtn: '#column-toggle-btn',
      columnToggleMenu: '#column-toggle-menu',
      exportBtn: '#export-btn',
      exportMenu: '#export-menu',
      paginationContainer: '#table-pagination',
      tableInfoStart: '#table-info-start',
      tableInfoEnd: '#table-info-end',
      tableInfoTotal: '#table-info-total',
      selectAllCheckbox: '#table-checkbox-all',
      rowCheckboxes: '.table-checkbox',
      bulkActionsBar: '#bulk-actions-overlay',
      selectedCount: '#selected-count'
    },
    notifier: window.toastManager
  });

  const originalRefresh = grid.refresh.bind(grid);
  grid.refresh = async function() {
    await originalRefresh();
    const schema = grid.getSchema();
    if (schema?.actions) {
      cachedSchemaActions = schema.actions;
    }
  };

  grid.init();

  const refreshBtn = document.getElementById('refresh-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      refreshBtn.classList.add('opacity-50');
      try {
        await grid.refresh();
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('opacity-50');
      }
    });
  }

  const filterToggleBtn = document.getElementById('filter-toggle-btn');
  if (filterFields.length > 0) {
    new FilterBuilder({
      notifier: window.toastManager,
      fields: filterFields,
      onApply: (structure) => {
        const appliedFilters = [];
        structure.groups.forEach(group => {
          group.conditions.forEach(condition => {
            appliedFilters.push({
              column: condition.field,
              operator: condition.operator,
              value: condition.value
            });
          });
        });
        grid.state.filters = appliedFilters;
        grid.resetPagination();
        grid.syncURL();
        grid.refresh();
      },
      onClear: () => {
        grid.state.search = '';
        grid.state.filters = [];
        grid.syncURL();
        grid.refresh();
      }
    });
  } else if (filterToggleBtn) {
    filterToggleBtn.disabled = true;
    filterToggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
});
</script>
{% endblock %}
