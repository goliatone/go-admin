{% extends "resources/shared/list-base.html" %}

{% block list_title %}Documents - {{ title }}{% endblock %}

{% block header_actions %}
  {% block header_actions_prepend %}{% endblock %}
  <a href="{{ routes.new }}" class="btn btn-primary" aria-label="Upload a new PDF document">
    <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
    </svg>
    Upload PDF
  </a>
  {% block header_actions_append %}{% endblock %}
{% endblock %}

{% block empty_state %}
<div class="text-center py-16" role="status" aria-label="No documents found">
  <div class="mx-auto w-24 h-24 mb-6 rounded-full bg-gray-100 flex items-center justify-center" aria-hidden="true">
    <svg class="w-12 h-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
    </svg>
  </div>
  <h3 class="text-xl font-semibold text-gray-900 mb-2">No documents uploaded</h3>
  <p class="text-gray-500 mb-6 max-w-sm mx-auto">
    Upload your first PDF document to start creating agreements for electronic signatures.
  </p>
  <a href="{{ routes.new }}" class="btn btn-primary" aria-label="Upload your first PDF document">
    <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
    </svg>
    Upload PDF
  </a>
</div>
{% endblock %}

{% block datatable_scripts %}
<script type="module">
import {
  DataGrid,
  FilterBuilder,
  GoCrudFilterBehavior,
  ServerColumnVisibilityBehavior,
  SchemaActionBuilder,
  extractSchemaActions
} from '{{ base_path }}/assets/dist/datatable/index.js';
import {
  PanelPaginationBehavior,
  PanelSearchBehavior,
  normalizeFilterType,
  normalizeFilterOptions,
  normalizeFilterOperators
} from '{{ base_path }}/assets/dist/esign/index.js';

const basePath = '{{ base_path }}';
const apiBasePath = '{{ api_base_path|default:"" }}';
const preferencesAPIPath = '{{ preferences_api_path|default:"" }}';
const apiEndpoint = '{{ list_api }}';
const actionBasePath = '{{ action_base }}';
const columns = {{ toJSON(columns)|safe }};
const filters = {{ toJSON(filters)|safe }};
const env = {{ toJSON(env)|safe }};
const locale = {{ toJSON(locale)|safe }};
const panelName = '{{ panel_name }}';
const columnFields = columns.map(c => c.field);
const gridColumns = columns.map(col => ({
  ...col,
  hidden: col.default === false
}));
const filterFields = (filters || []).map(filter => ({
  name: filter.name,
  label: filter.label,
  type: normalizeFilterType(filter.type),
  options: normalizeFilterOptions(filter.options),
  operators: normalizeFilterOperators(filter.operators, filter.default_operator)
}));

let schemaActionBuilder = null;
let cachedSchemaActions = null;

// Custom cell renderers for document-specific fields
const documentCellRenderers = {
  size_bytes: (value) => {
    if (!value || value <= 0) return '-';
    const bytes = parseInt(value, 10);
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
  },
  page_count: (value) => {
    if (!value) return '-';
    const count = parseInt(value, 10);
    return count === 1 ? '1 page' : `${count} pages`;
  },
  created_at: (value) => {
    if (!value) return '-';
    try {
      const date = new Date(value);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } catch {
      return value;
    }
  }
};

const datatableId = '{{ datatable_id|default:resource }}-datatable';

let grid;

document.addEventListener('DOMContentLoaded', async function() {
  const tableEl = document.getElementById(datatableId);
  if (!tableEl) return;

  const preferencesEndpoint = preferencesAPIPath || (apiBasePath ? `${apiBasePath}/panels/preferences` : `${basePath}/api/panels/preferences`);
  const columnVisibility = new ServerColumnVisibilityBehavior(columnFields, {
    resource: panelName,
    localStorageKey: `esign_documents_datatable_columns`,
    preferencesEndpoint: preferencesEndpoint
  });
  await columnVisibility.loadFromServer();

  schemaActionBuilder = new SchemaActionBuilder({
    apiEndpoint: apiEndpoint,
    actionBasePath: actionBasePath,
    actionContext: 'row',
    locale: locale || undefined,
    environment: env || undefined,
    panelName: panelName,
    useDefaultFallback: true,
    onActionSuccess: async (actionName, result) => {
      if (window.toastManager) {
        window.toastManager.success(`${actionName} completed successfully`);
      }
      await grid.refresh();
    },
    onActionError: (actionName, error) => {
      if (window.toastManager) {
        window.toastManager.error(error.message || `${actionName} failed`);
      }
    }
  });

  grid = new DataGrid({
    tableId: datatableId,
    apiEndpoint: apiEndpoint,
    actionBasePath: actionBasePath,
    columns: gridColumns,
    perPage: 10,
    searchDelay: 300,
    cellRenderers: documentCellRenderers,
    rowActions: (item) => {
      const schema = grid.getSchema();
      const schemaActions = schema?.actions || cachedSchemaActions;
      return schemaActionBuilder.buildRowActions(item, schemaActions);
    },
    behaviors: {
      search: new PanelSearchBehavior(),
      filter: new GoCrudFilterBehavior(),
      pagination: new PanelPaginationBehavior(),
      columnVisibility: columnVisibility
    },
    selectors: {
      searchInput: '#table-search',
      perPageSelect: '#table-per-page',
      filterRow: '[data-filter-column]',
      columnToggleBtn: '#column-toggle-btn',
      columnToggleMenu: '#column-toggle-menu',
      exportBtn: '#export-btn',
      exportMenu: '#export-menu',
      paginationContainer: '#table-pagination',
      tableInfoStart: '#table-info-start',
      tableInfoEnd: '#table-info-end',
      tableInfoTotal: '#table-info-total',
      selectAllCheckbox: '#table-checkbox-all',
      rowCheckboxes: '.table-checkbox',
      bulkActionsBar: '#bulk-actions-overlay',
      selectedCount: '#selected-count'
    },
    notifier: window.toastManager
  });

  const originalRefresh = grid.refresh.bind(grid);
  grid.refresh = async function() {
    await originalRefresh();
    const schema = grid.getSchema();
    if (schema?.actions) {
      cachedSchemaActions = schema.actions;
    }
  };

  grid.init();

  const refreshBtn = document.getElementById('refresh-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      refreshBtn.classList.add('opacity-50');
      try {
        await grid.refresh();
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('opacity-50');
      }
    });
  }

  const filterToggleBtn = document.getElementById('filter-toggle-btn');
  if (filterFields.length > 0) {
    new FilterBuilder({
      notifier: window.toastManager,
      fields: filterFields,
      onApply: (structure) => {
        const appliedFilters = [];
        structure.groups.forEach(group => {
          group.conditions.forEach(condition => {
            appliedFilters.push({
              column: condition.field,
              operator: condition.operator,
              value: condition.value
            });
          });
        });
        grid.state.filters = appliedFilters;
        grid.resetPagination();
        grid.syncURL();
        grid.refresh();
      },
      onClear: () => {
        grid.state.search = '';
        grid.state.filters = [];
        grid.syncURL();
        grid.refresh();
      }
    });
  } else if (filterToggleBtn) {
    filterToggleBtn.disabled = true;
    filterToggleBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
});
</script>
{% endblock %}
