{% extends "layout.html" %}

{% block title %}Upload Document - {{ title }}{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <div>
    <p class="text-sm text-gray-500 mb-1">E-Sign Documents</p>
    <h1 class="text-3xl font-bold text-admin-dark">Upload PDF Document</h1>
  </div>
  <div class="flex gap-3">
    {% if routes.index %}
      <a href="{{ routes.index }}" class="btn btn-secondary" aria-label="Return to documents list">
        <i class="iconoir-arrow-left" aria-hidden="true"></i>
        Back to Documents
      </a>
    {% endif %}
  </div>
</header>

<div class="flex-1 p-8 overflow-y-auto">
  <div class="max-w-2xl">
    <form id="document-upload-form" method="POST" action="{{ routes.create|default:routes.index }}" enctype="multipart/form-data" class="space-y-6">

      {# Document Title #}
      <div>
        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
          Document Title <span class="text-red-500" aria-hidden="true">*</span>
          <span class="sr-only">(required)</span>
        </label>
        <input
          type="text"
          id="title"
          name="title"
          required
          aria-required="true"
          aria-describedby="title-help"
          placeholder="e.g., Service Agreement 2024"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
        <p class="mt-1 text-xs text-gray-500" id="title-help">Give this document a descriptive name for easy identification.</p>
      </div>

      {# PDF File Upload #}
      <div>
        <label id="pdf-file-label" class="block text-sm font-medium text-gray-700 mb-1">
          PDF File <span class="text-red-500" aria-hidden="true">*</span>
          <span class="sr-only">(required)</span>
        </label>
        <div
          id="pdf-upload-zone"
          class="relative border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-gray-400 transition-colors cursor-pointer focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500"
          role="button"
          tabindex="0"
          aria-labelledby="pdf-file-label"
          aria-describedby="upload-help upload-error"
        >
          <input
            type="file"
            id="pdf_file"
            name="pdf_file"
            accept="application/pdf,.pdf"
            required
            aria-required="true"
            aria-describedby="upload-help upload-error"
            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
          >
          <div id="upload-placeholder" class="space-y-3">
            <div class="mx-auto w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center" aria-hidden="true">
              <svg class="w-8 h-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">
                <span class="font-medium text-blue-600 hover:text-blue-500">Click to upload</span>
                or drag and drop
              </p>
              <p class="text-xs text-gray-500 mt-1" id="upload-help">PDF files only (max 25 MB)</p>
            </div>
          </div>
          <div id="upload-preview" class="hidden space-y-3" role="status" aria-live="polite">
            <div class="mx-auto w-16 h-16 rounded-full bg-green-100 flex items-center justify-center" aria-hidden="true">
              <svg class="w-8 h-8 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900" id="selected-file-name">document.pdf</p>
              <p class="text-xs text-gray-500" id="selected-file-size">0 KB</p>
            </div>
            <button type="button" id="clear-file-btn" class="text-xs text-red-600 hover:text-red-700" aria-label="Remove selected file and choose another">
              Remove and select another file
            </button>
          </div>
        </div>
        <p id="upload-error" class="mt-2 text-sm text-red-600 hidden" role="alert" aria-live="assertive"></p>
      </div>

      {# Immutability Notice #}
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-4" role="note" aria-label="Important document information">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0" aria-hidden="true">
            <svg class="w-5 h-5 text-amber-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div>
            <h4 class="text-sm font-medium text-amber-800">Document Cannot Be Modified</h4>
            <p class="text-sm text-amber-700 mt-1">
              Once uploaded, this document cannot be edited or replaced. A cryptographic hash (SHA-256)
              will be generated to ensure document integrity throughout the signing process.
            </p>
          </div>
        </div>
      </div>

      {# Hidden field populated after upload API returns object_key #}
      <input type="hidden" id="source_object_key" name="source_object_key" value="">

      {# Submit #}
      <div class="flex justify-end gap-3 pt-4">
        <a href="{{ routes.index }}" class="btn btn-secondary" aria-label="Cancel and return to documents list">Cancel</a>
        <button type="submit" id="submit-btn" class="btn btn-primary" disabled aria-disabled="true">
          <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
          </svg>
          Upload Document
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('document-upload-form');
  const fileInput = document.getElementById('pdf_file');
  const uploadZone = document.getElementById('pdf-upload-zone');
  const placeholder = document.getElementById('upload-placeholder');
  const preview = document.getElementById('upload-preview');
  const fileName = document.getElementById('selected-file-name');
  const fileSize = document.getElementById('selected-file-size');
  const clearBtn = document.getElementById('clear-file-btn');
  const errorEl = document.getElementById('upload-error');
  const submitBtn = document.getElementById('submit-btn');
  const titleInput = document.getElementById('title');
  const sourceObjectKeyInput = document.getElementById('source_object_key');
  const apiBasePath = '{{ api_base_path|default:"/admin/api/v1" }}';
  const uploadEndpoint = apiBasePath.replace(/\/$/, '') + '/esign/documents/upload';

  const MAX_SIZE = 25 * 1024 * 1024; // 25 MB
  let isSubmitting = false;

  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
  }

  function showError(message) {
    errorEl.textContent = message;
    errorEl.classList.remove('hidden');
  }

  function clearError() {
    errorEl.textContent = '';
    errorEl.classList.add('hidden');
  }

  function updateSubmitState() {
    const hasFile = fileInput.files && fileInput.files.length > 0;
    const hasTitle = titleInput.value.trim().length > 0;
    const isEnabled = hasFile && hasTitle;
    submitBtn.disabled = !isEnabled;
    submitBtn.setAttribute('aria-disabled', !isEnabled);
  }

  function showPreview(file) {
    fileName.textContent = file.name;
    fileSize.textContent = formatBytes(file.size);
    placeholder.classList.add('hidden');
    preview.classList.remove('hidden');
    uploadZone.classList.remove('border-gray-300');
    uploadZone.classList.add('border-green-400', 'bg-green-50');
  }

  function clearPreview() {
    placeholder.classList.remove('hidden');
    preview.classList.add('hidden');
    uploadZone.classList.add('border-gray-300');
    uploadZone.classList.remove('border-green-400', 'bg-green-50');
  }

  function validateFile(file) {
    clearError();

    if (!file) return false;

    // Check file type
    if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
      showError('Please select a PDF file.');
      return false;
    }

    // Check file size
    if (file.size > MAX_SIZE) {
      showError(`File is too large (${formatBytes(file.size)}). Maximum size is ${formatBytes(MAX_SIZE)}.`);
      return false;
    }

    // Check for empty file
    if (file.size === 0) {
      showError('The selected file appears to be empty.');
      return false;
    }

    return true;
  }

  fileInput.addEventListener('change', function() {
    const file = this.files[0];
    if (file && validateFile(file)) {
      showPreview(file);
      sourceObjectKeyInput.value = '';

      // Auto-fill title from filename if empty
      if (!titleInput.value.trim()) {
        const nameWithoutExt = file.name.replace(/\.pdf$/i, '');
        titleInput.value = nameWithoutExt;
      }
    } else {
      this.value = '';
      clearPreview();
      sourceObjectKeyInput.value = '';
    }
    updateSubmitState();
  });

  clearBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    fileInput.value = '';
    sourceObjectKeyInput.value = '';
    clearPreview();
    clearError();
    updateSubmitState();
  });

  titleInput.addEventListener('input', updateSubmitState);

  // Drag and drop support
  ['dragenter', 'dragover'].forEach(eventName => {
    uploadZone.addEventListener(eventName, function(e) {
      e.preventDefault();
      e.stopPropagation();
      uploadZone.classList.add('border-blue-400', 'bg-blue-50');
    });
  });

  ['dragleave', 'drop'].forEach(eventName => {
    uploadZone.addEventListener(eventName, function(e) {
      e.preventDefault();
      e.stopPropagation();
      uploadZone.classList.remove('border-blue-400', 'bg-blue-50');
    });
  });

  uploadZone.addEventListener('drop', function(e) {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      fileInput.dispatchEvent(new Event('change'));
    }
  });

  // Keyboard accessibility
  uploadZone.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      fileInput.click();
    }
  });

  // Form submission
  function setSubmittingState(submitting) {
    submitBtn.disabled = submitting;
    submitBtn.setAttribute('aria-disabled', submitting ? 'true' : 'false');
    if (submitting) {
      submitBtn.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Uploading...
      `;
    } else {
      submitBtn.innerHTML = `
        <svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        Upload Document
      `;
    }
  }

  async function uploadSourcePDF(file) {
    const params = new URLSearchParams(window.location.search);
    const tenantId = params.get('tenant_id');
    const orgId = params.get('org_id');
    const uploadURL = new URL(uploadEndpoint, window.location.origin);
    if (tenantId) uploadURL.searchParams.set('tenant_id', tenantId);
    if (orgId) uploadURL.searchParams.set('org_id', orgId);

    const payload = new FormData();
    payload.append('file', file);

    const response = await fetch(uploadURL.toString(), {
      method: 'POST',
      body: payload,
      credentials: 'same-origin'
    });

    const body = await response.json().catch(() => ({}));
    if (!response.ok) {
      const message = body?.error?.message || body?.message || 'Upload failed. Please try again.';
      throw new Error(message);
    }
    const objectKey = (body && body.object_key) ? String(body.object_key).trim() : '';
    if (!objectKey) {
      throw new Error('Upload failed: missing source object key.');
    }
    return objectKey;
  }

  form.addEventListener('submit', async function(e) {
    if (isSubmitting) {
      return;
    }
    if (!validateFile(fileInput.files[0])) {
      e.preventDefault();
      return;
    }
    e.preventDefault();
    clearError();
    isSubmitting = true;
    setSubmittingState(true);
    try {
      const objectKey = await uploadSourcePDF(fileInput.files[0]);
      sourceObjectKeyInput.value = objectKey;
      form.submit();
    } catch (err) {
      const message = (err && err.message) ? err.message : 'Upload failed. Please try again.';
      showError(message);
      setSubmittingState(false);
      isSubmitting = false;
      updateSubmitState();
    }
  });
});
</script>
{% endblock %}
