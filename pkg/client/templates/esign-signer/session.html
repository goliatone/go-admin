{% extends "login-layout.html" %}

{% block title %}Sign Agreement - {{ agreement.title|default:"Document" }}{% endblock %}

{% block head_extra %}
<style>
  .signer-card {
    animation: fadeIn 0.3s ease-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .field-indicator {
    transition: all 0.2s ease;
  }
  .field-indicator:hover {
    transform: scale(1.05);
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col bg-gray-50">
  <!-- Header Bar -->
  <header class="bg-white border-b border-gray-200 px-4 py-4 sm:px-6" role="banner">
    <div class="max-w-3xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        {% if theme and theme.assets and theme.assets.icon %}
        <div class="w-10 h-10 bg-admin-dark rounded-xl flex items-center justify-center">
          <img src="{{ theme.assets.icon }}" alt="Logo" class="w-6 h-6 object-contain" />
        </div>
        {% elif theme and theme.assets and theme.assets.logo %}
        <img src="{{ theme.assets.logo }}" alt="Logo" class="h-8 max-w-[120px] object-contain" />
        {% else %}
        <div class="w-10 h-10 bg-admin-dark rounded-xl flex items-center justify-center">
          <i class="iconoir-signature text-white text-lg"></i>
        </div>
        {% endif %}
        <span class="text-sm font-medium text-gray-900 hidden sm:inline">E-Sign</span>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-500">Signing as</p>
        <p class="text-sm font-medium text-gray-900 truncate max-w-[200px]" title="{{ session.recipient_email }}">{{ session.recipient_name|default:session.recipient_email }}</p>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 px-4 py-6 sm:px-6" role="main">
    <div class="max-w-3xl mx-auto space-y-6">

      {% if session.state == "waiting" %}
      <!-- Waiting State -->
      <div class="signer-card bg-amber-50 rounded-2xl border border-amber-200 p-6 sm:p-8" role="alert" aria-live="polite">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="iconoir-hourglass text-amber-600 text-xl" aria-hidden="true"></i>
          </div>
          <div class="flex-1 min-w-0">
            <h1 class="text-xl font-bold text-gray-900 mb-2">Waiting for Previous Signer</h1>
            <p class="text-gray-600 mb-4">
              This document requires signatures in a specific order. You'll receive an email notification when it's your turn to sign.
            </p>
            <div class="bg-white rounded-lg border border-amber-200 p-4">
              <p class="text-sm text-gray-500 mb-1">Document</p>
              <p class="font-medium text-gray-900">{{ agreement.title|default:"Untitled Agreement" }}</p>
              <p class="text-sm text-gray-500 mt-3 mb-1">Your position</p>
              <p class="font-medium text-gray-900">Signer {{ session.recipient_order }} of {{ agreement.total_signers|default:"multiple" }}</p>
            </div>
          </div>
        </div>
      </div>

      {% elif session.state == "completed" %}
      <!-- Already Completed State -->
      <div class="signer-card bg-green-50 rounded-2xl border border-green-200 p-6 sm:p-8" role="status" aria-live="polite">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="iconoir-check text-green-600 text-xl" aria-hidden="true"></i>
          </div>
          <div class="flex-1 min-w-0">
            <h1 class="text-xl font-bold text-gray-900 mb-2">Already Signed</h1>
            <p class="text-gray-600 mb-4">
              You have already completed signing this document. No further action is required.
            </p>
            <div class="bg-white rounded-lg border border-green-200 p-4">
              <p class="text-sm text-gray-500 mb-1">Document</p>
              <p class="font-medium text-gray-900">{{ agreement.title|default:"Untitled Agreement" }}</p>
              {% if session.completed_at %}
              <p class="text-sm text-gray-500 mt-3 mb-1">Signed on</p>
              <p class="font-medium text-gray-900">{{ session.completed_at }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {% elif session.state == "terminal" %}
      <!-- Terminal State (Completed/Declined/Voided/Expired Agreement) -->
      <div class="signer-card bg-gray-50 rounded-2xl border border-gray-200 p-6 sm:p-8" role="status" aria-live="polite">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="iconoir-lock text-gray-500 text-xl" aria-hidden="true"></i>
          </div>
          <div class="flex-1 min-w-0">
            <h1 class="text-xl font-bold text-gray-900 mb-2">Document No Longer Available</h1>
            <p class="text-gray-600 mb-4">
              {% if agreement.status == "completed" %}
              This agreement has been completed by all signers.
              {% elif agreement.status == "declined" %}
              This agreement was declined and is no longer active.
              {% elif agreement.status == "voided" %}
              This agreement was voided by the sender.
              {% elif agreement.status == "expired" %}
              This agreement has expired and is no longer available for signing.
              {% else %}
              This agreement is no longer available for signing.
              {% endif %}
            </p>
            <p class="text-sm text-gray-500">
              If you need assistance, please contact the sender.
            </p>
          </div>
        </div>
      </div>

      {% elif session.state == "observer" %}
      <!-- CC Recipient (Observer) State -->
      <div class="signer-card bg-blue-50 rounded-2xl border border-blue-200 p-6 sm:p-8" role="status">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="iconoir-eye text-blue-600 text-xl" aria-hidden="true"></i>
          </div>
          <div class="flex-1 min-w-0">
            <h1 class="text-xl font-bold text-gray-900 mb-2">You're a Copy Recipient</h1>
            <p class="text-gray-600 mb-4">
              You have been included as a copy recipient on this document. No signature is required from you.
            </p>
            <div class="bg-white rounded-lg border border-blue-200 p-4">
              <p class="text-sm text-gray-500 mb-1">Document</p>
              <p class="font-medium text-gray-900">{{ agreement.title|default:"Untitled Agreement" }}</p>
              <p class="text-sm text-gray-500 mt-3 mb-1">Status</p>
              <p class="font-medium text-gray-900">{{ agreement.status|title }}</p>
            </div>
            <p class="text-sm text-gray-500 mt-4">
              You'll receive the final executed document once all signers have completed.
            </p>
          </div>
        </div>
      </div>

      {% elif session.state == "active" %}
      <!-- Active Signing State -->

      <!-- Agreement Summary Card -->
      <div class="signer-card bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
        <!-- Header -->
        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-white rounded-xl shadow-sm flex items-center justify-center flex-shrink-0 border border-gray-100">
              <i class="iconoir-page text-blue-600 text-xl" aria-hidden="true"></i>
            </div>
            <div class="flex-1 min-w-0">
              <h1 class="text-xl font-bold text-gray-900 mb-1">{{ agreement.title|default:"Untitled Agreement" }}</h1>
              <p class="text-sm text-gray-600">
                From: <span class="font-medium">{{ agreement.sender_name|default:agreement.sender_email }}</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Document Info -->
        <div class="px-6 py-5 space-y-4">
          <!-- Document Preview Link -->
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                <i class="iconoir-page text-red-600" aria-hidden="true"></i>
              </div>
              <div>
                <p class="font-medium text-gray-900">{{ agreement.document_name|default:"Document.pdf" }}</p>
                <p class="text-sm text-gray-500">{{ agreement.page_count|default:"1" }} page{% if agreement.page_count != 1 %}s{% endif %}</p>
              </div>
            </div>
            <button
              type="button"
              onclick="openDocumentPreview()"
              class="text-sm font-medium text-blue-600 hover:text-blue-700 flex items-center gap-1"
              aria-label="Preview document"
            >
              <i class="iconoir-eye" aria-hidden="true"></i>
              <span class="hidden sm:inline">Preview</span>
            </button>
          </div>

          <!-- Fields Summary -->
          {% if session.fields and session.fields|length > 0 %}
          <div class="space-y-3">
            <h2 class="text-sm font-medium text-gray-700">Required Actions</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
              {% set signature_count = 0 %}
              {% set text_count = 0 %}
              {% set checkbox_count = 0 %}
              {% for field in session.fields %}
                {% if field.type == "signature" or field.type == "initials" %}
                  {% set signature_count = signature_count + 1 %}
                {% elif field.type == "checkbox" %}
                  {% set checkbox_count = checkbox_count + 1 %}
                {% else %}
                  {% set text_count = text_count + 1 %}
                {% endif %}
              {% endfor %}

              {% if signature_count > 0 %}
              <div class="field-indicator flex items-center gap-2 p-3 bg-purple-50 rounded-lg border border-purple-100" role="status">
                <i class="iconoir-signature text-purple-600" aria-hidden="true"></i>
                <span class="text-sm font-medium text-purple-900">{{ signature_count }} Signature{% if signature_count != 1 %}s{% endif %}</span>
              </div>
              {% endif %}

              {% if text_count > 0 %}
              <div class="field-indicator flex items-center gap-2 p-3 bg-blue-50 rounded-lg border border-blue-100" role="status">
                <i class="iconoir-edit-pencil text-blue-600" aria-hidden="true"></i>
                <span class="text-sm font-medium text-blue-900">{{ text_count }} Text Field{% if text_count != 1 %}s{% endif %}</span>
              </div>
              {% endif %}

              {% if checkbox_count > 0 %}
              <div class="field-indicator flex items-center gap-2 p-3 bg-green-50 rounded-lg border border-green-100" role="status">
                <i class="iconoir-check-square text-green-600" aria-hidden="true"></i>
                <span class="text-sm font-medium text-green-900">{{ checkbox_count }} Checkbox{% if checkbox_count != 1 %}es{% endif %}</span>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Consent Card -->
      <div class="signer-card bg-white rounded-2xl shadow-sm border border-gray-200 p-6 sm:p-8" id="consent-section">
        <form id="consent-form" onsubmit="handleConsentSubmit(event)">
          <div class="space-y-5">
            <div>
              <h2 class="text-lg font-bold text-gray-900 mb-2">Electronic Signature Consent</h2>
              <p class="text-sm text-gray-600">
                Before proceeding, please review and acknowledge your consent to sign this document electronically.
              </p>
            </div>

            <!-- Consent Statement -->
            <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
              <p class="text-sm text-gray-700 leading-relaxed">
                By checking the box below, I agree to use electronic records and signatures for this document.
                I understand that my electronic signature will have the same legal effect as a handwritten signature.
                I confirm that I have reviewed the document and agree to its terms.
              </p>
            </div>

            <!-- Consent Checkbox -->
            <label class="flex items-start gap-3 cursor-pointer group" for="consent-checkbox">
              <div class="relative flex items-center justify-center mt-0.5">
                <input
                  type="checkbox"
                  id="consent-checkbox"
                  name="consent"
                  class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 cursor-pointer"
                  aria-describedby="consent-description"
                  required
                />
              </div>
              <span class="text-sm text-gray-700 group-hover:text-gray-900" id="consent-description">
                I have read and agree to the above electronic signature consent statement
              </span>
            </label>

            <!-- Continue Button -->
            <button
              type="submit"
              id="consent-submit-btn"
              class="btn btn-primary w-full justify-center py-3 text-base disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              <i class="iconoir-arrow-right mr-2" aria-hidden="true"></i>
              Continue to Sign
            </button>

            <!-- Decline Option -->
            <div class="text-center">
              <button
                type="button"
                onclick="showDeclineModal()"
                class="text-sm text-gray-500 hover:text-red-600 underline underline-offset-2"
              >
                I don't want to sign this document
              </button>
            </div>
          </div>
        </form>
      </div>

      {% else %}
      <!-- Invalid/Unknown State -->
      <div class="signer-card bg-red-50 rounded-2xl border border-red-200 p-6 sm:p-8" role="alert">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="iconoir-warning-circle text-red-600 text-xl" aria-hidden="true"></i>
          </div>
          <div class="flex-1 min-w-0">
            <h1 class="text-xl font-bold text-gray-900 mb-2">Unable to Load Document</h1>
            <p class="text-gray-600 mb-4">
              We couldn't load this signing session. The link may be invalid or the document may no longer be available.
            </p>
            <p class="text-sm text-gray-500">
              Please check that you're using the correct link, or contact the sender for assistance.
            </p>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </main>

  <!-- Footer -->
  <footer class="px-4 py-4 border-t border-gray-100 bg-white" role="contentinfo">
    <div class="max-w-3xl mx-auto">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-3 text-xs text-gray-500">
        <p>Secured with E-Sign</p>
        <div class="flex items-center gap-4">
          <a href="#" class="hover:text-gray-700">Privacy Policy</a>
          <a href="#" class="hover:text-gray-700">Terms of Service</a>
          <a href="#" class="hover:text-gray-700">Help</a>
        </div>
      </div>
    </div>
  </footer>
</div>

<!-- Decline Confirmation Modal -->
<div id="decline-modal" class="hidden fixed inset-0 z-50" role="dialog" aria-modal="true" aria-labelledby="decline-modal-title">
  <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm" onclick="hideDeclineModal()"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 relative" role="document">
      <button
        type="button"
        onclick="hideDeclineModal()"
        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
        aria-label="Close modal"
      >
        <i class="iconoir-xmark text-xl" aria-hidden="true"></i>
      </button>

      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="iconoir-warning-triangle text-red-600 text-2xl" aria-hidden="true"></i>
        </div>
        <h3 id="decline-modal-title" class="text-xl font-bold text-gray-900 mb-2">Decline to Sign?</h3>
        <p class="text-gray-600">
          If you decline, the sender will be notified and you won't be able to sign this document.
        </p>
      </div>

      <form id="decline-form" onsubmit="handleDeclineSubmit(event)">
        <div class="mb-4">
          <label for="decline-reason" class="block text-sm font-medium text-gray-700 mb-2">
            Reason for declining (optional)
          </label>
          <textarea
            id="decline-reason"
            name="reason"
            rows="3"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm resize-none"
            placeholder="Let the sender know why you're declining..."
          ></textarea>
        </div>

        <div class="flex gap-3">
          <button
            type="button"
            onclick="hideDeclineModal()"
            class="flex-1 btn btn-secondary justify-center"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="flex-1 btn bg-red-600 hover:bg-red-700 text-white justify-center"
          >
            Decline to Sign
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Configuration from server
  const signerConfig = {
    token: '{{ token }}',
    apiBasePath: '{{ api_base_path|default:"/api/v1/esign/signing" }}',
    sessionState: '{{ session.state }}',
    hasConsented: {{ session.has_consented|default:"false"|lower }},
    agreementId: '{{ session.agreement_id }}',
    recipientId: '{{ session.recipient_id }}'
  };

  // Enable/disable consent button based on checkbox
  document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('consent-checkbox');
    const submitBtn = document.getElementById('consent-submit-btn');

    if (checkbox && submitBtn) {
      checkbox.addEventListener('change', function() {
        submitBtn.disabled = !this.checked;
      });
    }

    // If already consented, redirect to signing flow
    if (signerConfig.hasConsented && signerConfig.sessionState === 'active') {
      window.location.href = signerConfig.apiBasePath.replace('/api/v1/esign/signing', '/esign/sign') + '/' + signerConfig.token + '/fields';
    }
  });

  // Handle consent form submission
  async function handleConsentSubmit(event) {
    event.preventDefault();

    const submitBtn = document.getElementById('consent-submit-btn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="iconoir-refresh animate-spin mr-2"></i> Processing...';

    try {
      const response = await fetch(`${signerConfig.apiBasePath}/consent/${signerConfig.token}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          accepted: true
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error?.message || 'Failed to submit consent');
      }

      // Redirect to signing flow
      window.location.href = signerConfig.apiBasePath.replace('/api/v1/esign/signing', '/esign/sign') + '/' + signerConfig.token + '/fields';
    } catch (error) {
      console.error('Consent error:', error);
      if (window.toastManager) {
        window.toastManager.error(error.message || 'An error occurred. Please try again.');
      } else {
        alert(error.message || 'An error occurred. Please try again.');
      }
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }

  // Show decline modal
  function showDeclineModal() {
    document.getElementById('decline-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.getElementById('decline-reason').focus();
  }

  // Hide decline modal
  function hideDeclineModal() {
    document.getElementById('decline-modal').classList.add('hidden');
    document.body.style.overflow = '';
  }

  // Handle decline submission
  async function handleDeclineSubmit(event) {
    event.preventDefault();

    const reason = document.getElementById('decline-reason').value;
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="iconoir-refresh animate-spin mr-2"></i> Processing...';

    try {
      const response = await fetch(`${signerConfig.apiBasePath}/decline/${signerConfig.token}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          reason: reason
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error?.message || 'Failed to decline');
      }

      // Redirect to declined confirmation
      window.location.href = signerConfig.apiBasePath.replace('/api/v1/esign/signing', '/esign/sign') + '/' + signerConfig.token + '/declined';
    } catch (error) {
      console.error('Decline error:', error);
      if (window.toastManager) {
        window.toastManager.error(error.message || 'An error occurred. Please try again.');
      } else {
        alert(error.message || 'An error occurred. Please try again.');
      }
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }

  // Open document preview
  function openDocumentPreview() {
    // TODO: Implement document preview modal or new window
    window.open(`${signerConfig.apiBasePath}/preview/${signerConfig.token}`, '_blank', 'width=800,height=600');
  }

  // Keyboard navigation for modal
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      hideDeclineModal();
    }
  });
</script>
{% endblock %}
