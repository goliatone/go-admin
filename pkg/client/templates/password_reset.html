{% extends "login-layout.html" %}

{% block title %}Password Reset - {{ title }}{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-50 px-4 py-8">
  <div
    id="password-reset-root"
    class="w-full max-w-2xl space-y-6"
    data-token-metadata-path="{{ token_metadata_path }}"
    data-token-query-key="{{ token_query_key }}"
    data-token-as-query="{{ token_as_query }}"
  >
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 space-y-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-zinc-500 font-semibold mb-1">Reset workflow</p>
        <h1 class="text-xl font-semibold text-admin-dark">Request a reset link</h1>
        <p class="text-sm text-zinc-500">Use your email or username. We'll send a secure link to reset your password.</p>
      </div>
      <form id="reset-request-form" class="space-y-3" action="{{ base_path }}/api/onboarding/password/reset/request" method="post">
        <input
          type="text"
          name="identifier"
          placeholder="Email or username"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        />
        <button type="submit" class="btn btn-primary w-full justify-center">Send reset link</button>
      </form>
      <div id="reset-request-result" class="hidden text-xs text-zinc-500"></div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 space-y-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-zinc-500 font-semibold mb-1">Apply token</p>
        <h2 class="text-lg font-semibold text-admin-dark">Confirm reset</h2>
        <p class="text-sm text-zinc-500">Paste the reset token from your email and choose a new password.</p>
      </div>
      <form id="reset-confirm-form" class="space-y-3" action="{{ base_path }}/api/onboarding/password/reset/confirm" method="post">
        <input
          id="reset-token"
          type="text"
          name="token"
          placeholder="Reset token"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        />
        <input
          id="reset-password"
          type="password"
          name="password"
          placeholder="New password"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        />
        {% if password_policy_hints %}
        <ul class="text-xs text-zinc-500 space-y-1">
          {% for hint in password_policy_hints %}
          <li>â€¢ {{ hint }}</li>
          {% endfor %}
        </ul>
        {% endif %}
        <button type="submit" class="btn btn-secondary w-full justify-center">Set password</button>
      </form>
      <div id="reset-token-status" class="hidden text-xs rounded-lg border border-gray-200 bg-gray-50 px-3 py-2"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const resetRoot = document.getElementById('password-reset-root');
  const resetRequestForm = document.getElementById('reset-request-form');
  const resetConfirmForm = document.getElementById('reset-confirm-form');
  const resetRequestResult = document.getElementById('reset-request-result');
  const tokenInput = document.getElementById('reset-token');
  const tokenStatus = document.getElementById('reset-token-status');

  const tokenMetadataPath = resetRoot?.dataset.tokenMetadataPath || '';
  const tokenQueryKey = resetRoot?.dataset.tokenQueryKey || 'token';
  const tokenAsQuery = (resetRoot?.dataset.tokenAsQuery || 'true') === 'true';

  const textCodeMessages = {
    FEATURE_DISABLED: 'Password reset is currently disabled.',
    RESET_RATE_LIMIT: 'A reset link was recently requested. Please wait before trying again.',
    RESET_NOT_ALLOWED: 'Password resets are not allowed for this account.',
    TOKEN_EXPIRED: 'This reset link has expired. Please request a new one.',
    TOKEN_ALREADY_USED: 'This reset link has already been used.',
    TOKEN_MALFORMED: 'This reset link is invalid. Please request a new one.',
    ACCOUNT_LOCKED: 'Your account is locked. Try again later.',
    ACCOUNT_DISABLED: 'Your account is disabled.',
    ACCOUNT_SUSPENDED: 'Your account is suspended.',
    ACCOUNT_ARCHIVED: 'Your account is archived.',
    ACCOUNT_PENDING: 'Your account is pending verification.',
    VERIFICATION_REQUIRED: 'Please verify your account before resetting your password.',
    VERIFICATION_EXPIRED: 'Your verification link has expired. Request a new one.'
  };

  async function readErrorPayload(response) {
    try {
      return await response.clone().json();
    } catch (error) {
      return null;
    }
  }

  async function resolveErrorMessage(response) {
    const payload = await readErrorPayload(response);
    const err = payload && payload.error ? payload.error : null;
    const textCode = err && err.text_code ? err.text_code : '';
    if (textCode && textCodeMessages[textCode]) {
      return textCodeMessages[textCode];
    }
    if (err && err.message) {
      return err.message;
    }
    if (window.extractErrorMessage) {
      return window.extractErrorMessage(response);
    }
    return 'Something went wrong. Please try again.';
  }

  function formatTimestamp(value) {
    if (!value) return '';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return '';
    return date.toLocaleString();
  }

  function setTokenStatus(message, tone) {
    if (!tokenStatus) return;
    tokenStatus.textContent = message;
    tokenStatus.classList.remove('hidden', 'text-emerald-700', 'text-amber-700', 'text-rose-600');
    tokenStatus.classList.add('text-sm');

    if (tone === 'ok') {
      tokenStatus.classList.add('text-emerald-700');
    } else if (tone === 'warn') {
      tokenStatus.classList.add('text-amber-700');
    } else {
      tokenStatus.classList.add('text-rose-600');
    }
  }

  function resolveTokenFromLocation() {
    const url = new URL(window.location.href);
    if (tokenAsQuery) {
      return url.searchParams.get(tokenQueryKey) || '';
    }
    const segments = url.pathname.split('/').filter(Boolean);
    return segments.length > 0 ? segments[segments.length - 1] : '';
  }

  async function fetchTokenMetadata(token) {
    if (!tokenMetadataPath || !token) return;
    try {
      const response = await fetch(`${tokenMetadataPath}?token=${encodeURIComponent(token)}&token_type=password_reset`, {
        headers: { 'Accept': 'application/json' }
      });
      if (!response.ok) {
        const message = await resolveErrorMessage(response);
        setTokenStatus(message, 'error');
        return;
      }
      const data = await response.json();
      if (!data || typeof data !== 'object') return;

      if (data.valid === false) {
        setTokenStatus('This reset link is no longer valid. Please request a new one.', 'warn');
        return;
      }

      const expiresAt = formatTimestamp(data.expires_at);
      if (expiresAt) {
        setTokenStatus(`Reset link expires on ${expiresAt}.`, 'ok');
      }
    } catch (error) {
      console.error('Failed to fetch token metadata', error);
    }
  }

  if (tokenInput) {
    const tokenFromURL = resolveTokenFromLocation();
    if (tokenFromURL) {
      tokenInput.value = tokenFromURL;
      fetchTokenMetadata(tokenFromURL);
    }
  }

  if (resetRequestForm) {
    resetRequestForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(resetRequestForm);
      const payload = Object.fromEntries(formData.entries());

      try {
        const response = await fetch(resetRequestForm.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const message = await resolveErrorMessage(response);
          window.toastManager?.error(message);
          return;
        }

        const data = await response.json();
        const expiresAt = formatTimestamp(data.expires_at);
        if (resetRequestResult) {
          resetRequestResult.textContent = expiresAt
            ? `Reset link requested. It expires on ${expiresAt}.`
            : 'Reset link requested. Check your email for the next step.';
          resetRequestResult.classList.remove('hidden');
        }
        window.toastManager?.success('Reset link sent. Check your email.');
      } catch (error) {
        console.error('Reset request failed', error);
        window.toastManager?.error('Unable to request a reset link.');
      }
    });
  }

  if (resetConfirmForm) {
    resetConfirmForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(resetConfirmForm);
      const payload = Object.fromEntries(formData.entries());

      try {
        const response = await fetch(resetConfirmForm.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const message = await resolveErrorMessage(response);
          window.toastManager?.error(message);
          return;
        }

        window.toastManager?.success('Password updated. You can sign in now.');
      } catch (error) {
        console.error('Reset confirmation failed', error);
        window.toastManager?.error('Unable to reset password.');
      }
    });
  }
</script>
{% endblock %}
