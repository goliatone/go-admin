{% extends "layout.html" %}

{% block title %}Notifications - {{ title }}{% endblock %}

{% block content %}
<div class="p-8 space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-admin-dark">Notifications</h1>
      <p class="text-sm text-zinc-500 mt-2">Review recent alerts and keep your inbox tidy.</p>
    </div>
    <div class="flex items-center gap-3">
      <span class="text-sm text-zinc-600">Unread: <span id="unread-count" class="font-semibold text-admin-dark">0</span></span>
      <button class="px-3 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700" onclick="refreshNotifications()">Refresh</button>
    </div>
  </div>

  <div class="bg-white border border-gray-200 rounded-xl shadow-sm">
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
      <div>
        <div class="text-lg font-semibold text-admin-dark">Inbox</div>
        <div class="text-sm text-zinc-500">Mark items read/unread to keep track of what matters.</div>
      </div>
      <div class="flex gap-2">
        <button class="px-3 py-2 text-sm font-semibold text-zinc-700 bg-gray-100 rounded-lg hover:bg-gray-200" onclick="markAll(true)">Mark all read</button>
        <button class="px-3 py-2 text-sm font-semibold text-zinc-700 bg-gray-100 rounded-lg hover:bg-gray-200" onclick="markAll(false)">Mark all unread</button>
      </div>
    </div>
    <ul class="divide-y divide-gray-100" id="notifications-list">
      <li class="px-6 py-5 text-zinc-500">Loading notifications...</li>
    </ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const notificationsBasePath = '{{ base_path }}';
  let notificationsCache = [];

  async function refreshNotifications() {
    try {
      const res = await fetch(`${notificationsBasePath}/api/notifications`);
      const data = await res.json();
      notificationsCache = data.notifications || [];
      renderNotifications(notificationsCache);
      const unreadCount = data.unread_count ?? data.notifications?.filter(n => !n.read).length ?? 0;
      document.getElementById('unread-count').textContent = unreadCount;
    } catch (err) {
      console.error('Failed to load notifications', err);
      document.getElementById('notifications-list').innerHTML = `<li class="px-6 py-5 text-red-600">Failed to load notifications</li>`;
    }
  }

  function renderNotifications(items) {
    const list = document.getElementById('notifications-list');
    if (!items || items.length === 0) {
      list.innerHTML = `<li class="px-6 py-5 text-zinc-500">No notifications yet.</li>`;
      return;
    }
    list.innerHTML = items.map(item => {
      const badge = item.read
        ? '<span class="px-2 py-1 text-xs font-semibold text-zinc-600 bg-gray-100 rounded-full">Read</span>'
        : '<span class="px-2 py-1 text-xs font-semibold text-white bg-amber-500 rounded-full">Unread</span>';
      const actionLabel = item.read ? 'Mark unread' : 'Mark read';
      const actionReadState = !item.read;
      return `
        <li class="px-6 py-5 flex items-start justify-between gap-4">
          <div>
            <div class="flex items-center gap-2">
              <div class="text-sm font-semibold ${item.read ? 'text-zinc-600' : 'text-admin-dark'}">${item.title || 'Notification'}</div>
              ${badge}
            </div>
            <div class="text-sm text-zinc-600 mt-1">${item.message || ''}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="px-3 py-2 text-sm font-semibold text-zinc-700 bg-gray-100 rounded-lg hover:bg-gray-200" onclick="toggleNotification('${item.id}', ${actionReadState})">${actionLabel}</button>
          </div>
        </li>
      `;
    }).join('');
  }

  async function toggleNotification(id, read) {
    try {
      await fetch(`${notificationsBasePath}/api/notifications/read`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ids: [id], read}),
      });
      refreshNotifications();
    } catch (err) {
      console.error('Failed to update notification state', err);
    }
  }

  async function markAll(read) {
    if (!notificationsCache || notificationsCache.length === 0) {
      return;
    }
    const ids = notificationsCache.map(n => n.id);
    try {
      await fetch(`${notificationsBasePath}/api/notifications/read`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ids, read}),
      });
      refreshNotifications();
    } catch (err) {
      console.error('Failed to update notifications', err);
    }
  }

  document.addEventListener('DOMContentLoaded', refreshNotifications);
</script>
{% endblock %}
