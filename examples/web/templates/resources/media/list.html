{% extends "layout.html" %}

{% block title %}Media - {{ title }}{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-admin-dark">Media</h1>
  <a href="{{ routes.new }}" class="btn btn-primary">+ Add Media</a>
</header>

<div class="flex-1 p-8 overflow-y-auto">
  {# DataGrid Toolbar #}
  <div class="bg-white border border-gray-200 rounded-xl mb-4 p-4">
    <div class="flex flex-wrap gap-4 items-center">
      {# Search #}
      <div class="flex-1 min-w-[200px]">
        <input
          type="text"
          id="search-input"
          placeholder="Search media..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>

      {# Filter Button #}
      <button
        id="filter-toggle-btn"
        class="btn btn-secondary flex items-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        Filters
      </button>

      {# Column Visibility #}
      <div class="relative">
        <button
          id="column-visibility-btn"
          class="btn btn-secondary flex items-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Columns
        </button>
        <div id="column-visibility-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
          <div class="p-2 space-y-1">
            {# Populated by ColumnVisibility behavior #}
          </div>
        </div>
      </div>

      {# Export #}
      <div class="relative">
        <button
          id="export-btn"
          class="btn btn-secondary flex items-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Export
        </button>
        <div id="export-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
          <button data-format="csv" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">CSV</button>
          <button data-format="json" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">JSON</button>
          <button data-format="excel" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">Excel</button>
        </div>
      </div>

      {# Bulk Actions #}
      <div class="relative">
        <button
          id="bulk-actions-btn"
          disabled
          class="btn btn-secondary flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Bulk Actions <span id="bulk-count" class="ml-1 text-xs">(0)</span>
        </button>
        <div id="bulk-actions-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
          <button data-action="archive" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">Archive</button>
          <button data-action="delete" class="w-full text-left px-4 py-2 hover:bg-red-100 text-red-600 text-sm">Delete</button>
        </div>
      </div>

      {# Refresh #}
      <button
        id="refresh-btn"
        class="btn btn-secondary flex items-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Refresh
      </button>
    </div>

    {# Filter Builder Panel #}
    <div id="filter-builder-panel" class="hidden mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
      <div id="filter-builder-root"></div>
      <div class="flex gap-2 mt-4">
        <button id="apply-filters-btn" class="btn btn-primary">Apply Filters</button>
        <button id="clear-filters-btn" class="btn btn-secondary">Clear</button>
      </div>
    </div>

    {# Active Filters Display #}
    <div id="active-filters" class="hidden mt-4 flex flex-wrap gap-2">
      {# Populated by FilterBehavior #}
    </div>
  </div>

  {# DataGrid Table #}
  <div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
    <div class="overflow-x-auto">
      <table id="media-datatable" class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" data-role="selection" data-fixed="left" class="px-6 py-3 text-start">
              <input type="checkbox" id="select-all" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
            </th>
            <th scope="col" data-column="filename" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
              Filename
              <button class="sort-btn ml-1" data-column="filename">
                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
              </button>
            </th>
            <th scope="col" data-column="mime_type" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
              Type
              <button class="sort-btn ml-1" data-column="mime_type">
                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
              </button>
            </th>
            <th scope="col" data-column="size" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
              Size
              <button class="sort-btn ml-1" data-column="size">
                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
              </button>
            </th>
            <th scope="col" data-column="created_at" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">
              Uploaded
              <button class="sort-btn ml-1" data-column="created_at">
                <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                </svg>
              </button>
            </th>
            <th scope="col" data-role="actions" data-fixed="right" class="px-6 py-3 text-end text-xs font-medium text-gray-500 uppercase tracking-wider">
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {# Rows populated by DataGrid #}
        </tbody>
      </table>
    </div>

    {# Loading State #}
    <div id="loading-state" class="hidden p-8 text-center text-gray-500">
      <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Loading...
    </div>

    {# Empty State #}
    <div id="empty-state" class="hidden p-8 text-center text-gray-500">
      <div class="text-6xl mb-4">üñºÔ∏è</div>
      <p class="text-lg font-medium">No media found</p>
      <p class="text-sm mt-1">Try adjusting your search or filters</p>
    </div>

    {# Error State #}
    <div id="error-state" class="hidden p-8 text-center text-red-500">
      <div class="text-6xl mb-4">‚ö†Ô∏è</div>
      <p class="text-lg font-medium">Failed to load media</p>
      <p class="text-sm mt-1" id="error-message"></p>
      <button id="retry-btn" class="mt-4 btn btn-primary">Retry</button>
    </div>
  </div>

  {# Pagination #}
  <div class="mt-4 flex justify-between items-center bg-white border border-gray-200 rounded-xl p-4">
    <div class="text-sm text-gray-600">
      Showing <span id="page-info-start">0</span> to <span id="page-info-end">0</span> of <span id="page-info-total">0</span> results
    </div>
    <div class="flex gap-2 items-center">
      <button id="prev-page" class="btn btn-secondary disabled:opacity-50 disabled:cursor-not-allowed">
        Previous
      </button>
      <div id="page-numbers" class="flex gap-1">
        {# Page numbers populated by PaginationBehavior #}
      </div>
      <button id="next-page" class="btn btn-secondary disabled:opacity-50 disabled:cursor-not-allowed">
        Next
      </button>
      <select id="per-page-select" class="ml-4 border border-gray-300 rounded-lg px-3 py-2 text-sm">
        <option value="10">10 per page</option>
        <option value="25">25 per page</option>
        <option value="50">50 per page</option>
        <option value="100">100 per page</option>
      </select>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{% verbatim %}
<script type="module">
  import {
    DataGrid,
    FilterBuilder,
    GoCrudSearchBehavior,
    GoCrudFilterBehavior,
    GoCrudPaginationBehavior,
    GoCrudSortBehavior,
    GoCrudExportBehavior,
    GoCrudBulkActionBehavior,
    DefaultColumnVisibilityBehavior
  } from '/admin/assets/dist/datatable/index.js';

  // Action base path for view/edit/delete
  const actionBasePath = window.location.pathname.replace('/list', '');

  // Initialize DataGrid
  const grid = new DataGrid({
    tableId: 'media-datatable',
    apiEndpoint: '/admin/crud/media',
    actionBasePath: actionBasePath,
    columns: [
      { field: 'filename', label: 'Filename', sortable: true, filterable: true },
      { field: 'mime_type', label: 'Type', sortable: true, filterable: true },
      { field: 'size', label: 'Size', sortable: true, filterable: true, render: (value) => {
        const kb = value / 1024;
        if (kb < 1024) return `${kb.toFixed(1)} KB`;
        return `${(kb / 1024).toFixed(1)} MB`;
      }},
      { field: 'created_at', label: 'Uploaded', sortable: true, filterable: true }
    ],
    perPage: 10,
    searchDelay: 300,
    behaviors: {
      search: new GoCrudSearchBehavior(['filename']),
      filter: new GoCrudFilterBehavior(),
      pagination: new GoCrudPaginationBehavior(),
      sort: new GoCrudSortBehavior(),
      export: new GoCrudExportBehavior('/admin/crud/media'),
      bulkActions: new GoCrudBulkActionBehavior('/admin/crud/media'),
      columnVisibility: new DefaultColumnVisibilityBehavior(
        ['filename', 'mime_type', 'size', 'created_at'],
        'media_datatable_columns'
      )
    }
  });

  // Initialize FilterBuilder
  const filterBuilder = new FilterBuilder({
    fields: [
      { name: 'filename', label: 'Filename', type: 'text' },
      { name: 'mime_type', label: 'Type', type: 'select', options: [
        { label: 'Image', value: 'image/*' },
        { label: 'Video', value: 'video/*' },
        { label: 'Document', value: 'application/*' }
      ]},
      { name: 'size', label: 'Size', type: 'number' },
      { name: 'created_at', label: 'Upload Date', type: 'date' }
    ],
    onApply: (structure) => {
      const filters = [];
      structure.groups.forEach(group => {
        group.conditions.forEach(condition => {
          filters.push({
            column: condition.field,
            operator: condition.operator,
            value: condition.value
          });
        });
      });
      grid.state.filters = filters;
      grid.resetPagination();
      grid.syncURL();
      grid.refresh();
    }
  });

  filterBuilder.mount(document.getElementById('filter-builder-root'));

  // UI Event Handlers
  document.getElementById('filter-toggle-btn').addEventListener('click', () => {
    const panel = document.getElementById('filter-builder-panel');
    panel.classList.toggle('hidden');
  });

  document.getElementById('apply-filters-btn').addEventListener('click', () => {
    filterBuilder.apply();
  });

  document.getElementById('clear-filters-btn').addEventListener('click', () => {
    filterBuilder.clear();
    grid.state.filters = [];
    grid.resetPagination();
    grid.syncURL();
    grid.refresh();
  });

  document.getElementById('refresh-btn').addEventListener('click', () => {
    grid.refresh();
  });

  // Initialize grid
  grid.init();
</script>
{% endverbatim %}
{% endblock %}
