{% extends "layout.html" %}

{% block title %}Dashboard - {{ title }}{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-admin-dark">Dashboard</h1>
  <div class="flex gap-3">
    <button class="btn btn-secondary" onclick="window.open('{{ base_path }}/api/dashboard')">‚Üë Export</button>
    <button class="btn btn-primary">+ Import</button>
  </div>
</header>

<div class="flex-1 p-8 overflow-y-auto">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Stats Overview -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white border border-gray-200 rounded-xl p-6">
          <div class="text-sm text-zinc-500 mb-2">Total Revenue</div>
          <div class="text-3xl font-bold text-admin-dark" id="total-revenue">$0</div>
          <div class="text-sm text-zinc-500 mt-1" id="total-orders">0 orders</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-6">
          <div class="text-sm text-zinc-500 mb-2">Total Users</div>
          <div class="text-3xl font-bold text-admin-dark" id="total-users">0</div>
          <div class="text-sm text-zinc-500 mt-1">Active users</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-6">
          <div class="text-sm text-zinc-500 mb-2">Published Content</div>
          <div class="text-3xl font-bold text-admin-dark" id="published-content">0</div>
          <div class="text-sm text-zinc-500 mt-1">Pages & Posts</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-6">
          <div class="text-sm text-zinc-500 mb-2">Storage Used</div>
          <div class="text-3xl font-bold text-admin-dark" id="storage-used">0 GB</div>
          <div class="text-sm text-zinc-500 mt-1" id="storage-percent">0% of total</div>
        </div>
      </div>

      <!-- Admin Panels -->
      <div class="bg-white border border-gray-200 rounded-xl p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-lg font-semibold text-admin-dark">Admin Panels</h2>
        </div>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
          <a href="{{ base_path }}/users" class="flex flex-col items-center text-center p-6 border border-gray-200 rounded-xl hover:border-blue-500 hover:shadow-lg hover:-translate-y-1 transition-all no-underline">
            <div class="text-4xl mb-3">üë•</div>
            <div class="text-base font-semibold text-admin-dark mb-1">Users</div>
            <div class="text-sm text-zinc-500">Manage user accounts</div>
          </a>
          <a href="{{ base_path }}/pages" class="flex flex-col items-center text-center p-6 border border-gray-200 rounded-xl hover:border-blue-500 hover:shadow-lg hover:-translate-y-1 transition-all no-underline">
            <div class="text-4xl mb-3">üìÑ</div>
            <div class="text-base font-semibold text-admin-dark mb-1">Pages</div>
            <div class="text-sm text-zinc-500">Edit website pages</div>
          </a>
          <a href="{{ base_path }}/posts" class="flex flex-col items-center text-center p-6 border border-gray-200 rounded-xl hover:border-blue-500 hover:shadow-lg hover:-translate-y-1 transition-all no-underline">
            <div class="text-4xl mb-3">üìù</div>
            <div class="text-base font-semibold text-admin-dark mb-1">Posts</div>
            <div class="text-sm text-zinc-500">Manage blog posts</div>
          </a>
          <a href="{{ base_path }}/media" class="flex flex-col items-center text-center p-6 border border-gray-200 rounded-xl hover:border-blue-500 hover:shadow-lg hover:-translate-y-1 transition-all no-underline">
            <div class="text-4xl mb-3">üñºÔ∏è</div>
            <div class="text-base font-semibold text-admin-dark mb-1">Media</div>
            <div class="text-sm text-zinc-500">Upload files & images</div>
          </a>
        </div>
      </div>

      <!-- Chart Widgets -->
      <div id="chart-widgets-main" class="space-y-6">
        <!-- Charts will be dynamically inserted here -->
      </div>

      <!-- Recent Activity -->
      <div class="bg-white border border-gray-200 rounded-xl p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-lg font-semibold text-admin-dark">Recent Activity</h2>
          <a href="{{ base_path }}/api/activity" class="text-sm text-blue-500 hover:text-blue-600 no-underline" target="_blank">View all</a>
        </div>
        <ul class="space-y-3" id="activity-feed">
          <li class="text-zinc-500">Loading...</li>
        </ul>
      </div>

      <!-- Background Jobs -->
      <div class="bg-white border border-gray-200 rounded-xl p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-lg font-semibold text-admin-dark">Background Jobs</h2>
          <a href="{{ base_path }}/api/jobs" class="text-sm text-blue-500 hover:text-blue-600 no-underline" target="_blank">Manage</a>
        </div>
        <ul class="space-y-2" id="jobs-list">
          <li class="text-zinc-500">Loading...</li>
        </ul>
      </div>

      <!-- Export & Bulk -->
      <div class="bg-white border border-gray-200 rounded-xl p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-lg font-semibold text-admin-dark">Data Export & Bulk</h2>
          <a href="{{ base_path }}/api/export?resource=users&format=json" class="text-sm text-blue-500 hover:text-blue-600 no-underline" target="_blank">Export API</a>
        </div>
        <div class="space-y-3">
          <div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-semibold text-admin-dark">Last Export</span>
              <button class="px-3 py-2 text-sm font-semibold text-zinc-700 bg-gray-100 rounded-lg hover:bg-gray-200" onclick="runExport()">Export Users (JSON)</button>
            </div>
            <pre class="mt-2 p-3 bg-gray-50 rounded-lg text-xs text-zinc-600 overflow-x-auto" id="export-preview">Pending...</pre>
          </div>
          <div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-semibold text-admin-dark">Bulk Jobs</span>
              <button class="px-3 py-2 text-sm font-semibold text-white bg-amber-500 rounded-lg hover:bg-amber-600" onclick="runBulkJob()">Start Bulk Cleanup</button>
            </div>
            <ul class="mt-2 space-y-2" id="bulk-jobs">
              <li class="text-zinc-500">Pending...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <aside class="space-y-6">
      <!-- Chart Widgets -->
      <div id="chart-widgets-sidebar" class="space-y-6">
        <!-- Charts will be dynamically inserted here -->
      </div>

      <!-- Revenue Chart -->
      <div class="bg-white border border-gray-200 rounded-xl p-6">
        <div class="text-xs uppercase tracking-wider text-zinc-500 mb-4 font-semibold">Receipt of Goods</div>
        <div class="flex justify-center mb-4">
          <div class="relative w-36 h-36">
            <svg class="w-full h-full" viewBox="0 0 140 140">
              <circle class="stroke-gray-100" fill="none" stroke-width="12" cx="70" cy="70" r="60"></circle>
              <circle class="stroke-blue-500" fill="none" stroke-width="12" cx="70" cy="70" r="60" id="revenue-circle"
                      stroke-dasharray="376.99" stroke-dashoffset="94.25"
                      transform="rotate(-90 70 70)" stroke-linecap="round"></circle>
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <div class="text-2xl font-bold text-admin-dark" id="revenue-percent">75%</div>
              <div class="text-xs text-zinc-500">Complete</div>
            </div>
          </div>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between text-sm">
            <span class="text-zinc-500">Target</span>
            <span class="font-semibold text-admin-dark">$50,000</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-zinc-500">Achieved</span>
            <span class="font-semibold text-admin-dark" id="revenue-achieved">$37,500</span>
          </div>
        </div>
      </div>

      <!-- System Metrics -->
      <div class="bg-white border border-gray-200 rounded-xl p-6">
        <div class="text-xs uppercase tracking-wider text-zinc-500 mb-4 font-semibold">System Metrics</div>
        <div class="space-y-4">
          <div>
            <div class="text-2xl font-bold text-admin-dark" id="metric-uptime">99.9%</div>
            <div class="text-sm text-zinc-500">Uptime</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-admin-dark" id="metric-requests">1.2M</div>
            <div class="text-sm text-zinc-500">Requests/day</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-admin-dark" id="metric-latency">45ms</div>
            <div class="text-sm text-zinc-500">Avg Latency</div>
          </div>
        </div>
      </div>

      <!-- Transaction Status -->
      <div class="bg-white border border-gray-200 rounded-xl p-6">
        <div class="text-xs uppercase tracking-wider text-zinc-500 mb-4 font-semibold">Transaction Status</div>
        <ul class="space-y-3">
          <li>
            <div class="flex justify-between mb-2 text-sm">
              <span class="flex items-center gap-2 text-admin-dark">
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                Paid
              </span>
              <span class="font-semibold text-zinc-600" id="status-paid">65%</span>
            </div>
            <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
              <div class="h-full bg-green-500 rounded-full transition-all" style="width: 65%"></div>
            </div>
          </li>
          <li>
            <div class="flex justify-between mb-2 text-sm">
              <span class="flex items-center gap-2 text-admin-dark">
                <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                Cancelled
              </span>
              <span class="font-semibold text-zinc-600" id="status-cancelled">20%</span>
            </div>
            <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
              <div class="h-full bg-red-500 rounded-full transition-all" style="width: 20%"></div>
            </div>
          </li>
          <li>
            <div class="flex justify-between mb-2 text-sm">
              <span class="flex items-center gap-2 text-admin-dark">
                <span class="w-2 h-2 bg-amber-500 rounded-full"></span>
                Refunded
              </span>
              <span class="font-semibold text-zinc-600" id="status-refunded">15%</span>
            </div>
            <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
              <div class="h-full bg-amber-500 rounded-full transition-all" style="width: 15%"></div>
            </div>
          </li>
        </ul>
      </div>

      <!-- Notifications Preview -->
      <div class="bg-white border border-gray-200 rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-admin-dark">Notifications</h2>
          <a href="{{ base_path }}/notifications" class="text-sm text-blue-500 hover:text-blue-600 no-underline">Open center</a>
        </div>
        <ul class="space-y-3" id="notifications-preview">
          <li class="text-zinc-500">Loading...</li>
        </ul>
      </div>

      <!-- Media Library -->
      <div class="bg-white border border-gray-200 rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-admin-dark">Media Library</h2>
          <a href="{{ base_path }}/api/media/library" class="text-sm text-blue-500 hover:text-blue-600 no-underline" target="_blank">View API</a>
        </div>
        <ul class="space-y-3" id="media-preview">
          <li class="text-zinc-500">Loading...</li>
        </ul>
      </div>
    </aside>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Fetch and populate dashboard data
  async function loadDashboard() {
    try {
      const response = await fetch('{{ base_path }}/api/dashboard');
      const data = await response.json();

      // Extract stats from widgets with type: "stat_card"
      if (data.widgets) {
        const statWidgets = data.widgets.filter(w => w.data && w.data.type === 'stat_card');

        statWidgets.forEach(widget => {
          const statData = widget.data;
          if (statData.stat_type === 'users') {
            document.getElementById('total-users').textContent = statData.total || 0;
          } else if (statData.stat_type === 'content') {
            document.getElementById('published-content').textContent = statData.published || 0;
          } else if (statData.stat_type === 'storage') {
            const usedGB = statData.used || 0;
            const percentage = statData.percentage || 0;
            document.getElementById('storage-used').textContent = `${usedGB} GB`;
            document.getElementById('storage-percent').textContent = `${percentage}% of total`;
          }
        });
      }

      // Keep existing revenue/orders defaults (no widget for these yet)
      document.getElementById('total-revenue').textContent = `$${data.totalRevenue?.toLocaleString() || 0}`;
      document.getElementById('total-orders').textContent = `${data.totalOrders || 0} orders`;

      // Update revenue chart
      if (data.revenuePercent !== undefined) {
        const circle = document.getElementById('revenue-circle');
        const circumference = 2 * Math.PI * 60;
        const offset = circumference - (data.revenuePercent / 100) * circumference;
        circle.style.strokeDashoffset = offset;
        document.getElementById('revenue-percent').textContent = `${data.revenuePercent}%`;
        document.getElementById('revenue-achieved').textContent = `$${data.revenueAchieved?.toLocaleString() || 0}`;
      }

      // Update activity feed from widgets
      if (data.widgets) {
        const activityWidget = data.widgets.find(w => w.definition === 'admin.widget.activity_feed');
        if (activityWidget && activityWidget.data && activityWidget.data.entries) {
          const activityFeed = document.getElementById('activity-feed');
          activityFeed.innerHTML = activityWidget.data.entries.map(entry => `
            <li class="py-3 border-b border-gray-100 last:border-b-0">
              <div class="font-semibold text-admin-dark text-sm">${entry.actor}</div>
              <div class="text-zinc-500 text-sm mt-1">${entry.action} ${entry.object}</div>
            </li>
          `).join('');
        }

        const notificationsWidget = data.widgets.find(w => w.definition === 'admin.widget.notifications');
        if (notificationsWidget && notificationsWidget.data && notificationsWidget.data.notifications) {
          const notifications = notificationsWidget.data.notifications;
          const preview = document.getElementById('notifications-preview');
          if (!notifications || notifications.length === 0) {
            preview.innerHTML = '<li class="text-zinc-500">No notifications yet.</li>';
          } else {
            preview.innerHTML = notifications.slice(0, 4).map(item => `
              <li class="py-3 border-b border-gray-100 last:border-b-0">
                <div class="flex items-center justify-between gap-3">
                  <div>
                    <div class="font-semibold text-admin-dark text-sm">${item.title || 'Notification'}</div>
                    <div class="text-zinc-500 text-sm mt-1">${item.message || ''}</div>
                  </div>
                  <span class="px-2 py-1 text-xs font-semibold ${item.read ? 'text-zinc-600 bg-gray-100' : 'text-white bg-blue-500'} rounded-full">${item.read ? 'Read' : 'Unread'}</span>
                </div>
              </li>
            `).join('');
          }
        }

        // Helper function to render HTML with script execution
        function renderHTMLWithScripts(container, html) {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;

          // Extract script elements
          const scripts = Array.from(tempDiv.querySelectorAll('script'));
          const scriptContents = [];

          scripts.forEach(script => {
            if (script.src) {
              // External script - preserve it
              scriptContents.push({ type: 'external', src: script.src });
            } else {
              // Inline script - save content
              scriptContents.push({ type: 'inline', content: script.textContent });
            }
            script.remove(); // Remove from HTML to prevent double execution
          });

          // Insert HTML first
          container.innerHTML = tempDiv.innerHTML;

          // Execute scripts in order
          scriptContents.forEach(scriptInfo => {
            if (scriptInfo.type === 'external') {
              const script = document.createElement('script');
              script.src = scriptInfo.src;
              document.head.appendChild(script);
            } else {
              const script = document.createElement('script');
              script.textContent = scriptInfo.content;
              document.body.appendChild(script);
            }
          });
        }

        // Render ECharts chart widgets
        if (data.widgets) {
          const chartTypes = ['admin.widget.bar_chart', 'admin.widget.line_chart', 'admin.widget.pie_chart', 'admin.widget.gauge_chart'];
          const chartWidgets = data.widgets.filter(w => chartTypes.includes(w.definition) && w.data && w.data.chart_html);

          // Separate main and sidebar charts based on actual area field
          const mainWidgets = chartWidgets.filter(w => w.area === 'admin.dashboard.main');
          const sidebarWidgets = chartWidgets.filter(w => w.area === 'admin.dashboard.sidebar');

          // Render main area charts
          if (mainWidgets.length > 0) {
            const mainContainer = document.getElementById('chart-widgets-main');
            const mainHTML = mainWidgets.map(widget => {
              const title = widget.data.title || 'Chart';
              const subtitle = widget.data.subtitle || '';
              return `
                <div class="bg-white border border-gray-200 rounded-xl p-6">
                  <div class="mb-4">
                    <h2 class="text-lg font-semibold text-admin-dark">${title}</h2>
                    ${subtitle ? `<p class="text-sm text-zinc-500 mt-1">${subtitle}</p>` : ''}
                  </div>
                  <div class="chart-container">
                    ${widget.data.chart_html}
                  </div>
                </div>
              `;
            }).join('');
            renderHTMLWithScripts(mainContainer, mainHTML);
          }

          // Render sidebar charts
          if (sidebarWidgets.length > 0) {
            const sidebarContainer = document.getElementById('chart-widgets-sidebar');
            const sidebarHTML = sidebarWidgets.map(widget => {
              const title = widget.data.title || 'Chart';
              return `
                <div class="bg-white border border-gray-200 rounded-xl p-6">
                  <h3 class="text-sm font-semibold text-admin-dark mb-4 uppercase tracking-wider text-zinc-500">${title}</h3>
                  <div class="chart-container">
                    ${widget.data.chart_html}
                  </div>
                </div>
              `;
            }).join('');
            renderHTMLWithScripts(sidebarContainer, sidebarHTML);
          }
        }
      }

      // Fetch and update jobs list from jobs API
      try {
        const jobsResponse = await fetch('{{ base_path }}/api/jobs');
        const jobsData = await jobsResponse.json();
        if (jobsData && jobsData.jobs && jobsData.jobs.length > 0) {
          const jobsList = document.getElementById('jobs-list');
          jobsList.innerHTML = jobsData.jobs.map(job => {
            const schedule = job.schedule || 'On demand';
            const lastRun = job.last_run ? new Date(job.last_run).toLocaleString() : 'Not run yet';
            const status = job.status || 'pending';
            return `
              <li class="py-2 px-3 border border-gray-200 rounded-lg bg-gray-50">
                <div class="flex items-center justify-between text-sm">
                  <span class="font-medium text-admin-dark">${job.name || job.command}</span>
                  <span class="text-xs text-zinc-500">${schedule}</span>
                </div>
                <div class="flex items-center justify-between text-xs text-zinc-500 mt-1">
                  <span class="${status === 'failed' ? 'text-red-600' : 'text-zinc-600'}">Status: ${status}</span>
                  <span>${lastRun}</span>
                </div>
              </li>
            `;
          }).join('');
        }
      } catch (jobsError) {
        console.error('Failed to load jobs data:', jobsError);
      }

      // Fetch bulk jobs list
      try {
        const bulkRes = await fetch('{{ base_path }}/api/bulk');
        const bulkData = await bulkRes.json();
        const bulkList = document.getElementById('bulk-jobs');
        if (bulkData && bulkData.jobs && bulkData.jobs.length > 0) {
          bulkList.innerHTML = bulkData.jobs.map(job => `
            <li class="p-3 bg-gray-50 rounded-lg border border-gray-200">
              <div class="flex items-center justify-between text-sm">
                <span class="font-semibold text-admin-dark">${job.name || job.action}</span>
                <span class="text-xs text-zinc-500">${job.status || 'pending'}</span>
              </div>
              <div class="text-xs text-zinc-500 mt-1">${job.processed || 0}/${job.total || 0} processed</div>
            </li>
          `).join('');
        } else {
          bulkList.innerHTML = '<li class="text-zinc-500">No bulk jobs yet.</li>';
        }
      } catch (bulkErr) {
        console.error('Failed to load bulk jobs:', bulkErr);
      }

      // Fetch media library preview (only if endpoint exists)
      try {
        const mediaRes = await fetch('{{ base_path }}/api/media/library');
        if (mediaRes.ok) {
          const mediaData = await mediaRes.json();
          const mediaList = document.getElementById('media-preview');
          if (mediaData && mediaData.items && mediaData.items.length > 0) {
            mediaList.innerHTML = mediaData.items.slice(0, 4).map(item => `
              <li class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-sm text-zinc-600">${(item.name || 'M')[0]}</div>
                <div>
                  <div class="text-sm font-semibold text-admin-dark">${item.name}</div>
                  <div class="text-xs text-zinc-500">${item.url}</div>
                </div>
              </li>
            `).join('');
          } else {
            document.getElementById('media-preview').innerHTML = '<li class="text-zinc-500">No media yet.</li>';
          }
        } else {
          // Media library not available - hide or show placeholder
          document.getElementById('media-preview').innerHTML = '<li class="text-zinc-500">Media library not configured.</li>';
        }
      } catch (mediaErr) {
        // Silently handle - media feature may not be enabled
        document.getElementById('media-preview').innerHTML = '<li class="text-zinc-500">Media library not available.</li>';
      }
    } catch (error) {
      console.error('Failed to load dashboard data:', error);
    }
  }

  async function runExport() {
    const preview = document.getElementById('export-preview');
    try {
      const res = await fetch('{{ base_path }}/api/export?resource=users&format=json');
      const data = await res.json();
      preview.textContent = (data && data.data) ? data.data.substring(0, 180) + '...' : 'No data';
    } catch (err) {
      preview.textContent = 'Failed to export data';
      console.error(err);
    }
  }

  async function runBulkJob() {
    const bulkList = document.getElementById('bulk-jobs');
    try {
      const res = await fetch('{{ base_path }}/api/bulk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: 'users.cleanup', action: 'cleanup', total: 10}),
      });
      const data = await res.json();
      if (data && data.job) {
        bulkList.innerHTML = `
          <li class="p-3 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center justify-between text-sm">
              <span class="font-semibold text-admin-dark">${data.job.name}</span>
              <span class="text-xs text-green-700">${data.job.status}</span>
            </div>
            <div class="text-xs text-zinc-500 mt-1">${data.job.processed}/${data.job.total} processed</div>
          </li>
        `;
      }
    } catch (err) {
      console.error('Failed to start bulk job', err);
      bulkList.innerHTML = '<li class="text-red-600">Bulk job failed</li>';
    }
  }

  // Load dashboard data on page load
  window.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}
