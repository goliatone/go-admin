{% extends "layout.html" %}

{% block title %}Dashboard - {{ title }}{% endblock %}

{% block content %}
<header class="px-8 py-6 bg-white border-b border-gray-200 flex justify-between items-center">
  <h1 class="text-3xl font-bold text-admin-dark">Dashboard</h1>
  <div class="flex gap-3">
    <button class="btn btn-secondary" onclick="window.open('{{ base_path }}/api/dashboard')">â†‘ Export</button>
  </div>
</header>

<!-- Save status indicator -->
<div id="save-status" class="px-8 py-3 bg-blue-50 text-blue-900 text-sm border-b border-blue-200">
  Drag widgets to rearrange, resize, or hide them. Changes save automatically.
</div>

<div class="flex-1 p-8 overflow-y-auto" data-widget-grid>
  <!-- Widget Grid Container -->
  <div class="dashboard-grid grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Main Area -->
    <section class="widget-area lg:col-span-2" data-area-code="admin.dashboard.main">
      <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Main Dashboard</h2>
      <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.main">
        <!-- Widgets will be rendered here -->
      </div>
    </section>

    <!-- Sidebar Area -->
    <aside class="widget-area" data-area-code="admin.dashboard.sidebar">
      <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Sidebar</h2>
      <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.sidebar">
        <!-- Widgets will be rendered here -->
      </div>
    </aside>

    <!-- Footer/Operations Area -->
    <section class="widget-area lg:col-span-3" data-area-code="admin.dashboard.footer">
      <h2 class="widget-area__title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Operations</h2>
      <div class="widgets-grid" data-widgets-grid data-area-grid="admin.dashboard.footer">
        <!-- Widgets will be rendered here -->
      </div>
    </section>

  </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Widget Grid System */
.widgets-grid {
  display: grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.widget {
  grid-column: span var(--span, 12);
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 0.75rem;
  padding: 1.5rem;
  cursor: grab;
  transition: all 200ms ease;
}

.widget:active {
  cursor: grabbing;
}

.widget.dragging {
  opacity: 0.5;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
}

.widget[data-hidden="true"],
.widget.is-hidden {
  opacity: 0.3;
}

.widget__toolbar {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.widget__toolbar-btn {
  padding: 0.375rem 0.75rem;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  cursor: pointer;
  transition: all 150ms ease;
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  color: #6b7280;
}

.widget__toolbar-btn:hover:not(:disabled) {
  background: #e5e7eb;
  color: #374151;
}

.widget__toolbar-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.widget__toolbar-btn svg {
  width: 1rem;
  height: 1rem;
}

.widget__content {
  /* Content styling */
}

.widget-area__title {
  margin: 0;
}

/* Chart container */
.widget .chart-container {
  min-height: 250px;
}

/* Stat cards within widgets */
.widget .metrics {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.widget .metric {
  flex: 1;
  min-width: 140px;
  background: #0f172a;
  color: #f8fafc;
  border-radius: 0.625rem;
  padding: 0.875rem 1rem;
}

.widget .metric small {
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 0.7rem;
  color: #cbd5f5;
}

.widget .metric span {
  display: block;
  font-size: 1.4rem;
  font-weight: 600;
  margin-top: 0.3rem;
}
</style>
{% endblock %}

{% block scripts %}
<script type="module">
import { WidgetGrid } from '{{ base_path }}/assets/dist/dashboard/index.js';

// Widget rendering helpers
function renderWidgetContent(widget) {
  const def = widget.definition || '';
  const data = widget.data || {};
  const config = widget.config || {};

  // User stats widget
  if (def === 'admin.widget.user_stats') {
    const values = data.values || {};
    return `
      <div class="metrics">
        ${Object.entries(values).map(([key, value]) => `
          <div class="metric">
            <small>${key}</small>
            <span>${formatNumber(value)}</span>
          </div>
        `).join('')}
      </div>
    `;
  }

  // Activity feed widget
  if (def === 'admin.widget.activity_feed') {
    const entries = data.entries || [];
    if (entries.length === 0) {
      return '<p class="text-gray-500">No recent activity</p>';
    }
    return `
      <ul class="space-y-3">
        ${entries.map(entry => `
          <li class="py-3 border-b border-gray-100 last:border-b-0">
            <div class="font-semibold text-gray-900 text-sm">${entry.actor}</div>
            <div class="text-gray-600 text-sm mt-1">${entry.action} ${entry.object}</div>
          </li>
        `).join('')}
      </ul>
    `;
  }

  // Notifications widget
  if (def === 'admin.widget.notifications') {
    const notifications = data.notifications || [];
    if (notifications.length === 0) {
      return '<p class="text-gray-500">No notifications</p>';
    }
    return `
      <ul class="space-y-3">
        ${notifications.slice(0, 5).map(notif => `
          <li class="py-3 border-b border-gray-100 last:border-b-0">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold text-gray-900 text-sm">${notif.title}</div>
                <div class="text-gray-600 text-sm mt-1">${notif.message}</div>
              </div>
              <span class="px-2 py-1 text-xs font-semibold ${notif.read ? 'text-gray-600 bg-gray-100' : 'text-white bg-blue-500'} rounded-full whitespace-nowrap">
                ${notif.read ? 'Read' : 'New'}
              </span>
            </div>
          </li>
        `).join('')}
      </ul>
    `;
  }

  // Chart widgets (bar, line, pie, gauge)
  if (def.includes('_chart') && data.chart_html) {
    const title = data.title || config.title || 'Chart';
    const subtitle = data.subtitle || config.subtitle || '';
    return `
      <div>
        ${subtitle ? `<p class="text-sm text-gray-500 mb-3">${subtitle}</p>` : ''}
        <div class="chart-container">${data.chart_html}</div>
      </div>
    `;
  }

  // Default: show raw data
  return `<pre class="text-xs text-gray-600 overflow-auto">${JSON.stringify(data, null, 2)}</pre>`;
}

function renderWidget(widget, areaCode) {
  const areaResizable = areaCode === 'admin.dashboard.main' || areaCode === 'admin.dashboard.footer';
  const span = widget.metadata?.layout?.width || widget.span || 12;
  const hidden = widget.hidden || false;
  const title = widget.data?.title || widget.config?.title || getWidgetTitle(widget.definition);

  return `
    <article class="widget"
             data-widget="${widget.id}"
             data-span="${span}"
             data-area-code="${areaCode}"
             data-resizable="${areaResizable}"
             ${hidden ? 'data-hidden="true"' : ''}
             style="--span: ${span}">

      <div class="widget__toolbar">
        <button type="button" class="widget__toolbar-btn" data-action="toggle-hide" title="Hide widget">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
          </svg>
          Hide
        </button>

        ${areaResizable ? `
          <button type="button" class="widget__toolbar-btn" data-action="toggle-width" title="Toggle width">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
            </svg>
            ${span === 12 ? 'Half' : 'Full'} Width
          </button>
        ` : ''}
      </div>

      <div class="widget__header mb-4">
        <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
      </div>

      <div class="widget__content">
        ${renderWidgetContent(widget)}
      </div>
    </article>
  `;
}

function getWidgetTitle(definition) {
  const titles = {
    'admin.widget.user_stats': 'User Statistics',
    'admin.widget.activity_feed': 'Recent Activity',
    'admin.widget.notifications': 'Notifications',
    'admin.widget.bar_chart': 'Bar Chart',
    'admin.widget.line_chart': 'Line Chart',
    'admin.widget.pie_chart': 'Pie Chart',
    'admin.widget.gauge_chart': 'Gauge',
  };
  return titles[definition] || definition;
}

function formatNumber(value) {
  if (typeof value === 'number') {
    return value.toLocaleString();
  }
  return value;
}

// Initialize dashboard
async function initDashboard() {
  try {
    // Fetch dashboard data
    const response = await fetch('{{ base_path }}/api/dashboard');
    const dashboardData = await response.json();

    // Group widgets by area
    const widgetsByArea = {};
    (dashboardData.widgets || []).forEach(widget => {
      const area = widget.area || 'admin.dashboard.main';
      if (!widgetsByArea[area]) {
        widgetsByArea[area] = [];
      }
      widgetsByArea[area].push(widget);
    });

    // Render widgets in each area
    Object.entries(widgetsByArea).forEach(([areaCode, widgets]) => {
      const container = document.querySelector(`[data-area-grid="${areaCode}"]`);
      if (container) {
        container.innerHTML = widgets.map(w => renderWidget(w, areaCode)).join('');
      }
    });

    // Execute any chart scripts
    document.querySelectorAll('.chart-container script').forEach(script => {
      const newScript = document.createElement('script');
      if (script.src) {
        newScript.src = script.src;
      } else {
        newScript.textContent = script.textContent;
      }
      document.body.appendChild(newScript);
    });

    // Initialize widget grid with drag & drop
    const grid = new WidgetGrid({
      apiEndpoint: '{{ base_path }}/api/dashboard',
      preferencesEndpoint: '{{ base_path }}/api/dashboard/preferences',
      areas: ['admin.dashboard.main', 'admin.dashboard.sidebar', 'admin.dashboard.footer'],
      onSave: (layout) => {
        console.log('Layout saved:', layout);
      },
      onError: (error) => {
        console.error('Widget grid error:', error);
        document.getElementById('save-status').textContent = 'Failed to save layout';
      }
    });

    await grid.init();

  } catch (error) {
    console.error('Failed to load dashboard:', error);
  }
}

// Load dashboard on page load
window.addEventListener('DOMContentLoaded', initDashboard);
</script>
{% endblock %}
