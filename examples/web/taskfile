#!/bin/bash

# Check for -debug flag
if [[ $* == *-debug* ]]; then
    set -x
fi

export LGR_NO_TIMESTAMP=true

# If we have a .taskenv file load it as source
if [ -f .taskenv ]; then
    # shellcheck disable=SC1091
    source .taskenv
fi

# This makes all bin packages installed via npm available here
# e.g. bogota, nyc, autocannon, etc.
PATH=$(pwd)/node_modules/.bin:$PATH

# This will make all scripts available in the ./src/bin directory
PATH=$(pwd)/src/bin:$PATH


##########################################
# Application management
##########################################


function dev:test {
    go test ./...
}

function dev:cover {
    go test -coverprofile=coverage.out ./... && go tool cover -func coverage.out
}

function dev:serve {
    local root_dir
    root_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
    local assets_dir="${root_dir}/pkg/client/assets"
    local hash_file="${assets_dir}/.build_hash"
    local src_dir="${assets_dir}/src"

    # Calculate hash of all frontend inputs that affect runtime behavior:
    # - Source files (TS/CSS/JS)
    # - Build config files (vite, tsconfig, tailwind, package.json)
    # - Input CSS for Tailwind
    local current_hash
    local config_files="${assets_dir}/vite.config.ts ${assets_dir}/tsconfig.json ${assets_dir}/tailwind.config.cjs ${assets_dir}/package.json ${assets_dir}/input.css"

    if command -v md5sum &> /dev/null; then
        # Linux
        current_hash=$(
            {
                find "${src_dir}" -type f \( -name "*.ts" -o -name "*.css" -o -name "*.js" \) -exec md5sum {} \; 2>/dev/null
                for f in $config_files; do [ -f "$f" ] && md5sum "$f" 2>/dev/null; done
            } | sort | md5sum | cut -d' ' -f1
        )
    else
        # macOS
        current_hash=$(
            {
                find "${src_dir}" -type f \( -name "*.ts" -o -name "*.css" -o -name "*.js" \) -exec md5 -q {} \; 2>/dev/null
                for f in $config_files; do [ -f "$f" ] && md5 -q "$f" 2>/dev/null; done
            } | sort | md5 -q
        )
    fi

    # Check if build is needed
    local needs_build=1
    if [ -f "$hash_file" ] && [ -d "${assets_dir}/dist" ]; then
        local stored_hash
        stored_hash=$(cat "$hash_file" 2>/dev/null)
        if [ "$stored_hash" = "$current_hash" ]; then
            needs_build=0
            echo "Assets unchanged, skipping build"
        fi
    fi

    # Safeguard: verify expected dist outputs exist even if hash matches
    if [ "$needs_build" -eq 0 ]; then
        local expected_outputs=(
            "${assets_dir}/dist/datatable/index.js"
            "${assets_dir}/dist/output.css"
            "${assets_dir}/dist/styles/datatable-actions.css"
        )
        for output in "${expected_outputs[@]}"; do
            if [ ! -f "$output" ]; then
                echo "Warning: Expected dist output missing: $output"
                echo "Forcing rebuild..."
                needs_build=1
                break
            fi
        done
    fi

    if [ "$needs_build" -eq 1 ]; then
        echo "Building assets..."
        (cd "${assets_dir}" && lgr exec -- npm run build)
        local build_status=$?
        if [ "$build_status" -ne 0 ]; then
            lgr error "npm build failed with status $build_status"
            return "$build_status"
        fi
        # Store hash after successful build
        echo "$current_hash" > "$hash_file"
    fi

    export ENV=development;
    export RESET_NAV_MENU=true;
    export USE_PERSISTENT_CMS=true;
    export NAV_DEBUG=false;
    export ADMIN_DEBUG=true;
    export ADMIN_SEEDS=true;
    export ADMIN_ASSETS_DEBUG=1;
    export ADMIN_DEBUG_REPL=true;
    export ADMIN_DEBUG_SCOPE=true;
    export ADMIN_DEBUG_LAYOUT=admin;
    export ADMIN_DEBUG_REPL_READONLY=false;
    export ADMIN_TRANSLATION_PROFILE=full;
    export ADMIN_ASSETS_DIR="${root_dir}/pkg/client/assets"

    go run .
}

# Force rebuild assets, bypassing hash check
function dev:serve:rebuild {
    local root_dir
    root_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
    local assets_dir="${root_dir}/pkg/client/assets"

    # Remove hash file to force rebuild
    rm -f "${assets_dir}/.build_hash"

    dev:serve
}

##########################################
# Help and auxiliary functions
##########################################

## Show function code
function help:show {
    declare -f "$1"
}

function help {
    echo ""
    echo "$0 <task> [...arguments]"
    echo ""
    echo "Project: ${PROJECT}"
    echo ""
    echo "Tasks:"
    compgen -A function | grep -v '^_' | cat -n
    echo ""

    prog="$0"
    me=$(basename "$prog")

    grep -e '^##[[:space:]]' -e '^##$' "$prog" | sed -e 's/^##//' -e "s/_PROG_/$me/" 2>&1 | less
}

TIMEFORMAT="Task completed in %3lR"
time "${@:-help}"; exit $?
