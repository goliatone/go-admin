<link rel="stylesheet" href="{{ asset_base_path }}/assets/sidebar.css">
<aside id="sidebar" class="sidebar bg-sidebar-bg text-sidebar-text flex flex-col overflow-hidden" data-collapsed="false" style="width: var(--sidebar-width, 260px);">
  <!-- Header: Logo -->
  <div class="sidebar-header flex items-center gap-2" style="padding: var(--sidebar-padding-y, 12px) var(--sidebar-padding-x, 12px);">
    <a href="{{ base_path }}" class="flex items-center no-underline flex-1 min-w-0">
      <img src="{{ asset_base_path }}/assets/logo.svg" alt="{{ title }}" class="sidebar-logo w-full h-auto" style="max-height: 32px;" />
    </a>
    <button id="sidebar-toggle" class="sidebar-toggle-btn p-1.5 rounded hover:bg-sidebar-bg-hover flex-shrink-0" aria-label="Toggle sidebar">
      <i class="iconoir-menu text-lg text-sidebar-text-muted"></i>
    </button>
  </div>

  <!-- Scrollable Main Navigation -->
  <nav class="flex-1 overflow-y-auto" style="padding: 0 var(--sidebar-padding-x, 12px);">
    {% for item in nav_items %}
      {% if item.type == "separator" %}
        <div style="height: var(--sidebar-gap-sections, 24px);"></div>
      {% elif item.type == "group" %}
        <div class="menu-group mb-4">
          <button class="flex items-center w-full gap-2 px-3 py-2 text-xs font-medium text-sidebar-text-muted hover:text-sidebar-text transition-colors rounded-lg hover:bg-sidebar-bg-hover">
            <i class="iconoir-nav-arrow-down text-xs transition-transform"></i>
            <span class="flex-1 text-left uppercase tracking-wider">{% if item.group_title %}{{ item.group_title }}{% else %}{{ item.label }}{% endif %}</span>
            <span class="menu-group-ellipsis text-sidebar-text-muted">...</span>
          </button>
          <div class="space-y-0.5 mt-1">
            {% for child in item.children %}
              {% if child.has_children and child.collapsible %}
                <div class="collapsible-menu-item mb-2" data-submenu-toggle="{{ child.id }}" data-expanded="{% if not child.collapsed %}true{% else %}false{% endif %}">
                  <button class="nav-item w-full" style="height: var(--sidebar-item-height, 36px);">
                    {% if child.icon %}
                      {{ renderMenuIcon(child.icon)|safe }}
                    {% endif %}
                    <span class="nav-text flex-1">{{ child.label }}</span>
                    <i class="iconoir-nav-arrow-down submenu-indicator text-xs transition-transform{% if not child.collapsed %} rotate-180{% endif %} flex-shrink-0"></i>
                  </button>
                  <div class="submenu space-y-0.5 mt-1 pl-8 {% if child.collapsed %}collapsed{% else %}expanded{% endif %}" data-submenu="{{ child.id }}">
                    {% for grandchild in child.children %}
                      <a href="{{ grandchild.href|default:'#' }}" class="nav-item{% if grandchild.active %} active{% endif %}" style="height: var(--sidebar-item-height, 36px);">
                        {% if grandchild.icon %}
                          {{ renderMenuIcon(grandchild.icon)|safe }}
                        {% endif %}
                        <span class="nav-text flex-1">{{ grandchild.label }}</span>
                      </a>
                    {% endfor %}
                  </div>
                </div>
              {% else %}
                <a href="{{ child.href|default:'#' }}" class="nav-item{% if child.active %} active{% endif %}" style="height: var(--sidebar-item-height, 36px);">
                  {% if child.icon %}
                    {{ renderMenuIcon(child.icon)|safe }}
                  {% endif %}
                  <span class="nav-text flex-1">{{ child.label }}</span>
                </a>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% elif item.children and item.collapsible %}
        <div class="collapsible-menu-item mb-2" data-submenu-toggle="{{ item.id }}" data-expanded="{% if not item.collapsed %}true{% else %}false{% endif %}">
          <button class="nav-item w-full" style="height: var(--sidebar-item-height, 36px);">
            {% if item.icon %}
              {{ renderMenuIcon(item.icon)|safe }}
            {% endif %}
            <span class="nav-text flex-1">{{ item.label }}</span>
            <i class="iconoir-nav-arrow-down submenu-indicator text-xs transition-transform{% if not item.collapsed %} rotate-180{% endif %} flex-shrink-0"></i>
          </button>
          <div class="submenu space-y-0.5 mt-1 pl-8 {% if item.collapsed %}collapsed{% else %}expanded{% endif %}" data-submenu="{{ item.id }}">
            {% for child in item.children %}
              <a href="{{ child.href|default:'#' }}" class="nav-item{% if child.active %} active{% endif %}" style="height: var(--sidebar-item-height, 36px);">
                {% if child.icon %}
                  {{ renderMenuIcon(child.icon)|safe }}
                {% endif %}
                <span class="nav-text flex-1">{{ child.label }}</span>
              </a>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <a href="{{ item.href|default:'#' }}" class="nav-item{% if item.active %} active{% endif %}" style="height: var(--sidebar-item-height, 36px);">
          {% if item.icon %}
            {{ renderMenuIcon(item.icon)|safe }}
          {% endif %}
          <span class="nav-text flex-1">{{ item.label }}</span>
        </a>
      {% endif %}
    {% endfor %}
    {% if nav_debug and nav_items_json %}
      <pre class="mt-4 text-[11px] bg-gray-900 text-gray-100 p-3 rounded-lg overflow-x-auto">{{ nav_items_json }}</pre>
    {% endif %}
  </nav>

  <!-- Fixed Bottom Section -->
  <div class="sidebar-bottom border-t border-sidebar-border" style="padding: var(--sidebar-padding-x, 12px);">
    <!-- User Profile -->
    <div class="border-t border-sidebar-border pt-3 pb-3 relative">
      <button id="user-menu-toggle" class="flex items-center gap-3 px-3 py-2.5 hover:bg-sidebar-bg-hover rounded-lg cursor-pointer transition-colors w-full text-left">
        <div class="relative flex-shrink-0">
          {% if session_user.avatar_url %}
            <img src="{{ session_user.avatar_url }}" alt="{{ session_user.display_name|default:"User" }}" class="w-9 h-9 rounded-full object-cover" loading="lazy">
          {% else %}
            <div class="w-9 h-9 rounded-full bg-blue-500/20 flex items-center justify-center font-semibold text-blue-400 text-sm">
              {{ session_user.initial|default:"?" }}
            </div>
          {% endif %}
          <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-sidebar-bg rounded-full"></span>
        </div>
        <div class="flex-1 min-w-0 sidebar-user-info">
          <div class="text-sm font-medium text-sidebar-text truncate">
            {{ session_user.display_name|default:"Guest" }}
          </div>
          <div class="text-xs text-sidebar-text-muted truncate">
            Online
          </div>
        </div>
        <i class="iconoir-nav-arrow-down flex-shrink-0 text-sidebar-text-muted text-sm sidebar-user-info transition-transform" id="user-menu-arrow"></i>
      </button>

      <!-- User Dropdown Menu -->
      <div id="user-menu" class="hidden absolute bottom-full left-0 right-0 mb-2 bg-sidebar-bg border border-sidebar-border rounded-xl shadow-2xl overflow-hidden" style="margin-left: 12px; margin-right: 12px;">
        <!-- User Header -->
        <div class="flex items-center gap-3 p-4 border-b border-sidebar-border">
          <div class="relative flex-shrink-0">
            {% if session_user.avatar_url %}
              <img src="{{ session_user.avatar_url }}" alt="{{ session_user.display_name|default:"User" }}" class="w-12 h-12 rounded-xl object-cover" loading="lazy">
            {% else %}
              <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center font-semibold text-blue-400 text-base">
                {{ session_user.initial|default:"?" }}
              </div>
            {% endif %}
            <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-sidebar-bg rounded-full"></span>
          </div>
          <div class="flex-1 min-w-0">
            <div class="text-base font-semibold text-sidebar-text truncate">
              {{ session_user.display_name|default:"Guest" }}
            </div>
            <div class="text-sm text-sidebar-text-muted truncate">
              Online
            </div>
          </div>
        </div>

        <!-- Danger Zone -->
        <div class="p-2">
          <a href="{{ base_path }}/logout" class="flex items-center gap-3 px-3 py-2.5 text-sidebar-text hover:bg-sidebar-bg-hover rounded-lg transition-colors">
            <i class="iconoir-log-out flex-shrink-0 text-sidebar-text-muted" style="font-size: 20px;"></i>
            <span class="flex-1 text-sm">Log out</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</aside>
